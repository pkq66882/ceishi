<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博客后台管理系统 - 期望ai</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' font-size='90' text-anchor='middle' dominant-baseline='central'%3E⚙️%3C/text%3E%3C/svg%3E" type="image/svg+xml">

    <!-- EasyMDE Markdown 编辑器 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.css">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* ==================== CSS Variables & Base Styles ==================== */
        :root {
            --font-body: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --bg-color: #f4f6f8;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --sidebar-hover-bg: #34495e;
            --sidebar-active-bg: #1abc9c;
            --content-bg: #ffffff;
            --text-color: #34495e;
            --heading-color: #2c3e50;
            --accent-color: #3498db;
            --accent-hover: #2980b9;
            --border-color: #e0e0e0;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --shadow: 0 1px 3px rgba(0,0,0,.12), 0 1px 2px rgba(0,0,0,.24);
            --focus-glow: 0 0 0 3px rgba(52, 152, 219, 0.25);
        }

        body {
            font-family: var(--font-body);
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 15px;
            line-height: 1.6;
        }

        a { text-decoration: none; color: var(--accent-color); transition: color .2s; }
        a:hover { color: var(--accent-hover); }

        input, textarea, button, select {
            font-family: inherit;
            font-size: 100%;
            margin: 0;
            padding: 0;
            line-height: normal;
        }

        input:focus, textarea:focus, button:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: var(--focus-glow);
        }

        h1, h2, h3, h4, h5, h6 { color: var(--heading-color); margin-top: 0; margin-bottom: 20px; }

        /* ==================== Login Page ==================== */
        #login-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--sidebar-bg);
            background-image: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        .login-box {
            width: 90%;
            max-width: 400px;
            padding: 40px;
            background: var(--content-bg);
            box-shadow: var(--shadow);
            border-radius: 8px;
            text-align: center;
            box-sizing: border-box;
        }
        .login-box h1 { margin-bottom: 25px; font-size: 2rem; color: var(--heading-color); }
        .login-box p { margin-bottom: 25px; color: #7f8c8d; line-height: 1.8; }
        .login-box input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1rem;
            color: var(--text-color);
            background-color: var(--bg-color);
        }
        .login-box input[type="checkbox"] {
            margin-right: 8px;
        }
        .remember-token-group {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--text-color);
        }
        .login-box button {
            width: 100%;
            padding: 12px;
            background: var(--accent-color);
            color: #fff;
            border: 0;
            border-radius: 5px;
            cursor: pointer;
            transition: background .2s ease, box-shadow .2s ease;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .login-box button:hover { background: var(--accent-hover); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .login-box button:disabled { background: #cccccc; cursor: not-allowed; }
        #initial-message { color: var(--danger-color); margin-top: 20px; font-size: 0.9rem; }
        .generate-token-link {
            display: block;
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--accent-color);
        }
        #path-display {
            font-size: 0.8em;
            color: #999;
            margin-top: 10px;
        }

        /* ==================== Admin Layout ==================== */
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
            background-color: var(--bg-color);
        }

        #admin-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 250px;
            background: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            transform: translateX(-100%);
            transition: transform .3s ease-in-out;
            z-index: 1000;
            box-shadow: var(--shadow);
        }
        .admin-wrapper.sidebar-visible #admin-sidebar { transform: translateX(0); }
        #admin-sidebar .logo {
            padding: 25px 20px;
            font-size: 1.6rem;
            font-weight: 700;
            text-align: center;
            background-color: rgba(0,0,0,.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        #admin-sidebar .nav {
            flex-grow: 1;
            list-style: none;
            margin: 0;
            padding: 20px 0;
        }
        #admin-sidebar .nav li { margin-bottom: 5px; }
        #admin-sidebar .nav a {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: var(--sidebar-text);
            transition: background .2s ease;
            border-left: 5px solid transparent;
        }
        #admin-sidebar .nav a i {
            margin-right: 12px;
            font-size: 1.1rem;
        }
        #admin-sidebar .nav a:hover { background: var(--sidebar-hover-bg); }
        #admin-sidebar .nav a.active {
            background: var(--sidebar-active-bg);
            color: white;
            border-left-color: #fff;
            font-weight: 600;
        }
        #admin-sidebar footer {
             padding: 20px;
             font-size: 0.9rem;
             color: #a0a8b4;
             border-top: 1px solid rgba(255,255,255,0.1);
             text-align: center;
        }
        #admin-sidebar footer a { color: var(--sidebar-active-bg); }


        #admin-content {
            flex-grow: 1;
            margin-left: 0;
            padding: 30px;
            box-sizing: border-box;
            transition: margin-left .3s ease-in-out;
        }

        #mobile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--content-bg);
            padding: 15px 20px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border-radius: 8px;
        }
        .mobile-menu-btn {
            font-size: 1.8rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
        }
        .mobile-logo {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--heading-color);
        }
        #mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.5);
            z-index: 999;
            display: none;
        }
        .admin-wrapper.sidebar-visible #mobile-overlay{ display: block; }

        @media(min-width: 768px) {
            #admin-sidebar {
                position: static;
                transform: translateX(0);
                flex-shrink: 0;
            }
            #admin-content {
                margin-left: 250px;
                padding: 30px;
            }
            #mobile-header { display: none; }
            #mobile-overlay { display: none !important; }
        }

        /* ==================== Content Area Common Styles ==================== */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }
        .page-header h2 {
            font-size: 1.8rem;
            margin: 0;
            line-height: 1;
        }

        /* Forms, Buttons, Tables */
        .form-group { margin-bottom: 25px; }
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--heading-color);
            font-size: 0.95rem;
        }
        .form-group input:not([type="checkbox"]), .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            box-sizing: border-box;
            background-color: var(--content-bg);
            color: var(--text-color);
            font-size: 1rem;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 250px;
        }
        .form-group .description {
            font-size: 0.85rem;
            color: var(--meta-color);
            margin-top: 5px;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .button-group {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        button, .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background .2s ease, box-shadow .2s ease;
            font-weight: 600;
        }
        button i, .btn i { margin-right: 8px; }
        button:hover:not(:disabled), .btn:hover:not(:disabled) { opacity: 0.9; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        button:disabled, .btn:disabled { background: #cccccc !important; cursor: not-allowed; opacity: 0.7; }

        .btn-primary { background: var(--accent-color); color: #fff; }
        .btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
        .btn-success { background: var(--success-color); color: #fff; }
        .btn-success:hover:not(:disabled) { background: #218838; }
        .btn-danger { background: var(--danger-color); color: #fff; }
        .btn-danger:hover:not(:disabled) { background: #c82333; }
        .btn-secondary { background: #6c757d; color: #fff; }
        .btn-secondary:hover:not(:disabled) { background: #5a6268; }

        .admin-table-wrapper { overflow-x: auto; background: var(--content-bg); border-radius: 8px; box-shadow: var(--shadow); }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--content-bg);
        }
        .admin-table thead { background: #f8f9fa; }
        .admin-table th, .admin-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        .admin-table th {
            font-weight: 700;
            color: var(--heading-color);
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        .admin-table td {
            font-size: 0.95rem;
            color: var(--text-color);
        }
        .admin-table tr:last-child td { border-bottom: none; }
        .admin-table .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-start;
            flex-wrap: wrap;
        }
        .admin-table .actions a.edit { color: var(--accent-color); }
        .admin-table .actions a.delete { color: var(--danger-color); }
        .admin-table .actions a.link { color: var(--sidebar-active-bg); }
        .admin-table td input[type="checkbox"] {
            margin-right: 0;
            width: auto;
        }

        /* EasyMDE Styles */
        .editor-toolbar {
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            background-color: #f8f9fa !important;
            border-color: var(--border-color) !important;
        }
        .editor-toolbar button { background: none !important; color: var(--text-color) !important; border: none !important; }
        .editor-toolbar button.active, .editor-toolbar button:hover { background-color: var(--border-color) !important; }
        .editor-toolbar button.active { border-radius: 4px; }
        .CodeMirror {
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
            border: 1px solid var(--border-color) !important;
            border-top: none !important;
            min-height: 400px;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .CodeMirror-fullscreen { z-index: 2000; }
        .editor-preview-active, .editor-preview-active-side {
            background-color: var(--content-bg) !important;
            color: var(--text-color) !important;
            padding: 15px;
        }
        .editor-preview h1, .editor-preview h2, .editor-preview h3, .editor-preview h4, .editor-preview h5, .editor-preview h6 {
            color: var(--heading-color);
        }
        .editor-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1rem 0;
            display: block;
        }
        .editor-preview blockquote {
            padding: 0.5em 1em;
            margin: 1em 0;
            border-left: 4px solid var(--accent-color);
            color: var(--meta-color);
            background-color: rgba(52, 152, 219, 0.05);
            border-radius: 5px;
        }
        .CodeMirror-scroll {
            background-color: var(--content-bg);
        }

        /* Image Upload Preview */
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .image-preview {
            position: relative;
            width: 100px;
            height: 100px;
            border: 1px dashed var(--border-color);
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-color: #f9f9f9;
        }
        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        .image-preview .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            line-height: 1;
            padding: 0;
        }
        .image-placeholder {
            color: var(--meta-color);
            font-size: 0.8rem;
            text-align: center;
        }
        #setting-bg-image-preview {
            width: 200px;
            height: 120px;
            border: 1px dashed var(--border-color);
            margin-top: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        #setting-bg-image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        #setting-bg-image-preview .placeholder {
            color: var(--meta-color);
            font-size: 0.9rem;
        }

        /* Alerts & Progress Bar */
        .alert {
            padding: 15px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .alert i { font-size: 1.2rem; }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .alert-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 10px;
            height: 25px;
            overflow: hidden;
            position: relative;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--accent-color);
            border-radius: 5px;
            text-align: center;
            line-height: 25px;
            color: white;
            transition: width 0.3s ease;
            font-size: 0.9em;
            position: absolute;
            top: 0;
            left: 0;
        }
        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 25px;
            color: var(--text-color);
            font-size: 0.9em; /* Ensures text is visible on dark bar too */
            z-index: 1;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.2); /* For better contrast on dark bar */
        }
        /* Editor specific progress bar */
        .editor.progress-container {
            margin-top: 5px;
            margin-bottom: 10px;
            height: 20px;
            width: calc(100% - 2px); /* Account for toolbar border */
            left: 1px;
            position: relative;
        }
        .editor .progress-bar {
            line-height: 20px;
            font-size: 0.8em;
        }
        .editor .progress-text {
            line-height: 20px;
            font-size: 0.8em;
        }
        
        /* Tag/Category Suggestions */
        .suggestion-box {
            position: absolute;
            background-color: var(--content-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            max-height: 150px;
            overflow-y: auto;
            width: 100%;
            z-index: 100;
            box-shadow: var(--shadow);
            top: 100%;
            left: 0;
            margin-top: 5px;
        }
        .suggestion-box div {
            padding: 10px;
            cursor: pointer;
            transition: background-color .2s;
        }
        .suggestion-box div:hover {
            background-color: var(--accent-color);
            color: white;
        }
        .form-group.has-suggestions {
            position: relative;
        }
        .tag-token-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 8px 10px;
            min-height: 40px;
            align-items: center;
            background-color: var(--content-bg);
            cursor: text;
        }
        .tag-token {
            display: inline-flex;
            align-items: center;
            background-color: var(--accent-color);
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .tag-token .remove-tag {
            margin-left: 5px;
            cursor: pointer;
            color: rgba(255,255,255,0.7);
        }
        .tag-token-input {
            border: none !important;
            flex-grow: 1;
            padding: 0 !important;
            margin-left: 5px;
            background: transparent !important;
            color: var(--text-color) !important;
            line-height: 1.5 !important;
        }
        .tag-token-input:focus {
            box-shadow: none !important;
        }

        /* Dashboard Specific Styles */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .stat-card {
            background: var(--content-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card i {
            font-size: 3rem;
            color: var(--accent-color);
            margin-bottom: 15px;
        }
        .stat-card h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--heading-color);
        }
        .stat-card p {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 0;
            line-height: 1;
        }
        .recent-activity {
            background: var(--content-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-top: 30px;
        }
        .recent-activity h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--heading-color);
        }
        .activity-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .activity-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .activity-item i {
            font-size: 1.2rem;
            color: var(--accent-color);
            margin-right: 15px;
            background: var(--bg-color);
            padding: 8px;
            border-radius: 50%;
            box-shadow: inset 0 0 0 1px var(--border-color);
        }
        .activity-item .content {
            flex-grow: 1;
        }
        .activity-item .content p {
            margin: 0;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        .activity-item .content .time {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        /* Media Library Specific Styles */
        #media-library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .media-item {
            background: var(--content-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease;
        }
        .media-item:hover {
            transform: translateY(-5px);
        }
        .media-item-thumbnail {
            width: 100%;
            height: 150px;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            border-bottom: 1px solid var(--border-color);
        }
        .media-item-thumbnail img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .media-item-info {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .media-item-info .name {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--heading-color);
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .media-item-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .media-item-actions button {
            padding: 8px 12px;
            font-size: 0.85rem;
            flex-grow: 1;
            min-width: 80px;
        }
        .media-upload-area {
            background: var(--content-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-top: 20px;
            text-align: center;
            border: 2px dashed var(--border-color);
            transition: border-color 0.3s ease;
        }
        .media-upload-area.drag-over {
            border-color: var(--accent-color);
        }
        .media-upload-area p {
            font-size: 1.1rem;
            color: var(--text-color);
        }
        .media-upload-area label.btn-primary {
            cursor: pointer;
            margin-top: 15px;
        }
        #media-upload-input {
            display: none;
        }
    </style>
</head>
<body>

    <div id="login-wrapper">
        <div id="login-box" class="login-box">
            <h1><i class="fas fa-lock"></i> 博客管理</h1>
            <p>请输入您的GitHub Personal Access Token以开始。该Token需具备 <code style="background-color: #f0f0f0; padding: 2px 5px; border-radius: 3px;">repo</code> 权限。</p>
            <input type="password" id="token-input" placeholder="ghp_xxx 或 Bearer xxx">
            <div class="remember-token-group">
                <input type="checkbox" id="remember-token">
                <label for="remember-token">记住Token (高风险，仅限个人安全设备)</label>
            </div>
            <button id="start-btn"><i class="fas fa-sign-in-alt"></i> 登录</button>
            <p id="initial-message"></p>
            <p id="path-display" style="display:none;"></p>
            <a href="https://github.com/settings/tokens" target="_blank" class="generate-token-link">如何生成 Personal Access Token?</a>
        </div>
    </div>

    <div id="admin-wrapper" class="admin-wrapper" style="display: none;">
        <div id="mobile-overlay"></div>
        <aside id="admin-sidebar">
            <div class="logo">博客管理系统</div>
            <ul class="nav">
                <li><a href="#" id="nav-dashboard" data-view="dashboard"><i class="fas fa-chart-line"></i> 仪表盘</a></li>
                <li><a href="#" id="nav-posts" data-view="posts"><i class="fas fa-newspaper"></i> 文章管理</a></li>
                <li><a href="#" id="nav-media-library" data-view="media-library"><i class="fas fa-images"></i> 媒体库</a></li>
                <li><a href="#" id="nav-settings" data-view="settings"><i class="fas fa-cog"></i> 网站设置</a></li>
                <li><a href="#" id="nav-gitalk-settings" data-view="gitalk-settings"><i class="fas fa-comments"></i> 评论设置</a></li>
                <li><a id="view-site-link" href="#" target="_blank"><i class="fas fa-desktop"></i> 查看站点</a></li>
                <li><a href="#" id="nav-logout"><i class="fas fa-sign-out-alt"></i> 安全退出</a></li>
            </ul>
            <footer>
                <p>Powered by <a href="https://github.com/rjdsq" target="_blank">期望ai</a></p>
            </footer>
        </aside>

        <main id="admin-content">
            <header id="mobile-header">
                <button id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
                <div class="mobile-logo">管理后台</div>
            </header>

            <!-- Dashboard View -->
            <div id="dashboard-view" class="admin-view" style="display:none;">
                <div class="page-header">
                    <h2><i class="fas fa-chart-line"></i> 仪表盘</h2>
                </div>
                <div class="grid-container">
                    <div class="stat-card">
                        <i class="fas fa-newspaper"></i>
                        <h3>文章总数</h3>
                        <p id="total-posts">0</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-layer-group"></i>
                        <h3>文章分类</h3>
                        <p id="total-categories">0</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-tags"></i>
                        <h3>文章标签</h3>
                        <p id="total-tags">0</p>
                    </div>
                </div>
                <div class="recent-activity">
                    <h3><i class="fas fa-history"></i> 最新活动</h3>
                    <div id="activity-list">
                        <div class="activity-item">
                            <i class="fas fa-info-circle"></i>
                            <div class="content">
                                <p>博客后台管理系统已成功加载，正在收集数据...</p>
                                <span class="time">刚刚</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Posts Management View -->
            <div id="posts-view" class="admin-view" style="display:none;">
                <div class="page-header">
                    <h2><i class="fas fa-list-alt"></i> 文章管理</h2>
                    <div>
                        <button id="new-post-btn" class="btn-primary"><i class="fas fa-plus-circle"></i> 撰写新文章</button>
                        <button id="delete-selected-posts-btn" class="btn-danger" style="display:none; margin-left: 10px;"><i class="fas fa-trash-alt"></i> 删除选中文章</button>
                    </div>
                </div>
                <div class="admin-table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-posts"></th>
                                <th>标题</th>
                                <th>分类</th>
                                <th>标签</th>
                                <th>发布日期</th>
                                <th>更新日期</th>
                                <th class="actions">操作</th>
                            </tr>
                        </thead>
                        <tbody id="post-list">
                            <!-- Posts list will be generated here dynamically -->
                            <tr><td colspan="7" style="text-align: center;">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Post Editor/Creation View -->
            <div id="editor-container" class="admin-view" style="display: none;">
                <h2 id="editor-title"><i class="fas fa-edit"></i> 撰写新文章</h2>
                 <input type="hidden" id="post-id">
                <div class="form-group">
                    <label for="post-title">文章标题 <span style="color:red;">*</span></label>
                    <input type="text" id="post-title" placeholder="请输入文章标题">
                </div>
                 <div class="form-group">
                    <label for="post-category">文章分类</label>
                    <input type="text" id="post-category" placeholder="请输入文章分类，例如：技术，生活">
                </div>
                 <div class="form-group has-suggestions">
                    <label for="post-tags-input">文章标签 (按 Enter 键添加，点击标签删除)</label>
                    <div id="tag-token-container" class="tag-token-container">
                        <input type="text" id="post-tags-input" placeholder="输入标签并按回车">
                    </div>
                    <div id="tag-suggestions" class="suggestion-box" style="display: none;"></div>
                    <input type="hidden" id="post-tags">
                    <p class="description">输入标签后按回车键添加。点击现有标签可删除。从建议列表中选择。</p>
                </div>

                <div class="form-group">
                    <label for="post-content">文章内容 (支持 Markdown)</label>
                    <textarea id="post-content"></textarea>
                    <p class="description">请使用 Markdown 格式编写文章。使用 `&lt;!--more--&gt;` 可定义文章摘要。</p>
                </div>
                <div class="button-group">
                    <button id="save-post-btn" class="btn-success"><i class="fas fa-upload"></i> 发布/更新文章</button>
                    <button id="cancel-edit-btn" class="btn-secondary"><i class="fas fa-times-circle"></i> 取消</button>
                    <button id="delete-post-btn" class="btn-danger" style="display:none;"><i class="fas fa-trash-alt"></i> 删除文章</button>
                </div>
            </div>

            <!-- Media Library View -->
            <div id="media-library-view" class="admin-view" style="display:none;">
                <div class="page-header">
                    <h2><i class="fas fa-images"></i> 媒体库</h2>
                    <label for="media-upload-input" class="btn btn-primary"><i class="fas fa-plus-circle"></i> 上传新图片</label>
                    <input type="file" id="media-upload-input" accept="image/*" multiple style="display:none;">
                </div>
                <div id="media-upload-droparea" class="media-upload-area">
                    <p><i class="fas fa-cloud-upload-alt"></i> 将图片拖拽到这里上传</p>
                    <div id="upload-progress-container" class="progress-container" style="display:none;">
                        <div id="upload-progress-bar" class="progress-bar"></div>
                        <div id="upload-progress-text" class="progress-text">0%</div>
                    </div>
                </div>
                <div id="media-library-grid">
                    <!-- Image list will be generated here dynamically -->
                    <p style="grid-column: 1 / -1; text-align: center;">加载中...</p>
                </div>
            </div>

            <!-- Website Settings View -->
            <div id="settings-view" class="admin-view" style="display: none;">
                <div class="page-header">
                    <h2><i class="fas fa-cogs"></i> 网站设置</h2>
                    <button id="save-settings-btn" class="btn-success"><i class="fas fa-save"></i> 保存设置</button>
                </div>
                 <div class="form-group">
                    <label for="setting-title">网站标题 <span style="color:red;">*</span></label>
                    <input type="text" id="setting-title" placeholder="例如：我的个人博客">
                </div>
                <div class="form-group">
                    <label for="setting-description">网站描述</label>
                    <input type="text" id="setting-description" placeholder="一句话描述你的博客">
                </div>
                <div class="form-group">
                    <label for="setting-about-content">“关于我”页面内容 (支持 Markdown)</label>
                    <textarea id="setting-about-content" rows="10" placeholder="请在这里填写关于你的介绍，支持 Markdown 格式。"></textarea>
                    <p class="description">此内容将显示在网站的“关于我”页面。留空时会显示默认提示。</p>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="setting-bg-color">背景颜色</label>
                        <input type="color" id="setting-bg-color">
                        <p class="description">网站的整体背景色。</p>
                    </div>
                    <div class="form-group">
                        <label for="setting-text-color">文字颜色</label>
                        <input type="color" id="setting-text-color">
                        <p class="description">网站内容的默认文字颜色。</p>
                    </div>
                    <div class="form-group">
                        <label for="setting-accent-color">链接/强调色</label>
                        <input type="color" id="setting-accent-color">
                        <p class="description">链接、按钮等强调元素的颜色。</p>
                    </div>
                </div>
                <div class="form-group">
                    <label for="setting-bg-image">网站背景图</label>
                    <input type="file" id="setting-bg-image" accept="image/*">
                    <div id="setting-bg-image-preview" style="margin-top:10px;">
                        <span class="placeholder">无背景图</span>
                    </div>
                    <input type="text" id="setting-bg-image-url" placeholder="背景图URL将显示在这里" readonly style="margin-top: 10px;">
                    <div class="button-group" style="margin-top: 10px; justify-content: flex-start;">
                        <button id="upload-bg-image-btn" class="btn-primary" style="display:none;"><i class="fas fa-upload"></i> 上传并设置</button>
                        <button id="clear-bg-image-btn" class="btn-danger"><i class="fas fa-trash-alt"></i> 清除背景图</button>
                    </div>
                    <p class="description">可上传图片作为网站背景，或直接粘帖图像的原始 URL (如 raw.githubusercontent.com)。</p>
                </div>
             </div>

            <!-- Gitalk Settings View -->
            <div id="gitalk-settings-view" class="admin-view" style="display: none;">
                <div class="page-header">
                    <h2><i class="fas fa-comments"></i> Gitalk 评论设置</h2>
                    <button id="save-gitalk-settings-btn" class="btn-success"><i class="fas fa-save"></i> 保存评论设置</button>
                </div>
                <p class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Gitalk 在您的博客文章下添加评论功能，它基于 GitHub Issues。请确保您创建的 GitHub Personal Access Token 拥有 `public_repo` (或 `repo` 用于私有库) 权限，且 `owner` 和 `repo` 字段填写正确。
                </p>
                <div class="form-group">
                    <label for="gitalk-clientID">GitHub Application Client ID <span style="color:red;">*</span></label>
                    <input type="text" id="gitalk-clientID" placeholder="GitHub OAuth Application Client ID">
                    <p class="description">在 GitHub 创建 OAuth Application 获取。回调 URL 填写您的博客网址。</p>
                </div>
                <div class="form-group">
                    <label for="gitalk-clientSecret">GitHub Application Client Secret <span style="color:red;">*</span></label>
                    <input type="password" id="gitalk-clientSecret" placeholder="GitHub OAuth Application Client Secret">
                    <p class="description">在 GitHub 创建 OAuth Application 获取。请妥善保管此Secret，但由于在前端使用，仍存在被获取的风险。</p>
                </div>
                <div class="form-group">
                    <label for="gitalk-repo">GitHub 仓库名 (用于存储评论 Issue) <span style="color:red;">*</span></label>
                    <input type="text" id="gitalk-repo" placeholder="例如：your-github-username.github.io">
                    <p class="description">存储博客评论的 GitHub 仓库名称，通常与您的博客仓库相同。</p>
                </div>
                <div class="form-group">
                    <label for="gitalk-owner">GitHub 仓库所有者 <span style="color:red;">*</span></label>
                    <input type="text" id="gitalk-owner" placeholder="例如：your-github-username">
                    <p class="description">GitHub 仓库所有者的用户名。</p>
                </div>
                <div class="form-group">
                    <label for="gitalk-admin">管理员 GitHub 用户名 (用英文逗号分隔，可多个)</label>
                    <input type="text" id="gitalk-admin" placeholder="例如：your-github-username">
                    <p class="description">拥有 Gitalk 评论管理权限的 GitHub 用户名，例如可以删除评论。</p>
                </div>
                 <div class="form-group">
                    <input type="checkbox" id="gitalk-enabled">
                    <label for="gitalk-enabled" style="display: inline-block; margin-left: 5px; margin-bottom: 0;">启用 Gitalk 评论</label>
                </div>
            </div>
        </main>
    </div>

    <!-- EasyMDE Markdown 编辑器 JS -->
    <script src="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.js"></script>

    <script>
        // ==================== Global Variables & Utility Functions ====================
        const utf8_to_b64 = (str) => btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
        const b64_to_utf8 = (b64String) => {
            try { 
                const binaryString = atob(b64String);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return new TextDecoder('utf-8').decode(bytes);
            } catch (e) { 
                console.error("Base64 decoding to UTF-8 failed:", e);
                return atob(b64String); 
            }
        };

        const GitHubAPI = {
            BASE_URL: 'https://api.github.com',
            async request(token, endpoint, options = {}) {
                const url = `${this.BASE_URL}${endpoint}`;
                const headers = { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json', ...options.headers };
                const response = await fetch(url, { ...options, headers });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP Error: ${response.statusText}`, documentation_url: response.url || endpoint }));
                    const errorMessage = errorData.message || `GitHub API request failed with status ${response.status}, endpoint: ${endpoint}`;
                    console.error('GitHub API Error:', errorMessage, errorData);
                    const specificError = (errorMessage.toLowerCase().includes('bad credentials') || errorMessage.toLowerCase().includes('requires authentication') || response.status === 401 || response.status === 403)
                        ? '你的 GitHub Token 可能无效或权限不足。请检查：[Token生成页面](https://github.com/settings/tokens)'
                        : '';
                    if (response.status === 404 && errorData.documentation_url.includes('create-or-update-file-contents')) {
                        throw new Error(`${errorMessage} (路径：${endpoint})。可能是由于 GitHub API 无法在不存在的父目录下创建文件。`);
                    }
                    throw new Error(`${errorMessage} ${specificError}`);
                }
                if (response.status === 204 || response.headers.get("Content-Length") === "0") return null;
                return response.json();
            },
            async getUser(token) { return this.request(token, '/user'); },
            async getDirectoryContents(token, owner, repo, path) {
                try {
                    const contents = await this.request(token, `/repos/${owner}/${repo}/contents/${path}`);
                    if (!Array.isArray(contents)) {
                        console.warn(`Path ${path} is not a directory or empty. Response:`, contents);
                        return [];
                    }
                    return contents;
                } catch (error) {
                    if (error.message && error.message.toLowerCase().includes('not found')) {
                         console.info(`Directory not found: ${path}. This is expected if the directory does not exist.`);
                         return [];
                    }
                    console.error(`Error fetching directory contents for ${path}:`, error);
                    throw error;
                }
            },
            async getFile(token, owner, repo, path) {
                try {
                    const result = await this.request(token, `/repos/${owner}/${repo}/contents/${path}`);
                    if (!result || typeof result.content === 'undefined' || result.encoding !== 'base64') { 
                        console.warn(`File data for ${path} is invalid or file not found. Response details:`, result);
                        return null; 
                    }
                    const content = result.content ? b64_to_utf8(result.content) : ''; 
                    return { content: content, sha: result.sha };
                } catch (error) {
                    if (error.message.toLowerCase().includes('not found') || String(error).toLowerCase().includes('no content')) {
                        console.info(`File not found: ${path}. This is expected during initial setup.`);
                        return null;
                    }
                    console.error(`Error fetching file ${path}:`, error);
                    throw error;
                }
            },
            async createFile(token, owner, repo, path, content, message, isBinary = false, onProgress = null) { 
                const body = JSON.stringify({ message, content: isBinary ? content : utf8_to_b64(content) });
                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('PUT', `${this.BASE_URL}/repos/${owner}/${repo}/contents/${path}`, true);
                    xhr.setRequestHeader('Authorization', `token ${token}`);
                    xhr.setRequestHeader('Accept', 'application/vnd.github.v3+json');
                    xhr.setRequestHeader('Content-Type', 'application/json');

                    if (onProgress && xhr.upload) {
                        xhr.upload.onprogress = (event) => {
                            if (event.lengthComputable) {
                                const percentComplete = (event.loaded / event.total) * 100;
                                onProgress(percentComplete);
                            }
                        };
                    }

                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch (e) {
                                resolve(null); // No content for 204 typically
                            }
                        } else {
                            try {
                                const errorData = JSON.parse(xhr.responseText);
                                reject(new Error(errorData.message || `HTTP Error: ${xhr.status} ${xhr.statusText}`));
                            } catch (e) {
                                reject(new Error(`HTTP Error: ${xhr.status} ${xhr.statusText}`));
                            }
                        }
                    };
                    xhr.onerror = () => reject(new Error('Network error or request failed.'));
                    xhr.send(body);
                });
            },
            async updateFile(token, owner, repo, path, content, sha, message, isBinary = false, onProgress = null) {
                if (!sha) {
                    throw new Error("SHA is required to update a file.");
                }
                const body = JSON.stringify({ message, content: isBinary ? content : utf8_to_b64(content), sha });
                 return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('PUT', `${this.BASE_URL}/repos/${owner}/${repo}/contents/${path}`, true);
                    xhr.setRequestHeader('Authorization', `token ${token}`);
                    xhr.setRequestHeader('Accept', 'application/vnd.github.v3+json');
                    xhr.setRequestHeader('Content-Type', 'application/json');

                    if (onProgress && xhr.upload) {
                        xhr.upload.onprogress = (event) => {
                            if (event.lengthComputable) {
                                const percentComplete = (event.loaded / event.total) * 100;
                                onProgress(percentComplete);
                            }
                        };
                    }

                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch (e) {
                                resolve(null); // No content for 204 typically
                            }
                        } else {
                             try {
                                const errorData = JSON.parse(xhr.responseText);
                                reject(new Error(errorData.message || `HTTP Error: ${xhr.status} ${xhr.statusText}`));
                            } catch (e) {
                                reject(new Error(`HTTP Error: ${xhr.status} ${xhr.statusText}`));
                            }
                        }
                    };
                    xhr.onerror = () => reject(new Error('Network error or request failed.'));
                    xhr.send(body);
                });
            },
            async deleteFile(token, owner, repo, path, sha, message) { 
                if (!sha) {
                    throw new Error("SHA is required to delete a file.");
                }
                return this.request(token, `/repos/${owner}/${repo}/contents/${path}`, { method: 'DELETE', body: JSON.stringify({ message, sha }) });
            },
        };

        // ==================== DOM Element Caching ====================
        const loginWrapper = document.getElementById('login-wrapper');
        const adminWrapper = document.getElementById('admin-wrapper');
        const tokenInput = document.getElementById('token-input');
        const rememberTokenCheckbox = document.getElementById('remember-token');
        const startBtn = document.getElementById('start-btn');
        const initialMessageEl = document.getElementById('initial-message');
        const pathDisplayEl = document.getElementById('path-display');


        const adminViews = {
            dashboard: document.getElementById('dashboard-view'),
            posts: document.getElementById('posts-view'),
            editor: document.getElementById('editor-container'),
            mediaLibrary: document.getElementById('media-library-view'),
            settings: document.getElementById('settings-view'),
            gitalkSettings: document.getElementById('gitalk-settings-view'),
        };
        
        const postListBody = document.getElementById('post-list');
        const mediaLibraryGrid = document.getElementById('media-library-grid');
        const uploadProgressBar = document.getElementById('upload-progress-bar');
        const uploadProgressText = document.getElementById('upload-progress-text');
        const uploadProgressContainer = document.getElementById('upload-progress-container');

        let token = null, owner = '', repo = '', publicUrlBase = ''; 
        let posts = [], postsSha = '';
        let config = {}, configSha = '';
        let easyMDE; 

        const viewSiteLink = document.getElementById('view-site-link');
        let selectedPostIds = []; // For bulk delete

        // Unified path parsing function (consistent with index.html)
        const parseGitHubRepoAndBasePath = (githubUsername) => {
            const hostname = window.location.hostname; 
            let pathSegments = window.location.pathname.split('/').filter(p => p); 

            // Remove current HTML file (admin.html or index.html) if it's the last segment
            if (pathSegments.length > 0 && 
                (pathSegments[pathSegments.length - 1].toLowerCase() === 'admin.html' || 
                 pathSegments[pathSegments.length - 1].toLowerCase() === 'index.html')) {
                pathSegments.pop();
            }

            const usernameLow = githubUsername.toLowerCase();
            const hostnameLow = hostname.toLowerCase();

            let finalOwner = githubUsername; // Use original casing for owner
            let finalRepo = '';
            let finalPublicUrlBase = ''; // e.g., '/ceishi' for pkq66882.github.io/ceishi

            // Scenario 1: User/Organization site (e.g., user.github.io) or local environment
            if (hostnameLow === `${usernameLow}.github.io` || /^localhost$|^127\.0\.0\.1$/.test(hostnameLow)) {
                if (pathSegments.length > 0) {
                    // Project site: e.g., pkq66882.github.io/ceishi/ -> repo="ceishi", publicUrlBase="/ceishi"
                    finalRepo = pathSegments[0];
                    finalPublicUrlBase = `/${pathSegments[0]}`;
                } else {
                    // User/Org site root: e.g., pkq66882.github.io/ -> repo="pkq66882.github.io", publicUrlBase=""
                    finalRepo = `${usernameLow}.github.io`; // Repo name is the hostname
                    finalPublicUrlBase = '';
                }
            } 
            // Scenario 2: Custom domain or other .github.io (e.g., another-org.github.io/someproject)
            else if (pathSegments.length > 0) {
                // Assume the first path segment is the repository name for a project-like setup
                finalRepo = pathSegments[0];
                finalPublicUrlBase = `/${pathSegments[0]}`;
            } else {
                // Custom domain pointing to user/org repo root without path segment
                finalRepo = `${usernameLow}.github.io`; 
                finalPublicUrlBase = '';
            }

            // Safety net: if repo is still empty (shouldn't happen with the above logic, but for robustness)
            if (!finalRepo || finalRepo.trim() === '') {
                finalRepo = `${usernameLow}.github.io`;
                finalPublicUrlBase = '';
            }

            console.log(`[parseGitHubRepoAndBasePath Final] Owner: ${finalOwner}, Repo: "${finalRepo}", PublicUrlBase: "${finalPublicUrlBase}"`);
            return { owner: finalOwner, repo: finalRepo, publicUrlBase: finalPublicUrlBase };
        };


        // Function to create/update directories with .gitkeep
        async function createGitHubDirectory(apiToken, apiOwner, apiRepo, directoryPath) {
            const gitkeepPath = `${directoryPath}/.gitkeep`; 
            console.log(`Checking/Creating directory: ${apiOwner}/${apiRepo}/${gitkeepPath}`);
            try {
                let fileData = null;
                try {
                    fileData = await GitHubAPI.getFile(apiToken, apiOwner, apiRepo, gitkeepPath);
                } catch (fetchError) {
                    console.warn(`Error fetching .gitkeep initially, assuming not found or transient error: ${fetchError.message}`);
                    fileData = null;
                }
                
                if (fileData === null) { 
                    console.log(`Attempting to create new .gitkeep for directory ${directoryPath}`);
                    await GitHubAPI.createFile(apiToken, apiOwner, apiRepo, gitkeepPath, '', `feat: create directory ${directoryPath}`);
                    console.log(`Directory ${directoryPath} created successfully.`);
                } else { 
                    console.log(`Attempting to update existing .gitkeep for directory ${directoryPath}`);
                    await GitHubAPI.updateFile(apiToken, apiOwner, apiRepo, gitkeepPath, '', fileData.sha, `ci: update .gitkeep content for directory ${directoryPath}`);
                    console.log(`Directory ${directoryPath} updated successfully.`);
                }
                return true;
            } catch (error) {
                console.error(`Failed to create/update directory ${directoryPath}:`, error);
                
                // If it's a SHA-related 422 error, retry by getting latest SHA and updating
                if (String(error.message).includes('sha wasn\'t supplied') || (String(error.message).includes('Invalid request') && String(error.message).includes('422'))) {
                    console.warn(`GitHub API reported 'sha wasn\'t supplied' or 'Invalid request' for .gitkeep. Attempting to recover by re-fetching and updating.`);
                    try {
                        const latestFileData = await GitHubAPI.getFile(apiToken, apiOwner, apiRepo, gitkeepPath);
                        if (latestFileData) {
                            await GitHubAPI.updateFile(apiToken, apiOwner, apiRepo, gitkeepPath, '', latestFileData.sha, `ci: retry update .gitkeep after previous failure`);
                            console.log(`Directory ${directoryPath} recovered by update with new sha.`);
                            return true;
                        } else {
                            throw new Error(`Failed to recover .gitkeep: still no file data after direct retry.`);
                        }
                    } catch (recoveryError) {
                        console.error("Failed to recover .gitkeep file after initial error:", recoveryError);
                        throw new Error(`Failed to manage .gitkeep directory at ${directoryPath}: ${error.message} (Recovery attempt also failed: ${recoveryError.message})`);
                    }
                }
                throw error; // Re-throw other errors
            }
        }

        // Unified function to process image URLs for display (always return proxied URL)
        const getProxiedImageUrl = (inputUrl) => {
            if (!inputUrl) return '';

            let urlToProcess = inputUrl;

            // Step 1: If inputUrl is already a gh-proxy URL, decode it to get the original raw GitHub URL.
            if (urlToProcess.startsWith('https://gh-proxy.com/')) {
                try {
                    urlToProcess = decodeURIComponent(urlToProcess.substring('https://gh-proxy.com/'.length));
                } catch (e) {
                    console.warn('Failed to decode existing gh-proxy URL, using as is for further processing:', e, urlToProcess);
                }
            }

            // Step 2: If the URL is a standard HTTP(S) link (e.g., raw.githubusercontent.com),
            // we will parse it, explicitly decode path components, then re-encode for the proxy.
            if (urlToProcess.startsWith('https://raw.githubusercontent.com/') || /^https?:\/\//.test(urlToProcess)) {
                try {
                    const urlObj = new URL(urlToProcess);
                    // Explicitly decode the path and search components fully.
                    // This handles cases where GitHub's download_url might return partially encoded URLs
                    // or contain characters like '~' that were not directly percent-encoded by GitHub but need it for the proxy.
                    urlObj.pathname = urlObj.pathname.split('/').map(segment => decodeURIComponent(segment || '')).join('/');
                    urlObj.search = decodeURIComponent(urlObj.search);
                    // Reconstruct the URL. urlObj.toString() will re-encode what's necessary,
                    // but on the now fully-decoded segments, avoiding double-encoding.
                    urlToProcess = urlObj.toString();
                } catch (e) {
                    console.warn("URL parsing/decoding for path normalization failed, using raw URL for encoding:", e, urlToProcess);
                     // Fallback: If URL parsing fails, assume the original URL is the target for encoding.
                }
                // Step 3: Now, apply the proxy with a *single, fresh* encodeURIComponent on the (now fully decoded/normalized) URL.
                return `https://gh-proxy.com/${encodeURIComponent(urlToProcess)}`;
            }

            // For any other URL (e.g., relative paths, data URIs, etc.), return as is.
            return inputUrl; 
        };


        // ==================== UI Helper Functions ====================
        const showAdminView = (viewName) => {
            Object.values(adminViews).forEach(v => v ? v.style.display = 'none' : null); 

            document.querySelectorAll('#admin-sidebar .nav a').forEach(a => {
                 a.classList.remove('active');
            });
            const currentNavLink = document.querySelector(`#admin-sidebar .nav a[data-view="${viewName}"]`);
            if (currentNavLink) {
                 currentNavLink.classList.add('active');
            } else if (viewName === 'editor') {
                const postsNavLink = document.getElementById('nav-posts');
                if (postsNavLink) postsNavLink.classList.add('active');
            }
            
            if (adminViews[viewName]) adminViews[viewName].style.display = 'block';
            
            if (viewName === 'editor' && !easyMDE) {
                initializeEasyMDE();
            }
            if (viewName === 'mediaLibrary') {
                // When navigating to media library, force a fresh render
                if (mediaLibraryGrid) renderMediaLibrary(true); // Pass true to force no cache
            }
            if (viewName === 'dashboard') {
                renderDashboard();
            }

            document.querySelector('.admin-wrapper').classList.remove('sidebar-visible');
        };

        const setButtonsDisabled = (disabled) => document.querySelectorAll('button').forEach(b => b.disabled = disabled);

        const showAlert = (message, type = 'info', id = 'global-alert') => {
            let existingAlert = document.getElementById(id);
            if (!existingAlert) {
                existingAlert = document.createElement('div');
                existingAlert.id = id;
                adminWrapper.querySelector('main').prepend(existingAlert);
            }
            existingAlert.className = `alert alert-${type}`;
            const icon = {
                'info': 'fas fa-info-circle',
                'success': 'fas fa-check-circle',
                'danger': 'fas fa-exclamation-circle',
                'warning': 'fas fa-exclamation-triangle'
            }[type];
            existingAlert.innerHTML = `<i class="${icon}"></i> ${message}`;
            existingAlert.style.display = 'flex';
            existingAlert.style.marginTop = '0';
            setTimeout(() => {
                existingAlert.style.display = 'none';
            }, 5000);
        };

        // ==================== Upload Progress Functions ====================
        const updateProgressBar = (percentage, message = '', elementId = 'upload-progress-container', barId = 'upload-progress-bar', textId = 'upload-progress-text') => {
            const container = document.getElementById(elementId);
            const bar = document.getElementById(barId);
            const text = document.getElementById(textId);

            if (!container || !bar || !text) {
                console.error("Progress bar elements not found.");
                return;
            }

            container.style.display = 'block';
            bar.style.width = `${percentage}%`;
            bar.textContent = `${Math.round(percentage)}%`;
            text.textContent = message || `${Math.round(percentage)}%`;
            if (percentage >= 100) {
                text.textContent = '完成！'; // Show "完成！" on 100%
                setTimeout(() => {
                    container.style.display = 'none';
                    bar.style.width = '0%';
                    bar.textContent = '0%';
                    text.textContent = '0%'; // Reset text
                }, 1000); // Hide after a short delay
            }
        };


        // ==================== Login / Initialization ====================
        const checkTokenAndStart = async () => {
             const storedToken = localStorage.getItem('github_token');
             if (storedToken) {
                 tokenInput.value = storedToken;
                 rememberTokenCheckbox.checked = true;
                startAdmin();
             }
        };

        const startAdmin = async () => {
            const userToken = tokenInput.value.trim();
            if (!userToken) { initialMessageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Token 不能为空。'; return; }
            token = userToken;
            setButtonsDisabled(true);
            initialMessageEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在验证并加载...';
            initialMessageEl.style.color = 'var(--text-color)';

            try {
                const githubUser = await GitHubAPI.getUser(token);
                initialMessageEl.innerHTML = `<i class="fas fa-spinner fa-spin"></i> 已验证GitHub用户: ${githubUser.login}, 正在解析仓库路径...`;

                const { owner: resolvedOwner, repo: resolvedRepo, publicUrlBase: resolvedPublicUrlBase } = parseGitHubRepoAndBasePath(githubUser.login);
                owner = resolvedOwner; 
                repo = resolvedRepo;   
                publicUrlBase = resolvedPublicUrlBase; 
                
                console.log(`[admin.html] Detected Owner: ${owner}, Repo: ${repo}, PublicUrlBase: "${publicUrlBase}"`);
                pathDisplayEl.textContent = `检测到仓库: Owner: ${owner}, Repo: ${repo}, Public URL Base: "${publicUrlBase || '/'}"`;
                pathDisplayEl.style.display = 'block';

                if (viewSiteLink) {
                    viewSiteLink.href = `${window.location.origin}${publicUrlBase}/index.html`;
                }

                initialMessageEl.innerHTML = `<i class="fas fa-spinner fa-spin"></i> 正在检查并创建所需文件目录...`;
                try {
                    // Create 'images' directory directly at the root of the identified repository
                    await createGitHubDirectory(token, owner, repo, 'images'); 

                } catch (e) {
                    initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 无法创建必要的目录。错误: ${e.message}<br>请检查您的 GitHub Token 权限是否包含 ` + `repo` + ` 权限。 (公共URL基础路径: ${publicUrlBase || '/'})`;
                    throw e;
                }

                let existingConfigData = null;
                let existingPostsData = null;
                initialMessageEl.innerHTML = `<i class="fas fa-spinner fa-spin"></i> 正在获取核心配置文件...`;

                try {
                    existingConfigData = await GitHubAPI.getFile(token, owner, repo, 'config.json');
                } catch (e) {
                    initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 获取 config.json 失败: ${e.message}`;
                    throw e;
                }
                
                try {
                    existingPostsData = await GitHubAPI.getFile(token, owner, repo, 'posts.json');
                } catch (e) {
                    initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 获取 posts.json 失败: ${e.message}`;
                    throw e;
                }

                const hasExistingConfig = !!existingConfigData && existingConfigData.content !== null; // Check for null content if file exists but is empty
                const hasExistingPosts = !!existingPostsData && existingPostsData.content !== null;


                const initialConfig = {
                    site: {
                        title: `${owner}的博客`,
                        description: "由GitHub驱动的现代化半静态博客",
                        aboutContent: `# 关于我\n\n你好！我是 ${owner}，一个热爱技术和分享的开发者。欢迎来到我的博客！\n\n在这里，我将分享我的技术心得、学习笔记以及一些生活感悟。希望我的内容能对你有所启发或帮助。\n\n**联系我:**\n\n*   GitHub: [${owner}](https://github.com/${owner})\n*   Email: your_email@example.com\n\n---`,
                    },
                    styling: {
                        backgroundColor: "#f8f9fa",
                        textColor: "#212529",
                        accentColor: "#0d6efd",
                        backgroundImageUrl: "" // Will store raw GitHub URL
                    },
                    gitalk: {
                        enabled: false,
                        clientID: '',
                        clientSecret: '',
                        repo: repo, 
                        owner: owner,
                        admin: [owner],
                        distractionFreeMode: false,
                        labels: ['Gitalk', '评论'],
                        perPage: 10,
                    }
                };
                const uniqueIdSuffix = () => Date.now() + '_' + Math.random().toString(36).substring(2, 8);
                const initialWelcomePost = {
                    id: `welcome_post_${uniqueIdSuffix()}`, 
                    title: "欢迎来到我的博客！",
                    content: "# 欢迎！\n\n这是您的第一篇文章，由期望ai自动生成。\n\n使用后台管理系统，您可以轻松发布、编辑和删除文章。文章支持 **Markdown** 格式。\n\n在 [博客管理后台](/admin.html) 中，您可以：\n\n*   撰写新的文章\n*   管理网站配置 (标题、描述、颜色、背景图)\n*   配置 Gitalk 评论系统\n\n快去发布你的第一篇文章吧！\n\n<!--more-->\n\n### Markdown 示例\n\n```javascript\nconsole.log('Hello, world!');\n```\n\n> 引用块。\n\n*   列表项1\n*   列表项2\n\n--- \n\n<p style=\"text-align: center;\">祝你创作愉快！</p>",
                    category: "公告",
                    tags: ["欢迎", "教程"],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                let currentConfig = initialConfig;
                if (hasExistingConfig) {
                    try {
                        let parsedConfig = JSON.parse(existingConfigData.content);
                        currentConfig = {
                            ...initialConfig,
                            ...parsedConfig,
                            site: {...initialConfig.site, ...(parsedConfig.site || {})},
                            styling: {...initialConfig.styling, ...(parsedConfig.styling || {})},
                            gitalk: {...initialConfig.gitalk, ...(parsedConfig.gitalk || {})},
                        };

                        currentConfig.gitalk.repo = currentConfig.gitalk.repo || repo; 
                        currentConfig.gitalk.owner = currentConfig.gitalk.owner || owner;
                        // Ensure owner is always in admin array
                        if (!Array.isArray(currentConfig.gitalk.admin)) {
                            currentConfig.gitalk.admin = [owner];
                        } else if (!currentConfig.gitalk.admin.includes(owner)) {
                            currentConfig.gitalk.admin.push(owner);
                            currentConfig.gitalk.admin = [...new Set(currentConfig.gitalk.admin)]; // Remove duplicates
                        }
                        
                        // Ensure backgroundImageUrl is a valid URL, otherwise clear it to prevent SyntaxError
                        if (currentConfig.styling.backgroundImageUrl && !/^https?:\/\//i.test(currentConfig.styling.backgroundImageUrl)) {
                            console.warn("Invalid backgroundImageUrl found in config.json, clearing it during initialization.");
                            currentConfig.styling.backgroundImageUrl = "";
                        }

                        const commitMessage = 'conf: update config with default/existing values';
                        const updateRes = await GitHubAPI.updateFile(token, owner, repo, 'config.json', JSON.stringify(currentConfig, null, 2), existingConfigData.sha, commitMessage);
                        configSha = updateRes.content.sha;

                    } catch (e) {
                        console.warn(`Invalid config.json content, attempting to use default config and update. Error: ${e}`);
                        showAlert('config.json ' + (existingConfigData.content ? '内容无效' : '文件不存在或为空') + '，已使用默认配置覆盖，请点击“保存设置”以写入。', 'warning');
                         try {
                            const commitMessage = 'conf: attempting to normalize/update config content';
                            const updateRes = await GitHubAPI.updateFile(token, owner, repo, 'config.json', JSON.stringify(currentConfig, null, 2), existingConfigData.sha, commitMessage);
                            configSha = updateRes.content.sha;
                        } catch (re) {
                           console.error(`Error during recovery update of config.json: ${re.message}`);
                           initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 无法更新 config.json: ${re.message}`;
                           throw re;
                        }
                    }
                } else {
                    try {
                        const commitMessage = 'feat: initialize config';
                        const createRes = await GitHubAPI.createFile(token, owner, repo, 'config.json', JSON.stringify(initialConfig, null, 2), commitMessage);
                        configSha = createRes.content.sha;
                        currentConfig = initialConfig;
                    } catches (e) {
                        console.error(`Error creating config.json: ${e.message}`);
                        initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 创建 config.json 失败: ${e.message}`;
                        throw e;
                    }
                }
                config = currentConfig;

                let currentPostsArray = [];
                if (hasExistingPosts) {
                    try {
                        currentPostsArray = JSON.parse(existingPostsData.content);
                        if (currentPostsArray.length === 0 || !currentPostsArray.some(p => p.title === initialWelcomePost.title)) { 
                             currentPostsArray.push(initialWelcomePost);
                             showAlert('posts.json 文件之前为空或缺少欢迎文章，已补充。', 'info');
                        }
                        currentPostsArray.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

                        // Store raw GitHub URLs from content (if any old proxied URLs exist)
                        currentPostsArray = currentPostsArray.map(post => {
                            let newContent = post.content.replace(/!\[(.*?)\]\((https?:\/\/[^\s)]+)\)/g, (match, alt, url) => {
                                let originalUrl = url;
                                if (originalUrl.startsWith('https://gh-proxy.com/')) {
                                    try {
                                        originalUrl = decodeURIComponent(originalUrl.substring('https://gh-proxy.com/'.length));
                                    } catch (e) {
                                        console.warn("Error decoding URL part during post content normalization:", e, originalUrl);
                                    }
                                }
                                return `![${alt}](${originalUrl})`; // Store the raw URL in post content
                            });
                            return { ...post, content: newContent };
                        });

                        const commitMessage = 'docs: update posts with initial/existing entries';
                        const updateRes = await GitHubAPI.updateFile(token, owner, repo, 'posts.json', JSON.stringify(currentPostsArray, null, 2), existingPostsData.sha, commitMessage);
                        postsSha = updateRes.content.sha;

                    } catch (e) {
                        console.warn(`Invalid posts.json content, attempting to use default post and update. Error: ${e}`);
                        showAlert('posts.json ' + (existingPostsData.content ? '内容无效' : '文件不存在或为空') + '，已添加默认文章，请点击“更新文章”以写入。', 'warning');
                        currentPostsArray = [initialWelcomePost]; // Fallback to just the welcome post
                        try {
                            const commitMessage = 'docs: attempting to normalize/update posts content';
                            const updateRes = await GitHubAPI.updateFile(token, owner, repo, 'posts.json', JSON.stringify(currentPostsArray, null, 2), existingPostsData.sha, commitMessage);
                            postsSha = updateRes.content.sha;
                        } catch (re) {
                           console.error(`Error during recovery update of posts.json: ${re.message}`);
                           initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 无法更新 posts.json: ${re.message}`;
                           throw re;
                        }
                    }
                } else {
                    try {
                        const commitMessage = 'feat: initialize first post';
                        const createRes = await GitHubAPI.createFile(token, owner, repo, 'posts.json', JSON.stringify([initialWelcomePost], null, 2), commitMessage);
                        postsSha = createRes.content.sha;
                        currentPostsArray = [initialWelcomePost];
                    } catch (e) {
                        console.error(`Error creating posts.json: ${e.message}`);
                        initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 创建 posts.json 失败: ${e.message}`;
                        throw e;
                    }
                }
                posts = currentPostsArray;

                loginWrapper.style.display = 'none';
                adminWrapper.style.display = 'flex';
                showAdminView('dashboard');
                populateSettings();
                populateGitalkSettings();
                updateUniqueTags();
                renderPostList(); 

                if (rememberTokenCheckbox.checked) {
                    localStorage.setItem('github_token', token);
                } else {
                    localStorage.removeItem('github_token');
                }

                initialMessageEl.innerHTML = ``;
                showAlert('博客后台管理系统已成功加载！', 'success');

            } catch (error) {
                console.error("Critical initialization failure:", error);
                if (!initialMessageEl.innerHTML.includes('Token') && !initialMessageEl.innerHTML.includes('权限')) {
                    initialMessageEl.innerHTML = `<i class="fas fa-times-circle"></i> 登录失败或系统初始化失败: ${error.message}<br>通用建议：请仔细检查您的Token权限、GitHub Pages配置和网络连接。`;
                } else if (initialMessageEl.innerHTML.includes('无法创建目录')) {
                    initialMessageEl.innerHTML += `<br>请注意：Token可能已失效或权限不足，导致无法创建目录。`;
                }
                initialMessageEl.style.color = 'var(--danger-color)';
                token = null;
                localStorage.removeItem('github_token');
            } finally {
                setButtonsDisabled(false);
            }
        };

        // ==================== Dashboard Functions ====================
        const renderDashboard = () => {
             if (!posts || posts.length === 0) {
                 document.getElementById('total-posts').textContent = '0';
                 document.getElementById('total-categories').textContent = '0';
                 document.getElementById('total-tags').textContent = '0';
                 document.getElementById('activity-list').innerHTML = `
                    <div class="activity-item">
                        <i class="fas fa-info-circle"></i>
                        <div class="content">
                            <p>数据加载中或暂无文章。</p>
                            <span class="time"></span>
                        </div>
                    </div>
                `;
                return;
            }

            document.getElementById('total-posts').textContent = posts.length.toString();
            
            const categories = new Set(posts.map(p => p.category).filter(Boolean));
            document.getElementById('total-categories').textContent = categories.size.toString();

            const tags = new Set();
            posts.forEach(p => p.tags && p.tags.forEach(tag => tags.add(tag)));
            document.getElementById('total-tags').textContent = tags.size.toString();

            const activityListEl = document.getElementById('activity-list');
            activityListEl.innerHTML = '';
            
            const sortedPostsByUpdate = [...posts].sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            if (sortedPostsByUpdate.length > 0) {
                const latestUpdatedPost = sortedPostsByUpdate[0];
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                activityItem.innerHTML = `
                    <i class="fas fa-pen-nib"></i>
                    <div class="content">
                        <p>最近更新文章: <a href="#" class="edit" data-id="${latestUpdatedPost.id}">${latestUpdatedPost.title}</a></p>
                        <span class="time">${timeAgo(new Date(latestUpdatedPost.updatedAt))}</span>
                    </div>
                `;
                activityListEl.appendChild(activityItem);
            }

            const sortedPostsByCreate = [...posts].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            if (sortedPostsByCreate.length > 0 && 
                (sortedPostsByUpdate.length === 0 || sortedPostsByCreate[0].id !== sortedPostsByUpdate[0].id)) {
                const latestCreatedPost = sortedPostsByCreate[0];
                const createdActivity = document.createElement('div');
                createdActivity.className = 'activity-item';
                createdActivity.innerHTML = `
                     <i class="fas fa-plus"></i>
                    <div class="content">
                        <p>最近发布文章: <a href="#" class="edit" data-id="${latestCreatedPost.id}">${latestCreatedPost.title}</a></p>
                        <span class="time">${timeAgo(new Date(latestCreatedPost.createdAt))}</span>
                    </div>
                `;
                activityListEl.appendChild(createdActivity);
            }
            
            if (activityListEl.children.length === 0) {
                 activityListEl.innerHTML = `
                    <div class="activity-item">
                        <i class="fas fa-info-circle"></i>
                        <div class="content">
                            <p>暂无活动。发布您的第一篇文章吧！</p>
                            <span class="time"></span>
                        </div>
                    </div>
                `;
            }

            activityListEl.querySelectorAll('.edit').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    openEditor(e.target.dataset.id);
                });
            });
        };

        const timeAgo = (date) => {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " 年前";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " 月前";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " 天前";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " 小时前";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " 分钟前";
            if (seconds < 10) return "刚刚";
            return Math.floor(seconds) + " 秒前";
        };


        // ==================== Post Management Functions ====================
        const renderPostList = () => {
            postListBody.innerHTML = '';
            document.getElementById('select-all-posts').checked = false;
            selectedPostIds = [];
            toggleBulkDeleteButton();

            if (!posts || posts.length === 0) {
                postListBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">暂无文章。点击“撰写新文章”开始创作吧！</td></tr>`;
                return;
            }

            // sort posts by creation date descending
            [...posts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(post => {
                const tr = document.createElement('tr');
                tr.dataset.postId = post.id;
                tr.innerHTML = `
                    <td><input type="checkbox" class="post-checkbox" data-id="${post.id}"></td>
                    <td>${post.title}</td>
                    <td>${post.category || '未分类'}</td>
                    <td>${post.tags && post.tags.length > 0 ? post.tags.slice(0, 3).join(', ') + (post.tags.length > 3 ? '...' : '') : '无标签'}</td>
                    <td>${new Date(post.createdAt).toLocaleDateString()}</td>
                    <td>${new Date(post.updatedAt).toLocaleDateString()}</td>
                    <td class="actions">
                        <a href="#" class="edit" data-id="${post.id}" title="编辑"><i class="fas fa-edit"></i></a>
                        <a href="${window.location.origin}${publicUrlBase}/index.html#/post/${post.id}" target="_blank" class="link" title="预览"><i class="fas fa-external-link-alt"></i></a>
                        <a href="#" class="delete" data-id="${post.id}" title="删除"><i class="fas fa-trash-alt"></i></a>
                    </td>
                `;
                postListBody.appendChild(tr);
            });
        };

        const toggleBulkDeleteButton = () => {
             const deleteBtn = document.getElementById('delete-selected-posts-btn');
             deleteBtn.style.display = selectedPostIds.length > 0 ? 'inline-flex' : 'none';
        };

        document.getElementById('select-all-posts').addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            document.querySelectorAll('.post-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
                const postId = checkbox.dataset.id;
                if (isChecked && !selectedPostIds.includes(postId)) {
                    selectedPostIds.push(postId);
                } else if (!isChecked && selectedPostIds.includes(postId)) {
                    selectedPostIds = selectedPostIds.filter(id => id !== postId);
                }
            });
            toggleBulkDeleteButton();
        });

        // Event listener for individual post checkboxes (delegated to parent tbody)
        postListBody.addEventListener('change', (e) => {
            if (e.target.classList.contains('post-checkbox')) {
                const postId = e.target.dataset.id;
                if (e.target.checked) {
                    if (!selectedPostIds.includes(postId)) {
                        selectedPostIds.push(postId);
                    }
                } else {
                    selectedPostIds = selectedPostIds.filter(id => id !== postId);
                    document.getElementById('select-all-posts').checked = false; // Uncheck select all if any is unchecked
                }
                toggleBulkDeleteButton();
            }
        });

        const bulkDeletePosts = async () => {
            if (selectedPostIds.length === 0) {
                showAlert('请选择要删除的文章。', 'warning');
                return;
            }
            if (!confirm(`确定要删除选中的 ${selectedPostIds.length} 篇文章吗？此操作不可逆！`)) {
                return;
            }

            setButtonsDisabled(true);
            const postsToDelete = posts.filter(p => selectedPostIds.includes(p.id));
            const deletedTitles = postsToDelete.map(p => `"${p.title}"`).join(', ');

            posts = posts.filter(p => !selectedPostIds.includes(p.id));
            
            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, 'posts.json', JSON.stringify(posts, null, 2), postsSha, `docs: bulk delete posts (${selectedPostIds.length}): ${deletedTitles.substring(0, 100)}...`);
                postsSha = res.content.sha;
                showAlert(`${selectedPostIds.length} 篇文章删除成功！`, 'success');
                updateUniqueTags();
                renderPostList();
                renderDashboard();
                selectedPostIds = []; 
                document.getElementById('select-all-posts').checked = false;
                toggleBulkDeleteButton();
            } catch (error) {
                showAlert(`批量删除文章失败: ${error.message}`, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };


        const openEditor = (postId = null) => {
            showAdminView('editor');
            const post = posts.find(p => p.id === postId);
            document.getElementById('editor-title').innerHTML = `<i class="fas fa-edit"></i> ${post ? '编辑文章' : '撰写新文章'}`;
            document.getElementById('save-post-btn').innerHTML = `<i class="fas fa-upload"></i> ${post ? '更新文章' : '发布文章'}`;
            document.getElementById('post-id').value = post?.id || '';
            document.getElementById('post-title').value = post?.title || '';
            document.getElementById('post-category').value = post?.category || '';
            const tagTokenContainer = document.getElementById('tag-token-container');
            tagTokenContainer.querySelectorAll('.tag-token').forEach(tagEl => tagEl.remove());
            const tagsInput = document.getElementById('post-tags-input');
            if (post && post.tags && Array.isArray(post.tags)) {
                post.tags.forEach(tag => addTagToInput(tag, tagsInput));
            }
            tagsInput.value = '';
            document.getElementById('post-tags').value = JSON.stringify(post?.tags || []);

            if (easyMDE) {
                easyMDE.value(post?.content || '');
            } else {
                document.getElementById('post-content').value = post?.content || '';
                initializeEasyMDE();
            }
            
            document.getElementById('delete-post-btn').style.display = post ? 'inline-flex' : 'none';
        };

        const savePost = async () => {
            const id = document.getElementById('post-id').value;
            const title = document.getElementById('post-title').value.trim();
            const category = document.getElementById('post-category').value.trim() || '未分类';
            const content = easyMDE.value().trim(); // Markdown content should contain raw image URLs
            if (!title || !content) { showAlert('标题和内容不能为空！', 'danger'); return; }
            
            setButtonsDisabled(true);
            const tags = JSON.parse(document.getElementById('post-tags').value || '[]');

            const postIndex = posts.findIndex(p => p.id === id);
            const now = new Date().toISOString();

            if (postIndex > -1) {
                Object.assign(posts[postIndex], { title, category, content, tags, updatedAt: now });
            } else {
                posts.push({ id: `post_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`, title, category, content, tags, createdAt: now, updatedAt: now });
            }
            posts.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, 'posts.json', JSON.stringify(posts, null, 2), postsSha, `docs: ${id ? 'update' : 'create'} post "${title}"`);
                postsSha = res.content.sha;
                showAlert('文章保存成功！', 'success');
                updateUniqueTags();
                renderPostList();
                renderDashboard();
                showAdminView('posts');
            } catch (error) {
                showAlert(`文章保存失败: ${error.message}`, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };

        const deletePost = async (postId) => {
            if (!postId || !confirm('确定要删除这篇文章吗？操作不可逆！')) return;
            setButtonsDisabled(true);
            const postToDelete = posts.find(p => p.id === postId);
            if (!postToDelete) {
                 showAlert('文章未找到！', 'danger');
                 setButtonsDisabled(false);
                 return;
            }
            posts = posts.filter(p => p.id !== postId);
            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, 'posts.json', JSON.stringify(posts, null, 2), postsSha, `docs: delete post "${postToDelete.title}"`);
                postsSha = res.content.sha;
                showAlert('文章删除成功！', 'success');
                updateUniqueTags();
                renderPostList();
                renderDashboard();
                showAdminView('posts');
            } catch (error) {
                showAlert(`文章删除失败: ${error.message}`, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };
        
        // This object will track whether fetch requests for media need to bypass browser cache
        const fetchCacheBuster = {};

        // ==================== Media Library Functions ====================
        const renderMediaLibrary = async (forceNoCache = false) => {
            mediaLibraryGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;"><i class="fas fa-spinner fa-spin"></i> 加载图像中...</p>';
            setButtonsDisabled(true);
            try {
                // If forceNoCache is true (e.g., after upload/delete), add a cache-busting parameter to the directory fetch
                const cacheParam = forceNoCache ? `?t=${Date.now()}` : '';
                const imageContents = await GitHubAPI.getDirectoryContents(token, owner, repo, `images${cacheParam}`);
                
                mediaLibraryGrid.innerHTML = '';
                let imagesFound = false;

                // Sort images alphabetically for consistent display
                imageContents.sort((a, b) => a.name.localeCompare(b.name));

                for (const item of imageContents) {
                    if (item.type === 'file' && item.name !== '.gitkeep') {
                        imagesFound = true;
                        const mediaItem = document.createElement('div');
                        mediaItem.className = 'media-item';

                        // Add cache-busting query parameter to actual image URL if forceNoCache
                        const imageUrlToDisplay = getProxiedImageUrl(item.download_url);
                        // However, for GitHub Raw directly using item.download_url as is, the proxy will handle cache.
                        // For display, `getProxiedImageUrl` handles the proxying. No need for extra ?t= on src.
                        
                        mediaItem.innerHTML = `
                            <div class="media-item-thumbnail">
                                <img src="${imageUrlToDisplay}" alt="${item.name}" loading="lazy" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ctext x=\'50%25\' y=\'50%25\' font-size=\'30\' text-anchor=\'middle\' dominant-baseline=\'central\'%3E🖼️Error%3C/text%3E%3C/svg%3E';" />
                            </div>
                            <div class="media-item-info">
                                <div class="name" title="${item.name}">${item.name}</div>
                                <div class="media-item-actions">
                                    <button class="btn btn-secondary btn-sm copy-url" data-raw-url="${item.download_url}"><i class="fas fa-link"></i> URL</button>
                                    <button class="btn btn-secondary btn-sm copy-markdown" data-filename="${item.name}" data-raw-url="${item.download_url}"><i class="fas fa-code"></i> MD</button>
                                    <button class="btn btn-danger btn-sm delete-media" data-path="${item.path}" data-sha="${item.sha}"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                        `;
                        mediaLibraryGrid.appendChild(mediaItem);
                    }
                }
                if (!imagesFound) {
                    mediaLibraryGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">媒体库为空。点击“上传新图片”或拖拽图片到上方区域。</p>';
                }

                 mediaLibraryGrid.querySelectorAll('.copy-url').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const rawUrl = e.currentTarget.dataset.rawUrl;
                        // Use the unified function to get the proxied URL for copying
                        navigator.clipboard.writeText(getProxiedImageUrl(rawUrl)).then(() => {
                            showAlert('图片 URL 已复制！', 'success');
                        }).catch(err => {
                            console.error('Failed to copy URL:', err);
                            showAlert('复制 URL 失败！', 'danger');
                        });
                    });
                });
                mediaLibraryGrid.querySelectorAll('.copy-markdown').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const filename = e.currentTarget.dataset.filename;
                        const rawUrl = e.currentTarget.dataset.rawUrl;
                        // Use the unified function to get the proxied URL for markdown
                        const proxiedUrl = getProxiedImageUrl(rawUrl);
                        const markdown = `![${filename.split('.')[0]}](${proxiedUrl})`;
                        navigator.clipboard.writeText(markdown).then(() => {
                            showAlert('图片 Markdown 链接已复制！', 'success');
                        }).catch(err => {
                            console.error('Failed to copy Markdown:', err);
                            showAlert('复制 Markdown 失败！', 'danger');
                        });
                    });
                });
                mediaLibraryGrid.querySelectorAll('.delete-media').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const pathToDelete = e.currentTarget.dataset.path;
                        const sha = e.currentTarget.dataset.sha;
                        if (confirm(`确定要删除图片 ${pathToDelete.split('/').pop()} 吗？`)) {
                            deleteMediaFile(pathToDelete, sha);
                        }
                    });
                });

            } catch (error) {
                console.error("Error rendering media library:", error);
                mediaLibraryGrid.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--danger-color);">加载媒体库失败: ${error.message}</p>`;
                showAlert(`加载媒体库失败: ${error.message}`, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };

        const deleteMediaFile = async (filePath, fileSha) => {
            setButtonsDisabled(true);
            try {
                await GitHubAPI.deleteFile(token, owner, repo, filePath, fileSha, `feat: delete media file ${filePath.split('/').pop()}`);
                showAlert('图片删除成功！', 'success');
                // Force a fresh render without cache after deletion
                // Adding a small delay to work around potential GitHub CDN propagation issues
                setTimeout(() => renderMediaLibrary(true), 1500); 
            } catch (error) {
                showAlert(`图片删除失败: ${error.message}`, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };

        const handleMediaFileUpload = async (files) => {
            if (!files || files.length === 0) return;
            setButtonsDisabled(true);
            
            uploadProgressContainer.style.display = 'block';
            updateProgressBar(0, '准备上传...');

            try {
                const uploadPromises = Array.from(files).map(file => {
                    return new Promise(async (resolve, reject) => {
                        try {
                            const rawImageUrl = await uploadFile(
                                file,
                                'images', // Target folder relative to repo root
                                `feat: upload image "${file.name}"`,
                                (progress) => {
                                    updateProgressBar(progress, `上传 ${file.name}: ${Math.round(progress)}%`);
                                }
                            );
                            resolve(rawImageUrl); // Return raw.githubusercontent.com URL
                        } catch (error) {
                            reject({ file: file.name, error: error });
                        }
                    });
                });

                const results = await Promise.allSettled(uploadPromises); 
                
                let successCount = 0;
                let failureCount = 0;
                results.forEach(result => {
                    if (result.status === 'fulfilled') {
                        successCount++;
                    } else {
                        failureCount++;
                        console.error(`Failed to upload image "${result.reason.file}":`, result.reason.error);
                    }
                });

                updateProgressBar(100, '上传完成！'); // Finalization
                if (successCount > 0) {
                    showAlert(`${successCount} 张图片上传成功！`, 'success');
                }
                if (failureCount > 0) {
                    showAlert(`${failureCount} 张图片上传失败，请查看控制台获取详情。`, 'danger');
                }
                if (successCount === 0 && failureCount === 0) {
                     showAlert('没有图片被上传。', 'info');
                }
                // Force a fresh render without cache after upload
                // Adding a small delay to work around potential GitHub CDN propagation issues
                setTimeout(() => renderMediaLibrary(true), 1500); 

            } catch (error) {
                 showAlert(`图片上传过程中发生未知错误: ${error.message}`, 'danger');
                 // Ensure progress bar hides on critical error too
                 uploadProgressContainer.style.display = 'none';
            } finally {
                setButtonsDisabled(false);
            }
        };


        // ==================== Website Settings Functions ====================
        const populateSettings = () => {
            document.getElementById('setting-title').value = config.site.title || '';
            document.getElementById('setting-description').value = config.site.description || '';
            document.getElementById('setting-about-content').value = config.site.aboutContent || '';
            document.getElementById('setting-bg-color').value = config.styling.backgroundColor || '#f8f9fa';
            document.getElementById('setting-text-color').value = config.styling.textColor || '#212529';
            document.getElementById('setting-accent-color').value = config.styling.accentColor || '#0d6efd';

            const bgImageUrl = config.styling.backgroundImageUrl;
            document.getElementById('setting-bg-image-url').value = bgImageUrl || ''; // Stored as raw URL
            const bgImagePreview = document.getElementById('setting-bg-image-preview');
            const uploadBgImageBtn = document.getElementById('upload-bg-image-btn');
            
            if (bgImageUrl && /^https?:\/\//i.test(bgImageUrl)) { // Only show preview if URL is valid
                bgImagePreview.innerHTML = `<img src="${getProxiedImageUrl(bgImageUrl)}" alt="背景图预览" loading="lazy">`;
                uploadBgImageBtn.style.display = 'none';
            } else {
                bgImagePreview.innerHTML = `<span class="placeholder">无背景图</span>`;
                uploadBgImageBtn.style.display = 'inline-flex';
            }
        };
        
        const saveSettings = async () => {
            setButtonsDisabled(true);
            const newConfig = JSON.parse(JSON.stringify(config));
            newConfig.site = {
                title: document.getElementById('setting-title').value.trim(),
                description: document.getElementById('setting-description').value.trim(),
                aboutContent: document.getElementById('setting-about-content').value.trim(),
            };
            let newBgImageUrl = document.getElementById('setting-bg-image-url').value.trim();
            // Validate background image URL to prevent SyntaxError with invalid URLs
            if (newBgImageUrl && !/^https?:\/\//i.test(newBgImageUrl)) {
                showAlert('背景图 URL 无效，请提供一个以 http:// 或 https:// 开头的完整 URL。已清除无效值。', 'danger');
                newBgImageUrl = ""; // Clear invalid URL
                document.getElementById('setting-bg-image-url').value = ""; // Update UI
                document.getElementById('setting-bg-image-preview').innerHTML = `<span class="placeholder">无背景图</span>`;
                document.getElementById('upload-bg-image-btn').style.display = 'inline-flex'; // Show upload btn if cleared
            }

            newConfig.styling = {
                backgroundColor: document.getElementById('setting-bg-color').value,
                textColor: document.getElementById('setting-text-color').value,
                accentColor: document.getElementById('setting-accent-color').value,
                backgroundImageUrl: newBgImageUrl, // Stores raw URL
            };

            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, 'config.json', JSON.stringify(newConfig, null, 2), configSha, 'conf: update website settings');
                configSha = res.content.sha;
                config = newConfig; // Update local config
                showAlert('网站设置已保存！', 'success');
            } catch (error) {
                showAlert(`网站设置保存失败: ${error.message}`, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };
        
        // ==================== Gitalk Settings Functions ====================
        const populateGitalkSettings = () => {
            const gitalkConfig = config.gitalk || {};
            document.getElementById('gitalk-enabled').checked = !!gitalkConfig.enabled;
            document.getElementById('gitalk-clientID').value = gitalkConfig.clientID || '';
            document.getElementById('gitalk-clientSecret').value = gitalkConfig.clientSecret || '';
            document.getElementById('gitalk-repo').value = gitalkConfig.repo || '';
            document.getElementById('gitalk-owner').value = gitalkConfig.owner || '';
            document.getElementById('gitalk-admin').value = (gitalkConfig.admin && Array.isArray(gitalkConfig.admin) ? gitalkConfig.admin.join(', ') : gitalkConfig.admin || '');
        };

        const saveGitalkSettings = async () => {
            setButtonsDisabled(true);
            const newConfig = JSON.parse(JSON.stringify(config));
            const gitalkAdminRaw = document.getElementById('gitalk-admin').value.trim();
            const gitalkAdminArray = gitalkAdminRaw.split(',').map(name => name.trim()).filter(Boolean);

            newConfig.gitalk = {
                enabled: document.getElementById('gitalk-enabled').checked,
                clientID: document.getElementById('gitalk-clientID').value.trim(),
                clientSecret: document.getElementById('gitalk-clientSecret').value.trim(),
                repo: document.getElementById('gitalk-repo').value.trim(),
                owner: document.getElementById('gitalk-owner').value.trim(),
                admin: gitalkAdminArray,
                distractionFreeMode: newConfig.gitalk.distractionFreeMode, 
                labels: newConfig.gitalk.labels || ['Gitalk', '评论'], 
                perPage: newConfig.gitalk.perPage || 10,
            };

            if (newConfig.gitalk.enabled && (!newConfig.gitalk.clientID || !newConfig.gitalk.clientSecret || !newConfig.gitalk.repo || !newConfig.gitalk.owner)) {
                showAlert('启用 Gitalk 评论时，Client ID, Client Secret, Repo, Owner 都是必填项！', 'danger');
                setButtonsDisabled(false);
                return;
            }

            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, 'config.json', JSON.stringify(newConfig, null, 2), configSha, 'conf: update Gitalk settings');
                configSha = res.content.sha;
                config = newConfig; 
                showAlert('Gitalk 评论设置已保存！', 'success');
            } catch (error) {
                showAlert(`Gitalk 评论设置保存失败: ${error.message}`, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };

        // ==================== File Upload Functions (Generic, for images) ====================
        const uploadFile = async (file, uploadDirectory, message, onProgress = null) => {
            if (!file) throw new Error("No file provided for upload.");
            
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); 
                reader.onload = async (e) => {
                    const contentBase64 = e.target.result.split(',')[1];
                    
                    const timestamp = new Date().toISOString().replace(/[-:.]/g, '');
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    const baseFileNameDirty = file.name.substring(0, file.name.lastIndexOf('.'));
                    
                    // Sanitize filename: remove all characters except alphanumeric, underscore, dash, dot
                    // Also filter out common problematic patterns like ~tplv or _origin
                    const sanitizedBaseFileName = baseFileNameDirty
                        .replace(/(~tplv|origin~|_origin~)+.*$/i, '') // Remove specific problematic patterns and anything after them
                        .replace(/[^\p{L}\p{N}_\-.]/gu, '') // Keep only letters, numbers, underscore, dash, dot (Unicode-aware)
                        .replace(/_+/g, '_') // Replace multiple underscores with single
                        .replace(/^-+|-+$/g, '') // Remove leading/trailing dashes
                        .replace(/^[_\-.]+|[_\-.]+$/g, '') // Remove leading/trailing unwanted chars
                        .slice(0, 100); // Limit length to avoid long paths on GitHub

                    const finalFileName = `${timestamp}_${sanitizedBaseFileName}.${fileExtension}`;
                    const blobPath = `${uploadDirectory}/${finalFileName}`;
                    
                    try {
                        const uploadResult = await GitHubAPI.createFile(token, owner, repo, blobPath, contentBase64, message, true, onProgress);
                        const rawGithubUrl = uploadResult.content.download_url || `https://raw.githubusercontent.com/${owner}/${repo}/main/${blobPath}`; // Fallback if download_url is missing
                        resolve(rawGithubUrl); 
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file); 
            });
        };


        // ==================== EasyMDE Initialization & Image Upload Integration ====================
        const initializeEasyMDE = () => {
            if (easyMDE) return;

            easyMDE = new EasyMDE({
                element: document.getElementById('post-content'),
                spellChecker: false,
                forceSync: true,
                toolbar: [
                    "bold", "italic", "heading", "|",
                    "quote", "unordered-list", "ordered-list", "|",
                    "link", "image", "|",
                    `upload-image`,
                    "table", "horizontal-rule", "|",
                    "preview", "side-by-side", "fullscreen", "|",
                    "guide"
                ],
                customIcons: {
                    "upload-image": "<i class='fas fa-image fa-fw'></i>"
                }
            });

            easyMDE.toolbar.find(item => item.name === 'upload-image').action = async () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        setButtonsDisabled(true); 
                        
                        const uploadAlertId = 'image-upload-alert';
                        showAlert(`正在上传图片 ${file.name}...`, 'info', uploadAlertId);
                        
                        const editorToolbarEl = document.querySelector('.editor-toolbar');
                        let editorProgressBarContainer = editorToolbarEl.querySelector('.progress-container.editor');
                        if (!editorProgressBarContainer) {
                            editorProgressBarContainer = document.createElement('div');
                            editorProgressBarContainer.className = 'progress-container editor';
                            editorProgressBarContainer.innerHTML = `
                                <div class="progress-bar" id="editor-progress-bar"></div>
                                <div class="progress-text" id="editor-progress-text">0%</div>
                            `;
                            editorToolbarEl.parentNode.insertBefore(editorProgressBarContainer, editorToolbarEl.nextSibling);
                        }
                        editorProgressBarContainer.style.display = 'block';
                        const editorProgressBar = editorProgressBarContainer.querySelector('#editor-progress-bar');
                        const editorProgressText = editorProgressBarContainer.querySelector('#editor-progress-text');

                        const updateEditorProgressBarLocal = (percentage, msg = '') => {
                            updateProgressBar(percentage, msg, editorProgressBarContainer.id, editorProgressBar.id, editorProgressText.id);
                        };
                        updateEditorProgressBarLocal(0, '初始化上传...');

                        try {
                            const rawImageUrl = await uploadFile(
                                file,
                                'images', 
                                `feat: upload image "${file.name}" for post`,
                                (progress) => updateEditorProgressBarLocal(progress, `上传 ${file.name}: ${Math.round(progress)}%`)
                            );
                            // IMPORTANT: Insert the RAW GitHub URL into markdown content.
                            // The blog's frontend (index.html) will handle proxying for display.
                            const markdownImage = `![${file.name.split('.')[0]}](${rawImageUrl})`; 
                            
                            const cm = easyMDE.codemirror;
                            const pos = cm.getCursor();
                            cm.replaceRange(markdownImage, pos);
                            showAlert(`图片 ${file.name} 上传成功并已插入！`, 'success', uploadAlertId);
                            updateEditorProgressBarLocal(100, '完成！');
                        } catch (error) {
                            showAlert(`图片 ${file.name} 上传失败: ${error.message}`, 'danger', uploadAlertId);
                        } finally {
                            setButtonsDisabled(false);
                            setTimeout(() => {
                                if (editorProgressBarContainer) editorProgressBarContainer.style.display = 'none';
                                editorProgressBar.style.width = '0%';
                                editorProgressBar.textContent = '0%';
                                editorProgressText.textContent = '0%'; 
                            }, 1500); 
                        }
                    }
                };
                input.click();
            };
        };


        // ==================== Tag Input Management ====================
        const allUniqueTags = new Set();
        const updateUniqueTags = () => {
            allUniqueTags.clear();
            posts.forEach(post => {
                if (post.tags && Array.isArray(post.tags)) {
                    post.tags.forEach(tag => allUniqueTags.add(tag));
                }
            });
        };

        const addTagToInput = (tagText, inputElement) => {
            tagText = tagText.trim();
            if (!tagText) return;

            const tagsContainer = document.getElementById('tag-token-container');
            let currentTags = JSON.parse(document.getElementById('post-tags').value || '[]');

            if (!currentTags.includes(tagText)) {
                currentTags.push(tagText);
                document.getElementById('post-tags').value = JSON.stringify(currentTags);

                const tagToken = document.createElement('span');
                tagToken.className = 'tag-token';
                tagToken.innerHTML = `${tagText} <i class="fas fa-times remove-tag"></i>`;
                tagToken.querySelector('.remove-tag').addEventListener('click', () => {
                    removeTagFromInput(tagText, inputElement);
                });
                tagsContainer.insertBefore(tagToken, inputElement);
            }
        };

        const removeTagFromInput = (tagText, inputElement) => {
            let currentTags = JSON.parse(document.getElementById('post-tags').value || '[]');
            currentTags = currentTags.filter(tag => tag !== tagText);
            document.getElementById('post-tags').value = JSON.stringify(currentTags);
            const tagsContainer = document.getElementById('tag-token-container');
            tagsContainer.querySelectorAll('.tag-token').forEach(tagEl => tagEl.remove());
            currentTags.forEach(tag => addTagToInput(tag, inputElement));
        };

        document.addEventListener('DOMContentLoaded', () => {
            const tagsInput = document.getElementById('post-tags-input');
            const tagSuggestionsBox = document.getElementById('tag-suggestions');
            const tagTokenContainer = document.getElementById('tag-token-container');

            if (tagsInput && tagSuggestionsBox && tagTokenContainer) {
                tagsInput.addEventListener('focus', () => {
                    if (posts.length > 0) {
                        showTagSuggestions(tagsInput.value.trim().toLowerCase());
                    }
                });
                tagsInput.addEventListener('blur', (e) => {
                    // Use a timeout to allow click on suggestion box to register before hiding
                    setTimeout(() => {
                        if (!tagSuggestionsBox.contains(document.activeElement)) {
                            tagSuggestionsBox.style.display = 'none';
                        }
                    }, 100);
                });

                tagsInput.addEventListener('input', () => {
                    const inputValue = tagsInput.value.toLowerCase().trim();
                    showTagSuggestions(inputValue);
                });

                tagsInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const inputValue = tagsInput.value.trim();
                        if (inputValue) {
                            addTagToInput(inputValue, tagsInput);
                            tagsInput.value = '';
                            tagSuggestionsBox.style.display = 'none';
                        }
                    } else if (e.key === 'Backspace' && tagsInput.value === '') {
                        const lastTagToken = tagTokenContainer.querySelector('.tag-token:last-of-type');
                        if (lastTagToken) {
                            const tagText = lastTagToken.textContent.split(' ')[0].trim();
                            removeTagFromInput(tagText, tagsInput);
                        }
                    }
                });

                tagTokenContainer.addEventListener('click', (e) => {
                    if (e.target === tagTokenContainer || e.target.classList.contains('tag-token')) {
                        tagsInput.focus();
                    }
                });

                const showTagSuggestions = (query) => {
                    tagSuggestionsBox.innerHTML = '';
                    const filteredSuggestions = Array.from(allUniqueTags).filter(tag =>
                        tag.toLowerCase().includes(query)
                    ).sort();

                    if (filteredSuggestions.length > 0) {
                        filteredSuggestions.forEach(tag => {
                            const div = document.createElement('div');
                            div.textContent = tag;
                            div.addEventListener('mousedown', (e) => { // Use mousedown to trigger before blur
                                e.preventDefault();
                                addTagToInput(tag, tagsInput);
                                tagsInput.value = '';
                                tagSuggestionsBox.style.display = 'none';
                            });
                            tagSuggestionsBox.appendChild(div);
                        });
                        const containerRect = tagTokenContainer.getBoundingClientRect();
                        tagSuggestionsBox.style.top = `${containerRect.height + 5}px`;
                        tagSuggestionsBox.style.left = `0`;
                        tagSuggestionsBox.style.width = `${tagTokenContainer.offsetWidth}px`;

                        tagSuggestionsBox.style.display = 'block';
                    } else {
                        tagSuggestionsBox.style.display = 'none';
                    }
                };
            }
        });


        // ==================== Event Bindings ====================
        document.addEventListener('DOMContentLoaded', () => {
            startBtn.onclick = startAdmin;
            tokenInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') startAdmin(); });
            
            document.getElementById('nav-dashboard').onclick = (e) => { e.preventDefault(); showAdminView('dashboard'); };
            document.getElementById('nav-posts').onclick = (e) => { e.preventDefault(); showAdminView('posts'); };
            document.getElementById('nav-media-library').onclick = (e) => { e.preventDefault(); showAdminView('mediaLibrary'); };
            document.getElementById('nav-settings').onclick = (e) => { e.preventDefault(); showAdminView('settings'); populateSettings(); };
            document.getElementById('nav-gitalk-settings').onclick = (e) => { e.preventDefault(); showAdminView('gitalkSettings'); populateGitalkSettings(); };
            document.getElementById('nav-logout').onclick = (e) => {
                e.preventDefault();
                if (confirm('确定要安全退出吗？')) {
                    localStorage.removeItem('github_token');
                    location.reload();
                }
            };

            document.getElementById('new-post-btn').onclick = () => openEditor();
            document.getElementById('delete-selected-posts-btn').onclick = bulkDeletePosts; 
            document.getElementById('cancel-edit-btn').onclick = () => {
                 showAdminView('posts');
                 showAlert('已取消文章编辑。', 'info');
            };
            document.getElementById('save-post-btn').onclick = savePost;
            document.getElementById('delete-post-btn').onclick = () => deletePost(document.getElementById('post-id').value);
            postListBody.addEventListener('click', (e) => {
                const editButton = e.target.closest('.edit');
                const deleteButton = e.target.closest('.delete');
                if (editButton) { e.preventDefault(); openEditor(editButton.dataset.id); }
                if (deleteButton) { e.preventDefault(); deletePost(deleteButton.dataset.id); }
            });

            document.getElementById('save-settings-btn').onclick = saveSettings;
            
            const settingBgImageInput = document.getElementById('setting-bg-image');
            const settingBgImageUrlInput = document.getElementById('setting-bg-image-url');
            const uploadBgImageBtn = document.getElementById('upload-bg-image-btn');
            const clearBgImageBtn = document.getElementById('clear-bg-image-btn');
            const settingBgImagePreview = document.getElementById('setting-bg-image-preview');

            settingBgImageInput.onchange = (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        settingBgImagePreview.innerHTML = `<img src="${e.target.result}" alt="背景图预览" loading="lazy">`;
                        uploadBgImageBtn.style.display = 'inline-flex'; 
                    };
                    reader.readAsDataURL(file);
                } else {
                    settingBgImagePreview.innerHTML = `<span class="placeholder">无背景图</span>`;
                    uploadBgImageBtn.style.display = 'none'; 
                }
            };
            settingBgImageUrlInput.addEventListener('input', () => {
                const url = settingBgImageUrlInput.value.trim();
                // Client-side preview, validation happens on saveSettings
                if (url && /^https?:\/\//i.test(url)) {
                    settingBgImagePreview.innerHTML = `<img src="${getProxiedImageUrl(url)}" alt="背景图预览" loading="lazy">`;
                    uploadBgImageBtn.style.display = 'none'; 
                } else {
                    settingBgImagePreview.innerHTML = `<span class="placeholder">无背景图</span>`;
                    if (!settingBgImageInput.files || settingBgImageInput.files.length === 0) {
                         uploadBgImageBtn.style.display = 'inline-flex'; 
                    } else {
                        // If a file is selected, the upload button should still be hidden as we wait for explicit upload click
                        uploadBgImageBtn.style.display = 'none'; 
                    }
                }
            });


            uploadBgImageBtn.onclick = async () => {
                const file = settingBgImageInput.files[0];
                if (file) {
                    try {
                        showAlert(`正在上传背景图片 ${file.name}...`, 'info');
                        const rawImageUrl = await uploadFile(file, 'images', `feat: upload background image "${file.name}"`); // Upload to 'images' folder
                        document.getElementById('setting-bg-image-url').value = rawImageUrl; // Stores raw URL
                        settingBgImagePreview.innerHTML = `<img src="${getProxiedImageUrl(rawImageUrl)}" alt="背景图预览" loading="lazy">`; 
                        uploadBgImageBtn.style.display = 'none';
                        showAlert('背景图片上传并设置成功！请点击保存设置！', 'success');
                    } catch (error) {
                        showAlert(`背景图片上传失败: ${error.message}`, 'danger');
                    }
                } else {
                    showAlert('请先选择一个图片文件！', 'warning');
                }
            };
            clearBgImageBtn.onclick = () => {
                document.getElementById('setting-bg-image-url').value = '';
                settingBgImageInput.value = '';
                settingBgImagePreview.innerHTML = `<span class="placeholder">无背景图</span>`;
                uploadBgImageBtn.style.display = 'inline-flex';
                showAlert('背景图已清除！请点击保存设置！', 'info');
            };

            document.getElementById('save-gitalk-settings-btn').onclick = saveGitalkSettings;

            document.getElementById('mobile-menu-btn').onclick = () => document.getElementById('admin-wrapper').classList.toggle('sidebar-visible');
            document.getElementById('mobile-overlay').onclick = () => document.getElementById('admin-wrapper').classList.remove('sidebar-visible');

            const mediaUploadInput = document.getElementById('media-upload-input');
            const mediaUploadDroparea = document.getElementById('media-upload-droparea');

            if (mediaUploadInput) mediaUploadInput.onchange = (e) => handleMediaFileUpload(e.target.files);

            if (mediaUploadDroparea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    mediaUploadDroparea.addEventListener(eventName, preventDefaults, false);
                });
                ['dragenter', 'dragover'].forEach(eventName => {
                    mediaUploadDroparea.addEventListener(eventName, () => mediaUploadDroparea.classList.add('drag-over'), false);
                });
                ['dragleave', 'drop'].forEach(eventName => {
                    mediaUploadDroparea.addEventListener(eventName, () => mediaUploadDroparea.classList.remove('drag-over'), false);
                });

                mediaUploadDroparea.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    handleMediaFileUpload(files);
                }, false);

                function preventDefaults (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            }

            checkTokenAndStart();
        });
    </script>
</body>
</html>
