<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>加载中...</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' font-size='90' text-anchor='middle' dominant-baseline='central'%3E✍️%3C/text%3E%3C/svg%3E" type="image/svg+xml">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/github-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        :root {
            --accent: #3498db;
            --accent-hover: #2980b9;
        }
        *{box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#212529;background:#f8f9fa;margin:0}
        header{background:#fff;padding:20px 0;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
        .container{max-width:900px;margin:0 auto;padding:20px}
        header h1{font-size:2rem;margin:0;color:#2c3e50}
        header p{margin:8px 0 0;color:#7f8c8d}
        nav{margin-top:12px}
        nav a{margin-right:12px;color:var(--accent)}
        .post-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
        .post-card{background:#fff;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.06);overflow:hidden;display:flex;flex-direction:column}
        .post-card-image{height:200px;background:#eef2f5;display:flex;align-items:center;justify-content:center;overflow:hidden}
        .post-card-image img{width:100%;height:100%;object-fit:cover}
        .post-card-content{padding:18px}
        .post-card h2{margin:0 0 8px 0}
        .post-card .excerpt{color:#5d6d7e}
        .post-full{background:#fff;padding:28px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.06)}
        .post-content img{max-width:100%;height:auto;border-radius:8px;margin:16px 0}
        .loading,.error{text-align:center;padding:40px;color:#7f8c8d}
        footer{background:#f0f2f5;padding:24px;text-align:center;color:#7f8c8d;margin-top:28px}
        @media(max-width:768px){ .post-card-image{height:160px} }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1 id="site-title">博客</h1>
            <p id="site-description">一个由 GitHub Pages 驱动的博客</p>
            <nav id="main-nav">
                <a href="javascript:void(0)" class="nav-link active" data-route="home">首页</a>
                <a href="javascript:void(0)" class="nav-link" data-route="about">关于</a>
                <a id="admin-link" target="_blank" class="nav-link">管理后台</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div id="loading" class="loading"><i class="fas fa-spinner fa-spin"></i> 正在初始化博客...</div>
        <div id="blog-content" style="display:none"></div>
        <div id="gitalk-container" style="display:none;margin-top:20px"></div>
    </main>

    <footer id="main-footer"></footer>

    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script>
    <script>
        // Utilities
        const utf8_to_b64 = str => btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,(m,p)=>String.fromCharCode('0x'+p)));
        const b64_to_utf8 = b64 => decodeURIComponent(Array.prototype.map.call(atob(b64), c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));

        // slugify safe
        const slugify = (text) => {
            if (!text) return '';
            return text.toString().toLowerCase().trim()
                .replace(/\s+/g, '-')
                .replace(/[^\p{L}\p{N}_\-.]/gu, '')
                .replace(/--+/g, '-')
                .substring(0,60)
                .replace(/^[_\-.]+|[_\-.]+$/g, '');
        };

        const md = window.markdownit({
            html:true, linkify:true, typographer:true,
            highlight: function (str, lang) {
                const escaped = md.utils.escapeHtml(str);
                if (lang && hljs.getLanguage(lang)) {
                    try { return '<pre><code class="hljs">' + hljs.highlight(escaped, {language:lang, ignoreIllegals:true}).value + '</code></pre>'; }
                    catch (__) { console.warn('highlight fail', __); }
                }
                return '<pre><code class="hljs">'+escaped+'</code></pre>';
            }
        });

        let siteConfig = null;
        let blogPosts = [];
        let owner = '', repo = '', publicUrlBase = '';

        const appContainer = document.querySelector('.container');
        const blogContentDiv = document.getElementById('blog-content');
        const loadingDiv = document.getElementById('loading');
        const siteTitleEl = document.getElementById('site-title');
        const siteDescriptionEl = document.getElementById('site-description');
        const mainFooterEl = document.getElementById('main-footer');
        const gitalkContainerEl = document.getElementById('gitalk-container');
        const adminLinkEl = document.getElementById('admin-link');

        const parseGitHubRepoAndBasePath = (githubUsername) => {
            const hostname = window.location.hostname;
            let pathSegments = window.location.pathname.split('/').filter(p=>p);
            if (pathSegments.length>0 && (pathSegments[pathSegments.length-1].toLowerCase()==='admin.html' || pathSegments[pathSegments.length-1].toLowerCase()==='index.html')) pathSegments.pop();
            const usernameLow = githubUsername.toLowerCase();
            const hostnameLow = hostname.toLowerCase();
            let finalOwner = githubUsername, finalRepo = '', finalPublicUrlBase = '';
            if (hostnameLow === `${usernameLow}.github.io` || /^localhost$|^127\.0\.0\.1$/.test(hostnameLow)) {
                if (pathSegments.length>0) { finalRepo = pathSegments[0]; finalPublicUrlBase = `/${pathSegments[0]}`; }
                else { finalRepo = `${usernameLow}.github.io`; finalPublicUrlBase = ''; }
            } else if (pathSegments.length>0) {
                finalRepo = pathSegments[0]; finalPublicUrlBase = `/${pathSegments[0]}`;
            } else {
                finalRepo = `${usernameLow}.github.io`; finalPublicUrlBase = '';
            }
            if (!finalRepo) { finalRepo = `${usernameLow}.github.io`; finalPublicUrlBase = ''; }
            return { owner: finalOwner, repo: finalRepo, publicUrlBase: finalPublicUrlBase };
        };

        const GitHubAPI_Frontend = {
            async getRawFile(owner_, repo_, path) {
                const rawUrl = `https://raw.githubusercontent.com/${owner_}/${repo_}/main/${path}`;
                const res = await fetch(rawUrl);
                if (!res.ok) {
                    if (res.status === 404) {
                        if (path === 'posts.json') return []; else return {};
                    }
                    throw new Error(`无法加载文件 (${res.status} ${res.statusText}) ${rawUrl}`);
                }
                const txt = await res.text();
                if (!txt.trim()) return path === 'posts.json' ? [] : {};
                try { return JSON.parse(txt); } catch (e) { throw new Error(`文件 ${rawUrl} 不是有效 JSON：${e.message}`); }
            }
        };

        // Normalize and proxy image URLs
        const getProxiedImageUrl = (inputUrl) => {
            if (!inputUrl) return '';
            let urlToProcess = inputUrl;
            if (urlToProcess.startsWith('https://gh-proxy.com/')) {
                try { urlToProcess = decodeURIComponent(urlToProcess.substring('https://gh-proxy.com/'.length)); } catch (e) {}
            }
            if (/^https?:\/\//.test(urlToProcess)) {
                try {
                    const u = new URL(urlToProcess);
                    u.pathname = u.pathname.split('/').map(seg => decodeURIComponent(seg || '')).join('/');
                    u.search = decodeURIComponent(u.search || '');
                    urlToProcess = u.toString();
                } catch (e) { console.warn('getProxiedImageUrl parse fail', e); }
                return `https://gh-proxy.com/${encodeURIComponent(urlToProcess)}`;
            }
            return inputUrl;
        };

        // Resolve relative markdown images to raw.githubusercontent absolute URL
        const resolveMarkdownImageUrl = (url, curOwner, curRepo) => {
            if (!url) return '';
            if (/^https?:\/\//i.test(url)) return url;
            const clean = url.startsWith('/') ? url.substring(1) : url;
            return `https://raw.githubusercontent.com/${curOwner}/${curRepo}/main/${clean}`;
        };

        // After rendering, sanitize img elements: set loading=lazy, set onerror fallback, hide invalid src
        const postRenderImagePostprocess = (containerEl) => {
            try {
                const imgs = containerEl.querySelectorAll('img');
                imgs.forEach(img => {
                    // ensure lazy
                    img.loading = 'lazy';
                    // if src empty or contains 'undefined', hide image
                    if (!img.src || img.src.includes('undefined') || img.src.trim()==='') {
                        img.style.display = 'none';
                        return;
                    }
                    // attach robust onerror
                    img.onerror = function() {
                        this.onerror = null;
                        this.src = 'data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27%3E%3Cpath fill=%27%23ccc%27 d=%27M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z%27/%3E%3C/svg%3E';
                        this.style.opacity = '0.6';
                        this.title = '图片加载失败';
                    };
                });
            } catch (e) { console.warn('postRenderImagePostprocess error', e); }
        };

        // Render home page
        const renderHomePage = () => {
            blogContentDiv.style.display = 'block';
            blogContentDiv.innerHTML = `<div class="post-list"></div>`;
            const container = blogContentDiv.querySelector('.post-list');
            if (!blogPosts || blogPosts.length===0) {
                container.innerHTML = `<div class="loading"><i class="fas fa-info-circle"></i> 暂无文章，去管理后台发布一篇吧</div>`;
                return;
            }
            blogPosts.slice().sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).forEach(post => {
                const excerpt = post.content.split('<!--more-->')[0].trim();
                let firstImage = '';
                const match = post.content.match(/!\[(.*?)\]\((.+?)\)/);
                if (match) firstImage = match[2];
                const resolved = firstImage ? resolveMarkdownImageUrl(firstImage, owner, repo) : '';
                const proxied = resolved ? getProxiedImageUrl(resolved) : '';
                const card = document.createElement('div');
                card.className = 'post-card';
                card.innerHTML = `
                    ${proxied ? `<div class="post-card-image"><img src="${proxied}" alt="${post.title}" /></div>` : ''}
                    <div class="post-card-content">
                        <h2><a href="#/post/${post.id}">${post.title}</a></h2>
                        <div class="meta">${new Date(post.createdAt).toLocaleDateString()} • ${post.category || '未分类'}</div>
                        <div class="excerpt">${md.render(excerpt)}</div>
                        <div style="margin-top:12px;"><a class="read-more" href="#/post/${post.id}">阅读全文 <i class="fas fa-arrow-right"></i></a></div>
                    </div>
                `;
                container.appendChild(card);
                postRenderImagePostprocess(card);
            });
        };

        // Render single post page
        const renderPostPage = (postId) => {
            const post = blogPosts.find(p=>p.id===postId);
            if (!post) {
                blogContentDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> 文章未找到</div>`;
                gitalkContainerEl.style.display = 'none';
                return;
            }
            // Replace markdown image urls to resolved raw then proxied
            let processedContent = post.content.replace(/!\[(.*?)\]\((.+?)\)/g, (m, alt, url) => {
                const resolved = resolveMarkdownImageUrl(url, owner, repo);
                const proxied = getProxiedImageUrl(resolved);
                // safe: return standard markdown syntax with proxied url; postRenderImagePostprocess will set onerror
                return `![${alt}](${proxied})`;
            });
            blogContentDiv.innerHTML = `
                <article class="post-full">
                    <h1>${post.title}</h1>
                    <div class="meta">${new Date(post.createdAt).toLocaleDateString()} • ${post.category || '未分类'}</div>
                    <div class="post-content">${md.render(processedContent)}</div>
                </article>
            `;
            postRenderImagePostprocess(blogContentDiv);
            hljs.highlightAll();

            // Gitalk
            if (siteConfig && siteConfig.gitalk && siteConfig.gitalk.enabled) {
                gitalkContainerEl.style.display = 'block';
                gitalkContainerEl.innerHTML = '';
                const safePostId = slugify(post.id).slice(0,20);
                const safeTitle = slugify(post.title).slice(0,30);
                const gitalkId = `${safeTitle}-${safePostId}`;
                try {
                    const gitalk = new Gitalk({
                        clientID: siteConfig.gitalk.clientID,
                        clientSecret: siteConfig.gitalk.clientSecret,
                        repo: siteConfig.gitalk.repo,
                        owner: siteConfig.gitalk.owner,
                        admin: siteConfig.gitalk.admin,
                        id: gitalkId,
                        title: post.title,
                        body: `文章链接：${window.location.href}\n\n${post.title}\n\n${(post.content||'').slice(0,300)}`,
                        labels: [...new Set([...(siteConfig.gitalk.labels||[]), post.category || '未分类'])],
                        distractionFreeMode: siteConfig.gitalk.distractionFreeMode || false,
                        perPage: siteConfig.gitalk.perPage || 10
                    });
                    gitalk.render('gitalk-container');
                } catch (e) {
                    console.error('gitalk init fail', e);
                    gitalkContainerEl.innerHTML = `<div class="error">Gitalk 初始化失败：${e.message}</div>`;
                }
            } else {
                gitalkContainerEl.style.display = 'none';
            }
        };

        const renderAboutPage = () => {
            blogContentDiv.innerHTML = `<div class="post-full"><h1>关于我</h1><div class="post-content">${siteConfig && siteConfig.site && siteConfig.site.aboutContent ? md.render(siteConfig.site.aboutContent) : '<p>暂无关于内容</p>'}</div></div>`;
            postRenderImagePostprocess(blogContentDiv);
        };

        const render404Page = () => {
            blogContentDiv.innerHTML = `<div class="error">页面未找到 (404)</div>`;
        };

        const handleRoute = () => {
            const route = window.location.hash.slice(1);
            document.querySelectorAll('#main-nav .nav-link').forEach(a=>a.classList.remove('active'));
            if (route.startsWith('/post/')) {
                const postId = route.replace('/post/','');
                renderPostPage(postId);
                document.querySelector('#main-nav a[data-route="home"]').classList.add('active');
            } else if (route==='/about') {
                renderAboutPage();
                document.querySelector('#main-nav a[data-route="about"]').classList.add('active');
            } else {
                renderHomePage();
                document.querySelector('#main-nav a[data-route="home"]').classList.add('active');
            }
        };

        const initializeBlog = async () => {
            loadingDiv.style.display = 'block';
            try {
                let tempUsername = window.location.hostname.split('.')[0];
                if (!tempUsername || tempUsername.toLowerCase()==='localhost' || tempUsername==='127') tempUsername = 'pkq66882';
                const parsed = parseGitHubRepoAndBasePath(tempUsername);
                owner = parsed.owner; repo = parsed.repo; publicUrlBase = parsed.publicUrlBase;
                adminLinkEl.href = `${window.location.origin}${publicUrlBase}/admin.html`;

                // fetch config & posts
                const [cfg, posts] = await Promise.all([
                    GitHubAPI_Frontend.getRawFile(owner, repo, 'config.json'),
                    GitHubAPI_Frontend.getRawFile(owner, repo, 'posts.json')
                ]);
                if (!cfg || Object.keys(cfg).length===0) throw new Error('config.json 未找到或为空，请先到管理后台初始化');
                if (!posts || !Array.isArray(posts)) throw new Error('posts.json 未找到或内容无效，请先到管理后台初始化');
                siteConfig = cfg;
                blogPosts = posts.map(p => {
                    // normalize: if content includes gh-proxy, decode to raw
                    const content = (p.content || '').replace(/!\[(.*?)\]\((https?:\/\/[^\s)]+)\)/g, (m, alt, url) => {
                        let original = url;
                        if (original.startsWith('https://gh-proxy.com/')) {
                            try { original = decodeURIComponent(original.substring('https://gh-proxy.com/'.length)); } catch (e) {}
                        }
                        return `![${alt}](${original})`;
                    });
                    return { ...p, content };
                });

                // dynamic styling from config
                document.title = siteConfig.site.title || `${owner} 的博客`;
                siteTitleEl.textContent = siteConfig.site.title || `${owner} 的博客`;
                siteDescriptionEl.textContent = siteConfig.site.description || '';
                mainFooterEl.innerHTML = `&copy; ${new Date().getFullYear()} ${siteConfig.site.title || owner}. Powered by 期望ai`;

                // inject dynamic CSS
                const style = document.createElement('style');
                style.textContent = `
                    body{background-color:${siteConfig.styling.backgroundColor || '#f8f9fa'}; color:${siteConfig.styling.textColor || '#212529'}}
                    :root{--accent:${siteConfig.styling.accentColor || '#0d6efd';} --accent-hover:${siteConfig.styling.accentHover || '#2980b9';}}
                `;
                document.head.appendChild(style);

                // background image if valid
                if (siteConfig.styling.backgroundImageUrl && /^https?:\/\//i.test(siteConfig.styling.backgroundImageUrl)) {
                    const bgUrl = getProxiedImageUrl(siteConfig.styling.backgroundImageUrl);
                    document.body.style.backgroundImage = `url("${bgUrl}")`;
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundPosition = 'center';
                    document.body.style.backgroundAttachment = 'fixed';
                }

                // ready: render
                loadingDiv.style.display = 'none';
                blogContentDiv.style.display = 'block';
                handleRoute();
            } catch (e) {
                console.error('初始化失败', e);
                loadingDiv.style.display = 'none';
                blogContentDiv.style.display = 'block';
                blogContentDiv.innerHTML = `<div class="error">博客初始化失败：${e.message}。请先在管理后台完成初始化。</div>`;
            }
        };

        window.addEventListener('hashchange', handleRoute);
        document.addEventListener('DOMContentLoaded', () => {
            initializeBlog();
            document.querySelector('#main-nav a[data-route="home"]').addEventListener('click', (e) => { e.preventDefault(); const cleanUrl = `${window.location.origin}${publicUrlBase}/index.html`; if (window.location.href !== cleanUrl) window.location.replace(cleanUrl); else handleRoute(); });
            document.querySelector('#main-nav a[data-route="about"]').addEventListener('click', (e) => { e.preventDefault(); window.location.hash = '/about'; });
        });
    </script>
</body>
</html>
