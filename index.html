<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="site-title-meta">加载中...</title>
    <meta name="description" id="site-description-meta" content="一个由期望AI构建的半静态博客">
    <link rel="icon" href="https://avatars.githubusercontent.com/u/0?v=4" id="site-favicon"> <!-- 默认icon -->
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <!-- Markdown-it for rendering Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        /* Basic styles and theme variables */
        :root {
            --primary-color: #4f46e5; /* Indigo-600 */
            --bg-start: #f3f4f6;
            --bg-end: #e5e7eb;
            --card-bg: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
        }

        body.dark-mode {
            --bg-start: #1a202c;
            --bg-end: #2d3748;
            --card-bg: #2d3748;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
            background-attachment: fixed;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
        }

        .navbar {
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex; /* Add flex to align items */
            justify-content: space-between; /* Space out items */
            align-items: center; /* Vertically center items */
        }
        .navbar a {
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease;
        }
        .navbar a:hover {
            background-color: var(--bg-start);
            color: var(--primary-color);
        }
        .navbar .active {
            color: var(--primary-color);
            font-weight: 600;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            margin-bottom: 2rem;
            transition: background-color 0.3s ease;
        }

        .post-card {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .post-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        /* Markdown rendering styles */
        .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4, .markdown-content h5, .markdown-content h6 {
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            line-height: 1.25;
            color: var(--text-primary);
        }
        .markdown-content h1 { font-size: 2.25rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        .markdown-content h2 { font-size: 1.875rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3rem; }
        .markdown-content h3 { font-size: 1.5rem; }
        .markdown-content p {
            margin-bottom: 1rem;
            line-height: 1.75;
            color: var(--text-secondary);
        }
        .markdown-content a {
            color: var(--primary-color);
            text-decoration: underline;
        }
        .markdown-content ul, .markdown-content ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
            list-style-position: inside; /* Prevent list markers from being outside on small screens */
        }
        .markdown-content ul { list-style-type: disc; }
        .markdown-content ol { list-style-type: decimal; }
        .markdown-content li {
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }
        .markdown-content pre {
            background-color: #2d3748; /* Dark background for code blocks */
            color: white;
            padding: 1rem;
            border-radius: 0.375rem;
            overflow-x: auto;
            margin-bottom: 1rem;
            font-family: monospace;
        }
        .markdown-content code {
            background-color: rgba(125, 125, 125, 0.1);
            color: var(--text-primary); /* Adjust for readability in both modes */
            padding: 0.2em 0.4em;
            border-radius: 0.25rem;
            font-family: monospace;
            white-space: pre-wrap; /* Wrap code inside text paragraphs */
            word-break: break-all;
        }
        .markdown-content pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
            border-radius: 0;
            white-space: pre; /* Keep original white-space for block code */
        }
        .markdown-content blockquote {
            border-left: 4px solid var(--primary-color);
            padding-left: 1rem;
            margin-left: 0;
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }
        .markdown-content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1rem auto;
            border-radius: 0.375rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            text-align: left;
        }
        th {
            background-color: var(--bg-start);
            font-weight: 600;
        }
        .utterances {
            max-width: 100%; /* Ensure utterances scales with container */
        }

        /* Day/Night toggle button */
        #theme-toggle-button {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }
        #theme-toggle-button:hover {
            background-color: var(--bg-start);
        }

    </style>
</head>
<body class="light-mode">
    <div class="navbar sticky top-0 bg-white z-10 p-4 shadow-sm text-gray-800">
        <div class="container mx-auto flex justify-between items-center">
            <a href="#home" id="navbar-brand" class="text-xl font-bold flex items-center">
                <img id="site-logo" src="https://avatars.githubusercontent.com/u/0?v=4" alt="Logo" class="w-8 h-8 rounded-full mr-2">
                <span id="site-name">加载中...</span>
            </a>
            <nav class="flex items-center space-x-4">
                <a href="#home" class="nav-link" data-page="home">首页</a>
                <a href="#about" class="nav-link" data-page="about">关于</a>
                <button id="theme-toggle-button">
                    <i class="fas fa-sun text-yellow-500"></i>
                </button>
            </nav>
        </div>
    </div>

    <div id="app" class="container mx-auto py-8">
        <!-- Content will be rendered here -->
        <div id="loading-screen" class="flex justify-center items-center h-64">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
            <p class="ml-4 text-lg text-gray-600 dark:text-gray-400">加载网站数据...</p>
        </div>
    </div>

    <script>
        // GitHub Pages 配置
        const GITHUB_USERNAME = "你的GitHub用户名"; // 替换为你的 GitHub 用户名
        const GITHUB_REPO_NAME = "你的GitHub仓库名"; // 替换为你的 GitHub 仓库名 (例如: 'blog')
        const DEFAULT_BRANCH = "main"; // 你的仓库默认分支，通常是 main 或 master

        // CDN Base URL for raw content
        // jsDelivr is usually preferred for production due to better caching and global CDN
        const BASE_CDN_URL = `https://cdn.jsdelivr.net/gh/${GITHUB_USERNAME}/${GITHUB_REPO_NAME}@${DEFAULT_BRANCH}`;
        // Fallback to GitHub Raw if jsDelivr encounters issues, but be aware of rate limits
        const BASE_RAW_URL = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO_NAME}/${DEFAULT_BRANCH}`;

        // Local Storage Keys
        const LOCAL_STORAGE_THEME_KEY = 'blog_theme';

        // DOM Elements
        const siteTitleMeta = document.getElementById('site-title-meta');
        const siteDescriptionMeta = document.getElementById('site-description-meta');
        const siteFavicon = document.getElementById('site-favicon');
        const navbarBrand = document.getElementById('navbar-brand');
        const siteLogo = document.getElementById('site-logo');
        const siteName = document.getElementById('site-name');
        const navLinks = document.querySelectorAll('.nav-link');
        const app = document.getElementById('app');
        const loadingScreen = document.getElementById('loading-screen');
        const themeToggleButton = document.getElementById('theme-toggle-button');

        // Markdown renderer setup
        const md = window.markdownit({
            html: true, // Enable HTML tags in source
            linkify: true, // Autoconvert URL-like text to links
            typographer: true, // Enable some common typographical replacements
        }).use(window.markdownitContainer, 'highlighted', {
            validate: function (params) {
                return params.trim().match(/^highlight(ed)?\s+(.*)$/);
            },
            render: function (tokens, idx) {
                const m = tokens[idx].info.trim().match(/^highlight(ed)?\s+(.*)$/);
                if (tokens[idx].nesting === 1) {
                    // opening tag
                    return '<div class="custom-highlight-block"><p class="highlight-title">' + md.utils.escapeHtml(m[2]) + '</p>\n';
                } else {
                    // closing tag
                    return '</div>\n';
                }
            }
        });

        // Highlight.js initialization hook for markdown-it
        md.options.highlight = function (str, lang) {
            if (lang && hljs.getLanguage(lang)) {
                try {
                    return '<pre class="hljs"><code>' +
                           hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +
                           '</code></pre>';
                } catch (__) {}
            }
            return '<pre class="hljs"><code>' + md.utils.escapeHtml(str) + '</code></pre>';
        };

        let configData = {};
        let postsData = [];

        // --- Utility Functions ---

        // Fetch JSON data, with fallback to raw.githubusercontent
        async function fetchJsonWithFallback(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch JSON from ${url}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.warn(`Attempting fallback for ${url}:`, error);
                const fallbackUrl = url.replace(BASE_CDN_URL, BASE_RAW_URL);
                const fallbackResponse = await fetch(fallbackUrl);
                if (!fallbackResponse.ok) {
                    throw new Error(`Failed to fetch JSON from fallback ${fallbackUrl}: ${fallbackResponse.statusText}`);
                }
                return await fallbackResponse.json();
            }
        }

        // --- Theme Functions ---
        function setTheme(theme) {
            document.body.classList.remove('light-mode', 'dark-mode');
            document.body.classList.add(theme);
            localStorage.setItem(LOCAL_STORAGE_THEME_KEY, theme);
            updateThemeToggleButton(theme);
        }

        function toggleTheme() {
            const currentTheme = document.body.classList.contains('dark-mode') ? 'dark-mode' : 'light-mode';
            setTheme(currentTheme === 'light-mode' ? 'dark-mode' : 'light-mode');
        }

        function updateThemeToggleButton(theme) {
            if (theme === 'dark-mode') {
                themeToggleButton.innerHTML = '<i class="fas fa-moon text-blue-300"></i>';
                themeToggleButton.title = '切换日间模式';
                document.querySelector('link[href*="github.min.css"]').href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css';
            } else {
                themeToggleButton.innerHTML = '<i class="fas fa-sun text-yellow-500"></i>';
                themeToggleButton.title = '切换夜间模式';
                document.querySelector('link[href*="github-dark.min.css"]').href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css';
            }
        }

        // --- Router Functions ---
        function navigate(hash) {
            window.location.hash = hash;
        }

        function handleRoute() {
            const hash = window.location.hash;
            navLinks.forEach(link => link.classList.remove('active'));

            if (hash.startsWith('#post=')) {
                const postId = hash.substring(6);
                displayPost(postId);
                document.querySelector('.nav-link[data-page="home"]').classList.add('active'); // Keep home active for post view
            } else if (hash === '#about') {
                displayAboutPage();
                document.querySelector('.nav-link[data-page="about"]').classList.add('active');
            } else {
                displayPostList();
                document.querySelector('.nav-link[data-page="home"]').classList.add('active');
            }
        }

        // --- Content Display Functions ---

        function updateMetaTags() {
            siteTitleMeta.textContent = configData.siteTitle || '期望AI - 半静态博客';
            siteDescriptionMeta.setAttribute('content', configData.siteDescription || '一个由期望AI构建的半静态博客');
            siteFavicon.href = configData.siteFavicon || 'https://avatars.githubusercontent.com/u/0?v=4';
            siteLogo.src = configData.siteLogo || 'https://avatars.githubusercontent.com/u/0?v=4';
            siteName.textContent = configData.siteTitle || '加载中...';
        }

        function displayPostList() {
            app.innerHTML = `
                <h1 class="text-3xl font-bold mb-8 text-center text-gray-800 dark:text-gray-200">${configData.siteTitle || '最新文章'}</h1>
                <div id="posts-list-container" class="grid gap-6 sm:grid-cols-1 lg:grid-cols-2">
                    ${postsData.length === 0 ? '<p class="text-center text-gray-500 dark:text-gray-400">暂无文章。</p>' : ''}
                </div>
            `;
            const postsListContainer = document.getElementById('posts-list-container');

            postsData.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date descending

            postsData.forEach(post => {
                const postCard = document.createElement('div');
                postCard.className = 'post-card card p-6 cursor-pointer';
                postCard.onclick = () => navigate(`#post=${post.id}`);
                postCard.innerHTML = `
                    <h2 class="text-xl font-semibold mb-2 text-gray-800 dark:text-gray-200 hover:text-indigo-600 dark:hover:text-indigo-400">
                        ${post.title}
                    </h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                        ${post.author} • ${post.date}
                    </p>
                    <p class="text-gray-700 dark:text-gray-300 mb-4">
                        ${post.summary}
                    </p>
                    <a href="#post=${post.id}" class="text-indigo-600 dark:text-indigo-400 hover:underline">
                        阅读全文 <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                `;
                postsListContainer.appendChild(postCard);
            });
            hideLoadingScreen();
        }

        async function displayPost(postId) {
            const post = postsData.find(p => p.id === postId);
            if (!post) {
                app.innerHTML = `
                    <p class="text-center text-red-500 text-xl font-semibold mt-16">
                        文章未找到。
                        <a href="#home" class="text-indigo-600 dark:text-indigo-400 hover:underline ml-2">返回主页</a>
                    </p>`;
                hideLoadingScreen();
                return;
            }

            app.innerHTML = `
                <div class="card p-8">
                    <h1 class="text-4xl font-bold mb-4 text-gray-800 dark:text-gray-200">${post.title}</h1>
                    <p class="text-md text-gray-500 dark:text-gray-400 mb-8">
                        作者: ${post.author} • 发布日期: ${post.date}
                    </p>
                    <div id="post-content" class="markdown-content text-gray-700 dark:text-gray-300">
                        <p class="text-center text-gray-500">加载文章内容...</p>
                    </div>
                </div>
                <div id="comments-section" class="card mt-8 p-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200">评论</h2>
                    <div id="utterances-comments"></div>
                </div>
            `;

            try {
                const markdownUrl = post.contentUrl.startsWith('http') ? post.contentUrl : `${BASE_CDN_URL}/${post.contentUrl}`;
                const response = await fetch(markdownUrl);
                if (!response.ok) {
                    throw new Error(`Failed to load markdown from ${markdownUrl}`);
                }
                const markdownText = await response.text();
                document.getElementById('post-content').innerHTML = md.render(markdownText);
                hljs.highlightAll(); // Apply syntax highlighting after markdown rendering

                // Load Utterances comments
                loadUtterances(post.title, post.id);

            } catch (error) {
                console.error('Error loading post content:', error);
                document.getElementById('post-content').innerHTML = `
                    <p class="text-center text-red-500">无法加载文章内容。</p>
                `;
            }
            hideLoadingScreen();
        }

        function displayAboutPage() {
            app.innerHTML = `
                <div class="card p-8">
                    <h1 class="text-3xl font-bold mb-4 text-gray-800 dark:text-gray-200">关于我们</h1>
                    <div id="about-content" class="markdown-content text-gray-700 dark:text-gray-300">
                        ${configData.aboutContent ? md.render(configData.aboutContent) : '<p>尚未配置“关于”页面内容。</p>'}
                    </div>
                </div>
            `;
            hljs.highlightAll(); // Apply syntax highlighting
            hideLoadingScreen();
        }

        // --- Utterances Comments Integration ---
        // IMPORTANT: Replace 'YOUR_GITHUB_REPO_FOR_COMMENTS' with the actual repository
        // where you want to store comments as issues (e.g., 'your-username/your-blog-repo').
        // This *must* be a PUBLIC repository that Utterances can access and where users can create issues.
        // It's often the same repository that hosts your blog.
        const UTTERANCES_REPO = `${GITHUB_USERNAME}/${GITHUB_REPO_NAME}`; // Uses the same repo as blog content

        function loadUtterances(postTitle, postId) {
            const commentsSection = document.getElementById('utterances-comments');
            if (!commentsSection) return;

            // Clear previous utterances instance if any
            commentsSection.innerHTML = '';

            const script = document.createElement('script');
            script.src = "https://utteranc.es/client.js";
            script.setAttribute("repo", UTTERANCES_REPO);
            script.setAttribute("issue-term", "pathname"); // Use the page path as the issue title or data-id field
            script.setAttribute("label", "评论"); // Label for issues created by comments
            script.setAttribute("theme", document.body.classList.contains('dark-mode') ? "github-dark" : "github-light");
            script.setAttribute("crossorigin", "anonymous");
            script.setAttribute("async", "");

            commentsSection.appendChild(script);
        }

        // --- Loading Screen ---
        function showLoadingScreen() {
            loadingScreen.classList.remove('hidden');
            app.innerHTML = ''; // Clear existing content
        }

        function hideLoadingScreen() {
            loadingScreen.classList.add('hidden');
        }

        // --- Initialization ---
        async function initialize() {
            showLoadingScreen();
            
            // Apply saved theme first to avoid flash of unstyled content
            const savedTheme = localStorage.getItem(LOCAL_STORAGE_THEME_KEY);
            setTheme(savedTheme || 'light-mode');

            try {
                configData = await fetchJsonWithFallback(`${BASE_CDN_URL}/config.json`);
                postsData = await fetchJsonWithFallback(`${BASE_CDN_URL}/posts.json`);

                updateMetaTags();
                handleRoute(); 
            } catch (error) {
                console.error('Failed to load website data:', error);
                app.innerHTML = `
                    <div class="text-center text-red-500 text-xl font-semibold mt-16">
                        <h2>加载网站数据失败!</h2>
                        <p class="text-lg text-gray-700 dark:text-gray-300">
                            请检查您的GitHub用户名、仓库名和分支是否正确，并确保 
                            <code class="font-mono bg-gray-200 dark:bg-gray-700 px-1 py-0.5 rounded">config.json</code>
                             和 
                            <code class="font-mono bg-gray-200 dark:bg-gray-700 px-1 py-0.5 rounded">posts.json</code> 
                            文件存在于仓库根目录，且可公开访问。</p>
                        <p class="text-sm mt-4">详细错误: ${error.message}</p>
                    </div>
                `;
                hideLoadingScreen();
            }
        }

        // Event Listeners
        window.addEventListener('hashchange', handleRoute);
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                navigate(e.target.getAttribute('href'));
            });
        });

        themeToggleButton.addEventListener('click', toggleTheme);
        
        // Initial setup
        initialize();

    </script>
</body>
</html>
