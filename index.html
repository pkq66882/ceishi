<!-- index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>正在加载...</title>
    <!-- Favicon PlaceHolder (Replace with your own) -->
    <link rel="icon" href="https://example.com/favicon.ico" type="image/x-icon">

    <!-- Google Fonts - Inter for clean typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Prism.js for code highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

    <style>
        /* CSS Variables for Theming */
        :root {
            --bg-color: #f8f9fa;
            --text-color: #343a40;
            --heading-color: #212529;
            --accent-color: #0d6efd;
            --link-hover-color: #0b5ed7;
            --border-color: #e9ecef;
            --card-bg: #ffffff;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            --meta-color: #6c757d;
            --code-bg: #2d2d2d;
            --code-text: #f8f8f2;
            --footer-bg: #f1f3f5;
        }

        /* Dark Mode Example (Admin can configure in settings) */
        body.dark-mode {
            --bg-color: #212529;
            --text-color: #e9ecef;
            --heading-color: #dee2e6;
            --accent-color: #0d6efd; /* Keep accent same or adjust to a lighter blue */
            --link-hover-color: #6daffb;
            --border-color: #495057;
            --card-bg: #2d313a;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            --meta-color: #adb5bd;
            --code-bg: #1e1e1e;
            --code-text: #d4d4d4;
            --footer-bg: #282c34;
        }

        /* Base Styles */
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            line-height: 1.7;
            color: var(--text-color);
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            transition: background-color .3s, color .3s;
            display: flex; /* For loader centering */
            flex-direction: column;
            min-height: 100vh;
        }

        a {
            color: var(--accent-color);
            text-decoration: none;
            transition: color .2s ease-in-out, text-decoration .2s ease-in-out;
        }

        a:hover {
            color: var(--link-hover-color);
            text-decoration: underline;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
            flex-grow: 1; /* Allow content to grow */
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Inter', sans-serif;
            color: var(--heading-color);
            margin-top: 2rem;
            margin-bottom: 1rem;
            line-height: 1.3;
        }
        h1 { font-size: 2.5rem; }
        h2 { font-size: 2rem; }
        h3 { font-size: 1.75rem; }
        p { margin-bottom: 1rem; }

        /* Site Header */
        .site-header {
            padding: 3rem 1.5rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 3rem;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .site-title {
            font-size: 2.8rem;
            margin: 0 0 0.5rem;
            color: var(--heading-color);
            font-weight: 700;
            line-height: 1.2;
        }
        .site-description {
            font-size: 1.1rem;
            margin: 0;
            color: var(--meta-color);
            max-width: 600px;
        }
        .site-header a {
            color: var(--heading-color);
        }
        .site-header a:hover {
             color: var(--accent-color);
             text-decoration: none;
        }

        /* Post Excerpt (List Item) */
        .post-excerpt {
            background-color: var(--card-bg);
            margin-bottom: 2.5rem;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            transition: transform .2s ease-in-out, box-shadow .2s ease-in-out;
        }
        .post-excerpt:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        .post-title {
            margin: 0 0 0.75rem;
            line-height: 1.3;
        }
        .post-title a {
            font-size: 1.8rem;
            color: var(--heading-color);
            font-weight: 600;
        }
        .post-title a:hover {
            color: var(--accent-color);
            text-decoration: none;
        }
        .post-meta {
            font-size: 0.9rem;
            color: var(--meta-color);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .post-meta span {
            margin-right: 15px;
            display: flex;
            align-items: center;
        }
        .post-meta span svg {
             margin-right: 5px;
             opacity: 0.7;
        }
        .post-summary {
            color: var(--text-color);
            margin-bottom: 1.5rem;
            word-wrap: break-word;
            line-height: 1.6;
        }
        .post-summary p:last-of-type {
            margin-bottom: 0;
        }
        .post-images-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 1.5rem;
        }
        .post-images-preview img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .read-more-btn {
            display: inline-flex;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--accent-color);
            color: #fff;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            transition: background-color .2s ease-in-out, transform .1s ease-in-out;
        }
        .read-more-btn:hover {
            background-color: var(--link-hover-color);
            transform: translateY(-1px);
            text-decoration: none;
        }
        .read-more-btn svg {
            margin-left: 8px;
        }

        /* Post Detail View */
        #post-detail-view {
            display: none;
            background-color: var(--card-bg);
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }
        .post-full-header {
            margin-bottom: 2.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            text-align: center; /* Center header elements for single post */
        }
        .post-full-title {
            font-size: 3rem;
            color: var(--heading-color);
            margin: 0 0 1rem;
            line-height: 1.2;
            word-break: break-word; /* Ensure long titles wrap */
        }
        .post-full-meta {
            font-size: 1rem;
            color: var(--meta-color);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .post-full-meta span {
            display: flex;
            align-items: center;
        }
         .post-full-meta span svg {
             margin-right: 5px;
             opacity: 0.7;
        }
        .post-full-content {
            font-size: 1.1rem;
            line-height: 1.8;
            word-wrap: break-word;
        }
        .post-full-content h2,
        .post-full-content h3,
        .post-full-content h4,
        .post-full-content h5,
        .post-full-content h6 {
            margin-top: 3rem;
            margin-bottom: 1.2rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .post-full-content h2 { font-size: 2.2rem; }
        .post-full-content h3 { font-size: 1.9rem; }
        .post-full-content p { margin-bottom: 1.5rem; }
        .post-full-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 2rem 0;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            cursor: zoom-in; /* Indicate clickable for lightbox */
        }
        .post-full-content blockquote {
            margin: 2rem 0;
            padding: 1.5rem 2rem;
            border-left: 5px solid var(--accent-color);
            background-color: rgba(var(--accent-color-rgb, 13, 110, 253), 0.05); /* Dynamic rgba */
            color: var(--text-color);
            border-radius: 8px;
            font-style: italic;
        }
        .post-full-content pre {
            background-color: var(--code-bg);
            color: var(--code-text);
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.95rem;
            margin: 2rem 0;
            line-height: 1.5;
        }
        .post-full-content code {
            background-color: rgba(120, 120, 120, 0.1);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .post-full-content ul, .post-full-content ol {
            margin-bottom: 1.5rem;
            padding-left: 20px;
        }
        .post-full-content li {
            margin-bottom: 0.5rem;
        }
        .back-to-home-link {
            display: inline-flex;
            align-items: center;
            margin-top: 3rem;
            font-size: 1rem;
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: background-color .2s ease-in-out, border-color .2s ease-in-out;
        }
        .back-to-home-link:hover {
            background-color: var(--bg-color);
            border-color: var(--accent-color);
            text-decoration: none;
        }
        .back-to-home-link svg {
            margin-right: 8px;
        }

        /* Giscus Comments Styling */
        #comments-container {
            margin-top: 3rem;
            background-color: var(--card-bg);
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }

        /* Site Footer */
        .site-footer {
            flex-shrink: 0; /* Prevent footer from shrinking */
            text-align: center;
            padding: 2.5rem 1.5rem;
            margin-top: 3rem;
            border-top: 1px solid var(--border-color);
            color: var(--meta-color);
            font-size: 0.95rem;
            background-color: var(--footer-bg);
        }

        /* Loading Spinner */
        #app-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        #app-loader.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .spinner {
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .loader-message {
            margin-top: 20px;
            color: var(--text-color);
            font-size: 1.1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 2.5rem;
        }
        .empty-state h3 {
            margin-top: 0;
            font-size: 1.8rem;
            color: var(--heading-color);
        }
        .empty-state p {
            color: var(--meta-color);
            font-size: 1.1rem;
        }
        .empty-state svg {
            color: var(--accent-color);
            margin-bottom: 20px;
        }

        /* Scroll to Top Button */
        #scroll-to-top {
            display: none; /* Hidden by default */
            position: fixed; /* Fixed position */
            bottom: 30px; /* Place at the bottom */
            right: 30px; /* Place at the right */
            z-index: 99; /* Make sure it does not overlap */
            border: none; /* Remove borders */
            outline: none; /* Remove outline */
            background-color: var(--accent-color); /* Set a background color */
            color: white; /* Text color */
            cursor: pointer; /* Add a mouse pointer on hover */
            padding: 15px; /* Some padding */
            border-radius: 50%; /* Rounded corners */
            font-size: 1rem; /* Increase font size */
            box-shadow: var(--card-shadow);
            transition: background-color 0.3s, opacity 0.3s;
        }
        #scroll-to-top:hover {
            background-color: var(--link-hover-color);
        }

        /* Lightbox for Images (Optional, for future enhancement) */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 1001;
            padding-top: 100px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.9);
        }
        .lightbox-content {
            margin: auto;
            display: block;
            max-width: 80%;
            max-height: 80%;
        }
        .lightbox-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .lightbox-close:hover,
        .lightbox-close:focus {
            color: #bbb;
            text-decoration: none;
        }


        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 1.5rem 1rem;
            }
            .site-header {
                padding: 2.5rem 1rem;
                margin-bottom: 2rem;
                border-radius: 8px;
            }
            .site-title {
                font-size: 2rem;
            }
            .site-description {
                font-size: 0.95rem;
            }
            .post-excerpt {
                padding: 1.5rem;
                margin-bottom: 2rem;
                border-radius: 8px;
            }
            .post-title a {
                font-size: 1.35rem;
                line-height: 1.4;
            }
            .post-meta {
                font-size: 0.8rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .post-images-preview {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 10px;
            }
            .post-images-preview img {
                height: 100px;
            }
            .read-more-btn {
                padding: 8px 16px;
                font-size: 0.85rem;
            }
            #post-detail-view {
                padding: 2rem;
                border-radius: 8px;
            }
            .post-full-header {
                margin-bottom: 2rem;
                padding-bottom: 1rem;
            }
            .post-full-title {
                font-size: 2.2rem;
            }
            .post-full-meta {
                font-size: 0.85rem;
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }
            .post-full-content {
                font-size: 1rem;
            }
            .post-full-content h2 { font-size: 1.8rem; }
            .post-full-content h3 { font-size: 1.5rem; }
            .post-full-content img { margin: 1.5rem 0; }
            .post-full-content blockquote { padding: 1rem 1.2rem; }
            .post-full-content pre { padding: 1rem; font-size: 0.9rem; }
            .back-to-home-link {
                margin-top: 2rem;
                font-size: 0.9rem;
            }
            #comments-container {
                padding: 2rem;
            }
            .site-footer {
                padding: 2rem 1rem;
                margin-top: 2rem;
            }
            #scroll-to-top {
                bottom: 20px;
                right: 20px;
                padding: 12px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body class="loading">
    <div id="app-loader">
        <div class="spinner"></div>
        <p class="loader-message">正在加载博客内容...</p>
    </div>

    <div class="container" style="display: none;">
        <header id="site-header" class="site-header">
            <h1 class="site-title"><a href="/"></a></h1>
            <p id="blog-description" class="site-description"></p>
        </header>

        <main>
            <div id="posts-list-view">
                <!-- Posts will be dynamically loaded here -->
            </div>
            <div id="post-detail-view">
                <!-- Single post content will be loaded here -->
                <div id="comments-container"></div>
            </div>
        </main>

        <footer class="site-footer">
            <p id="copyright-info"></p>
            <p>Powered by <a href="https://github.com/rjdsq/rjdsq.github.io" target="_blank" rel="noopener noreferrer">ExpectAI-BlogEngine</a> & GitHub Pages</p>
        </footer>
    </div>

    <button id="scroll-to-top" title="回到顶部">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
    </button>

    <!-- Prism.js for code highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <!-- Add more Prism language components as needed -->

    <script>
        // Helper function to decode base64 to UTF-8
        const b64_to_utf8 = (str) => {
            try { return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); } catch (e) { return atob(str); }
        };

        // DOM elements
        const body = document.body;
        const appLoader = document.getElementById('app-loader');
        const mainContainer = document.querySelector('.container');
        const siteHeader = document.getElementById('site-header');
        const blogTitleLink = siteHeader.querySelector('.site-title a');
        const blogDescriptionEl = document.getElementById('blog-description');
        const postsListView = document.getElementById('posts-list-view');
        const postDetailView = document.getElementById('post-detail-view');
        const commentsContainer = document.getElementById('comments-container');
        const copyrightInfoEl = document.getElementById('copyright-info');
        const scrollToTopBtn = document.getElementById('scroll-to-top');

        let allPosts = [];
        let siteConfig = {};
        let giscusScript = null; // To manage Giscus script

        /**
         * Fetches a file from GitHub API.
         * @param {string} owner - GitHub username.
         * @param {string} repo - Repository name.
         * @param {string} path - Path to the file.
         * @returns {Promise<string>} - File content as string.
         */
        const getFileFromApi = async (owner, repo, path) => {
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
            const response = await fetch(url, { cache: "no-store", headers: {'Accept': 'application/vnd.github.v3.raw'} });
            if (!response.ok) {
                // If 404, file might not exist, return null gracefully.
                if (response.status === 404) return null;
                throw new Error(`无法从API获取文件: ${path} (${response.status} ${response.statusText})`);
            }
            // For raw content, we don't need b64_to_utf8, fetch directly as text
            return response.text();
            /* Original logic for `application/vnd.github.v3+json`
            const data = await response.json();
            if (typeof data.content !== 'string') throw new Error(`API返回的文件内容格式不正确: ${path}`);
            return b64_to_utf8(data.content);
            */
        };


        /**
         * Renders the list of posts.
         */
        const renderPostList = () => {
            postsListView.innerHTML = '';
            postDetailView.style.display = 'none';
            commentsContainer.innerHTML = ''; // Clear comments when going back to list
            postsListView.style.display = 'block';
            siteHeader.style.display = 'flex'; // Ensure header is visible
            blogTitleLink.href = '/'; // Ensure home link always works for list view

            if (allPosts.length > 0) {
                // Sort posts by creation date, newest first
                allPosts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                allPosts.forEach(post => {
                    const postEl = document.createElement('article');
                    postEl.className = 'post-excerpt';

                    let summary = '';
                    const moreMarker = '<!--more-->';
                    const content = post.content;
                    const markerIndex = content.indexOf(moreMarker);
                    if (markerIndex !== -1) {
                        summary = content.substring(0, markerIndex);
                    } else {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = content;
                        summary = tempDiv.textContent.substring(0, 200) + (tempDiv.textContent.length > 200 ? '...' : '');
                    }

                    // Extract up to 3 images from the content for preview
                    const tempDivForImages = document.createElement('div');
                    tempDivForImages.innerHTML = content;
                    const images = Array.from(tempDivForImages.querySelectorAll('img')).map(img => img.src).slice(0, 3);
                    let imagesHtml = '';
                    if (images.length > 0) {
                        imagesHtml += '<div class="post-images-preview">';
                        images.forEach(imgUrl => { imagesHtml += `<img src="${imgUrl}" alt="Post image preview">`; });
                        imagesHtml += '</div>';
                    }

                    postEl.innerHTML = `
                        <header class="post-header">
                            <h2 class="post-title"><a href="${window.location.protocol}//${window.location.host}/#${post.id}">${post.title}</a></h2>
                            <p class="post-meta">
                                <span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>${new Date(post.createdAt).toLocaleDateString()}</span>
                                ${post.tags && post.tags.length > 0 ? `<span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 10V2l8 8 2.83-2.83a2 2 0 0 1 0-2.83l7.17-7.17 2.12 2.12zM7 7h.01"></path></svg>${post.tags.map(tag => `<a href="#/tag/${tag}" class="post-tag-link">${tag}</a>`).join(', ')}</span>` : ''}
                            </p>
                        </header>
                        <div class="post-summary">${summary}</div>
                        ${imagesHtml}
                        <a href="${window.location.protocol}//${window.location.host}/#${post.id}" class="read-more-btn">阅读全文 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></a>
                    `;
                    postsListView.appendChild(postEl);
                });
            } else {
                postsListView.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <h3>暂无文章</h3>
                        <p>期待您的第一篇博客文章发布！</p>
                    </div>
                `;
            }
            document.title = siteConfig.site.title || '博客'; // Reset title for list
        };

        /**
         * Renders a single post in detail view.
         * @param {string} postId - The ID of the post to render.
         */
        const renderSinglePost = (postId) => {
            const post = allPosts.find(p => p.id === postId);
            postsListView.style.display = 'none';
            postDetailView.style.display = 'block';
            siteHeader.style.display = 'none'; // Hide header for full post view

            if (post) {
                document.title = `${post.title} - ${siteConfig.site.title}`;
                let contentWithFixedImages = post.content.replace(/<img src="(\/.*?)">/g, (match, p1) => `<img src="${window.location.origin}${p1}">`);

                postDetailView.innerHTML = `
                    <article class="post-full">
                        <header class="post-full-header">
                            <h1 class="post-full-title">${post.title}</h1>
                            <p class="post-full-meta">
                                <span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg> 发布于 ${new Date(post.createdAt).toLocaleDateString()}</span>
                                ${post.updatedAt && post.createdAt !== post.updatedAt ? `<span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg> 更新于 ${new Date(post.updatedAt).toLocaleDateString()}</span>` : ''}
                                ${post.tags && post.tags.length > 0 ? `<span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 10V2l8 8 2.83-2.83a2 2 0 0 1 0-2.83l7.17-7.17 2.12 2.12zM7 7h.01"></path></svg> 标签: ${post.tags.map(tag => `<a href="#/tag/${tag}" class="post-tag-link">${tag}</a>`).join(', ')}</span>` : ''}
                            </p>
                        </header>
                        <section class="post-full-content">${contentWithFixedImages}</section>
                        <a href="${window.location.protocol}//${window.location.host}" class="back-to-home-link">&larr; 返回首页</a>
                    </article>
                `;

                // Apply Prism.js highlighting
                Prism.highlightAllUnder(postDetailView);

                // Initialize Giscus comments for this post
                initGiscus(post.id, siteConfig.giscus); // Pass post.id as Giscus ID for unique discussions

            } else {
                document.title = `未找到文章 - ${siteConfig.site.title}`;
                postDetailView.innerHTML = `
                    <article class="post-full">
                        <header class="post-full-header">
                            <h1 class="post-full-title">404 - 未找到文章</h1>
                            <p class="post-full-meta">抱歉，您要查找的文章不存在。</p>
                            <a href="${window.location.protocol}//${window.location.host}" class="back-to-home-link">&larr; 返回首页</a>
                        </header>
                    </article>
                `;
                commentsContainer.innerHTML = '';
            }
        };

        /**
         * Initializes Giscus comments section.
         * @param {string} currentPageId - A unique ID for the current page/post.
         * @param {object} giscusConfig - Giscus configuration from config.json.
         */
        const initGiscus = (currentPageId, giscusConfig) => {
            if (!giscusConfig || !giscusConfig.repo || !giscusConfig.repoId || !giscusConfig.category || !giscusConfig.categoryId) {
                console.warn("Giscus 配置不完整，评论功能将不会显示。请在 admin.html 中完善设置。");
                commentsContainer.innerHTML = '<p class="empty-state">评论功能未配置或配置不完整。管理员请检查后台“网站设置-评论”部分。</p>';
                return;
            }

            if (giscusScript) {
                // If Giscus script already exists, remove it to re-initialize for new page
                commentsContainer.innerHTML = '';
                giscusScript.remove();
            }

            const theme = body.classList.contains('dark-mode') ? 'dark_protanopia' : 'light'; // Pick theme based on blog theme

            giscusScript = document.createElement('script');
            giscusScript.src = 'https://giscus.app/client.js';
            giscusScript.setAttribute('data-repo', giscusConfig.repo);
            giscusScript.setAttribute('data-repo-id', giscusConfig.repoId);
            giscusScript.setAttribute('data-category', giscusConfig.category);
            giscusScript.setAttribute('data-category-id', giscusConfig.categoryId);
            giscusScript.setAttribute('data-mapping', 'specific'); // Use specific map, then use `id` or `title`
            giscusScript.setAttribute('data-term', currentPageId); // Use post.id as term to identify discussion
            giscusScript.setAttribute('data-strict', '0');
            giscusScript.setAttribute('data-reactions-enabled', '1');
            giscusScript.setAttribute('data-emit-metadata', '0');
            giscusScript.setAttribute('data-input-position', 'bottom');
            giscusScript.setAttribute('data-theme', theme);
            giscusScript.setAttribute('data-lang', 'zh-CN');
            giscusScript.setAttribute('crossorigin', 'anonymous');
            giscusScript.setAttribute('async', '');
            commentsContainer.appendChild(giscusScript);
        };

        /**
         * Handles routing based on URL hash.
         */
        const handleRoute = () => {
            const hash = window.location.hash;
            if (hash.startsWith('#')) {
                const postId = hash.substring(1); // Remove leading #
                renderSinglePost(postId);
            } else {
                renderPostList();
            }
            window.scrollTo(0, 0); // Scroll to top on route change
        };

        /**
         * Main function to load configuration and posts.
         */
        const main = async () => {
            try {
                // Determine GitHub Pages owner and repository from hostname
                const hostnameParts = window.location.hostname.split('.');
                const owner = hostnameParts[0];
                const repo = `${owner}.github.io`;
                // Determine base path for custom domains / subdirectories
                const pathParts = window.location.pathname.split('/').filter(p => p && p.toLowerCase() !== 'index.html');
                const basePath = pathParts.join('/');
                const getPath = (fileName) => basePath ? `${basePath}/${fileName}` : fileName;

                // Fetch configuration
                const configContent = await getFileFromApi(owner, repo, getPath('config.json'));
                if (!configContent) {
                     throw new Error('config.json 文件未找到。请确保该文件存在于您的GitHub仓库中。');
                }
                siteConfig = JSON.parse(configContent);

                // Apply site configuration
                blogTitleLink.textContent = siteConfig.site.title;
                blogTitleLink.href = '/';
                blogDescriptionEl.textContent = siteConfig.site.description;
                document.title = siteConfig.site.title || '博客';

                // Apply styling from config
                const {
                    backgroundColor,
                    textColor,
                    headingColor,
                    accentColor,
                    linkHoverColor,
                    borderColor,
                    cardBg,
                    cardShadow,
                    metaColor,
                    codeBg,
                    codeText,
                    footerBg,
                    darkModeEnabled,
                    backgroundImageUrl
                } = siteConfig.styling;

                if (backgroundColor) document.documentElement.style.setProperty('--bg-color', backgroundColor);
                if (textColor) document.documentElement.style.setProperty('--text-color', textColor);
                if (headingColor) document.documentElement.style.setProperty('--heading-color', headingColor);
                if (accentColor) {
                    document.documentElement.style.setProperty('--accent-color', accentColor);
                    // Extract RGB for dynamic RGBA colors if needed (for blockquote background)
                    const rgb = hexToRgb(accentColor);
                    if (rgb) {
                        document.documentElement.style.setProperty('--accent-color-rgb', `${rgb.r}, ${rgb.g}, ${rgb.b}`);
                    }
                }
                if (linkHoverColor) document.documentElement.style.setProperty('--link-hover-color', linkHoverColor);
                if (borderColor) document.documentElement.style.setProperty('--border-color', borderColor);
                if (cardBg) document.documentElement.style.setProperty('--card-bg', cardBg);
                if (cardShadow) document.documentElement.style.setProperty('--card-shadow', cardShadow);
                if (metaColor) document.documentElement.style.setProperty('--meta-color', metaColor);
                if (codeBg) document.documentElement.style.setProperty('--code-bg', codeBg);
                if (codeText) document.documentElement.style.setProperty('--code-text', codeText);
                if (footerBg) document.documentElement.style.setProperty('--footer-bg', footerBg);

                if (darkModeEnabled) {
                    body.classList.add('dark-mode');
                } else {
                    body.classList.remove('dark-mode');
                }

                if (backgroundImageUrl) {
                    body.style.backgroundImage = `url(${backgroundImageUrl})`;
                    body.style.backgroundSize = 'cover';
                    body.style.backgroundPosition = 'center';
                    body.style.backgroundAttachment = 'fixed';
                } else {
                    body.style.backgroundImage = 'none';
                }

                // Set copyright info
                const currentYear = new Date().getFullYear();
                copyrightInfoEl.textContent = `© ${currentYear} ${siteConfig.site.title}. All rights reserved.`;

                // Fetch posts data
                const postsContent = await getFileFromApi(owner, repo, getPath('posts.json'));
                if (!postsContent) {
                    allPosts = []; // No posts yet, initialize empty array
                } else {
                     allPosts = JSON.parse(postsContent);
                }

                // Initialize router and render content
                window.addEventListener('hashchange', handleRoute);
                handleRoute();

            } catch (error) {
                console.error("加载博客失败:", error);
                blogTitleLink.textContent = '博客加载失败';
                blogDescriptionEl.textContent = '发生错误。';
                postsListView.style.display = 'block';
                postsListView.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-alert-triangle"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        <h3>博客加载失败</h3>
                        <p><b>错误:</b> ${error.message}</p>
                        <p>请确认您的GitHub仓库中存在 <code>config.json</code> 和 <code>posts.json</code> 文件，且格式正确。</p>
                        <p>如果问题持续存在，请检查浏览器控制台了解更多详情。</p>
                    </div>
                `;
            } finally {
                // Hide loader and show content
                appLoader.classList.add('hidden');
                setTimeout(() => {
                    appLoader.style.display = 'none';
                    mainContainer.style.display = 'flex'; // Use flex for body and container
                    body.classList.remove('loading');
                }, 500); // Allow fade-out transition
            }
        };

        // Helper to convert hex color to RGB
        function hexToRgb(hex) {
            const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, function(m, r, g, b) {
                return r + r + g + g + b + b;
            });
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        // Scroll to top button logic
        window.onscroll = function() {
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                scrollToTopBtn.style.display = "block";
            } else {
                scrollToTopBtn.style.display = "none";
            }
        };

        scrollToTopBtn.addEventListener('click', () => {
            document.body.scrollTop = 0; // For Safari
            document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
        });

        // Event listener for main execution
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
