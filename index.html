<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的博客</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' font-size='90' text-anchor='middle' dominant-baseline='central'%3E✍️%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css">

    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --accent-color: #0d6efd;
            --header-bg: #ffffff;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --link-hover: #0a58ca;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
        }

        body.dark-mode {
            --bg-color: #282c36;
            --text-color: #abb2bf;
            --accent-color: #61afef;
            --header-bg: #21252b;
            --card-bg: #21252b;
            --border-color: #3e4451;
            --link-hover: #52a0e0;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: var(--header-bg);
            padding: 1.5rem 0;
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 0 15px;
        }

        h1 {
            margin: 0;
            font-size: 2.2rem;
            color: var(--text-color);
        }

        h1 a {
            color: inherit;
            text-decoration: none;
        }
        h2, h3, h4, h5, h6 { color: var(--text-color); }

        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        nav ul li {
            display: inline-block;
            margin-left: 20px;
        }

        nav a {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        nav a:hover {
            color: var(--link-hover);
        }

        main {
            flex-grow: 1;
            padding-bottom: 3rem;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
            word-wrap: break-word; /* 确保长单词不溢出 */
        }

        .post-list .card h2 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        .post-list .card h2 a {
            color: var(--text-color);
            text-decoration: none;
            transition: color 0.2s;
        }
        .post-list .card h2 a:hover {
            color: var(--accent-color);
        }

        .post-meta {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 15px;
        }

        .post-meta span {
            margin-right: 15px;
        }

        .post-meta a {
            color: #6c757d;
            text-decoration: none;
        }

        .post-meta a:hover {
            text-decoration: underline;
        }

        .post-content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1.5rem auto;
            border-radius: 8px;
        }
        .post-content iframe {
            max-width: 100%;
            display: block;
            margin: 1.5rem auto;
        }

        .read-more {
            display: inline-block;
            margin-top: 15px;
            padding: 8px 15px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 5px;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .read-more:hover {
            background-color: var(--link-hover);
        }

        #site-description {
            font-size: 1.1em;
            color: #6c757d;
            margin-top: 10px;
            margin-bottom: 1.5rem;
        }

        #about-page h2 {
            margin-top: 0;
            margin-bottom: 20px;
        }

        .markdown-body pre {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.9em;
            line-height: 1.4;
            margin-bottom: 1rem;
        }
        .markdown-body code {
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, Courier, monospace;
            background-color: rgba(175, 184, 193, 0.2);
            border-radius: 3px;
            padding: 0.2em 0.4em;
        }
        .markdown-body pre code {
            background: none;
            padding: 0;
        }
        .markdown-body blockquote {
            padding: 0 1em;
            color: #6a737d;
            border-left: 0.25em solid #dfe2e5;
            margin: 0;
            background-color: var(--bg-color);
        }
        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: left;
        }
        .markdown-body thead {
            background-color: #f6f8fa;
        }
        body.dark-mode .markdown-body thead {
            background-color: #3e4451;
        }

        footer {
            border-top: 1px solid var(--border-color);
            padding: 2rem 0;
            margin-top: 3rem;
            text-align: center;
            font-size: 0.9em;
            color: #6c757d;
            background-color: var(--header-bg); /* Use header-bg for footer too for consistency */
            box-shadow: 0 -0.125rem 0.25rem rgba(0,0,0,.025);
        }
        footer a { color: var(--accent-color); text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        /* Gitalk specific styles */
        #gitalk-container {
            padding: 25px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            header .container {
                text-align: center;
            }
            nav ul {
                margin-top: 1rem;
            }
            nav ul li {
                margin: 0 10px;
            }
            h1 {
                font-size: 1.8rem;
            }
             #site-description {
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1 id="site-title"><a href="#/">我的博客</a></h1>
            <p id="site-description">由GitHub驱动的现代化半静态博客</p>
            <nav>
                <ul>
                    <li><a href="#/" id="nav-home">首页</a></li>
                    <li><a href="#/about" id="nav-about">关于</a></li>
                    <li><a href="admin.html" target="_blank">后台管理</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        <div id="loading" style="text-align: center; padding: 50px; display: none;">
            <p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%236c757d' d='M73 50c0-12.7-10.3-23-23-23S27 37.3 27 50s10.3 23 23 23 23-10.3 23-23zm-23 20c-9.4 0-17-7.6-17-17s7.6-17 17-17 17 7.6 17 17-7.6 17-17 17z'%3E%3CanimateTransform attributeName='transform' type='rotate' calcMode='linear' values='0 50 50;360 50 50' keyTimes='0;1' dur='1.5s' repeatCount='indefinite'%3E%3C/animateTransform%3E%3C/path%3E%3C/svg%3E" alt="加载中..." style="width: 50px; height: 50px;"></p>
            <p>正在加载博客内容...</p>
        </div>

        <div id="posts-list-view" class="blog-view">
            <!-- 文章列表将渲染在这里 -->
        </div>

        <div id="post-detail-view" class="blog-view" style="display: none;">
            <article class="card">
                <h2 id="post-detail-title"></h2>
                <div class="post-meta">
                    <span id="post-detail-date"></span>
                    <span id="post-detail-category"></span>
                    <span id="post-detail-tags"></span>
                </div>
                <div id="post-detail-content" class="markdown-body"></div>
            </article>
            <div id="gitalk-container" style="margin-top: 30px;"></div>
        </div>

        <div id="about-page" class="blog-view card" style="display: none;">
            <h2>关于我</h2>
            <div id="about-content" class="markdown-body"></div>
        </div>

        <div id="not-found-page" class="blog-view card" style="display: none;">
            <h2>页面未找到 (404)</h2>
            <p>抱歉，您访问的页面不存在。</p>
            <p><a href="#/">返回首页</a></p>
        </div>
    </main>

    <footer id="blog-footer">
        <div class="container">
            <p>&copy; <span id="current-year"></span> <a href="#/">我的博客</a>. All rights reserved.</p>
            <p>Powered by <a href="https://github.com/rjdsq" target="_blank">期望ai</a></p>
        </div>
    </footer>

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Code Highlight -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <!-- Gitalk -->
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script>

    <script>
        // ==================== 全局变量和工具函数 ====================
        const utf8_to_b64 = (str) => btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
        const b64_to_utf8 = (str) => {
            try { return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); } catch (e) { return atob(str); }
        };

        const GitHubAPI = {
            BASE_URL: 'https://api.github.com',
            async request(token, endpoint, options = {}) {
                const url = `${this.BASE_URL}${endpoint}`;
                const headers = { 'Authorization': token ? `token ${token}` : undefined, 'Accept': 'application/vnd.github.v3+json', ...options.headers };
                if (!token) delete headers.Authorization; // Do not send Authorization header if token is not provided
                
                const response = await fetch(url, { ...options, headers });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP Error: ${response.statusText}`, documentation_url: response.url || endpoint }));
                    const errorMessage = errorData.message || `GitHub API request failed with status ${response.status}`;
                    console.error('GitHub API Error for frontend:', errorMessage, errorData);
                    throw new Error(`${errorMessage} (Path: ${endpoint})`);
                }
                if (response.status === 204 || response.headers.get("Content-Length") === "0") return null;
                return response.json();
            },
            async getFile(token, owner, repo, path) {
                try {
                    const result = await this.request(token, `/repos/${owner}/${repo}/contents/${path}`);
                    if (!result || typeof result.content !== 'string' || b64_to_utf8(result.content).trim().length === 0) {
                        console.warn(`File content for ${path} is empty, invalid, or file not found.`);
                        return null; 
                    }
                    return { content: b64_to_utf8(result.content), sha: result.sha };
                } catch (error) {
                    if (error.message.toLowerCase().includes('not found') || error.message.includes('file not found')) {
                        console.info(`File not found: ${path}. This is expected during initial setup or for non-existent files.`);
                        return null;
                    }
                    console.error(`Error fetching file ${path}:`, error);
                    throw error;
                }
            },
        };

        // GitHub Owner and global data (determined during initialization)
        let blogOwner = '';
        let blogRepo = '';
        let blogBasePath = ''; // Base path within the repo, e.g., 'blog' if hosted at user.github.io/blog/
        let siteConfig = null;
        let allPosts = [];

        // Utility function to detect GitHub repo and base path - REUSED from admin.html
        // 此函数不再依赖于`userLogin`，而是直接从`GitHubAPI.getUser`获取`user.login`
        async function detectRepoAndBasePath(userLoginFromApi) {
            const hostname = window.location.hostname; // e.g., pkq66882.github.io, custom.domain.com
            let pathSegments = window.location.pathname.split('/').filter(p => p); // e.g., ["ceishi", "admin.html"] or ["admin.html"]

            let detectedRepo = '';
            let detectedBasePath = '';

            // Remove admin.html or index.html from pathSegments for base path calculation
            if (pathSegments.length > 0 && 
                (['admin.html', 'index.html'].includes(pathSegments[pathSegments.length - 1].toLowerCase()))
            ) {
                pathSegments.pop();
            }

            if (hostname.endsWith('.github.io')) {
                const hostnamePrefix = hostname.replace('.github.io', ''); // e.g., "pkq66882"
                if (hostnamePrefix.toLowerCase() === userLoginFromApi.toLowerCase()) {
                    // User or Organization Page: username.github.io -> repo is hostname
                    detectedRepo = hostname; // e.g., "pkq66882.github.io"
                    detectedBasePath = pathSegments.join('/'); // e.g., "" (for root) or "blog" (for pkq66882.github.io/blog/)
                } else if (pathSegments.length > 0) {
                    // Project Page: username.github.io/reponame/ -> repo is pathSegments[0]
                    // e.g. https://pkq66882.github.io/ceishi/ -> repo='ceishi', basePath=''
                    detectedRepo = pathSegments[0];
                    detectedBasePath = pathSegments.slice(1).join('/'); // basePath is empty if index.html is directly in 'ceishi'
                } else {
                    // This case is unlikely for a github.io domain with content. Fallback.
                    detectedRepo = userLoginFromApi + '.github.io'; // Default to user page repo naming convention
                    detectedBasePath = '';
                }
            } else {
                // Custom domain or local development.
                if (pathSegments.length > 0) {
                    detectedRepo = pathSegments[0]; // e.g., "ceishi" if URL is http://local/ceishi/index.html
                    detectedBasePath = pathSegments.slice(1).join('/');
                } else {
                    // Fallback if no path segments (e.g., http://localhost/index.html)
                    detectedRepo = userLoginFromApi + '.github.io'; 
                    detectedBasePath = '';
                }
            }
            
            console.log(`Detected GitHub Info: Owner=${userLoginFromApi}, Repo=${detectedRepo}, BasePath="${detectedBasePath}"`);
            return { detectedRepo, detectedBasePath };
        }

        // ==================== UI 渲染函数 ====================
        const showLoading = (show) => {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        };

        const showView = (viewId) => {
            document.querySelectorAll('.blog-view').forEach(view => view.style.display = 'none');
            document.getElementById(viewId).style.display = 'block';
            resetGitalk(); // Hide Gitalk on view change, will be re-initialized for post-detail
        };

        const renderPostsList = () => {
            showView('posts-list-view');
            const postsListDiv = document.getElementById('posts-list-view');
            postsListDiv.innerHTML = ''; // 清空现有内容

            if (!allPosts || allPosts.length === 0) {
                postsListDiv.innerHTML = '<div class="card"><p style="text-align:center;">暂无文章。</p></div>';
                return;
            }

            allPosts.forEach(post => {
                const excerpt = post.content.split('<!--more-->')[0];
                const postElement = document.createElement('div');
                postElement.className = 'card';
                postElement.innerHTML = `
                    <h2><a href="#/post/${post.id}">${post.title}</a></h2>
                    <div class="post-meta">
                        <span>发布于 ${new Date(post.createdAt).toLocaleDateString()}</span>
                        <span>分类: ${post.category || '未分类'}</span>
                        <span>标签: ${post.tags && post.tags.length > 0 ? post.tags.join(', ') : '无'}</span>
                    </div>
                    <div class="markdown-body">${marked.parse(excerpt)}</div>
                    ${post.content.includes('<!--more-->') ? `<a href="#/post/${post.id}" class="read-more">阅读全文 &rarr;</a>` : ''}
                `;
                postsListDiv.appendChild(postElement);
            });
            hljs.highlightAll(); // 渲染代码高亮
        };

        const renderPostDetail = (postId) => {
            showView('post-detail-view');
            const post = allPosts.find(p => p.id === postId);

            if (!post) {
                showView('not-found-page');
                return;
            }

            document.getElementById('post-detail-title').textContent = post.title;
            document.getElementById('post-detail-date').textContent = `发布于 ${new Date(post.createdAt).toLocaleDateString()}`;
            document.getElementById('post-detail-category').textContent = `分类: ${post.category || '未分类'}`;
            document.getElementById('post-detail-tags').textContent = `标签: ${post.tags && post.tags.length > 0 ? post.tags.join(', ') : '无'}`;
            document.getElementById('post-detail-content').innerHTML = marked.parse(post.content);

            hljs.highlightAll(); // 渲染代码高亮

            // Gitalk comments
            if (siteConfig && siteConfig.gitalk && siteConfig.gitalk.enabled) {
                initializeGitalk(post);
            } else {
                document.getElementById('gitalk-container').style.display = 'none';
            }
        };

        const renderAboutPage = () => {
            showView('about-page');
            const aboutContentDiv = document.getElementById('about-content');
            const content = siteConfig?.site?.aboutContent || '# 关于我\n\n您可以使用后台管理系统来编辑此页面内容。';
            aboutContentDiv.innerHTML = marked.parse(content);
            hljs.highlightAll();
        };

        // ==================== Gitalk 评论初始化 ====================
        let gitalkInstance = null;
        const initializeGitalk = (post) => {
            const gitalkConfig = siteConfig.gitalk;
            if (!gitalkConfig || !gitalkConfig.enabled) {
                document.getElementById('gitalk-container').style.display = 'none';
                return;
            }
            document.getElementById('gitalk-container').style.display = 'block';

            // Gitalk requires a unique ID for each post as part of the GitHub Issue title/label
            // Max length for id is 50. Hash the post ID to ensure uniqueness and fit
            const getGitalkId = (str) => {
                let hash = 0;
                if (str.length === 0) return hash;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash |= 0; // Convert to 32bit integer
                }
                return `post-${Math.abs(hash)}`; // Using a hash based ID
            };
            const gitalkId = getGitalkId(post.id); 

            if (gitalkInstance) {
                // To properly handle hash changes and different posts, it's safer to destroy and re-create Gitalk.
                // Simply calling render might not update context fully for new 'id'.
                gitalkInstance = null; // Mark for recreation
                document.getElementById('gitalk-container').innerHTML = ''; // Clear container
            }

            // Always create a new instance for the specific post
            gitalkInstance = new Gitalk({
                clientID: gitalkConfig.clientID,
                clientSecret: gitalkConfig.clientSecret,
                repo: gitalkConfig.repo,
                owner: gitalkConfig.owner,
                admin: gitalkConfig.admin,
                id: gitalkId, // Unique ID for each post
                title: post.title, // Use post title as issue title
                labels: ['Gitalk', post.category || '未分类'],
                distractionFreeMode: false, // Facebook-like distraction free mode
                // You might need to set it for custom domains if the issue's URL is incorrect.
                // url: window.location.href, // This defaults to current URL. For gh-pages it works.
            });
            gitalkInstance.render('gitalk-container');
        };

        const resetGitalk = () => {
             if (gitalkInstance) {
                document.getElementById('gitalk-container').innerHTML = ''; // Clear the container
                gitalkInstance = null; // Nullify instance
             }
             document.getElementById('gitalk-container').style.display = 'none';
        };


        // ==================== 博客初始化 ====================
        const initializeBlog = async () => {
            showLoading(true);
            try {
                // 1. Get user to determine potential owner, this request doesn't need a token
                const user = await GitHubAPI.request(null, '/user'); 
                blogOwner = user.login;

                // 2. Dynamically detect repo and base path
                const { detectedRepo, detectedBasePath } = await detectRepoAndBasePath(blogOwner);
                blogRepo = detectedRepo;
                blogBasePath = detectedBasePath;
                
                // Helper to get path with determined basePath
                const getBlobPath = (fileName) => blogBasePath ? `${blogBasePath}/${fileName}` : fileName;

                // 3. Fetch config.json
                const configData = await GitHubAPI.getFile(null, blogOwner, blogRepo, getBlobPath('config.json'));
                if (!configData || !configData.content) {
                    throw new Error('config.json 文件未找到或为空。');
                }
                siteConfig = JSON.parse(configData.content);

                // 4. Fetch posts.json
                const postsData = await GitHubAPI.getFile(null, blogOwner, blogRepo, getBlobPath('posts.json'));
                if (!postsData) { // posts.json can be empty, but not null
                    console.warn("posts.json file not found or empty, initializing with empty array.");
                    allPosts = [];
                } else if (!postsData.content || postsData.content.trim() === '[]') {
                    console.warn("posts.json file is empty, initializing with empty array.");
                    allPosts = [];
                }
                 else {
                    allPosts = JSON.parse(postsData.content);
                }
                 allPosts.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));


                // Apply configurations
                document.title = siteConfig.site.title || '我的博客';
                document.getElementById('site-title').innerHTML = `<a href="#/">${siteConfig.site.title || '我的博客'}</a>`;
                document.getElementById('site-description').textContent = siteConfig.site.description || '由GitHub驱动的现代化半静态博客';
                
                document.body.style.backgroundColor = siteConfig.styling.backgroundColor || '';
                document.body.style.color = siteConfig.styling.textColor || '';
                document.documentElement.style.setProperty('--accent-color', siteConfig.styling.accentColor || '#0d6efd');
                document.documentElement.style.setProperty('--link-hover', siteConfig.styling.accentColor ? darkenColor(siteConfig.styling.accentColor, -15) : '#0a58ca'); // Auto-derive hover color

                if (siteConfig.styling.backgroundImageUrl) {
                    document.body.style.backgroundImage = `url(${siteConfig.styling.backgroundImageUrl})`;
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundAttachment = 'fixed';
                    document.body.style.backgroundPosition = 'center center';
                } else {
                    document.body.style.backgroundImage = 'none';
                }

                hljs.configure({
                    ignoreUnescapedHTML: true // markdown output may produce this
                });

                // Setup routing
                window.addEventListener('hashchange', handleRouteChange);
                handleRouteChange(); // Initial route handling
                
            } catch (error) {
                console.error("博客初始化失败:", error);
                document.getElementById('posts-list-view').innerHTML = `<div class="card alert-danger" style="color: grey; padding: 20px;">
                    <h2>博客加载错误</h2>
                    <p>无法加载博客内容。请检查GitHub Pages配置、仓库名或 ` + (blogBasePath ? `${blogBasePath}/config.json` : `config.json`) + `是否存在且内容正确。具体错误：${error.message}</p>
                    <p>如果你刚刚设置，请访问 <a href="admin.html" target="_blank">后台管理</a> 页面，填写你的 GitHub Token 登录，系统会自动创建必要文件。</p>
                </div>`;
                showView('posts-list-view'); // Show the error on the main view
            } finally {
                showLoading(false);
            }
        };

        // Function to darken or lighten a color (percentage is 0-100)
        function darkenColor(hex, percent) {
            let f = parseInt(hex.slice(1), 16),
                t = percent < 0 ? 0 : 255,
                p = percent < 0 ? percent * -1 : percent,
                R = f >> 16,
                G = (f >> 8) & 0x00ff,
                B = f & 0x0000ff;
            return "#" + (
                0x1000000 + (Math.round((t - R) * p / 100) + R) * 0x10000 +
                (Math.round((t - G) * p / 100) + G) * 0x100 +
                (Math.round((t - B) * p / 100) + B)
            ).toString(16).slice(1);
        }

        const handleRouteChange = () => {
            const path = window.location.hash.slice(1) || '/';
            if (path === '/') {
                renderPostsList();
            } else if (path === '/about') {
                renderAboutPage();
            } else if (path.startsWith('/post/')) {
                const postId = path.split('/')[2];
                renderPostDetail(postId);
            } else {
                showView('not-found-page');
            }
        };

        // Initial setup for footer year
        document.getElementById('current-year').textContent = new Date().getFullYear();

        // Start the blog initialization process
        document.addEventListener('DOMContentLoaded', initializeBlog);

        // Markdown renderer setup
        marked.setOptions({
            langPrefix: 'hljs language-', // highlight.js css expects this
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            gfm: true, // GitHub Flavored Markdown
            breaks: true, // Enable GFM line breaks
            // sanitize: true, // Prevent XSS by sanitizing HTML (can be problematic if you need custom HTML)
            // Removed sanitize: true because it can strip valid HTML often used in markdown, like custom styles or iframes.
            // If security is a major concern, consider a more robust sanitization library on the server-side,
            // or carefully review user-generated content before rendering.
        });
    </script>
</body>
</html>
