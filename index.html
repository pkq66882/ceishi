<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加载中...</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' font-size='90' text-anchor='middle' dominant-baseline='central'%3E✍️%3C/text%3E%3C/svg%3E" type="image/svg+xml">

    <!-- Gitalk CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css">
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/github-dark.min.css">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* Modern CSS Reset (simplified) */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        body, h1, h2, h3, h4, h5, h6, p, ul, ol, li, figure, figcaption, blockquote, dl, dd {
            margin: 0;
            padding: 0;
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            background-color: #f8f9fa; /* Default background */
            color: #212529; /* Default text color */
        }
        a {
            color: #0d6efd; /* Default accent color for links */
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        ul, ol {
            list-style: none; /* Remove default list styles */
        }
        img {
            max-width: 100%;
            height: auto;
            display: block;
        }
        pre {
            overflow-x: auto;
        }
        code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        }

        /* Layout and General Styling */
        #app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            flex-grow: 1; /* Allow container to grow */
        }

        header {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 20px 0;
            margin-bottom: 20px;
            text-align: center;
        }
        header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        header p {
            font-size: 1.1rem;
            color: #7f8c8d;
        }
        nav {
            margin-top: 15px;
        }
        nav a {
            margin: 0 15px;
            font-size: 1.1rem;
            font-weight: 500;
            color: #3498db;
            transition: color 0.2s ease;
        }
        nav a:hover {
            color: #2980b9;
        }

        footer {
            text-align: center;
            padding: 30px 20px;
            margin-top: 40px;
            background-color: #f0f2f5;
            color: #7f8c8d;
            font-size: 0.9rem;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.03);
        }
        footer a { color: #3498db; }

        /* Blog Post List */
        .post-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }
        .post-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); 
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            text-align: left;
            position: relative; /* 用于徽章定位 */
        }
        .post-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.12);
        }
        .post-card-image {
            width: 100%;
            height: 200px; 
            overflow: hidden;
            background-color: #e9ecef;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .post-card-image img {
            width: 100%;
            height: auto; /* 保持图片比例 */
            object-fit: cover; /* 裁剪以填充，保持比例 */
            min-height: 100%; /* 确保高度填充 */
        }
        .post-card-content {
            padding: 25px;
            flex-grow: 1;
        }
        .post-card h2 {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 12px;
            line-height: 1.3;
        }
        .post-card h2 a {
            color: inherit; /* 标题链接颜色继承 */
        }
        .post-card h2 a:hover {
            text-decoration: underline;
        }
        .post-card .meta {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap; 
        }
        .post-card .meta span {
            display: inline-flex;
            align-items: center;
        }
        .post-card .meta i {
            margin-right: 5px;
            color: #95a5a6;
        }
        .post-card .excerpt {
            font-size: 1rem;
            color: #5d6d7e;
            margin-bottom: 20px;
            line-height: 1.7;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .post-card .read-more {
            display: inline-block;
            background-color: #3498db;
            color: #fff;
            padding: 10px 18px;
            border-radius: 5px;
            font-size: 0.95rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        .post-card .read-more:hover {
            background-color: #2980b9;
            text-decoration: none;
        }
        /* New badge for post-card */
        .post-card .new-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--accent-color);
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
            font-weight: bold;
            border-bottom-left-radius: 8px;
            z-index: 10;
        }

        /* Single Post View */
        .post-full {
            background-color: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            text-align: left;
        }
        .post-full h1 {
            font-size: 2.8rem;
            color: #2c3e50;
            margin-bottom: 20px;
            line-height: 1.2;
        }
        .post-full .meta {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }
        .post-full .meta span {
            display: inline-flex;
            align-items: center;
        }
        .post-full .meta i {
            margin-right: 8px;
            color: #95a5a6;
        }
        .post-content {
            font-size: 1.05rem;
            color: #34495e;
            line-height: 1.8;
            word-wrap: break-word; /* 确保长单词换行 */
        }
        .post-content h1, .post-content h2, .post-content h3, .post-content h4, .post-content h5, .post-content h6 {
            color: #2c3e50;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #f0f0f0;
        }
        .post-content h1 { font-size: 2.5rem; }
        .post-content h2 { font-size: 2rem; }
        .post-content h3 { font-size: 1.7rem; }
        .post-content p {
            margin-bottom: 1em;
        }
        .post-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1.5rem auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .post-content blockquote {
            padding: 10px 20px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
            color: #5d6d7e;
            background-color: #f5fafd;
            border-radius: 5px;
        }
        .post-content pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 20px 0;
        }
        /* Highlight.js code color variables needed for dark theme */
        .hljs {
            background: #282c34 !important; 
            color: #abb2bf !important;
        }
        .post-content code {
            background-color: #e0e0e0;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.9em;
            word-break: break-all;
        }
        .post-content pre code {
            background-color: transparent;
            padding: 0;
            font-size: 1em;
            word-break: normal; 
        }
        .post-content ul, .post-content ol {
            margin-left: 25px;
            margin-bottom: 1em;
            list-style-type: disc; 
        }
        .post-content ol {
            list-style-type: decimal;
        }
        .post-content li {
            margin-bottom: 0.5em;
        }
        .post-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            overflow-x: auto;
            display: block;
        }
        .post-content th, .post-content td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        .post-content th {
            background-color: #f2f2f2;
        }

        /* About Page */
        .about-page {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            text-align: left;
        }
        .about-page h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .about-content {
             font-size: 1.05rem;
            color: #34495e;
            line-height: 1.8;
            word-wrap: break-word; /* 确保长单词换行 */
        }
        .about-content h2, .about-content h3 {
             color: #2c3e50;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #f0f0f0;
        }
        .about-content p { margin-bottom: 1em; }
        .about-content ul, .about-content ol {
            margin-left: 25px;
            margin-bottom: 1em;
            list-style-type: disc;
        }

        /* Error/Loading state */
        .loading, .error {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: #7f8c8d;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .loading i {
            margin-right: 10px;
            animation: spin 1.5s linear infinite;
        }
         @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Gitalk Styling Adjustments */
        #gitalk-container {
            margin-top: 40px;
            padding: 20px;
            background-color: #fdfdfd;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .gt-container {
            font-family: inherit; 
        }
        .gt-hd-text strong {
            color: inherit; 
        }
        .gt-hdr-btn {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .gt-hdr-btn:hover {
            background-color: var(--accent-hover);
            border-color: var(--accent-hover);
        }
        .gt-btn-public, .gt-btn-preview {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .gt-btn-public:hover, .gt-btn-preview:hover {
            background-color: var(--accent-hover);
            border-color: var(--accent-hover);
        }
        .gt-link, .gt-comment-username {
            color: var(--accent-color);
            text-decoration: none;
        }
        .gt-link:hover, .gt-comment-username:hover {
            text-decoration: underline;
        }
        /* Markdown-it generated list styles */
        .post-content ul, .post-content ol, .about-content ul, .about-content ol {
            padding-left: 20px;
            margin-left: 0;
            list-style-position: inside; 
        }
        .post-content ul li, .about-content ul li {
            list-style-type: disc;
        }
        .post-content ol li, .about-content ol li {
            list-style-type: decimal;
        }

        /* Responsiveness */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }
            header p {
                font-size: 1rem;
            }
            nav a {
                margin: 0 10px;
                font-size: 1rem;
            }
            .container {
                padding: 15px;
            }
            .post-list {
                grid-template-columns: 1fr;
            }
            .post-full, .about-page {
                padding: 25px;
            }
            .post-full h1 {
                font-size: 2rem;
            }
            .post-content, .about-content {
                font-size: 1rem;
            }
             .post-full .meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .post-card-image {
                height: 180px; 
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <div class="container">
                <h1 id="site-title"></h1>
                <p id="site-description"></p>
                <nav id="main-nav">
                    <!-- 修正导航链接，通过JS处理点击，防止#的出现 -->
                    <a href="javascript:void(0);" class="nav-link active" data-route="home">首页</a>
                    <a href="javascript:void(0);" class="nav-link" data-route="about">关于我</a>
                    <!-- adminLinkEl 的 href 会在 initializeBlog 中动态设置 -->
                    <a id="admin-link" target="_blank" class="nav-link admin-link">管理后台</a>
                </nav>
            </div>
        </header>

        <main class="container">
            <div id="loading" class="loading">
                <i class="fas fa-spinner fa-spin"></i> 博客初始化中...
            </div>
            <div id="blog-content">
                <!-- Blog content will be loaded here -->
            </div>
            <div id="gitalk-container" style="display: none;"></div>
        </main>

        <footer id="main-footer"></footer>
    </div>

    <!-- Markdown It and Highlight.js -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/json.min.js"></script>
    <!-- Font Awesome Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Gitalk JS -->
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script>

    <script>
        // ==================== 全局变量和工具函数 ====================
        const utf8_to_b64 = (str) => btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
        const b64_to_utf8 = (b64String) => {
            try {
                const binaryString = atob(b64String);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return new TextDecoder('utf-8').decode(bytes);
            } catch (e) {
                console.error("Base64 decoding to UTF-8 failed:", e);
                return atob(b64String); 
            }
        };

        // GitHubAPI_Frontend: 用于读取 raw.githubusercontent.com 上的公开文件
        const GitHubAPI_Frontend = {
            async getRawFile(owner, repo, path) {
                const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/main/${path}`;
                console.log(`[GitHubAPI_Frontend] Fetching raw file from: ${rawUrl}`);
                const response = await fetch(rawUrl);
                if (!response.ok) {
                    throw new Error(`无法加载文件 (${response.status} ${response.statusText} from ${rawUrl})`);
                }
                return response.json(); // 假设是 JSON 文件
            }
        };

        const md = new markdownit({
            html: true,
            linkify: true,
            typographer: true,
            highlight: function (str, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return '<pre><code class="hljs">' +
                               hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +
                               '</code></pre>';
                    } catch (__) {
                        console.warn('Highlight.js failed, falling back to basic escape.');
                    }
                }
                return '<pre><code class="hljs">' + md.utils.escapeHtml(str) + '</code></pre>';
            }
        });

        let siteConfig = null;
        let blogPosts = [];
        let owner = ''; 
        let repo = '';    
        let basePath = ''; 

        const appDiv = document.getElementById('app');
        const blogContentDiv = document.getElementById('blog-content');
        const loadingDiv = document.getElementById('loading');
        const siteTitleEl = document.getElementById('site-title');
        const siteDescriptionEl = document.getElementById('site-description');
        const mainFooterEl = document.getElementById('main-footer');
        const gitalkContainerEl = document.getElementById('gitalk-container');
        const adminLinkEl = document.getElementById('admin-link');


        const getFilePath = (fileName) => basePath ? `${basePath}/${fileName}` : fileName;

        const parseGitHubPath = (githubUsername) => {
            const hostname = window.location.hostname; 
            let pathSegments = window.location.pathname.split('/').filter(p => p); 

            if (pathSegments.length > 0 && 
                (pathSegments[pathSegments.length - 1].toLowerCase() === 'admin.html' || 
                 pathSegments[pathSegments.length - 1].toLowerCase() === 'index.html')) {
                pathSegments.pop();
            }

            let currentRepo = '';
            let currentBasePath = '';

            const hostnameLow = hostname.toLowerCase();
            const usernameLow = githubUsername.toLowerCase();
            const userGithubIoPattern = new RegExp(`^${usernameLow}\\.github\\.io$`);
            
            console.log(`[parseGitHubPath Debug] Hostname: ${hostname}, Username: ${githubUsername}, PathSegments: [${pathSegments.join(', ')}]`);

            if (userGithubIoPattern.test(hostnameLow) || /^localhost$|^127\.0\.0\.1$/.test(hostnameLow)) {
                if (pathSegments.length > 0) {
                    currentRepo = pathSegments[0]; 
                    currentBasePath = pathSegments.slice(1).join('/'); 
                    console.log(`[parseGitHubPath Debug] Case 1.1: Project Page under User.github.io or Local, Repo: "${currentRepo}", BasePath: "${currentBasePath}"`);
                } else {
                    currentRepo = hostnameLow; 
                    currentBasePath = '';
                    console.log(`[parseGitHubPath Debug] Case 1.2: User/Org Page Root, Repo: "${currentRepo}", BasePath: "${currentBasePath}"`);
                }
            } else if (hostnameLow.endsWith('.github.io')) { 
                 if (pathSegments.length > 0) {
                    currentRepo = pathSegments[0];
                    currentBasePath = pathSegments.slice(1).join('/');
                    console.log(`[parseGitHubPath Debug] Case 2.1: Generic .github.io Project Page, Repo: "${currentRepo}", BasePath: "${currentBasePath}"`);
                } else {
                    currentRepo = `${githubUsername}.github.io`; 
                    currentBasePath = '';
                    console.log(`[parseGitHubPath Debug] Case 2.2: Generic .github.io No Path, Default to User Repo, Repo: "${currentRepo}", BasePath: "${currentBasePath}"`);
                }
            } else { 
                if (pathSegments.length > 0) {
                    currentRepo = pathSegments[0];
                    currentBasePath = pathSegments.slice(1).join('/');
                    console.log(`[parseGitHubPath Debug] Case 3.1: Custom Domain Project Page, Repo: "${currentRepo}", BasePath: "${currentBasePath}"`);
                } else {
                    currentRepo = `${githubUsername}.github.io`; 
                    currentBasePath = '';
                    console.log(`[parseGitHubPath Debug] Case 3.2: Custom Domain User/Org Page Root, Repo: "${currentRepo}", BasePath: "${currentBasePath}"`);
                }
            }
            
            if (!currentRepo || currentRepo.trim() === '') {
                console.warn("[parseGitHubPath Debug] Final adjustment: currentRepo is empty or invalid, defaulting to user site repo.");
                currentRepo = `${githubUsername}.github.io`;
            }

            console.log(`[parseGitHubPath Final] Owner: ${githubUsername}, Repo: "${currentRepo}", BasePath: "${currentBasePath}"`);
            return { owner: githubUsername, repo: currentRepo, basePath: currentBasePath };
        };


        // ==================== 渲染函数 ====================
        const renderHomePage = () => {
            blogContentDiv.innerHTML = `<div class="post-list"></div>`;
            const postListContainer = blogContentDiv.querySelector('.post-list');

            if (blogPosts.length === 0) {
                postListContainer.innerHTML = `<div class="loading" style="grid-column: 1 / -1; font-weight: normal;">暂无文章。去<a href="${basePath ? `/${basePath}` : ''}/admin.html" target="_blank" style="margin-left: 5px;">管理后台</a>发布您的第一篇文章吧！</div>`;
                return;
            }

            blogContentDiv.style.display = 'block';
            gitalkContainerEl.style.display = 'none';

            blogPosts.forEach(post => {
                const excerpt = post.content.split('<!--more-->')[0].trim();
                const postCard = document.createElement('div');
                postCard.className = 'post-card';
                
                // 提取文章中的第一张图片作为封面图
                // 正则捕获 Alt Text 和 URL
                const firstImageMatch = post.content.match(/!\[(.*?)\]\((https?:\/\/[^\s)]+)\)/);
                let imageUrl = firstImageMatch ? firstImageMatch[2] : ''; // 捕获组2是URL
                let imageAlt = firstImageMatch ? firstImageMatch[1] : post.title; // 捕获组1是Alt Text

                // 统一图片 URL 处理逻辑
                imageUrl = processImageUrlForDisplay(imageUrl);
                
                const imagePreviewHtml = imageUrl ? `<div class="post-card-image"><img src="${imageUrl}" alt="${imageAlt}" loading="lazy"></div>` : '';

                postCard.innerHTML = `
                    ${imagePreviewHtml}
                    <div class="post-card-content">
                        <h2><a href="#/post/${post.id}">${post.title}</a></h2>
                        <div class="meta">
                            <span><i class="fas fa-calendar-alt"></i> ${new Date(post.createdAt).toLocaleDateString()}</span>
                            <span><i class="fas fa-tag"></i> ${post.category || '未分类'}</span>
                            ${post.tags && post.tags.length > 0 ? `<span><i class="fas fa-tags"></i> ${post.tags.join(', ')}</span>` : ''}
                        </div>
                        <div class="excerpt">${md.render(excerpt)}</div>
                        <a href="#/post/${post.id}" class="read-more">阅读全文 <i class="fas fa-arrow-right"></i></a>
                    </div>
                `;
                postListContainer.appendChild(postCard);
            });
        };

        const renderPostPage = (postId) => {
            const post = blogPosts.find(p => p.id === postId);
            if (!post) {
                blogContentDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> 文章未找到！</div>`;
                gitalkContainerEl.style.display = 'none';
                return;
            }

            // 对文章内容进行 Markdown 渲染
            // 确保渲染前，文章内容中的图片URL也被正确代理和编码
            let processedContent = post.content.replace(/!\[(.*?)\]\((https?:\/\/[^\s)]+)\)/g, (match, alt, url) => {
                const finalUrl = processImageUrlForDisplay(url);
                return `![${alt}](${finalUrl})`;
            });

            blogContentDiv.innerHTML = `
                <article class="post-full">
                    <h1>${post.title}</h1>
                    <div class="meta">
                        <span><i class="fas fa-calendar-alt"></i> ${new Date(post.createdAt).toLocaleDateString()}</span>
                        <span><i class="fas fa-edit"></i> ${new Date(post.updatedAt).toLocaleDateString()}</span>
                        <span><i class="fas fa-tag"></i> ${post.category || '未分类'}</span>
                        ${post.tags && post.tags.length > 0 ? `<span><i class="fas fa-tags"></i> ${post.tags.join(', ')}</span>` : ''}
                    </div>
                    <div class="post-content">${md.render(processedContent)}</div>
                </article>
            `;
            blogContentDiv.style.display = 'block';
            hljs.highlightAll(); 

            if (siteConfig && siteConfig.gitalk && siteConfig.gitalk.enabled) {
                gitalkContainerEl.innerHTML = '';
                gitalkContainerEl.style.display = 'block';

                const safePostId = post.id.replace(/[^a-zA-Z0-9-]/g, '').slice(0, 20); 
                const safeTitleSlug = md.utils.slugify(post.title).replace(/[^a-zA-Z0-9-]/g, '').slice(0, 30); 
                const gitalkId = `${safeTitleSlug}-${safePostId}`; 

                try {
                    const gitalk = new Gitalk({
                        clientID: siteConfig.gitalk.clientID,
                        clientSecret: siteConfig.gitalk.clientSecret,
                        repo: siteConfig.gitalk.repo,
                        owner: siteConfig.gitalk.owner,
                        admin: siteConfig.gitalk.admin,
                        id: gitalkId,
                        distractionFreeMode: siteConfig.gitalk.distractionFreeMode || false,
                        title: post.title,
                        labels: [...new Set([...(siteConfig.gitalk.labels || []), post.category || '未分类'])], 
                        body: `文章链接: ${window.location.href}\n\n${post.title}\n\n${post.content.split('<!--more-->')[0].trim().substring(0, 500)}...`,
                        createIssueManually: false,
                        perPage: siteConfig.gitalk.perPage || 10,
                    });
                    gitalk.render('gitalk-container');
                } catch (e) {
                     console.error("Gitalk initialization failed:", e);
                     gitalkContainerEl.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> Gitalk 评论加载失败: ${e.message}。请检查管理后台的评论设置。</div>`;
                }
            } else {
                gitalkContainerEl.style.display = 'none';
            }
        };

        const renderAboutPage = () => {
             blogContentDiv.innerHTML = `
                <div class="about-page">
                    <h1>关于我</h1>
                    <div class="about-content">${siteConfig && siteConfig.site.aboutContent ? md.render(siteConfig.site.aboutContent) : `<p>暂无内容。请前往<a href="${basePath ? `/${basePath}` : ''}/admin.html" target="_blank">管理后台</a>的“网站设置”编辑“关于我”页面。</p>`}</div>
                </div>
            `;
            blogContentDiv.style.display = 'block';
            gitalkContainerEl.style.display = 'none';
        };

        const render404Page = () => {
            blogContentDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> 页面未找到 (404)</div>`;
            blogContentDiv.style.display = 'block';
            gitalkContainerEl.style.display = 'none';
        };

        // 处理图片URL，确保只代理一次且编码正确
        const processImageUrlForDisplay = (rawUrl) => {
            if (!rawUrl) return '';

            let finalUrl = rawUrl;

            // 1. 如果url已经包含gh-proxy，则剥离gh-proxy，然后重新编码和代理
            if (finalUrl.startsWith('https://gh-proxy.com/')) {
                // 解码gh-proxy后的URL部分，以获取原始URL
                const urlAfterProxy = finalUrl.substring('https://gh-proxy.com/'.length);
                try {
                    // console.log("Decoding urlAfterProxy:", urlAfterProxy);
                    finalUrl = decodeURIComponent(urlAfterProxy);
                    // console.log("Decoded finalUrl:", finalUrl);
                } catch (e) {
                    console.warn("Could not decode part of image URL after gh-proxy, using as is:", e, urlAfterProxy);
                    finalUrl = urlAfterProxy; // Fallback if decoding fails
                }
            }
            
            // 2. 重新添加gh-proxy并对整个“内部URL”进行编码
            // 我们需要确保内部URL（raw.githubusercontent.com/...）的**路径部分**被正确编码，
            // 但是整个 `gh-proxy.com/` + `encodeURIComponent(目标URL)` 的结构是正确的
            // 假设 rawUrl 已经是可直接请求的 URL，encodeURIComponent 针对其中的特殊字符进行编码
            // 比如对于 `https://raw.githubusercontent.com/user/repo/main/images/你好.png`
            // encodeURIComponent 会处理 `你好.png`

            if (finalUrl) { 
                // 只对 raw.githubusercontent.com 这种 URL 做编码
                // 确保它是一个完整的可被代理的URL
                if (finalUrl.startsWith('https://raw.githubusercontent.com/')) {
                    // console.log("Final URL (before proxy+encode):", finalUrl);
                    finalUrl = `https://gh-proxy.com/${encodeURIComponent(finalUrl)}`;
                    // console.log("Final URL (after proxy+encode):", finalUrl);
                } else if (finalUrl.startsWith('http://') || finalUrl.startsWith('https://')) {
                    // 如果是其他外部链接，直接代理即可，因为其内部编码可能已由原网站处理
                    finalUrl = `https://gh-proxy.com/${encodeURIComponent(finalUrl)}`;
                }
                // else: 如果是相对路径或其他，不处理，可能被视为无效
            }

            return finalUrl;
        };


        // ==================== 路由处理 ====================
        const handleRoute = () => {
            const path = window.location.hash.slice(1);
            const navLinks = document.querySelectorAll('#main-nav .nav-link');
            navLinks.forEach(link => link.classList.remove('active'));

            if (path.startsWith('/post/')) {
                const postId = path.replace('/post/', '');
                renderPostPage(postId);
                const homeNavLink = document.querySelector('#main-nav a[data-route="home"]');
                if (homeNavLink) homeNavLink.classList.add('active'); 
            } else if (path === '/about') {
                renderAboutPage();
                const aboutNavLink = document.querySelector('#main-nav a[data-route="about"]');
                if (aboutNavLink) aboutNavLink.classList.add('active');
            } else { // 首页
                renderHomePage();
                const homeNavLink = document.querySelector('#main-nav a[data-route="home"]');
                if (homeNavLink) homeNavLink.classList.add('active');
            }
        };

        // ==================== 初始化博客 ====================
        const initializeBlog = async () => {
            loadingDiv.style.display = 'block';

            try {
                let tempOwner = window.location.hostname.split('.')[0];
                if (!tempOwner || tempOwner.toLowerCase() === 'localhost' || tempOwner.toLowerCase() === '127.0.0.1') {
                     tempOwner = prompt("请手动输入您的GitHub用户名 (例如: pkq66882):", "pkq66882");
                     if (!tempOwner) throw new Error("GitHub用户名是必须的。");
                }
                const resolvedOwner = tempOwner; 
                
                const parsedPath = parseGitHubPath(resolvedOwner);
                owner = parsedPath.owner; 
                repo = parsedPath.repo;   
                basePath = parsedPath.basePath; 

                console.log(`[index.html] Detected Owner: ${owner}, Repo: ${repo}, Base Path: "${basePath}"`);

                const rawBaseUrl = `https://raw.githubusercontent.com/${owner}/${repo}/main`;
                // 确保文件路径是相对于 basePath 的完整路径
                const configRawFilepath = getFilePath('config.json');
                const postsRawFilepath = getFilePath('posts.json');

                console.log(`[index.html] Attempting to fetch config.json from: ${rawBaseUrl}/${configRawFilepath}`);
                console.log(`[index.html] Attempting to fetch posts.json from: ${rawBaseUrl}/${postsRawFilepath}`);

                const fetchConfig = GitHubAPI_Frontend.getRawFile(owner, repo, configRawFilepath);
                const fetchPosts = GitHubAPI_Frontend.getRawFile(owner, repo, postsRawFilepath);

                const [configJson, postsJson] = await Promise.all([fetchConfig, fetchPosts]);

                if (!configJson || !postsJson || !Array.isArray(postsJson)) { 
                    throw new Error("博客核心文件 (config.json 或 posts.json) 未找到、为空或内容无效，请先前往管理后台初始化。");
                }

                siteConfig = configJson;
                // 对 posts 中的图片 URL 进行预处理/标准化（存储为原始 raw.githubusercontent.com URL）
                // 这里的处理是确保如果文章内容中保存的 URL 已经是 gh-proxy 的，则先将其还原成原始的 raw.githubusercontent.com URL
                // 这样在渲染时 processImageUrlForDisplay 函数就能得到一个干净的原始 URL
                blogPosts = postsJson.map(post => {
                    let newContent = post.content.replace(/!\[(.*?)\]\((https?:\/\/[^\s)]+)\)/g, (match, alt, url) => {
                        let processedUrl = url;
                        if (processedUrl.startsWith('https://gh-proxy.com/')) {
                            const urlAfterProxy = processedUrl.substring('https://gh-proxy.com/'.length);
                            try {
                                processedUrl = decodeURIComponent(urlAfterProxy);
                            } catch (e) {
                                console.warn("Error decoding URL part during post content standardization:", e, urlAfterProxy);
                            }
                        }
                        return `![${alt}](${processedUrl})`; // 存储为原始 URL
                    });
                    return { ...post, content: newContent };
                });

                const styleElement = document.createElement('style');
                styleElement.textContent = `
                    body {
                        background-color: ${siteConfig.styling.backgroundColor || '#f8f9fa'};
                        color: ${siteConfig.styling.textColor || '#212529'};
                        ${siteConfig.styling.backgroundImageUrl ? `
                            background-image: url("${processImageUrlForDisplay(siteConfig.styling.backgroundImageUrl)}");
                            background-size: cover;
                            background-attachment: fixed;
                            background-position: center;
                        ` : ''}
                    }
                    :root {
                        --accent-color: ${siteConfig.styling.accentColor || '#0d6efd'};
                        --accent-hover: ${siteConfig.styling.accentHover || '#2980b9'}; 
                        --header-bg-color: ${siteConfig.styling.headerBgColor || '#fff'};
                        --header-text-color: ${siteConfig.styling.headerTitleColor || '#2c3e50'}; 
                        --header-description-color: ${siteConfig.styling.headerDescriptionColor || '#7f8c8d'};
                        --footer-bg-color: ${siteConfig.styling.footerBgColor || '#f0f2f5'};
                        --footer-text-color: ${siteConfig.styling.footerTextColor || '#7f8c8d'};
                        --footer-link-color: ${siteConfig.styling.footerLinkColor || '#3498db'};
                    }

                    header {
                        background-color: var(--header-bg-color);
                    }
                    header h1 {
                         color: var(--header-text-color);
                    }
                    header p {
                         color: var(--header-description-color);
                    }
                    footer {
                        background-color: var(--footer-bg-color);
                        color: var(--footer-text-color);
                    }
                    footer a {
                        color: var(--footer-link-color);
                    }
                `;
                document.head.appendChild(styleElement);

                siteTitleEl.textContent = siteConfig.site.title || `${owner}的博客`;
                siteDescriptionEl.textContent = siteConfig.site.description || "一个由GitHub Pages驱动的现代化博客。";
                
                if (adminLinkEl) {
                    adminLinkEl.href = `${window.location.protocol}//${window.location.host}${basePath ? `/${basePath}` : ''}/admin.html`;
                }

                mainFooterEl.innerHTML = `
                    <p>&copy; ${new Date().getFullYear()} ${siteConfig.site.title || `${owner}的博客`}. All rights reserved. Powered by <a href="https://github.com/rjdsq" target="_blank">期望ai</a></p>
                `;

                handleRoute();

            } catch (error) {
                console.error("博客初始化失败:", error);
                document.title = "错误 - 博客";
                blogContentDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> 博客初始化失败: ${error.message}<br>请确保您的博客已在 <a href="${basePath ? `/${basePath}` : ''}/admin.html" target="_blank">管理后台</a> 完成初始化和配置。</div>`;
                blogContentDiv.style.display = 'block';
            } finally {
                loadingDiv.style.display = 'none';
            }
        };

        // Events
        window.addEventListener('hashchange', handleRoute);
        document.addEventListener('DOMContentLoaded', () => {
            initializeBlog(); 
            document.querySelector('#main-nav a[data-route="home"]').addEventListener('click', (e) => {
                e.preventDefault();
                // 导航到不带 hash 的基础 URL 并刷新页面，彻底清除 #
                const cleanUrl = window.location.origin + window.location.pathname;
                if (window.location.href !== cleanUrl) {
                    window.location.replace(cleanUrl);
                } else {
                    handleRoute(); // 如果是同一URL，手动触发路由处理器
                }
            });
            document.querySelector('#main-nav a[data-route="about"]').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.hash = '/about';
            });
        });
    </script>
</body>
</html>
