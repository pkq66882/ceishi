<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加载中...</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' font-size='90' text-anchor='middle' dominant-baseline='central'%3E✍️%3C/text%3E%3C/svg%3E" type="image/svg+xml">

    <!-- Gitalk CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css">
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/github-dark.min.css">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* Modern CSS Reset (simplified) */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        body, h1, h2, h3, h4, h5, h6, p, ul, ol, li, figure, figcaption, blockquote, dl, dd {
            margin: 0;
            padding: 0;
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            background-color: #f8f9fa; /* Default background */
            color: #212529; /* Default text color */
        }
        a {
            color: #0d6efd; /* Default accent color for links */
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        ul, ol {
            list-style: none; /* Remove default list styles */
        }
        img {
            max-width: 100%;
            height: auto;
            display: block;
        }
        pre {
            overflow-x: auto;
        }
        code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        }

        /* Layout and General Styling */
        #app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            flex-grow: 1; /* Allow container to grow */
        }

        header {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 20px 0;
            margin-bottom: 20px;
            text-align: center;
        }
        header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        header p {
            font-size: 1.1rem;
            color: #7f8c8d;
        }
        nav {
            margin-top: 15px;
        }
        nav a {
            margin: 0 15px;
            font-size: 1.1rem;
            font-weight: 500;
            color: #3498db;
            transition: color 0.2s ease;
        }
        nav a:hover {
            color: #2980b9;
        }

        footer {
            text-align: center;
            padding: 30px 20px;
            margin-top: 40px;
            background-color: #f0f2f5;
            color: #7f8c8d;
            font-size: 0.9rem;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.03);
        }
        footer a { color: #3498db; }

        /* Blog Post List */
        .post-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }
        .post-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); 
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            text-align: left;
            position: relative; /* Used for badge positioning */
        }
        .post-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.12);
        }
        .post-card-image {
            width: 100%;
            height: 200px; 
            overflow: hidden;
            background-color: #e9ecef;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .post-card-image img {
            width: 100%;
            height: auto; /* Preserve aspect ratio */
            object-fit: cover; /* Crop to fill, maintain aspect ratio */
            min-height: 100%; /* Ensure height fills */
        }
        .post-card-content {
            padding: 25px;
            flex-grow: 1;
        }
        .post-card h2 {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 12px;
            line-height: 1.3;
        }
        .post-card h2 a {
            color: inherit; /* Title link color inherits */
        }
        .post-card h2 a:hover {
            text-decoration: underline;
        }
        .post-card .meta {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap; 
        }
        .post-card .meta span {
            display: inline-flex;
            align-items: center;
        }
        .post-card .meta i {
            margin-right: 5px;
            color: #95a5a6;
        }
        .post-card .excerpt {
            font-size: 1rem;
            color: #5d6d7e;
            margin-bottom: 20px;
            line-height: 1.7;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .post-card .read-more {
            display: inline-block;
            background-color: #3498db;
            color: #fff;
            padding: 10px 18px;
            border-radius: 5px;
            font-size: 0.95rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        .post-card .read-more:hover {
            background-color: #2980b9;
            text-decoration: none;
        }
        /* New badge for post-card */
        .post-card .new-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--accent-color);
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
            font-weight: bold;
            border-bottom-left-radius: 8px;
            z-index: 10;
        }

        /* Single Post View */
        .post-full {
            background-color: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            text-align: left;
        }
        .post-full h1 {
            font-size: 2.8rem;
            color: #2c3e50;
            margin-bottom: 20px;
            line-height: 1.2;
        }
        .post-full .meta {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }
        .post-full .meta span {
            display: inline-flex;
            align-items: center;
        }
        .post-full .meta i {
            margin-right: 8px;
            color: #95a5a6;
        }
        .post-content {
            font-size: 1.05rem;
            color: #34495e;
            line-height: 1.8;
            word-wrap: break-word; /* Ensure long words break */
        }
        .post-content h1, .post-content h2, .post-content h3, .post-content h4, .post-content h5, .post-content h6 {
            color: #2c3e50;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #f0f0f0;
        }
        .post-content h1 { font-size: 2.5rem; }
        .post-content h2 { font-size: 2rem; }
        .post-content h3 { font-size: 1.7rem; }
        .post-content p {
            margin-bottom: 1em;
        }
        .post-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1.5rem auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .post-content blockquote {
            padding: 10px 20px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
            color: #5d6d7e;
            background-color: #f5fafd;
            border-radius: 5px;
        }
        .post-content pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 20px 0;
        }
        /* Highlight.js code color variables needed for dark theme */
        .hljs {
            background: #282c34 !important; /* Overwrite github-dark bg to match our pre */
            color: #abb2bf !important;
        }
        .post-content code {
            background-color: #e0e0e0;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.9em;
            word-break: break-all;
        }
        .post-content pre code {
            background-color: transparent;
            padding: 0;
            font-size: 1em;
            word-break: normal; 
        }
        .post-content ul, .post-content ol {
            margin-left: 25px;
            margin-bottom: 1em;
            list-style-type: disc; 
        }
        .post-content ol {
            list-style-type: decimal;
        }
        .post-content li {
            margin-bottom: 0.5em;
        }
        .post-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            overflow-x: auto;
            display: block;
        }
        .post-content th, .post-content td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        .post-content th {
            background-color: #f2f2f2;
        }

        /* About Page */
        .about-page {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            text-align: left;
        }
        .about-page h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .about-content {
             font-size: 1.05rem;
            color: #34495e;
            line-height: 1.8;
            word-wrap: break-word; /* Ensure long words break */
        }
        .about-content h2, .about-content h3 {
             color: #2c3e50;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #f0f0f0;
        }
        .about-content p { margin-bottom: 1em; }
        .about-content ul, .about-content ol {
            margin-left: 25px;
            margin-bottom: 1em;
            list-style-type: disc;
        }

        /* Error/Loading State */
        .loading, .error {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: #7f8c8d;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .loading i {
            margin-right: 10px;
            animation: spin 1.5s linear infinite;
        }
         @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Gitalk Styling Adjustments */
        #gitalk-container {
            margin-top: 40px;
            padding: 20px;
            background-color: #fdfdfd;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .gt-container {
            font-family: inherit; 
        }
        .gt-hd-text strong {
            color: inherit; 
        }
        .gt-hdr-btn {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .gt-hdr-btn:hover {
            background-color: var(--accent-hover);
            border-color: var(--accent-hover);
        }
        .gt-btn-public, .gt-btn-preview {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .gt-btn-public:hover, .gt-btn-preview:hover {
            background-color: var(--accent-hover);
            border-color: var(--accent-hover);
        }
        .gt-link, .gt-comment-username {
            color: var(--accent-color);
            text-decoration: none;
        }
        .gt-link:hover, .gt-comment-username:hover {
            text-decoration: underline;
        }
        /* Markdown-it generated list styles */
        .post-content ul, .post-content ol, .about-content ul, .about-content ol {
            padding-left: 20px;
            margin-left: 0;
            list-style-position: inside; 
        }
        .post-content ul li, .about-content ul li {
            list-style-type: disc;
        }
        .post-content ol li, .about-content ol li {
            list-style-type: decimal;
        }

        /* Responsiveness */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }
            header p {
                font-size: 1rem;
            }
            nav a {
                margin: 0 10px;
                font-size: 1rem;
            }
            .container {
                padding: 15px;
            }
            .post-list {
                grid-template-columns: 1fr;
            }
            .post-full, .about-page {
                padding: 25px;
            }
            .post-full h1 {
                font-size: 2rem;
            }
            .post-content, .about-content {
                font-size: 1rem;
            }
             .post-full .meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .post-card-image{
                height: 180px; 
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <div class="container">
                <h1 id="site-title"></h1>
                <p id="site-description"></p>
                <nav id="main-nav">
                    <!-- Home link uses JS to clear hash entirely -->
                    <a href="javascript:void(0);" class="nav-link active" data-route="home">首页</a>
                    <a href="javascript:void(0);" class="nav-link" data-route="about">关于我</a>
                    <!-- Admin link href will be set dynamically -->
                    <a id="admin-link" target="_blank" class="nav-link admin-link">管理后台</a>
                </nav>
            </div>
        </header>

        <main class="container">
            <div id="loading" class="loading">
                <i class="fas fa-spinner fa-spin"></i> 博客初始化中...
            </div>
            <div id="blog-content">
                <!-- Blog content will be loaded here -->
            </div>
            <div id="gitalk-container" style="display: none;"></div>
        </main>

        <footer id="main-footer"></footer>
    </div>

    <!-- Markdown It and Highlight.js -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/json.min.js"></script>
    <!-- Font Awesome Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Gitalk JS -->
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script>

    <script>
        // ==================== Global Variables & Utility Functions ====================
        const GitHubAPI_Frontend = {
            async getRawFile(owner, repo, path) {
                const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/main/${path}`;
                console.log(`[GitHubAPI_Frontend] Fetching raw file from: ${rawUrl}`);
                const response = await fetch(rawUrl);
                if (!response.ok) {
                    throw new Error(`无法加载文件 (${response.status} ${response.statusText} from ${rawUrl})`);
                }
                return response.json();
            }
        };

        const md = new markdownit({
            html: true,
            linkify: true,
            typographer: true,
            highlight: function (str, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return '<pre><code class="hljs">' +
                               hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +
                               '</code></pre>';
                    } catch (__) {
                        console.warn('Highlight.js failed, falling back to basic escape.');
                    }
                }
                return '<pre><code class="hljs">' + md.utils.escapeHtml(str) + '</code></pre>';
            }
        });

        let siteConfig = null;
        let blogPosts = [];
        let owner = ''; 
        let repo = '';    
        let basePath = ''; 

        const appDiv = document.getElementById('app');
        const blogContentDiv = document.getElementById('blog-content');
        const loadingDiv = document.getElementById('loading');
        const siteTitleEl = document.getElementById('site-title');
        const siteDescriptionEl = document.getElementById('site-description');
        const mainFooterEl = document.getElementById('main-footer');
        const gitalkContainerEl = document.getElementById('gitalk-container');
        const adminLinkEl = document.getElementById('admin-link');


        const getFilePath = (fileName) => basePath ? `${basePath}/${fileName}` : fileName;

        const parseGitHubPath = (githubUsername) => {
            const hostname = window.location.hostname; 
            let pathSegments = window.location.pathname.split('/').filter(p => p); 

            if (pathSegments.length > 0 && 
                (pathSegments[pathSegments.length - 1].toLowerCase() === 'admin.html' || 
                 pathSegments[pathSegments.length - 1].toLowerCase() === 'index.html')) {
                pathSegments.pop();
            }

            let currentRepo = '';
            let currentBasePath = '';

            const hostnameLow = hostname.toLowerCase();
            const usernameLow = githubUsername.toLowerCase();
            const userGithubIoPattern = new RegExp(`^${usernameLow}\\.github\\.io$`);
            
            console.log(`[parseGitHubPath Debug] Hostname: ${hostname}, Username: ${githubUsername}, PathSegments: [${pathSegments.join(', ')}]`);

            if (userGithubIoPattern.test(hostnameLow) || /^localhost$|^127\.0\.0\.1$/.test(hostnameLow)) {
                if (pathSegments.length > 0) {
                    currentRepo = pathSegments[0]; 
                    currentBasePath = pathSegments.slice(1).join('/'); 
                    console.log(`[parseGitHubPath Debug] Case 1.1: Project Page under User.github.io or Local, Repo: "${currentRepo}", BasePath: "${currentBasePath}"`);
                } else {
                    currentRepo = hostnameLow; 
                    currentBasePath = '';
                    console.log(`[parseGitHubPath Debug] Case 1.2: User/Org Page Root, Repo: "${currentRepo}", BasePath: "${currentBasePath}"`);
                }
            } else if (hostnameLow.endsWith('.github.io')) { 
                 if (pathSegments.length > 0) {
                    currentRepo = pathSegments[0];
                    currentBasePath = pathSegments.slice(1).join('/');
                    console.log(`[parseGitHubPath Debug] Case 2.1: Generic .github.io Project Page, Repo: "${currentRepo}", BasePath: "${currentBasePath}"`);
                } else {
                    currentRepo = `${githubUsername}.github.io`; 
                    currentBasePath = '';
                    console.log(`[parseGitHubPath Debug] Case 2.2: Generic .github.io No Path, Default to User Repo, Repo: "${currentRepo}", BasePath: "${currentBasePath}"`);
                }
            } else { 
                if (pathSegments.length > 0) {
                    currentRepo = pathSegments[0];
                    currentBasePath = pathSegments.slice(1).join('/');
                    console.log(`[parseGitHubPath Debug] Case 3.1: Custom Domain Project Page, Repo: "${currentRepo}", BasePath: "${currentBasePath}"`);
                } else {
                    currentRepo = `${githubUsername}.github.io`; 
                    currentBasePath = '';
                    console.log(`[parseGitHubPath Debug] Case 3.2: Custom Domain User/Org Page Root, Repo: "${currentRepo}", BasePath: "${currentBasePath}"`);
                }
            }
            
            if (!currentRepo || currentRepo.trim() === '') {
                console.warn("[parseGitHubPath Debug] Final adjustment: currentRepo is empty or invalid, defaulting to user site repo.");
                currentRepo = `${githubUsername}.github.io`;
            }

            console.log(`[parseGitHubPath Final] Owner: ${githubUsername}, Repo: "${currentRepo}", BasePath: "${currentBasePath}"`);
            return { owner: githubUsername, repo: currentRepo, basePath: currentBasePath };
        };

        // Unified function to process image URLs for display (adds gh-proxy and handles encoding)
        const processImageUrlForDisplay = (inputUrl) => {
            if (!inputUrl) return '';

            let processedUrl = inputUrl;

            // 1. Check if it's already proxied. If so, strip the proxy and decode to get the original raw URL.
            if (processedUrl.startsWith('https://gh-proxy.com/')) {
                const urlAfterProxy = processedUrl.substring('https://gh-proxy.com/'.length);
                try {
                    // Try to decode to get the original raw.githubusercontent.com URL
                    processedUrl = decodeURIComponent(urlAfterProxy);
                    console.log(`[processImageUrl] Decoded existing proxied URL to: ${processedUrl}`);
                } catch (e) {
                    console.warn(`[processImageUrl] Could not decode part of image URL after gh-proxy, using as is: ${e}, ${urlAfterProxy}`);
                    processedUrl = urlAfterProxy; // Fallback if decoding fails
                }
            }
            
            // 2. Now that we have the (hopefully) raw URL, apply gh-proxy and encode it properly.
            // This ensures only one layer of gh-proxy and correct encoding of the target URL.
            if (processedUrl) {
                // We only proxy http/https URLs. Relative paths should ideally not reach here or be ignored.
                if (processedUrl.startsWith('http://') || processedUrl.startsWith('https://')) {
                    const encodedTargetUrl = encodeURIComponent(processedUrl);
                    processedUrl = `https://gh-proxy.com/${encodedTargetUrl}`;
                    console.log(`[processImageUrl] Final proxied URL: ${processedUrl}`);
                } else {
                    console.warn(`[processImageUrl] Non-absolute URL not proxied: ${processedUrl}`);
                    // For non-absolute URLs (e.g., relative paths), we might return them as is,
                    // or null if we only support absolute URLs for proxying.
                    // For now, return as is (browser will try to resolve it).
                }
            }

            return processedUrl;
        };


        // ==================== Render Functions ====================
        const renderHomePage = () => {
            blogContentDiv.innerHTML = `<div class="post-list"></div>`;
            const postListContainer = blogContentDiv.querySelector('.post-list');

            if (blogPosts.length === 0) {
                postListContainer.innerHTML = `<div class="loading" style="grid-column: 1 / -1; font-weight: normal;">暂无文章。去<a href="${basePath ? `/${basePath}` : ''}/admin.html" target="_blank" style="margin-left: 5px;">管理后台</a>发布您的第一篇文章吧！</div>`;
                return;
            }

            blogContentDiv.style.display = 'block';
            gitalkContainerEl.style.display = 'none';

            blogPosts.forEach(post => {
                const excerpt = post.content.split('<!--more-->')[0].trim();
                const postCard = document.createElement('div');
                postCard.className = 'post-card';
                
                // Extract first image as cover image
                // Match ![alt text](url) - group 1 is alt, group 2 is URL
                const firstImageMatch = post.content.match(/!$$(.*?)$$$(https?:\/\/[^\s)]+)$/);
