<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加载中...</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' font-size='90' text-anchor='middle' dominant-baseline='central'%3E✍️%3C/text%3E%3C/svg%3E" type="image/svg+xml">

    <!-- Gitalk CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css">
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/github.min.css">
    <!-- Markdown-It CSS for basic markdown rendering -->
    <style>
        /* Modern CSS Reset (simplified) */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        body, h1, h2, h3, h4, h5, h6, p, ul, ol, li, figure, figcaption, blockquote, dl, dd {
            margin: 0;
            padding: 0;
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            background-color: #f8f9fa; /* Default background */
            color: #212529; /* Default text color */
        }
        a {
            color: #0d6efd; /* Default accent color for links */
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        ul, ol {
            list-style: none; /* Remove default list styles */
        }
        img {
            max-width: 100%;
            height: auto;
            display: block;
        }
        pre {
            overflow-x: auto;
        }
        code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        }

        /* Layout and General Styling */
        #app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            flex-grow: 1; /* Allow container to grow */
        }

        header {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 20px 0;
            margin-bottom: 20px;
            text-align: center;
        }
        header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        header p {
            font-size: 1.1rem;
            color: #7f8c8d;
        }
        nav {
            margin-top: 15px;
        }
        nav a {
            margin: 0 15px;
            font-size: 1.1rem;
            font-weight: 500;
            color: #3498db;
            transition: color 0.2s ease;
        }
        nav a:hover {
            color: #2980b9;
        }

        footer {
            text-align: center;
            padding: 30px 20px;
            margin-top: 40px;
            background-color: #f0f2f5;
            color: #7f8c8d;
            font-size: 0.9rem;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.03);
        }
        footer a { color: #3498db; }

        /* Blog Post List */
        .post-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }
        .post-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); /* 更柔和的阴影 */
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
        }
        .post-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.12);
        }
        .post-card-content {
            padding: 25px;
            flex-grow: 1;
        }
        .post-card h2 {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 12px;
            line-height: 1.3;
        }
        .post-card .meta {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap; 
        }
        .post-card .meta span {
            display: inline-flex;
            align-items: center;
        }
        .post-card .meta i {
            margin-right: 5px;
            color: #95a5a6;
        }
        .post-card .excerpt {
            font-size: 1rem;
            color: #5d6d7e;
            margin-bottom: 20px;
            line-height: 1.7;
        }
        .post-card .read-more {
            display: inline-block;
            background-color: #3498db;
            color: #fff;
            padding: 10px 18px;
            border-radius: 5px;
            font-size: 0.95rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        .post-card .read-more:hover {
            background-color: #2980b9;
            text-decoration: none;
        }

        /* Single Post View */
        .post-full {
            background-color: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        .post-full h1 {
            font-size: 2.8rem;
            color: #2c3e50;
            margin-bottom: 20px;
            line-height: 1.2;
        }
        .post-full .meta {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }
        .post-full .meta span {
            display: inline-flex;
            align-items: center;
        }
        .post-full .meta i {
            margin-right: 8px;
            color: #95a5a6;
        }
        .post-content {
            font-size: 1.05rem;
            color: #34495e;
            line-height: 1.8;
        }
        .post-content h1, .post-content h2, .post-content h3, .post-content h4, .post-content h5, .post-content h6 {
            color: #2c3e50;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #f0f0f0;
        }
        .post-content h1 { font-size: 2.5rem; }
        .post-content h2 { font-size: 2rem; }
        .post-content h3 { font-size: 1.7rem; }
        .post-content p {
            margin-bottom: 1em;
        }
        .post-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1.5rem 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .post-content blockquote {
            padding: 10px 20px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
            color: #5d6d7e;
            background-color: #f5fafd;
            border-radius: 5px;
        }
        .post-content pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 20px 0;
        }
        .post-content code {
            background-color: #e0e0e0;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .post-content pre code {
            background-color: transparent;
            padding: 0;
            font-size: 1em;
        }
        .post-content ul, .post-content ol {
            margin-left: 25px;
            margin-bottom: 1em;
            list-style-type: disc; /* Re-enable list bullets */
        }
        .post-content ol {
            list-style-type: decimal;
        }
        .post-content li {
            margin-bottom: 0.5em;
        }
        .post-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .post-content th, .post-content td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        .post-content th {
            background-color: #f2f2f2;
        }

        /* About Page */
        .about-page {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        .about-page h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .about-content {
             font-size: 1.05rem;
            color: #34495e;
            line-height: 1.8;
        }
        .about-content h2, .about-content h3 {
             color: #2c3e50;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #f0f0f0;
        }
        .about-content p { margin-bottom: 1em; }
        .about-content ul, .about-content ol {
            margin-left: 25px;
            margin-bottom: 1em;
            list-style-type: disc;
        }

        /* Error/Loading state */
        .loading, .error {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: #7f8c8d;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .loading i {
            margin-right: 10px;
            animation: spin 1.5s linear infinite;
        }
         @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Gitalk Styling Adjustments */
        #gitalk-container {
            margin-top: 40px;
            padding: 20px;
            background-color: #fdfdfd;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .gt-container {
            font-family: var(--font-body);
        }
        .gt-hd-text strong {
            color: var(--heading-color);
        }
        .gt-hdr-btn {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .gt-hdr-btn:hover {
            background-color: var(--accent-hover);
            border-color: var(--accent-hover);
        }
        .gt-btn-public, .gt-btn-preview {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .gt-btn-public:hover, .gt-btn-preview:hover {
            background-color: var(--accent-hover);
            border-color: var(--accent-hover);
        }
        .gt-link, .gt-comment-username {
            color: var(--accent-color);
            text-decoration: none;
        }
        .gt-link:hover, .gt-comment-username:hover {
            text-decoration: underline;
        }

        /* Responsiveness */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }
            header p {
                font-size: 1rem;
            }
            nav a {
                margin: 0 10px;
                font-size: 1rem;
            }
            .container {
                padding: 15px;
            }
            .post-list {
                grid-template-columns: 1fr;
            }
            .post-full, .about-page {
                padding: 25px;
            }
            .post-full h1 {
                font-size: 2rem;
            }
            .post-content, .about-content {
                font-size: 1rem;
            }
             .post-full .meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <div class="container">
                <h1 id="site-title"></h1>
                <p id="site-description"></p>
                <nav id="main-nav">
                    <a href="#/" class="nav-link active" data-route="home">首页</a>
                    <a href="#/about" class="nav-link" data-route="about">关于我</a>
                    <!-- 使用 basePath 构建 admin.html 链接 -->
                    <a href="${basePath ? `/${basePath}` : ''}/admin.html" target="_blank" class="nav-link admin-link">管理后台</a>
                </nav>
            </div>
        </header>

        <main class="container">
            <div id="loading" class="loading">
                <i class="fas fa-spinner fa-spin"></i> 博客初始化中...
            </div>
            <div id="blog-content">
                <!-- Blog content will be loaded here -->
            </div>
            <div id="gitalk-container" style="display: none;"></div>
        </main>

        <footer id="main-footer"></footer>
    </div>

    <!-- Markdown It and Highlight.js -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/json.min.js"></script>
    <!-- Font Awesome Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Gitalk JS -->
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script>

    <script>
        // ==================== 全局变量和工具函数 ====================
        const GitHubAPI = {
            BASE_URL: 'https://api.github.com',
            async request(token, endpoint) {
                const url = `${this.BASE_URL}${endpoint}`;
                const headers = { 
                    'Accept': 'application/vnd.github.v3+json', 
                };
                if (token) {
                    headers['Authorization'] = `token ${token}`;
                }

                const response = await fetch(url, { headers });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP Error: ${response.statusText}`, documentation_url: response.url || endpoint }));
                    const errorMessage = errorData.message || `GitHub API request failed with status ${response.status}`;
                    console.error('GitHub API Error (frontend):', errorMessage, errorData);
                    throw new Error(errorMessage);
                }
                if (response.status === 204 || response.headers.get("Content-Length") === "0") return null;
                return response.json();
            },
            async getFile(owner, repo, path, token = null) {
                try {
                    const result = await this.request(token, `/repos/${owner}/${repo}/contents/${path}`);
                    if (!result || typeof result.content !== 'string' || result.encoding !== 'base64') {
                        console.warn(`File content for ${path} is empty, invalid, or file not found.`);
                        return null; 
                    }
                    const decodedContent = atob(result.content);
                    return { content: decodedContent, sha: result.sha };
                } catch (error) {
                    if (String(error.message).toLowerCase().includes('not found') || String(error.message).includes('file not found') || String(error).includes('No content.')) {
                        console.info(`File not found: ${path}. This is expected if not initialized.`);
                        return null;
                    }
                    console.error(`Error fetching file ${path}:`, error);
                    throw error;
                }
            }
        };

        const md = new markdownit({
            html: true,
            linkify: true,
            typographer: true,
            highlight: function (str, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return '<pre><code class="hljs">' +
                               hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +
                               '</code></pre>';
                    } catch (__) {}
                }
                return '<pre><code class="hljs">' + md.utils.escapeHtml(str) + '</code></pre>';
            }
        });

        let siteConfig = null;
        let blogPosts = [];
        let owner = '';
        let repo = '';
        let basePath = '';

        const appDiv = document.getElementById('app');
        const blogContentDiv = document.getElementById('blog-content');
        const loadingDiv = document.getElementById('loading');
        const siteTitleEl = document.getElementById('site-title');
        const siteDescriptionEl = document.getElementById('site-description');
        const mainFooterEl = document.getElementById('main-footer');
        const gitalkContainerEl = document.getElementById('gitalk-container');

        // **通用路径解析函数** (与admin.html保持一致，确保行为统一)
        const parseGitHubPath = (githubUsername) => {
            const hostname = window.location.hostname;
            let pathSegments = window.location.pathname.split('/').filter(p => p);

            if (pathSegments.length > 0 && 
                (pathSegments[pathSegments.length - 1].toLowerCase() === 'admin.html' || 
                 pathSegments[pathSegments.length - 1].toLowerCase() === 'index.html')) {
                pathSegments.pop();
            }

            let currentRepo = '';
            let currentBasePath = '';

            const userDomainPattern = new RegExp(`^${githubUsername.toLowerCase()}\\.github\\.io$`);

            if (userDomainPattern.test(hostname)) {
                // 情况1: 用户/组织页面部署 (e.g., username.github.io/)
                // 或项目页面部署 (e.g., username.github.io/projectName/)，这里的 projectName 是 pathSegments[0]
                if (pathSegments.length > 0) {
                    currentRepo = pathSegments[0]; // projectRepoName, e.g., 'ceishi'
                    currentBasePath = pathSegments.slice(1).join('/'); // 如果是 'ceishi/sub/admin.html' => basePath = 'sub'
                } else {
                    currentRepo = hostname; // user.github.io for root deployment
                    currentBasePath = '';
                }
            } else if (hostname.endsWith('.github.io')) {
                // 可能是其他用户的项目页面托管在本项目域下，或域名不匹配
                // 暂时按照项目页面处理
                if (pathSegments.length > 0) {
                    currentRepo = pathSegments[0];
                    currentBasePath = pathSegments.slice(1).join('/');
                } else {
                    currentRepo = `${githubUsername}.github.io`; 
                    currentBasePath = '';
                }
            }
            else { // 自定义域名
                if (pathSegments.length > 0) {
                    currentRepo = pathSegments[0]; // 假设 custom.com/my-blog/ => my-blog
                    currentBasePath = pathSegments.slice(1).join('/');
                } else {
                    // 没有 pathname 段，假设 CNAME 直接指向用户/组织仓库根目录
                    currentRepo = `${githubUsername}.github.io`; 
                    currentBasePath = '';
                }
            }
            
            // 最终修正：如果 currentRepo 仍然为空，或者无法准确判断，提供一个合理的 fallback
            if (!currentRepo) {
                currentRepo = `${githubUsername}.github.io`; 
            }
            // 重要：确保 Gitalk 的 repo 设置与实际部署的 repo 名称一致。
            // 您的截图显示仓库是 pkq66882/ceishi，所以无论域名如何，实际操作的 GitHub 仓库就是 'ceishi'
            // 如果 `owner` 是 `pkq66882` 且 `hostname` 是 `pkq66882.github.io`
            // 并且 `pathSegments` (去掉 `admin.html`/`index.html`) 的第一个元素是 `ceishi`
            // 那么 `repo` 应该是 `ceishi`，`basePath` 应该只包含 `ceishi` 之后的部分。
            if (hostname.startsWith(githubUsername.toLowerCase()) && hostname.endsWith('.github.io') && pathSegments.length > 0) {
                currentRepo = pathSegments[0]; // e.g., "ceishi"
                currentBasePath = pathSegments.slice(1).join('/'); // e.g., "" if URL is /ceishi/index.html
            } else if (currentRepo.endsWith('.github.io') && pathSegments.length > 0) {
                // 比如是 custom.com/ceishi/admin.html 这种情况，hostname不是user.github.io但有path
                // 这表明 repo 是 pathSegments[0], basePath是之后的部分
                currentRepo = pathSegments[0];
                currentBasePath = pathSegments.slice(1).join('/');
            }


            return { owner: githubUsername, repo: currentRepo, basePath: currentBasePath };
        };


        const getFilePath = (fileName) => basePath ? `${basePath}/${fileName}` : fileName;

        // ==================== 渲染函数 ====================
        const renderHomePage = () => {
            blogContentDiv.innerHTML = `<div class="post-list"></div>`;
            const postListContainer = blogContentDiv.querySelector('.post-list');

            if (blogPosts.length === 0) {
                postListContainer.innerHTML = `<div class="loading" style="grid-column: 1 / -1; font-weight: normal;">暂无文章。去<a href="${basePath ? `/${basePath}` : ''}/admin.html" target="_blank" style="margin-left: 5px;">管理后台</a>发布您的第一篇文章吧！</div>`;
                return;
            }

            blogContentDiv.style.display = 'block';
            gitalkContainerEl.style.display = 'none';

            blogPosts.forEach(post => {
                const excerpt = post.content.split('<!--more-->')[0].trim();
                const postCard = document.createElement('div');
                postCard.className = 'post-card';
                postCard.innerHTML = `
                    <div class="post-card-content">
                        <h2><a href="#/post/${post.id}">${post.title}</a></h2>
                        <div class="meta">
                            <span><i class="fas fa-calendar-alt"></i> ${new Date(post.createdAt).toLocaleDateString()}</span>
                            <span><i class="fas fa-tag"></i> ${post.category || '未分类'}</span>
                            ${post.tags && post.tags.length > 0 ? `<span><i class="fas fa-tags"></i> ${post.tags.join(', ')}</span>` : ''}
                        </div>
                        <div class="excerpt">${md.render(excerpt)}</div>
                        <a href="#/post/${post.id}" class="read-more">阅读全文 <i class="fas fa-arrow-right"></i></a>
                    </div>
                `;
                postListContainer.appendChild(postCard);
            });
        };

        const renderPostPage = (postId) => {
            const post = blogPosts.find(p => p.id === postId);
            if (!post) {
                blogContentDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> 文章未找到！</div>`;
                gitalkContainerEl.style.display = 'none';
                return;
            }

            blogContentDiv.innerHTML = `
                <article class="post-full">
                    <h1>${post.title}</h1>
                    <div class="meta">
                        <span><i class="fas fa-calendar-alt"></i> ${new Date(post.createdAt).toLocaleDateString()}</span>
                        <span><i class="fas fa-edit"></i> ${new Date(post.updatedAt).toLocaleDateString()}</span>
                        <span><i class="fas fa-tag"></i> ${post.category || '未分类'}</span>
                        ${post.tags && post.tags.length > 0 ? `<span><i class="fas fa-tags"></i> ${post.tags.join(', ')}</span>` : ''}
                    </div>
                    <div class="post-content">${md.render(post.content)}</div>
                </article>
            `;
            blogContentDiv.style.display = 'block';
            hljs.highlightAll();

            if (siteConfig && siteConfig.gitalk && siteConfig.gitalk.enabled) {
                gitalkContainerEl.innerHTML = '';
                gitalkContainerEl.style.display = 'block';

                let gitalkIdSource = `${post.title}-${postId}`;
                if (gitalkIdSource.length > 50) gitalkIdSource = gitalkIdSource.slice(0, 50); // Trim if too long

                try {
                    const gitalk = new Gitalk({
                        clientID: siteConfig.gitalk.clientID,
                        clientSecret: siteConfig.gitalk.clientSecret,
                        repo: siteConfig.gitalk.repo,
                        owner: siteConfig.gitalk.owner,
                        admin: siteConfig.gitalk.admin,
                        id: gitalkIdSource,
                        distractionFreeMode: siteConfig.gitalk.distractionFreeMode,
                        title: post.title,
                        labels: [...siteConfig.gitalk.labels, post.category || '未分类'], 
                        body: `文章链接: ${window.location.href}\n\n${post.title}\n\n${post.content.split('<!--more-->')[0].trim().substring(0, 500)}...`,
                        createIssueManually: false,
                        perPage: siteConfig.gitalk.perPage,
                    });
                    gitalk.render('gitalk-container');
                } catch (e) {
                     console.error("Gitalk initialization failed:", e);
                     gitalkContainerEl.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> Gitalk 评论加载失败: ${e.message}。请检查管理后台的评论设置。</div>`;
                }
            } else {
                gitalkContainerEl.style.display = 'none';
            }
        };

        const renderAboutPage = () => {
             blogContentDiv.innerHTML = `
                <div class="about-page">
                    <h1>关于我</h1>
                    <div class="about-content">${siteConfig && siteConfig.site.aboutContent ? md.render(siteConfig.site.aboutContent) : `<p>暂无内容。请前往<a href="${basePath ? `/${basePath}` : ''}/admin.html" target="_blank">管理后台</a>的“网站设置”编辑“关于我”页面。</p>`}</div>
                </div>
            `;
            blogContentDiv.style.display = 'block';
            gitalkContainerEl.style.display = 'none';
        };

        const render404Page = () => {
            blogContentDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> 页面未找到 (404)</div>`;
            blogContentDiv.style.display = 'block';
            gitalkContainerEl.style.display = 'none';
        };

        // ==================== 路由处理 ====================
        const handleRoute = () => {
            const path = window.location.hash.slice(1);
            const navLinks = document.querySelectorAll('#main-nav .nav-link');
            navLinks.forEach(link => link.classList.remove('active'));

            if (path.startsWith('/post/')) {
                const postId = path.replace('/post/', '');
                renderPostPage(postId);
                document.querySelector('#main-nav a[data-route="home"]').classList.add('active');
            } else if (path === '/about') {
                renderAboutPage();
                document.querySelector('#main-nav a[data-route="about"]').classList.add('active');
            } else {
                renderHomePage();
                document.querySelector('#main-nav a[data-route="home"]').classList.add('active');
            }
        };

        // ==================== 初始化博客 ====================
        const initializeBlog = async () => {
            loadingDiv.style.display = 'block';

            try {
                // Step 1: 获取当前GitHub用户名 (可以从URL或LocalStorage获取，这里假设直接从hostname推断)
                let tempOwner = window.location.hostname.split('.')[0];
                if (!tempOwner || tempOwner.toLowerCase() === 'localhost') { // for local testing safety
                     tempOwner = prompt("请手动输入您的GitHub用户名 (例如: pkq66882):", "pkq66882");
                     if (!tempOwner) throw new Error("GitHub用户名是必须的。");
                }
                owner = tempOwner;

                // Step 2: 动态解析 repo 和 basePath
                const parsedPath = parseGitHubPath(owner);
                repo = parsedPath.repo;
                basePath = parsedPath.basePath;

                console.log(`[index.html] Detected Owner: ${owner}, Repo: ${repo}, Base Path: "${basePath}"`);

                // Step 3: 获取 config.json 和 posts.json
                const configData = await GitHubAPI.getFile(owner, repo, getFilePath('config.json'));
                const postsData = await GitHubAPI.getFile(owner, repo, getFilePath('posts.json'));

                if (!configData || !postsData) {
                    throw new Error("博客核心文件 (config.json 或 posts.json) 未找到或为空，请先前往管理后台初始化。");
                }

                siteConfig = JSON.parse(configData.content);
                blogPosts = JSON.parse(postsData.content);

                // Apply dynamic styles
                document.body.style.backgroundColor = siteConfig.styling.backgroundColor || '#f8f9fa';
                document.body.style.color = siteConfig.styling.textColor || '#212529';
                // Update nav links and other elements that use accent color.
                // This is a minimal example; a more robust solution would be to use CSS variables via JS.
                const styleElement = document.createElement('style');
                styleElement.textContent = `
                    body {
                        background-color: ${siteConfig.styling.backgroundColor || '#f8f9fa'};
                        color: ${siteConfig.styling.textColor || '#212529'};
                        ${siteConfig.styling.backgroundImageUrl ? `
                            background-image: url(${siteConfig.styling.backgroundImageUrl});
                            background-size: cover;
                            background-attachment: fixed;
                            background-position: center;
                        ` : ''}
                    }
                    a { color: ${siteConfig.styling.accentColor || '#0d6efd'}; }
                    a:hover { color: ${siteConfig.styling.accentHover || '#2980b9'}; }
                    .post-card .read-more { background-color: ${siteConfig.styling.accentColor || '#3498db'}; }
                    .post-card .read-more:hover { background-color: ${siteConfig.styling.accentHover || '#2980b9'}; }
                    .post-content blockquote { border-left-color: ${siteConfig.styling.accentColor || '#3498db'}; background-color: ${siteConfig.styling.accentColor + '08' || '#f5fafd'}; }
                    .post-full .meta i { color: ${siteConfig.styling.accentColor || '#95a5a6'}; }
                    .gt-hdr-btn, .gt-btn-public, .gt-btn-preview { background-color: ${siteConfig.styling.accentColor || '#3498db'}; border-color: ${siteConfig.styling.accentColor || '#3498db'}; }
                    .gt-hdr-btn:hover, .gt-btn-public:hover, .gt-btn-preview:hover { background-color: ${siteConfig.styling.accentHover || '#2980b9'}; border-color: ${siteConfig.styling.accentHover || '#2980b9'}; }
                    .gt-link, .gt-comment-username { color: ${siteConfig.styling.accentColor || '#0d6efd'}; }
                `;
                document.head.appendChild(styleElement);


                // Populate header and footer
                siteTitleEl.textContent = siteConfig.site.title || `${owner}的博客`;
                siteDescriptionEl.textContent = siteConfig.site.description || "一个由GitHub Pages驱动的现代化博客。";
                
                // Construct admin link correctly
                const adminLinkEl = document.querySelector('.admin-link');
                if (adminLinkEl) {
                    adminLinkEl.href = `${basePath ? `/${basePath}` : ''}/admin.html`;
                }

                mainFooterEl.innerHTML = `
                    <p>&copy; ${new Date().getFullYear()} ${siteConfig.site.title || `${owner}的博客`}. All rights reserved. Powered by <a href="https://github.com/rjdsq" target="_blank">期望ai</a></p>
                `;

                handleRoute();

            } catch (error) {
                console.error("博客初始化失败:", error);
                document.title = "错误 - 博客";
                blogContentDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> 博客初始化失败: ${error.message}<br>请确保您的博客已在 <a href="${basePath ? `/${basePath}` : ''}/admin.html" target="_blank">管理后台</a> 完成初始化和配置。</div>`;
                blogContentDiv.style.display = 'block';
            } finally {
                loadingDiv.style.display = 'none';
            }
        };

        // Events
        window.addEventListener('hashchange', handleRoute);
        document.addEventListener('DOMContentLoaded', initializeBlog);
    </script>
</body>
</html>
