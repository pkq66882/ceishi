<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ blogTitle || '正在加载...' }}</title>
    <!-- Favicon -->
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <!-- Google Fonts - Opt for system fonts if privacy is a concern, or self-host -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <!-- Highlight.js CSS for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-markdown.min.css">
    <!-- Basic CSS Themes (Light/Dark) - Using inline style for simplicity, but consider external SCSS/CSS files -->
    <style>
        /* Base Variables (Light Theme Defaults) */
        :root {
            --font-serif: 'Merriweather', serif;
            --font-sans: 'Lato', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Hiragino Sans GB", "Microsoft YaHei", sans-serif;

            --bg-color: #f8f9fa; /* Light background */
            --text-color: #212529; /* Dark text */
            --heading-color: #343a40; /* Darker headings */
            --accent-color: #0d6efd; /* Primary accent blue */
            --accent-hover-color: #0a58ca; /* Darker accent on hover */
            --secondary-text-color: #6c757d; /* Muted text */
            --border-color: #dee2e6; /* Light border */
            --card-bg: #fff; /* Card background */
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Soft shadow */
            --card-shadow-hover: 0 6px 16px rgba(0, 0, 0, 0.12); /* Enhanced shadow on hover */

            --code-bg: #f6f8fa; /* Light code background */
            --code-text: #24292e; /* Dark code text */

            --header-bg: var(--card-bg);
            --header-shadow: var(--card-shadow);
            --footer-bg: var(--bg-color);
            --transition-duration: 0.3s ease;
        }

        /* Dark Theme Variables */
        body.dark-mode {
            --bg-color: #282c34; /* Dark background */
            --text-color: #abb2bf; /* Light text */
            --heading-color: #e0e6ed; /* Lighter headings */
            --accent-color: #61afef; /* Primary accent blue (dark mode) */
            --accent-hover-color: #528fc8; /* Darker accent on hover */
            --secondary-text-color: #6c757d; /* Muted text */
            --border-color: #3e4451; /* Dark border */
            --card-bg: #323842; /* Dark card background */
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            --card-shadow-hover: 0 6px 16px rgba(0, 0, 0, 0.3);

            --code-bg: #1e2127;
            --code-text: #abb2bf;

            --header-bg: var(--card-bg);
            --header-shadow: var(--card-shadow);
            --footer-bg: var(--bg-color);
        }

        /* General Body & Typography */
        body {
            font-family: var(--font-sans);
            line-height: 1.7;
            color: var(--text-color);
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            transition: background-color var(--transition-duration), color var(--transition-duration);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-serif);
            color: var(--heading-color);
            margin-top: 1.5em;
            margin-bottom: 0.8em;
            font-weight: 700;
            transition: color var(--transition-duration);
        }

        a {
            color: var(--accent-color);
            text-decoration: none;
            transition: color var(--transition-duration);
        }

        a:hover {
            color: var(--accent-hover-color);
        }

        p {
            margin-bottom: 1em;
        }
        
        strong {
            font-weight: 700;
        }

        /* Layout Container */
        .container {
            max-width: 960px; /* Wider container for better content display */
            margin: 0 auto;
            padding: 1.5rem;
            flex-grow: 1; /* Allow content to grow */
        }

        /* Header */
        .site-header {
            padding: 2.5rem 0;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2.5rem;
            background-color: var(--header-bg);
            border-radius: 12px;
            box-shadow: var(--header-shadow);
            transition: background-color var(--transition-duration), box-shadow var(--transition-duration), border-color var(--transition-duration);
            position: relative;
            clip-path: inset(0 round 12px); /* Ensures shadow and border-radius play nicely */
        }

        .site-title {
            font-size: 2.8rem;
            margin: 0;
            color: var(--heading-color);
            transition: color var(--transition-duration);
        }

        .site-description {
            font-size: 1.1rem;
            margin: 15px 0 0;
            color: var(--secondary-text-color);
            transition: color var(--transition-duration);
        }
        
        /* Theme Toggle */
        .theme-toggle {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--secondary-text-color);
            transition: color var(--transition-duration);
            padding: 0;
            line-height: 1; /* Aligns icon better */
        }

        .theme-toggle:hover {
            color: var(--accent-color);
        }

        /* Post Excerpt (List Item) */
        .post-excerpt {
            background-color: var(--card-bg);
            margin-bottom: 2.5rem;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            transition: box-shadow var(--transition-duration), background-color var(--transition-duration);
            overflow: hidden; /* For rounded corners with inner elements */
        }

        .post-excerpt:hover {
            box-shadow: var(--card-shadow-hover);
        }

        .post-title {
            margin: 0 0 15px;
        }

        .post-title a {
            font-size: 2rem; /* Larger title for readability */
            color: var(--heading-color);
            text-decoration: none;
            transition: color var(--transition-duration);
            display: inline-block; /* Allows hover effect on full text */
        }

        .post-title a:hover {
            color: var(--accent-color);
        }

        .post-meta {
            font-size: 0.9rem;
            color: var(--secondary-text-color);
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem; /* Spacing between meta items */
        }
        
        .post-meta span {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .badge {
            display: inline-block;
            padding: 0.4em 0.8em;
            margin-right: 0.5em;
            border-radius: 50px;
            font-size: 0.8em;
            background-color: var(--border-color);
            color: var(--secondary-text-color);
            transition: background-color var(--transition-duration), color var(--transition-duration);
        }
        
        .badge:hover {
            background-color: var(--accent-color);
            color: #fff;
        }

        .post-summary {
            color: var(--text-color);
            margin-bottom: 1.8rem;
            word-wrap: break-word;
        }

        .post-summary p:last-of-type {
            margin-bottom: 0;
        }

        .post-images-preview {
            display: grid;
            grid-gap: 15px;
            margin-bottom: 1.8rem;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Larger image previews */
        }

        .post-images-preview img {
            width: 100%;
            height: 180px; /* Taller images */
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .post-images-preview img:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,.15);
        }

        .read-more-btn {
            display: inline-block;
            padding: 10px 22px;
            background-color: var(--accent-color);
            color: #fff;
            border-radius: 50px; /* Pill shape */
            font-size: 1rem;
            transition: background-color var(--transition-duration), transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,.1);
        }

        .read-more-btn:hover {
            background-color: var(--accent-hover-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,.15);
        }

        /* Footer */
        .site-footer {
            text-align: center;
            padding: 2.5rem 1.5rem;
            margin-top: 2rem;
            border-top: 1px solid var(--border-color);
            color: var(--secondary-text-color);
            font-size: 0.95rem;
            background-color: var(--footer-bg);
            transition: background-color var(--transition-duration), border-color var(--transition-duration), color var(--transition-duration);
        }
        
        .site-footer p {
            margin: 0;
        }

        /* Post Detail View */
        #post-detail-view {
            display: none;
            background-color: var(--card-bg);
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            transition: background-color var(--transition-duration), box-shadow var(--transition-duration);
        }

        .post-full-header {
            margin-bottom: 2.5rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            transition: border-color var(--transition-duration);
        }

        .post-full-title {
            font-size: 3rem; /* Larger title */
            color: var(--heading-color);
            margin: 0 0 1.2rem;
            line-height: 1.2;
            transition: color var(--transition-duration);
        }

        .post-full-meta {
            font-size: 1rem;
            color: var(--secondary-text-color);
            transition: color var(--transition-duration);
        }

        .post-full-content {
            font-size: 1.15rem; /* Increased base font size for readability */
            word-wrap: break-word;
            color: var(--text-color);
            transition: color var(--transition-duration);
        }
        
        .post-full-content p, 
        .post-full-content li {
            line-height: 1.9;
        }

        .post-full-content h1, 
        .post-full-content h2, 
        .post-full-content h3, 
        .post-full-content h4, 
        .post-full-content h5, 
        .post-full-content h6 {
            color: var(--heading-color);
            margin-top: 2.5rem;
            font-family: var(--font-serif);
        }

        .post-full-content h2 { font-size: 2.2rem; margin-bottom: 1rem; }
        .post-full-content h3 { font-size: 1.8rem; margin-bottom: 0.8rem; }
        .post-full-content h4 { font-size: 1.5rem; margin-bottom: 0.6rem; }

        .post-full-content p {
            margin-bottom: 1.5rem;
        }

        .post-full-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 2rem 0;
            box-shadow: 0 4px 10px rgba(0,0,0,.1);
            display: block; /* Centers block images */
            margin-left: auto;
            margin-right: auto;
        }

        .post-full-content blockquote {
            margin: 2rem 0;
            padding: 1.5rem 2rem;
            border-left: 5px solid var(--accent-color);
            color: var(--secondary-text-color);
            background-color: var(--bg-color);
            border-radius: 8px;
            font-style: italic;
            transition: background-color var(--transition-duration), border-color var(--transition-duration), color var(--transition-duration);
        }
        
        .post-full-content blockquote p {
            margin-bottom: 0;
        }

        .post-full-content pre {
            background-color: var(--code-bg);
            color: var(--code-text);
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            line-height: 1.6;
            margin: 2rem 0;
            transition: background-color var(--transition-duration), color var(--transition-duration);
        }

        .post-full-content code {
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            background-color: var(--code-bg);
            color: var(--code-text);
            padding: 0.2em 0.4em;
            border-radius: 4px;
        }
        
        .post-full-content pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        .back-to-home {
            display: inline-block;
            margin-top: 3rem;
            font-size: 1.1rem;
            color: var(--accent-color);
            padding: 10px 15px;
            border: 1px solid var(--accent-color);
            border-radius: 50px;
            transition: background-color var(--transition-duration), color var(--transition-duration), border-color var(--transition-duration);
        }

        .back-to-home:hover {
            background-color: var(--accent-color);
            color: #fff;
        }
        
        /* Search & Filter Section */
        .filter-section {
            margin-bottom: 2.5rem;
            padding: 1.5rem;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: background-color var(--transition-duration), box-shadow var(--transition-duration);
        }

        .filter-section label {
            font-weight: 700;
            color: var(--heading-color);
        }

        .filter-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: border-color var(--transition-duration), background-color var(--transition-duration), color var(--transition-duration);
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.2);
        }
        
        .tag-cloud, .category-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            margin-top: 0.5rem;
        }
        
        .tag-cloud .tag-item, .category-list .category-item {
            padding: 8px 15px;
            border-radius: 50px;
            background-color: var(--border-color);
            color: var(--secondary-text-color);
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color var(--transition-duration), color var(--transition-duration);
        }
        
        .tag-cloud .tag-item:hover, .category-list .category-item:hover {
            background-color: var(--accent-color);
            color: #fff;
        }
        
        .tag-cloud .tag-item.active, .category-list .category-item.active {
            background-color: var(--accent-color);
            color: #fff;
            font-weight: 700;
        }
        
        /* Loading States */
        .loading-message {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: var(--secondary-text-color);
        }
        
        /* Comments Section */
        #comments-section {
            margin-top: 3rem;
            padding-top: 2.5rem;
            border-top: 1px solid var(--border-color);
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .site-header {
                padding: 2rem 0;
                margin-bottom: 1.5rem;
            }

            .site-title {
                font-size: 2.2rem;
            }

            .site-description {
                font-size: 1rem;
            }
            
            .theme-toggle {
                top: 1rem;
                right: 1rem;
                font-size: 1.3rem;
            }

            .post-excerpt {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .post-title a {
                font-size: 1.6rem;
            }

            .post-images-preview {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                grid-gap: 10px;
            }
            
            .post-images-preview img {
                height: 100px;
            }

            #post-detail-view {
                padding: 1.5rem;
            }

            .post-full-title {
                font-size: 2rem;
            }

            .post-full-content {
                font-size: 1rem;
            }
            
            .filter-section {
                padding: 1rem;
                flex-direction: column;
                gap: 0.8rem;
            }
        }
    </style>
</head>
<body :class="{ 'dark-mode': isDarkMode }">
    <div id="app" class="container">
        <header id="site-header" class="site-header">
            <button class="theme-toggle" @click="toggleTheme" aria-label="Toggle theme">
                <span v-if="isDarkMode">&#9728;</span> <!-- Sun icon -->
                <span v-else>&#9790;</span> <!-- Moon icon -->
            </button>
            <h1 class="site-title">{{ blogTitle }}</h1>
            <p class="site-description">{{ blogDescription }}</p>
        </header>

        <main>
            <!-- Posts List View -->
            <transition name="fade" mode="out-in">
                <div v-if="!currentPostId" key="list" id="posts-list-view">
                    <div v-if="loading" class="loading-message">
                        <p>正在加载文章...</p>
                    </div>
                    <div v-else-if="filteredPosts.length > 0">
                        <!-- Search and Filter Section -->
                        <div class="filter-section">
                            <label for="search-input">搜索文章:</label>
                            <input
                                type="text"
                                id="search-input"
                                v-model="searchTerm"
                                placeholder="输入关键词搜索..."
                                class="filter-input"
                            />
                            
                            <template v-if="allCategories.length > 0">
                                <label>分类:</label>
                                <div class="category-list">
                                    <span 
                                        class="category-item" 
                                        :class="{ active: activeCategory === null }" 
                                        @click="setActiveCategory(null)">全部</span>
                                    <span 
                                        v-for="category in allCategories" 
                                        :key="category" 
                                        class="category-item" 
                                        :class="{ active: activeCategory === category }" 
                                        @click="setActiveCategory(category)">
                                        {{ category }}
                                    </span>
                                </div>
                            </template>

                            <template v-if="allTags.length > 0">
                                <label>标签:</label>
                                <div class="tag-cloud">
                                    <span 
                                        class="tag-item" 
                                        :class="{ active: activeTag === null }" 
                                        @click="setActiveTag(null)">全部</span>
                                    <span 
                                        v-for="tag in allTags" 
                                        :key="tag" 
                                        class="tag-item" 
                                        :class="{ active: activeTag === tag }" 
                                        @click="setActiveTag(tag)">
                                        {{ tag }}
                                    </span>
                                </div>
                            </template>
                        </div>

                        <article v-for="post in paginatedFilteredPosts" :key="post.id" class="post-excerpt">
                            <header class="post-header">
                                <h2 class="post-title"><a :href="'#/post/' + post.id" @click.prevent="openPost(post.id)">{{ post.title }}</a></h2>
                                <p class="post-meta">
                                    <span>🗓️ {{ formatDate(post.createdAt) }}</span>
                                    <span v-if="post.category">分类: <span class="badge">{{ post.category }}</span></span>
                                    <span v-if="post.tags && post.tags.length > 0">标签: 
                                        <span v-for="tag in post.tags" :key="tag" class="badge">{{ tag }}</span>
                                    </span>
                                </p>
                            </header>
                            <div class="post-summary" v-html="excerptContent(post.content)"></div>
                            <div v-if="getImagesFromContent(post.content).length > 0" class="post-images-preview">
                                <img v-for="(img, index) in getImagesFromContent(post.content).slice(0, 3)" :key="index" :src="img" alt="Post image preview">
                            </div>
                            <a :href="'#/post/' + post.id" @click.prevent="openPost(post.id)" class="read-more-btn">阅读全文 &rarr;</a>
                        </article>

                        <!-- Basic Pagination (optional, for many posts) -->
                        <div v-if="totalPages > 1" class="pagination-controls" style="text-align: center; margin-top: 2rem;">
                            <button @click="currentPage--" :disabled="currentPage === 1" class="read-more-btn" style="margin-right: 1rem;">&larr; 上一页</button>
                            <span>页 {{ currentPage }} / {{ totalPages }}</span>
                            <button @click="currentPage++" :disabled="currentPage === totalPages" class="read-more-btn" style="margin-left: 1rem;">下一页 &rarr;</button>
                        </div>

                    </div>
                    <div v-else class="loading-message">
                        <p>暂无匹配的文章。开始您的第一篇创作吧！</p>
                    </div>
                </div>

                <!-- Post Detail View -->
                <div v-else-if="currentPost" key="detail" id="post-detail-view">
                    <article class="post-full">
                        <header class="post-full-header">
                            <h1 class="post-full-title">{{ currentPost.title }}</h1>
                            <p class="post-full-meta">
                                🗓️ 发布于 {{ formatDate(currentPost.createdAt) }}
                                <template v-if="currentPost.category">| 分类: <span class="badge">{{ currentPost.category }}</span></template>
                                <template v-if="currentPost.tags && currentPost.tags.length > 0">
                                    | 标签: <span v-for="tag in currentPost.tags" :key="tag" class="badge">{{ tag }}</span>
                                </template>
                            </p>
                        </header>
                        <section class="post-full-content" v-html="renderedPostContent"></section>
                        <a href="#" @click.prevent="backToHome" class="back-to-home">&larr; 返回首页</a>
                    </article>
                    
                    <!-- Comments Section -->
                    <div id="comments-section">
                        <h3>评论</h3>
                        <div id="utterances-comments" v-if="commentsConfig.type === 'utterances'"></div>
                        <div id="gitalk-comments" v-else-if="commentsConfig.type === 'gitalk'"></div>
                        <!-- You can add other comment systems here -->
                        <div v-else-if="!commentsConfig.type" style="text-align: center; color: var(--secondary-text-color);">
                            评论功能未配置。
                        </div>
                    </div>
                </div>

                <div v-else key="not-found" id="post-detail-view">
                    <article class="post-full">
                        <h1 class="post-full-title">404 - 未找到文章</h1>
                        <p>抱歉，您要查找的文章不存在。</p>
                        <a href="#" @click.prevent="backToHome" class="back-to-home">&larr; 返回首页</a>
                    </article>
                </div>
            </transition>
        </main>

        <footer class="site-footer">
            <p>&copy; {{ new Date().getFullYear() }} {{ blogTitle }}. All rights reserved.</p>
            <p>Powered by GitHub Pages with ❤️</p>
        </footer>
    </div>

    <!-- Vue.js CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- Marked.js CDN for Markdown to HTML conversion -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js CDN for code syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Highlight.js language packs (optional, add only what you need) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/css.min.js"></script>
    <!-- Add more languages as needed -->

    <script>
        // Setup Marked.js for Markdown parsing with Highlight.js
        marked.setOptions({
            // Use GitHub Flavored Markdown
            gfm: true,
            // Prefix for "id" for headings (optional)
            headerIds: true,
            // Sanitize input (disabled here as we trust our content, enable if users can post raw markdown)
            sanitize: false,
            // Highlight code blocks
            highlight: function(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            // Custom renderer to add classes or modify elements
            renderer: new marked.Renderer()
        });

        const app = Vue.createApp({
            data() {
                return {
                    blogTitle: '加载中...',
                    blogDescription: '',
                    allPosts: [],
                    loading: true,
                    currentPostId: null,
                    currentPost: null,
                    siteConfig: {},
                    isDarkMode: false,
                    searchTerm: '',
                    activeCategory: null,
                    activeTag: null,
                    postsPerPage: 6, // Number of posts per page
                    currentPage: 1,
                    commentsConfig: {}
                };
            },
            computed: {
                filteredPosts() {
                    let posts = [...this.allPosts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    // Filter by search term
                    if (this.searchTerm) {
                        const lowerSearchTerm = this.searchTerm.toLowerCase();
                        posts = posts.filter(post =>
                            post.title.toLowerCase().includes(lowerSearchTerm) ||
                            post.content.toLowerCase().includes(lowerSearchTerm) ||
                            (post.tags && post.tags.some(tag => tag.toLowerCase().includes(lowerSearchTerm))) ||
                            (post.category && post.category.toLowerCase().includes(lowerSearchTerm))
                        );
                    }

                    // Filter by active category
                    if (this.activeCategory) {
                        posts = posts.filter(post => post.category === this.activeCategory);
                    }

                    // Filter by active tag
                    if (this.activeTag) {
                        posts = posts.filter(post => post.tags && post.tags.includes(this.activeTag));
                    }
                    
                    this.currentPage = 1; // Reset page when filters change
                    return posts;
                },
                paginatedFilteredPosts() {
                    const start = (this.currentPage - 1) * this.postsPerPage;
                    const end = start + this.postsPerPage;
                    return this.filteredPosts.slice(start, end);
                },
                totalPages() {
                    return Math.ceil(this.filteredPosts.length / this.postsPerPage);
                },
                renderedPostContent() {
                    if (this.currentPost && this.currentPost.content) {
                        // Markdown content is rendered to HTML by Marked.js
                        return marked.parse(this.currentPost.content);
                    }
                    return '';
                },
                allCategories() {
                    const categories = new Set();
                    this.allPosts.forEach(post => {
                        if (post.category) categories.add(post.category);
                    });
                    return Array.from(categories).sort();
                },
                allTags() {
                    const tags = new Set();
                    this.allPosts.forEach(post => {
                        if (post.tags) post.tags.forEach(tag => tags.add(tag));
                    });
                    return Array.from(tags).sort();
                }
            },
            methods: {
                b64_to_utf8(str) {
                    try { return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); } catch (e) { return atob(str); }
                },
                async getFileFromApi(owner, repo, path) {
                    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
                    const response = await fetch(url, { cache: "no-store" });
                    if (!response.ok) {
                        if (response.status === 404) return null; // File not found, not an error for initial setup
                        throw new Error(`无法从GitHub API获取文件 (${path}): ${response.status} ${response.statusText}`);
                    }
                    const data = await response.json();
                    if (typeof data.content !== 'string') throw new Error(`API返回的文件内容格式不正确: ${path}`);
                    return this.b64_to_utf8(data.content);
                },
                formatDate(dateString) {
                    return new Date(dateString).toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
                },
                excerptContent(content) {
                    const moreMarker = '<!--more-->';
                    const markerIndex = content.indexOf(moreMarker);
                    let summary = '';
                    if (markerIndex !== -1) {
                        summary = marked.parse(content.substring(0, markerIndex));
                    } else {
                        // If no marker, take first 150 words from plain text, then render as markdown (for simpler formatting)
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = marked.parse(content); // First convert markdown to HTML for cleaner text extraction
                        summary = tempDiv.textContent.substring(0, 200) + (tempDiv.textContent.length > 200 ? '...' : '');
                        summary = marked.parse(summary); // Render the truncated text as markdown
                    }
                    return summary;
                },
                getImagesFromContent(content) {
                    const tempDiv = document.createElement('div');
                    // Render markdown to HTML temporarily to extract image sources reliably
                    tempDiv.innerHTML = marked.parse(content);
                    return Array.from(tempDiv.querySelectorAll('img')).map(img => img.src);
                },
                toggleTheme() {
                    this.isDarkMode = !this.isDarkMode;
                    localStorage.setItem('theme', this.isDarkMode ? 'dark' : 'light');
                },
                setActiveCategory(category) {
                    this.activeCategory = category;
                },
                setActiveTag(tag) {
                    this.activeTag = tag;
                },
                openPost(postId) {
                    this.currentPostId = postId;
                    this.currentPost = this.allPosts.find(p => p.id === postId) || null;
                    if (this.currentPost) {
                        document.title = `${this.currentPost.title} - ${this.siteConfig.site.title}`;
                        // Delay comment system load to ensure DOM element is ready
                        this.$nextTick(() => {
                            this.loadComments(this.currentPost.id, this.currentPost.title);
                        });
                    } else {
                        document.title = `未找到文章 - ${this.siteConfig.site.title}`;
                    }
                    window.location.hash = `#/post/${postId}`;
                    window.scrollTo(0, 0); // Scroll to top
                },
                backToHome() {
                    this.currentPostId = null;
                    this.currentPost = null;
                    document.title = this.siteConfig.site.title || '博客';
                    window.location.hash = ''; // Clear hash
                    window.scrollTo(0, 0); // Scroll to top
                },
                loadComments(postId, postTitle) {
                    const commentsConfig = this.commentsConfig;
                    if (!commentsConfig || !commentsConfig.type) {
                        console.warn('评论功能未配置。');
                        return;
                    }

                    // Clean up existing comments widget if any
                    const existingU = document.getElementById('utterances-comments');
                    if (existingU) existingU.innerHTML = '';
                    const existingG = document.getElementById('gitalk-comments');
                    if (existingG) existingG.innerHTML = '';


                    if (commentsConfig.type === 'utterances' && commentsConfig.utterances) {
                        const script = document.createElement('script');
                        script.src = 'https://utteranc.es/client.js';
                        script.setAttribute('repo', commentsConfig.utterances.repo);
                        script.setAttribute('issue-term', commentsConfig.utterances.issueTerm || 'pathname'); // or "title" or "url" or a specific issue number
                        script.setAttribute('label', commentsConfig.utterances.label || 'comment');
                        script.setAttribute('theme', this.isDarkMode ? 'photon-dark' : 'github-light'); // Theme based on dark mode
                        script.setAttribute('crossorigin', 'anonymous');
                        script.async = true;

                        const container = document.getElementById('utterances-comments');
                        if (container) {
                            container.appendChild(script);
                        }
                    } else if (commentsConfig.type === 'gitalk' && commentsConfig.gitalk) {
                        // Gitalk requires its own CSS and JS
                        // For a clean implementation, you'd typically load this dynamically or from CDN in production.
                        // Here, we'll assume Gitalk.js and Gitalk.css are already loaded if 'gitalk' is chosen.
                        // Add Gitalk CDN links to head:
                        // <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
                        // <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

                        if (typeof Gitalk === 'undefined') {
                            console.error('Gitalk library not loaded. Please include Gitalk CDN scripts in your HTML head.');
                            // Dynamically load Gitalk if not present (optional)
                            const gitalkCss = document.createElement('link');
                            gitalkCss.rel = 'stylesheet';
                            gitalkCss.href = 'https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css';
                            document.head.appendChild(gitalkCss);

                            const gitalkJs = document.createElement('script');
                            gitalkJs.src = 'https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js';
                            gitalkJs.onload = () => this.initGitalk(postId, postTitle, commentsConfig.gitalk);
                            document.head.appendChild(gitalkJs);
                            return;
                        }
                        this.initGitalk(postId, postTitle, commentsConfig.gitalk);
                    }
                },
                initGitalk(postId, postTitle, gitalkConfig) {
                    const gitalk = new Gitalk({
                        clientID: gitalkConfig.clientID,
                        clientSecret: gitalkConfig.clientSecret,
                        repo: gitalkConfig.repo,
                        owner: gitalkConfig.owner,
                        admin: gitalkConfig.admin,
                        id: postId, // Use post ID to uniquely identify discussion
                        title: postTitle,
                        distractionFreeMode: false,
                        labels: ['Gitalk', gitalkConfig.label || 'comment'],
                        theme: this.isDarkMode ? 'dark' : 'light',
                    });
                    const container = document.getElementById('gitalk-comments');
                    if (container) {
                        gitalk.render(container);
                    }
                },
                handleRouteChange() {
                    const hash = window.location.hash;
                    if (hash === '' || hash === '#/') {
                        this.backToHome();
                    } else if (hash.startsWith('#/post/')) {
                        const postId = hash.substring(7);
                        this.openPost(postId);
                    }
                },
            },
            async mounted() {
                const storedTheme = localStorage.getItem('theme');
                if (storedTheme) {
                    this.isDarkMode = storedTheme === 'dark';
                } else {
                    // Default to system preference
                    this.isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                }

                try {
                    const hostname = window.location.hostname;
                    // Determine owner and repo from hostname.
                    // For `username.github.io` -> owner is `username`, repo is `username.github.io`
                    // For `custom.domain.com` -> assume default_owner/default_repo if you have one, or configure explicitly
                    // For now, let's assume `username.github.io` structure.
                    const owner = hostname.startsWith('localhost') ? 'rjdsq' : hostname.split('.')[0]; // Fallback for localhost
                    const repo = hostname.startsWith('localhost') ? 'rjdsq.github.io' : hostname;


                    const basePath = window.location.pathname.split('/').filter(p => p && !p.endsWith('.html')).join('/');
                    const getPath = (fileName) => basePath ? `${basePath}/${fileName}` : fileName;

                    // Fetch config
                    const configContent = await this.getFileFromApi(owner, repo, getPath('config.json'));
                    if (configContent) {
                        this.siteConfig = JSON.parse(configContent);
                        this.blogTitle = this.siteConfig.site.title || '我的博客';
                        this.blogDescription = this.siteConfig.site.description || '';
                        
                        // Apply custom styling
                        const styling = this.siteConfig.styling;
                        if (styling) {
                            if (styling.backgroundColor) document.documentElement.style.setProperty('--bg-color', styling.backgroundColor);
                            if (styling.textColor) document.documentElement.style.setProperty('--text-color', styling.textColor);
                            if (styling.accentColor) document.documentElement.style.setProperty('--accent-color', styling.accentColor);
                            if (styling.backgroundImageUrl) {
                                document.body.style.backgroundImage = `url(${styling.backgroundImageUrl})`;
                                document.body.style.backgroundSize = 'cover';
                                document.body.style.backgroundPosition = 'center';
                                document.body.style.backgroundAttachment = 'fixed';
                            } else {
                                document.body.style.backgroundImage = 'none';
                            }
                        }
                        this.commentsConfig = this.siteConfig.comments || {}; // Load comments config
                    }

                    // Fetch posts
                    const postsContent = await this.getFileFromApi(owner, repo, getPath('posts.json'));
                    if (postsContent) {
                        this.allPosts = JSON.parse(postsContent);
                    } else {
                        console.warn('posts.json not found or empty.');
                    }

                    window.addEventListener('hashchange', this.handleRouteChange);
                    this.handleRouteChange(); // Initial route handling

                } catch (error) {
                    console.error('博客初始化失败:', error);
                    this.blogTitle = '博客加载失败';
                    this.blogDescription = '请检查配置或网络连接。';
                    this.currentPostId = 'error'; // Indicate an error state for detail view
                } finally {
                    this.loading = false;
                }
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
