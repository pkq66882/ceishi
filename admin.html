<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博客后台管理系统 - 期望ai</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' font-size='90' text-anchor='middle' dominant-baseline='central'%3E⚙️%3C/text%3E%3C/svg%3E" type="image/svg+xml">

    <!-- EasyMDE Markdown 编辑器 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.css">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* ==================================================================== */
        /*                          CSS 变量及基础样式 - inspired by Typecho/WordPress                     */
        /* ==================================================================== */
        :root {
            --font-body: 'Roboto', sans-serif;
            --font-headings: 'Merriweather', serif;
            --bg-color: #f0f2f5; /* 整体页面背景 */
            --sidebar-bg: #2d323e; /* 侧边栏背景 */
            --sidebar-text: #e9ecef; /* 侧边栏文字 */
            --sidebar-hover-bg: #3f4756; /* 侧边栏菜单悬浮背景 */
            --sidebar-active-bg: #42b983; /* 侧边栏菜单选中背景 */
            --sidebar-active-text: #ffffff; /* 选中菜单文字颜色 */
            --content-bg: #ffffff; /* 内容区卡片背景 */
            --text-color-dark: #343a40; /* 主要文字颜色 (标题等) */
            --text-color-light: #495057; /* 次要文字颜色 (正文) */
            --text-color-muted: #868e96; /* 静音文字颜色 (描述、日期等) */
            --primary-color: #007bff; /* 主要按钮、链接强调色 */
            --primary-hover: #0056b3;
            --success-color: #28a745; /* 成功操作颜色 */
            --success-hover: #218838;
            --danger-color: #dc3545; /* 危险操作颜色 */
            --danger-hover: #c82333;
            --warning-color: #ffc107; /* 警告操作颜色 */
            --warning-hover: #e0a800;
            --info-color: #17a2b8; /* 信息提示颜色 */
            --info-hover: #138496;
            --border-color: #e9ecef; /* 边框颜色 */
            --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); /* 卡片阴影 */
            --input-border: #ced4da;
            --input-focus-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .25);

            /* EasyMDE overrides */
            --easymde-toolbar-bg: #f8f9fa;
            --easymde-border-color: #e0e0e0;
        }

        body {
            font-family: var(--font-body);
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color-light);
            font-size: 15px;
            line-height: 1.6;
            overflow-x: hidden; /* 防止横向滚动条 */
        }

        a { text-decoration: none; color: var(--primary-color); transition: color .2s; }
        a:hover { color: var(--primary-hover); }

        input, textarea, button, select {
            font-family: inherit;
            font-size: 100%;
            margin: 0;
            padding: 0;
            line-height: normal;
        }

        input:focus, textarea:focus, button:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: var(--input-focus-shadow);
        }

        h1, h2, h3, h4, h5, h6 { color: var(--text-color-dark); margin-top: 0; margin-bottom: 20px; font-family: var(--font-headings); }

        /* ==================== Login 页面 ==================== */
        #login-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--sidebar-bg); /* Use sidebar bg for login */
            background-image: linear-gradient(135deg, #2d323e 0%, #3f4756 100%);
        }
        .login-box {
            width: 90%;
            max-width: 420px;
            padding: 45px;
            background: var(--content-bg);
            box-shadow: var(--card-shadow);
            border-radius: 12px;
            text-align: center;
            box-sizing: border-box;
        }
        .login-box h1 { margin-bottom: 28px; font-size: 2.2rem; color: var(--text-color-dark); }
        .login-box p { margin-bottom: 25px; color: var(--text-color-muted); line-height: 1.8; }
        .login-box input[type="password"] {
            width: 100%;
            padding: 13px 18px;
            margin-bottom: 25px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            color: var(--text-color-dark);
            background-color: var(--bg-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .login-box input[type="checkbox"] {
            margin-right: 8px;
            vertical-align: middle;
        }
        .remember-token-group {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            font-size: 0.95rem;
            color: var(--text-color-light);
        }
        .login-box button {
            width: 100%;
            padding: 13px;
            background: var(--primary-color);
            color: #fff;
            border: 0;
            border-radius: 8px;
            cursor: pointer;
            transition: background .2s ease, box-shadow .2s ease;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .login-box button:hover { background: var(--primary-hover); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        .login-box button:disabled { background: #cccccc; cursor: not-allowed; opacity: 0.7; }
        #initial-message { color: var(--danger-color); margin-top: 20px; font-size: 0.9rem; }
        .generate-token-link {
            display: block;
            margin-top: 18px;
            font-size: 0.95rem;
            color: var(--primary-color);
        }

        /* ==================== Admin Layout ==================== */
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
            background-color: var(--bg-color);
        }

        #admin-sidebar {
            width: 260px; /* 侧边栏宽度 */
            background: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            flex-shrink: 0; /* 防止收缩 */
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        #admin-sidebar .logo {
            padding: 25px 20px;
            font-size: 1.7rem;
            font-weight: 700;
            text-align: center;
            background-color: rgba(0,0,0,.15);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            letter-spacing: 0.5px;
        }
        #admin-sidebar .nav {
            flex-grow: 1;
            list-style: none;
            margin: 0;
            padding: 20px 0;
        }
        #admin-sidebar .nav li { margin-bottom: 4px; }
        #admin-sidebar .nav a {
            display: flex;
            align-items: center;
            padding: 14px 25px;
            color: var(--sidebar-text);
            transition: background .2s ease, color .2s;
            border-left: 4px solid transparent;
            font-weight: 500;
        }
        #admin-sidebar .nav a i {
            margin-right: 15px;
            font-size: 1.1rem;
        }
        #admin-sidebar .nav a:hover { background: var(--sidebar-hover-bg); }
        #admin-sidebar .nav a.active {
            background: var(--sidebar-active-bg);
            color: var(--sidebar-active-text);
            border-left-color: var(--sidebar-active-text);
            font-weight: 600;
        }
        #admin-sidebar footer {
             padding: 20px;
             font-size: 0.85rem;
             color: #a0a8b4;
             border-top: 1px solid rgba(255,255,255,0.08);
             text-align: center;
        }
        #admin-sidebar footer a { color: var(--sidebar-active-bg); }

        #admin-content {
            flex-grow: 1;
            padding: 30px;
            box-sizing: border-box;
            background-color: var(--bg-color);
        }

        /* Mobile specific styles */
        #mobile-header {
            display: none; /* Default hidden for desktop */
            justify-content: space-between;
            align-items: center;
            background: var(--content-bg);
            padding: 15px 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            border-radius: 8px;
        }
        .mobile-menu-btn {
            font-size: 1.8rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color-dark);
        }
        .mobile-logo {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-color-dark);
        }
        #mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.5);
            z-index: 999;
            display: none;
        }
        /* When sidebar is visible in mobile */
        .admin-wrapper.sidebar-visible #admin-sidebar {
            transform: translateX(0);
            position: fixed; /* Make it fixed for mobile overlay */
            height: 100%;
            transition: transform .3s ease-in-out;
            z-index: 1001; /* Above overlay */
        }
        .admin-wrapper.sidebar-visible #mobile-overlay{
            display: block;
        }

        /* Responsive adjustments */
        @media(max-width: 768px) {
            #admin-sidebar {
                transform: translateX(-100%); /* Hide sidebar by default on small screens */
            }
            #admin-content {
                margin-left: 0; /* No static margin on small screens */
            }
            #mobile-header { display: flex; } /* Show mobile header */
        }


        /* ==================== 内容区通用样式 ==================== */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .page-header h2 {
            font-size: 1.8rem;
            margin: 0;
            line-height: 1;
            font-family: var(--font-headings);
        }

        /* Forms, Buttons, Tables */
        .form-group { margin-bottom: 25px; }
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-color-dark);
            font-size: 0.95rem;
        }
        .form-group input:not([type="checkbox"]), .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            box-sizing: border-box;
            background-color: var(--content-bg);
            color: var(--text-color-dark);
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 200px; /* 文本域最小高度 */
        }
        .form-group .description {
            font-size: 0.85rem;
            color: var(--text-color-muted);
            margin-top: 5px;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        @media (max-width: 768px) {
            .form-row { flex-direction: column; }
        }

        .button-group {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        button, .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background .2s ease, box-shadow .2s ease;
            font-weight: 600;
        }
        button i, .btn i { margin-right: 8px; }
        button:hover:not(:disabled), .btn:hover:not(:disabled) { opacity: 0.9; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        button:disabled, .btn:disabled { background: #cccccc !important; cursor: not-allowed; opacity: 0.7; }

        .btn-primary { background: var(--primary-color); color: #fff; }
        .btn-primary:hover:not(:disabled) { background: var(--primary-hover); }
        .btn-success { background: var(--success-color); color: #fff; }
        .btn-success:hover:not(:disabled) { background: var(--success-hover); }
        .btn-danger { background: var(--danger-color); color: #fff; }
        .btn-danger:hover:not(:disabled) { background: var(--danger-hover); }
        .btn-secondary { background: #6c757d; color: #fff; }
        .btn-secondary:hover:not(:disabled) { background: #5a6268; }
        .btn-info { background: var(--info-color); color: #fff; }
        .btn-info:hover:not(:disabled) { background: var(--info-hover); }

        .admin-table-wrapper { overflow-x: auto; background: var(--content-bg); border-radius: 8px; box-shadow: var(--card-shadow); }
        .admin-table {
            width: 100%;
            border-collapse: separate; /* 用于圆角 */
            border-spacing: 0;
            background: var(--content-bg);
        }
        .admin-table thead { background: var(--bg-color); }
        .admin-table th, .admin-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .admin-table th {
            font-weight: 700;
            color: var(--text-color-dark);
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        .admin-table td {
            font-size: 0.95rem;
            color: var(--text-color-light);
        }
        .admin-table tbody tr:last-child td { border-bottom: none; }
        .admin-table .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-start;
            flex-wrap: wrap; 
        }
        .admin-table .actions a {
            color: var(--text-color-muted);
            font-size: 1.1em;
        }
        .admin-table .actions a:hover {
            color: var(--primary-color);
        }
        .admin-table .actions a.delete:hover {
             color: var(--danger-color);
        }
        .admin-table input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        /* EasyMDE 样式调整 */
        .editor-container .CodeMirror-fullscreen {
            z-index: 2000;
            top: 0; left: 0; right: 0; bottom: 0;
            height: 100vh !important; /* 全屏时高度100% */
            width: 100vw !important; /* 全屏时宽度100% */
            position: fixed;
        }
        .editor-container .CodeMirror-fullscreen .editor-preview-full {
             width: 50% !important; /* 调整预览宽度 */
        }
        .editor-container .CodeMirror-fullscreen .EasyMDE_Focus {
             width: 50% !important; /* 调整编辑器宽度 */
        }
        .editor-toolbar {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            background-color: var(--easymde-toolbar-bg) !important;
            border: 1px solid var(--easymde-border-color) !important;
            border-bottom: none !important;
        }
        .editor-toolbar button { background: none !important; color: var(--text-color-dark) !important; border: none !important; padding: 8px 10px;}
        .editor-toolbar button.active, .editor-toolbar button:hover { background-color: var(--easymde-border-color) !important; color: var(--primary-color) !important; border-radius: 4px; }
        .CodeMirror {
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            border: 1px solid var(--easymde-border-color) !important;
            border-top: none !important;
            min-height: 400px;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 20px; /* 增加编辑器与底部按钮间距 */
        }
        .CodeMirror-scroll {
            background-color: var(--content-bg) !important;
        }
        .editor-preview-active-side, .editor-preview-active {
            background-color: var(--content-bg) !important;
            color: var(--text-color-light) !important;
            padding: 15px;
            border: 1px solid var(--easymde-border-color);
            border-radius: 8px;
            margin-top: 10px;
        }
        .editor-preview h1, .editor-preview h2, .editor-preview h3, .editor-preview h4, .editor-preview h5, .editor-preview h6 {
            color: var(--text-color-dark);
            font-family: var(--font-headings);
        }
        .editor-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1rem 0;
            display: block;
            box-shadow: 0 2px 8px var(--shadow-light);
        }
        .editor-preview blockquote {
            padding: 0.5em 1em;
            margin: 1em 0;
            border-left: 4px solid var(--primary-color);
            color: var(--text-color-muted);
            background-color: rgba(0, 123, 255, 0.05); /* Slightly lighter accent background */
            border-radius: 5px;
            font-style: italic;
        }
        .editor-preview pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 1em;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Fira Code', 'JetBrains Mono', monospace;
            line-height: 1.4;
            font-size: 0.95em;
        }
        .editor-preview code {
             font-family: 'Fira Code', 'JetBrains Mono', monospace;
             background-color: rgba(0, 0, 0, 0.05);
             padding: 2px 5px;
             border-radius: 4px;
             font-size: 0.9em;
             color: #c0392b; /* Code snippet color */
        }
        .editor-preview pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
        }
        .editor-preview-full { padding: 20px; } /* Ensure padding for full preview */
        
        /* Alerts */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .alert i { font-size: 1.2rem; }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .alert-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        /* Tag/Category Suggestions */
        .suggestion-box {
            position: absolute;
            background-color: var(--content-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 180px;
            overflow-y: auto;
            width: 100%;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            top: 100%;
            left: 0;
            margin-top: 5px;
        }
        .suggestion-box div {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color .2s, color .2s;
            font-size: 0.95rem;
        }
        .suggestion-box div:hover {
            background-color: var(--primary-color);
            color: white;
        }
        .form-group.has-suggestions {
            position: relative;
        }
        .tag-token-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            padding: 10px 12px;
            min-height: 48px;
            align-items: center;
            background-color: var(--content-bg);
            cursor: text;
        }
        .tag-token {
            display: inline-flex;
            align-items: center;
            background-color: var(--primary-color);
            color: white;
            padding: 6px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: 500;
        }
        .tag-token .remove-tag {
            margin-left: 7px;
            cursor: pointer;
            color: rgba(255,255,255,0.8);
            transition: color 0.1s;
        }
        .tag-token .remove-tag:hover {
            color: white;
        }
        .tag-token-input {
            border: none !important;
            flex-grow: 1;
            padding: 0 !important;
            margin-left: 5px;
            background: transparent !important;
            color: var(--text-color-dark) !important;
            line-height: 1.5 !important;
            box-shadow: none !important;
        }
        .tag-token-input:focus {
            box-shadow: none !important;
        }

        /* =========== Dashboard Styles =========== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        .stat-card, .quick-actions-card, .recent-posts-card {
            background: var(--content-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .stat-card:hover, .quick-actions-card:hover, .recent-posts-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        .stat-card {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .stat-card .icon {
            font-size: 2.8rem;
            color: var(--primary-color);
            flex-shrink: 0;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-color);
        }
        .stat-card .info .number {
            font-size: 2.4rem;
            font-weight: 700;
            color: var(--text-color-dark);
            margin: 0;
            line-height: 1;
        }
        .stat-card .info .label {
            font-size: 0.95rem;
            color: var(--text-color-muted);
            margin: 0;
            margin-top: 5px;
        }
        .quick-actions-card h3, .recent-posts-card h3 {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--text-color-dark);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        .quick-actions-card .button-group {
            margin-top: 0;
            flex-direction: column;
            gap: 12px;
        }
        .recent-posts-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .recent-posts-card li {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .recent-posts-card li:last-child {
            border-bottom: none;
        }
        .recent-posts-card li a {
            font-weight: 500;
            color: var(--text-color-dark);
            transition: color 0.2s;
        }
        .recent-posts-card li a:hover {
            color: var(--primary-color);
        }
        .recent-posts-card li .date {
            font-size: 0.85rem;
            color: var(--text-color-muted);
        }

        /* =========== Media Library Styles =========== */
        .media-library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }
        .media-card {
            background-color: var(--content-bg);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .media-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
        }
        .media-card .image-container {
            width: 100%;
            padding-top: 75%; /* 4:3 Aspect Ratio */
            position: relative;
            background-color: #f0f0f0;
            border-bottom: 1px solid var(--border-color);
        }
        .media-card img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .media-card .info {
            padding: 12px;
            font-size: 0.85rem;
            color: var(--text-color-dark);
            word-break: break-all;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Limit to 2 lines */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
            flex-grow: 1; /* Make info section grow */
        }
        .media-card .actions {
            display: flex;
            gap: 8px;
            padding: 0 12px 12px;
        }
        .media-card .actions .btn {
            flex: 1;
            padding: 6px;
            font-size: 0.8rem;
            border-radius: 6px;
        }
        #media-upload-input { display: none; } /* Hide file input */

        /* Markdown Live Preview for Settings 'About me' */
        #about-content-preview {
            background-color: var(--content-bg);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            padding: 15px;
            min-height: 100px;
            margin-top: 10px;
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-color-light);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Internal shadow */
        }
        #about-content-preview h1, #about-content-preview h2, #about-content-preview h3 {
            font-family: var(--font-headings);
            color: var(--text-color-dark);
            margin-top: 0.8em;
            margin-bottom: 0.5em;
        }
        #about-content-preview pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 0.8em;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Fira Code', 'JetBrains Mono', monospace;
            line-height: 1.4;
            font-size: 0.9em;
        }
        #about-content-preview code {
             font-family: 'Fira Code', 'JetBrains Mono', monospace;
             background-color: rgba(0, 0, 0, 0.05);
             padding: 2px 5px;
             border-radius: 4px;
             font-size: 0.9em;
             color: #c0392b;
        }
        #about-content-preview blockquote {
            padding: 0.5em 1em;
            margin: 1em 0;
            border-left: 4px solid var(--primary-color);
            background-color: rgba(0, 123, 255, 0.05);
            color: var(--text-color-muted);
            border-radius: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>

    <div id="login-wrapper">
        <div id="login-box" class="login-box">
             <h1><i class="fas fa-lock"></i> 博客管理</h1>
             <p>请输入您的GitHub Personal Access Token以开始。该Token需具备 <code style="background-color: #f0f0f0; padding: 2px 5px; border-radius: 3px;">repo</code> 权限。</p>
             <input type="password" id="token-input" placeholder="ghp_xxx 或 Bearer xxx">
            <div class="remember-token-group">
                <input type="checkbox" id="remember-token">
                <label for="remember-token">记住Token (高风险，仅限个人安全设备)</label>
            </div>
             <button id="start-btn"><i class="fas fa-sign-in-alt"></i> 登录</button>
             <p id="initial-message"></p>
             <a href="https://github.com/settings/tokens" target="_blank" class="generate-token-link">如何生成 Personal Access Token?</a>
        </div>
    </div>

    <div id="admin-wrapper" class="admin-wrapper" style="display: none;">
        <div id="mobile-overlay"></div>
        <aside id="admin-sidebar">
            <div class="logo">博客管理系统</div>
            <ul class="nav">
                <li><a href="#" id="nav-dashboard" class="active" data-view="dashboard"><i class="fas fa-tachometer-alt"></i> 仪表盘</a></li>
                <li><a href="#" id="nav-posts" data-view="posts"><i class="fas fa-newspaper"></i> 文章管理</a></li>
                <li><a href="#" id="nav-media" data-view="media"><i class="fas fa-images"></i> 媒体库</a></li>
                <li><a href="#" id="nav-settings" data-view="settings"><i class="fas fa-cog"></i> 网站设置</a></li>
                <li><a href="#" id="nav-gitalk-settings" data-view="gitalk-settings"><i class="fas fa-comments"></i> 评论设置</a></li>
                <li><a href="index.html" target="_blank"><i class="fas fa-desktop"></i> 查看站点</a></li>
                <li><a href="#" id="nav-logout"><i class="fas fa-sign-out-alt"></i> 安全退出</a></li>
            </ul>
            <footer>
                 <p>Powered by <a href="https://github.com/rjdsq/rjdsq.github.io" target="_blank">期望ai</a></p>
            </footer>
        </aside>

        <main id="admin-content">
            <header id="mobile-header">
                <button id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
                <div class="mobile-logo">管理后台</div>
                 <div id="global-alert-mobile-container"></div>
            </header>
            <div id="global-alert-desktop-container"></div>

            <!-- 仪表盘视图 -->
            <div id="dashboard-view" class="admin-view">
                <div class="page-header"><h2><i class="fas fa-home"></i> 仪表盘</h2></div>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-file-alt"></i></div>
                        <div class="info">
                            <p id="stat-posts" class="number">0</p>
                            <p class="label">篇文章</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-folder-open"></i></div>
                        <div class="info">
                            <p id="stat-categories" class="number">0</p>
                            <p class="label">个分类</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-tags"></i></div>
                        <div class="info">
                            <p id="stat-tags" class="number">0</p>
                            <p class="label">个标签</p>
                        </div>
                    </div>
                </div>
                <div class="dashboard-grid">
                    <div class="quick-actions-card">
                        <h3>快速操作</h3>
                        <div class="button-group">
                            <button id="dashboard-new-post-btn" class="btn btn-primary"><i class="fas fa-plus-circle"></i> 撰写新文章</button>
                            <button id="dashboard-settings-btn" class="btn btn-secondary"><i class="fas fa-cog"></i> 网站设置</button>
                            <button id="dashboard-media-btn" class="btn btn-info"><i class="fas fa-images"></i> 媒体库</button>
                        </div>
                    </div>
                    <div class="recent-posts-card">
                        <h3>最新文章</h3>
                        <ul id="dashboard-recent-posts">
                            <!-- Recent posts will be added here -->
                            <li><i class="fas fa-spinner fa-spin"></i> 加载中...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 文章管理视图 -->
            <div id="posts-view" class="admin-view" style="display: none;">
                <div class="page-header">
                    <h2><i class="fas fa-list-alt"></i> 文章管理</h2>
                    <div class="button-group">
                         <button id="bulk-delete-posts-btn" class="btn-danger" style="display:none;"><i class="fas fa-trash-alt"></i> 批量删除</button>
                         <button id="new-post-btn" class="btn-primary"><i class="fas fa-plus-circle"></i> 撰写新文章</button>
                    </div>
                </div>
                <div class="admin-table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-posts"></th>
                                <th>标题</th><th>分类</th><th>标签</th><th>发布日期</th><th>更新日期</th><th class="actions">操作</th>
                            </tr>
                        </thead>
                        <tbody id="post-list">
                            <tr><td colspan="7" style="text-align: center;">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 文章编辑/创建视图 -->
            <div id="editor-container" class="admin-view" style="display: none;">
                 <h2 id="editor-title"><i class="fas fa-edit"></i> 撰写新文章</h2>
                 <input type="hidden" id="post-id">
                <div class="form-group">
                    <label for="post-title">文章标题 <span style="color:red;">*</span></label>
                    <input type="text" id="post-title" placeholder="请输入文章标题">
                </div>
                 <div class="form-group">
                    <label for="post-category">文章分类</label>
                    <input type="text" id="post-category" placeholder="请输入文章分类，例如：技术，生活">
                </div>
                 <div class="form-group has-suggestions">
                    <label for="post-tags-input">文章标签 (按 Enter 键添加，点击标签删除)</label>
                    <div id="tag-token-container" class="tag-token-container">
                        <input type="text" id="post-tags-input" placeholder="输入标签并按回车">
                    </div>
                    <div id="tag-suggestions" class="suggestion-box" style="display: none;"></div>
                    <input type="hidden" id="post-tags">
                     <p class="description">输入标签后按回车键添加。点击现有标签可删除。从建议列表中选择。</p>
                </div>
                <div class="form-group">
                    <label for="post-content">文章内容 (支持 Markdown)</label>
                    <textarea id="post-content"></textarea>
                     <p class="description">请使用 Markdown 格式编写文章。使用 <code>&lt;!--more--&gt;</code> 可定义文章摘要。</p>
                </div>
                <div class="button-group">
                    <button id="save-post-btn" class="btn-success"><i class="fas fa-upload"></i> 发布/更新文章</button>
                    <button id="cancel-edit-btn" class="btn-secondary"><i class="fas fa-times-circle"></i> 取消</button>
                    <button id="delete-post-btn" class="btn-danger" style="display:none;"><i class="fas fa-trash-alt"></i> 删除文章</button>
                </div>
            </div>

            <!-- 媒体库视图 -->
            <div id="media-view" class="admin-view" style="display: none;">
                <div class="page-header">
                    <h2><i class="fas fa-photo-video"></i> 媒体库</h2>
                    <div>
                        <input type="file" id="media-upload-input" accept="image/*" multiple="multiple">
                        <button id="media-upload-btn" class="btn-primary"><i class="fas fa-upload"></i> 上传新图片</button>
                    </div>
                </div>
                <div id="media-library-grid" class="media-library-grid">
                    <!-- Media cards will be populated here -->
                    <p style="grid-column: 1 / -1; text-align: center;">正在加载媒体文件...</p>
                </div>
            </div>


            <!-- 网站设置视图 -->
            <div id="settings-view" class="admin-view" style="display: none;">
                <div class="page-header">
                    <h2><i class="fas fa-cogs"></i> 网站设置</h2>
                    <button id="save-settings-btn" class="btn-success"><i class="fas fa-save"></i> 保存设置</button>
                </div>
                 <div class="form-group">
                    <label for="setting-title">网站标题 <span style="color:red;">*</span></label>
                    <input type="text" id="setting-title" placeholder="例如：我的个人博客">
                </div>
                <div class="form-group">
                    <label for="setting-description">网站描述</label>
                    <input type="text" id="setting-description" placeholder="一句话描述你的博客">
                </div>
                <div class="form-group">
                    <label for="setting-about-content">“关于我”页面内容 (支持 Markdown)</label>
                    <textarea id="setting-about-content" rows="10" placeholder="请在这里填写关于你的介绍，支持 Markdown 格式。"></textarea>
                    <p class="description">此内容将显示在网站的“关于我”页面。</p>
                    <label style="margin-top: 15px;">Markdown 预览:</label>
                    <div id="about-content-preview"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="setting-bg-color">背景颜色</label><input type="color" id="setting-bg-color">
                        <p class="description">网站的整体背景色。</p>
                    </div>
                    <div class="form-group">
                        <label for="setting-text-color">文字颜色</label><input type="color" id="setting-text-color">
                        <p class="description">网站内容的默认文字颜色。</p>
                    </div>
                    <div class="form-group">
                        <label for="setting-accent-color">链接/强调色</label><input type="color" id="setting-accent-color">
                        <p class="description">链接、按钮等强调元素的颜色。</p>
                    </div>
                </div>
                <div class="form-group">
                    <label for="setting-bg-image">网站背景图</label>
                    <input type="file" id="setting-bg-image" accept="image/*">
                    <input type="text" id="setting-bg-image-url" placeholder="背景图URL将显示在这里" readonly style="margin-top: 10px;">
                    <div class="button-group" style="margin-top: 10px; justify-content: flex-start;">
                        <button id="upload-bg-image-btn" class="btn-primary" style="display:none;"><i class="fas fa-upload"></i> 上传并设置</button>
                        <button id="clear-bg-image-btn" class="btn-danger"><i class="fas fa-trash-alt"></i> 清除背景图</button>
                    </div>
                    <p class="description">可上传图片作为网站背景，或直接粘帖URL。</p>
                </div>
            </div>

            <!-- Gitalk 评论设置视图 -->
            <div id="gitalk-settings-view" class="admin-view" style="display: none;">
                <div class="page-header">
                    <h2><i class="fas fa-comments"></i> Gitalk 评论设置</h2>
                    <button id="save-gitalk-settings-btn" class="btn-success"><i class="fas fa-save"></i> 保存评论设置</button>
                </div>
                <p class="alert alert-info"><i class="fas fa-info-circle"></i> Gitalk在您的博客文章下添加评论功能，它基于GitHub Issues。请确保您创建的 GitHub Personal Access Token 拥有 `repo` 权限，且 `owner` 和 `repo` 字段填写正确。</p>
                <div class="form-group">
                    <label for="gitalk-clientID">GitHub Application Client ID <span style="color:red;">*</span></label>
                    <input type="text" id="gitalk-clientID" placeholder="GitHub OAuth Application Client ID">
                    <p class="description">在 GitHub 创建 OAuth Application 获取。回调 URL 填写您的博客网址。</p>
                </div>
                <div class="form-group">
                    <label for="gitalk-clientSecret">GitHub Application Client Secret <span style="color:red;">*</span></label>
                    <input type="password" id="gitalk-clientSecret" placeholder="GitHub OAuth Application Client Secret">
                    <p class="description">在 GitHub 创建 OAuth Application 获取。请妥善保管此Secret，但由于在前端使用，仍存在被获取的风险。</p>
                </div>
                <div class="form-group">
                    <label for="gitalk-repo">GitHub 仓库名 (用于存储评论 Issue) <span style="color:red;">*</span></label>
                    <input type="text" id="gitalk-repo" placeholder="例如：your-github-username.github.io">
                    <p class="description">存储博客评论的 GitHub 仓库名称，通常与您的博客仓库相同。</p>
                </div>
                <div class="form-group">
                    <label for="gitalk-owner">GitHub 仓库所有者 <span style="color:red;">*</span></label>
                    <input type="text" id="gitalk-owner" placeholder="例如：your-github-username">
                    <p class="description">GitHub 仓库所有者的用户名。</p>
                </div>
                <div class="form-group">
                    <label for="gitalk-admin">管理员 GitHub 用户名 (用英文逗号分隔，可多个)</label>
                    <input type="text" id="gitalk-admin" placeholder="例如：your-github-username">
                    <p class="description">拥有 Gitalk 评论管理权限的 GitHub 用户名。</p>
                </div>
                 <div class="form-group">
                    <input type="checkbox" id="gitalk-enabled" style="width: auto; margin-right: 8px;">
                    <label for="gitalk-enabled" style="display: inline-block; margin-bottom: 0;">启用 Gitalk 评论</label>
                </div>
            </div>
        </main>
    </div>

    <!-- EasyMDE Markdown 编辑器 JS -->
    <script src="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.js"></script>
    <!-- Marked.js for rendering markdown, for About Me Preview -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // ====================================================================
        //                          全局变量和工具函数
        // ====================================================================
        const utf8_to_b64 = (str) => btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
        const b64_to_utf8 = (str) => {
            try { return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); } catch (e) { return atob(str); }
        };

        const GitHubAPI = {
            BASE_URL: 'https://api.github.com',
            async request(token, endpoint, options = {}) {
                const url = `${this.BASE_URL}${endpoint}`;
                const headers = { 
                    'Authorization': `token ${token}`, 
                    'Accept': 'application/vnd.github.v3+json', 
                    ...options.headers 
                };
                const response = await fetch(url, { ...options, headers });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP Error: ${response.statusText}`, documentation_url: response.url || endpoint }));
                    const errorMessage = errorData.message || `GitHub API request failed with status ${response.status}`;
                    console.error('GitHub API Error:', errorMessage, errorData);
                    const specificError = errorMessage.toLowerCase().includes('bad credentials') || errorMessage.toLowerCase().includes('requires authentication') || response.status === 401 || response.status === 403
                        ? '你的 GitHub Token 可能无效或权限不足。请检查：Token生成页面 [<sup>1</sup>](https://github.com/settings/tokens)'
                        : '';
                    if (response.status === 404 && (options.method === 'PUT' || options.method === 'DELETE')) {
                        throw new Error(`${errorMessage} (路径：${endpoint})。可能是由于父目录或文件不存在。`);
                    }
                    throw new Error(`${errorMessage} ${specificError}`);
                }
                if (response.status === 204 || response.headers.get("Content-Length") === "0") return null;
                return response.json();
            },
            async getUser(token) { return this.request(token, '/user'); },
            async getFile(token, owner, repo, path) {
                try {
                    const result = await this.request(token, `/repos/${owner}/${repo}/contents/${path}`);
                    if (!result || typeof result.content !== 'string') {
                        return null; 
                    }
                    // For files expected to be JSON, return parsed object. For other files (e.g., .gitkeep), just return its existence and SHA.
                    if (path.endsWith('.json')) {
                         const content = b64_to_utf8(result.content);
                        if (content.trim().length === 0) return null; // Empty content is like not found for JSON.
                         return { content: content, sha: result.sha };
                    }
                    return { content: (result.content), sha: result.sha }; // binary/text content remains base64 for .gitkeep
                } catch (error) {
                    if (error.message.toLowerCase().includes('not found')) {
                        return null;
                    }
                    console.error(`Error fetching file ${path}:`, error);
                    throw error;
                }
            },
            async getDirectoryContents(token, owner, repo, path) {
                try {
                    const contents = await this.request(token, `/repos/${owner}/${repo}/contents/${path}`);
                    return Array.isArray(contents) ? contents : [];
                } catch (error) {
                    if (error.message.toLowerCase().includes('not found')) return []; 
                    console.error(`Error fetching directory contents for ${path}:`, error);
                    throw error;
                }
            },
            async createFile(token, owner, repo, path, content, message, isBinary = false) { 
                return this.request(token, `/repos/${owner}/${repo}/contents/${path}`, { method: 'PUT', body: JSON.stringify({ message, content: isBinary ? content : utf8_to_b64(content) }) });
            },
            async updateFile(token, owner, repo, path, content, sha, message, isBinary = false) {
                return this.request(token, `/repos/${owner}/${repo}/contents/${path}`, { method: 'PUT', body: JSON.stringify({ message, content: isBinary ? content : utf8_to_b64(content), sha }) });
            },
            async deleteFile(token, owner, repo, path, sha, message) { 
                return this.request(token, `/repos/${owner}/${repo}/contents/${path}`, { method: 'DELETE', body: JSON.stringify({ message, sha }) });
            },
        };

        // ==================== DOM 元素缓存 ====================
        const loginWrapper = document.getElementById('login-wrapper');
        const adminWrapper = document.getElementById('admin-wrapper');
        const tokenInput = document.getElementById('token-input');
        const rememberTokenCheckbox = document.getElementById('remember-token');
        const startBtn = document.getElementById('start-btn');
        const initialMessageEl = document.getElementById('initial-message');

        const adminViews = {
            dashboard: document.getElementById('dashboard-view'),
            posts: document.getElementById('posts-view'),
            editor: document.getElementById('editor-container'),
            media: document.getElementById('media-view'),
            settings: document.getElementById('settings-view'),
            gitalkSettings: document.getElementById('gitalk-settings-view'),
        };
        const navButtons = {
            dashboard: document.getElementById('nav-dashboard'),
            posts: document.getElementById('nav-posts'),
            media: document.getElementById('nav-media'),
            settings: document.getElementById('nav-settings'),
            gitalkSettings: document.getElementById('nav-gitalk-settings'), 
            logout: document.getElementById('nav-logout'),
        };
        const postListBody = document.getElementById('post-list');
        const selectAllPostsCheckbox = document.getElementById('select-all-posts');
        const bulkDeletePostsBtn = document.getElementById('bulk-delete-posts-btn');

        let token = null, owner = '', repo = '', basePath = '';
        let posts = [], postsSha = '';
        let config = {}, configSha = '';
        let easyMDE; 

        // 统一获取文件路径，处理basePath为空或不为空的情况
        const getPath = (fileName) => basePath ? `${basePath}/${fileName}` : fileName;

        // 新函数：尝试创建目录及其.gitkeep文件
        async function createGitHubDirectory(apiToken, apiOwner, apiRepo, directoryPath) {
            if (!directoryPath) return true; 
            const gitkeepPath = `${directoryPath}/.gitkeep`;
            try {
                // 检查 .gitkeep 是否存在，如果存在则目录结构被GitHub认为是存在的
                const fileData = await GitHubAPI.getFile(apiToken, apiOwner, apiRepo, gitkeepPath);
                if (!fileData) {
                    await GitHubAPI.createFile(apiToken, apiOwner, apiRepo, gitkeepPath, '', `feat: create directory ${directoryPath}`);
                    console.log(`Directory ${directoryPath} created successfully with .gitkeep.`);
                } else {
                    console.log(`Directory ${directoryPath} already exists.`);
                }
                return true;
            } catch (error) {
                console.error(`Failed to create directory ${directoryPath}:`, error);
                // 特殊处理 GitHub 多级目录创建问题
                if (error.message.includes('404') && error.message.includes('parent directory')) {
                    throw new Error(`无法创建目录 ${directoryPath}。可能是由于父目录不存在，GitHub API 无法创建多级目录。请确保目标路径的父目录在GitHub仓库中已存在。`);
                }
                throw error;
            }
        }
        
        // Helper to format date and time
        function formatDateTime(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false // 24小时制
            });
        }


        // ==================== UI 辅助函数 ====================
        const showAdminView = (viewName) => {
            Object.values(adminViews).forEach(v => v.style.display = 'none');
            
            if (easyMDE && viewName !== 'editor') {
                easyMDE.toTextArea();
                document.getElementById('post-content').style.display = '';
                easyMDE = null;
            }
            
            Object.values(navButtons).forEach(b => b?.classList.remove('active')); // 使用可选链操作符
            const currentNavLink = document.querySelector(`[data-view="${viewName}"]`);
            if (currentNavLink) {
                 currentNavLink.classList.add('active');
            } else if (viewName === 'editor') {
                navButtons.posts?.classList.add('active'); 
            }
            
            adminViews[viewName]?.style.display = 'block'; // 使用可选链操作符
            
            if (viewName === 'editor' && !easyMDE) {
                initializeEasyMDE();
            }
            // Trigger specific actions when a view is shown
            if (viewName === 'dashboard') renderDashboard();
            if (viewName === 'media') loadMediaLibrary();
            if (viewName === 'posts') {
                 renderPostList();
            }
            
            document.querySelector('.admin-wrapper').classList.remove('sidebar-visible'); // Hide mobile sidebar
            // Clear global alerts when switching views
            document.getElementById('global-alert-desktop-container').innerHTML = '';
            document.getElementById('global-alert-mobile-container').innerHTML = '';
        };

        const setButtonsDisabled = (disabled) => document.querySelectorAll('button').forEach(b => b.disabled = disabled);

        const showAlert = (message, type = 'info', id = 'global-alert') => {
            const container = window.innerWidth <= 768 ? document.getElementById('global-alert-mobile-container') : document.getElementById('global-alert-desktop-container');
            let existingAlert = document.getElementById(id);
            if (!existingAlert) {
                existingAlert = document.createElement('div');
                existingAlert.id = id;
                container.prepend(existingAlert);
            }
            existingAlert.className = `alert alert-${type}`;
            const icon = {'info': 'fas fa-info-circle', 'success': 'fas fa-check-circle', 'danger': 'fas fa-exclamation-circle', 'warning': 'fas fa-exclamation-triangle'}[type];
            existingAlert.innerHTML = `<i class="${icon}"></i> ${message}`;
            existingAlert.style.display = 'flex';
            existingAlert.style.removeProperty('margin-top'); // Ensure no top margin if reused

            setTimeout(() => { 
                if(existingAlert) existingAlert.style.display = 'none'; 
            }, 8000); // 延长显示时间
        };

        const copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('URL已复制到剪贴板！', 'success');
            }).catch(err => {
                showAlert('复制失败: ' + err, 'danger');
            });
        };

        // ==================== 登录/初始化 ====================
        const checkTokenAndStart = async () => {
             const storedToken = localStorage.getItem('github_token');
             if (storedToken) {
                 tokenInput.value = storedToken;
                 rememberTokenCheckbox.checked = true;
                startAdmin();
             }
        };

        const startAdmin = async () => {
            const userToken = tokenInput.value.trim();
            if (!userToken) { initialMessageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Token 不能为空。'; return; }
            token = userToken;
            setButtonsDisabled(true);
            initialMessageEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在验证并加载...';
            initialMessageEl.style.color = 'var(--text-color-light)';

            try {
                const user = await GitHubAPI.getUser(token);
                owner = user.login;
                
                // --- 动态解析 repo 和 basePath ---
                const hostname = window.location.hostname; // e.g., pkq66882.github.io, custom.domain.com
                let pathSegments = window.location.pathname.split('/').filter(p => p); // e.g., ["ceishi", "admin.html"] or ["admin.html"]

                if (hostname.endsWith('.github.io')) {
                    // This is a user/organization page or a project page hosted on a *.github.io domain
                    if (pathSegments.length > 0 && pathSegments[pathSegments.length - 1].toLowerCase().endsWith('admin.html')) {
                        pathSegments.pop(); // Remove "admin.html"
                    }

                    if (pathSegments.length > 0) {
                        // This is a project page, repo name is the first path segment
                        // e.g., https://pkq66882.github.io/ceishi/admin.html -> owner='pkq66882', repo='ceishi', basePath=''
                        repo = pathSegments[0];
                        basePath = pathSegments.slice(1).join('/'); // If any subdirectories exist after repo name
                    } else {
                        // This is a user/organization page at the root
                        // e.g., https://pkq66882.github.io/admin.html -> owner='pkq66882', repo='pkq66882.github.io', basePath=''
                        repo = hostname;
                        basePath = '';
                    }

                } else {
                    // Custom domain or other complex cases, or just a file in a repo, fallback logic
                    // Assume first path segment is repo, rest is base path (might need fine-tuning for custom domains)
                    if (pathSegments.length > 0 && pathSegments[pathSegments.length - 1].toLowerCase().endsWith('admin.html')) {
                        pathSegments.pop(); 
                    }
                    if (pathSegments.length > 0) {
                        repo = pathSegments[0];
                        basePath = pathSegments.slice(1).join('/');
                    } else {
                        throw new Error("无法从URL中确定仓库名称。对于自定义域名，请在config.js中手动配置或确保路径遵循 /repo/subpath 结构。");
                    }
                }
                
                // 打印调试信息，确认解析是否正确
                console.log(`Detected Owner: ${owner}, Repo: ${repo}, Base Path: "${basePath}"`);
                showAlert(`检测到仓库信息：Owner: ${owner}, Repo: ${repo}, Base Path: "${basePath}"`, 'info', 'path-detection-alert');


                // **STEP 1: 自动化创建必要的子目录**
                initialMessageEl.innerHTML = `<i class="fas fa-spinner fa-spin"></i> 正在检查并创建所需文件目录...`;
                try {
                
                    const baseDirParts = basePath.split('/').filter(Boolean); // Filter removes empty strings from split
                    let currentPathAccumulated = '';
                    for (const part of baseDirParts) {
                        currentPathAccumulated = currentPathAccumulated ? `${currentPathAccumulated}/${part}` : part;
                        await createGitHubDirectory(token, owner, repo, currentPathAccumulated);
                    }
                    // 无论有没有 basePath，images 目录都应该在逻辑上的根目录（即 basePath 下）
                    await createGitHubDirectory(token, owner, repo, getPath('images')); 

                } catch (e) {
                    initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 无法创建必要的目录。错误: ${e.message}<br>请检查您的 GitHub Token 权限是否包含 ` + `repo` + ` 权限。`;
                    throw e;
                }

                // **STEP 2: 获取 config.json 和 posts.json (现在它们应该能在创建的目录中被访问)**
                let configData = null;
                let postsData = null;
                initialMessageEl.innerHTML = `<i class="fas fa-spinner fa-spin"></i> 正在获取核心配置文件...`;

                try {
                    configData = await GitHubAPI.getFile(token, owner, repo, getPath('config.json'));
                } catch (e) {
                    initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 获取 ${getPath('config.json')} 失败: ${e.message}`;
                    throw e;
                }
                
                try {
                    postsData = await GitHubAPI.getFile(token, owner, repo, getPath('posts.json'));
                } catch (e) {
                    initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 获取 ${getPath('posts.json')} 失败: ${e.message}`;
                    throw e;
                }

                const hasExistingConfig = !!configData;
                const hasExistingPosts = !!postsData; // 即使是空数组也视为存在

                // 默认配置和文章 (保持不变)
                const initialConfig = {
                    site: {
                        title: `${user.login}的博客`,
                        description: "由GitHub驱动的现代化半静态博客",
                        aboutContent: `# 关于我\n\n你好！我是 ${user.login}，一个热爱技术和分享的开发者。欢迎来到我的博客！\n\n在这里，我将分享我的技术心得、学习笔记以及一些生活感悟。希望我的内容能对你有所启发或帮助。\n\n**联系我:**\n\n*   GitHub: ${user.login} [<sup>2</sup>](https://github.com/${user.login})\n*   Email: your_email@example.com\n\n---`,
                    },
                    styling: {
                        backgroundColor: "#f0f2f5",
                        textColor: "#343a40",
                        accentColor: "#007bff",
                        backgroundImageUrl: ""
                    },
                    gitalk: {
                        enabled: false,
                        clientID: '',
                        clientSecret: '',
                        repo: repo, 
                        owner: owner,
                        admin: [owner],
                        id: 'blog-comment' // Default ID for blog comments
                    }
                };
                const initialPosts = {
                    id: `hello_world_${Date.now()}`,
                    title: "欢迎来到我的博客！",
                    content: "# 欢迎！\n\n这是您的第一篇文章，由期望ai自动生成。\n\n使用后台管理系统，您可以轻松发布、编辑和删除文章。文章支持 **Markdown** 格式。\n\n在 [博客管理后台 [<sup>3</sup>](admin.html) 中，您可以：\n\n*   撰写新的文章\n*   管理网站配置 (标题、描述、颜色、背景图)\n*   配置 Gitalk 评论系统\n\n快去发布你的第一篇文章吧！\n\n<!--more-->\n\n### Markdown 示例\n\n```javascript\nconsole.log('Hello, world!');\n```\n\n> 引用块。\n\n*   列表项1\n*   列表项2\n\n--- \n\n<p style=\"text-align: center;\">祝你创作愉快！</p>",
                    category: "公告",
                    tags: ["欢迎", "教程"],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }];

                // 核心文件处理逻辑 - config.json 
                let currentConfig = initialConfig;
                if (hasExistingConfig) {
                    try {
                        let parsedConfig = JSON.parse(configData.content);
                        // Deep merge to ensure all properties from initial config are present
                        currentConfig.site = Object.assign({}, initialConfig.site, parsedConfig.site);
                        currentConfig.styling = Object.assign({}, initialConfig.styling, parsedConfig.styling);
                        currentConfig.gitalk = Object.assign({}, initialConfig.gitalk, parsedConfig.gitalk);
                        
                        // Ensure gitalk.repo and owner are updated based on current repo detection
                        currentConfig.gitalk.repo = repo; 
                        currentConfig.gitalk.owner = owner;
                        if (!currentConfig.gitalk.admin || currentConfig.gitalk.admin.length === 0) {
                            currentConfig.gitalk.admin = [owner];
                        }
                    } catch (e) {
                        console.warn("Invalid config.json content, using default config.", e);
                        showAlert('config.json' + (configData.content ? '内容无效' : '文件不存在或为空') + '，已使用默认配置覆盖。', 'warning');
                    }
                    try {
                        const commitMessage = 'conf: update config with default/existing values';
                        const res = await GitHubAPI.updateFile(token, owner, repo, getPath('config.json'), JSON.stringify(currentConfig, null, 2), configData.sha, commitMessage);
                        configSha = res.content.sha;
                    } catch (e) {
                         console.error(`Error updating config.json: ${e.message}`);
                         initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 更新 ${getPath('config.json')} 失败: ${e.message}`;
                         throw e;
                    }
                } else {
                    try {
                        const commitMessage = 'feat: initialize config';
                        const res = await GitHubAPI.createFile(token, owner, repo, getPath('config.json'), JSON.stringify(initialConfig, null, 2), commitMessage);
                        configSha = res.content.sha;
                        currentConfig = initialConfig;
                    } catch (e) {
                        console.error(`Error creating config.json: ${e.message}`);
                        initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 创建 ${getPath('config.json')} 失败: ${e.message}`;
                        throw e;
                    }
                }
                config = currentConfig;

                // 核心文件处理逻辑 - posts.json
                let currentPostsArray = [];
                if (hasExistingPosts) {
                    try {
                        currentPostsArray = JSON.parse(postsData.content);
                        if (!Array.isArray(currentPostsArray)) { // Ensure it's an array
                             throw new Error("posts.json 文件内容不是有效的JSON数组。");
                        }
                        if (currentPostsArray.length === 0 || !currentPostsArray.some(p => p.id === initialPosts[0].id)) {
                             currentPostsArray.push(initialPosts[0]);
                             showAlert('posts.json 文件之前为空或缺少欢迎文章，已补充。', 'info');
                        }
                    } catch (e) {
                        console.warn("Invalid posts.json content, overwriting with default post.", e);
                        showAlert('posts.json' + (postsData.content ? '内容无效' : '文件不存在或为空') + '，已添加默认文章。', 'warning');
                        currentPostsArray = initialPosts;
                    }
                    currentPostsArray.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                    try {
                        const commitMessage = 'docs: update posts with initial/existing entries';
                        const res = await GitHubAPI.updateFile(token, owner, repo, getPath('posts.json'), JSON.stringify(currentPostsArray, null, 2), postsData.sha, commitMessage);
                        postsSha = res.content.sha;
                    } catch (e) {
                        console.error(`Error updating posts.json: ${e.message}`);
                        initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 更新 ${getPath('posts.json')} 失败: ${e.message}`;
                        throw e;
                    }
                } else {
                    try {
                        const commitMessage = 'feat: initialize first post';
                        const res = await GitHubAPI.createFile(token, owner, repo, getPath('posts.json'), JSON.stringify(initialPosts, null, 2), commitMessage);
                        postsSha = res.content.sha;
                        currentPostsArray = initialPosts;
                    } catch (e) {
                        console.error(`Error creating posts.json: ${e.message}`);
                        initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 创建 ${getPath('posts.json')} 失败: ${e.message}`;
                        throw e;
                    }
                }
                posts = currentPostsArray;

                // --- 初始化成功后界面渲染 ---
                loginWrapper.style.display = 'none';
                adminWrapper.style.display = 'flex';
                showAdminView('dashboard'); // 设置仪表盘为默认视图
                populateSettings();
                populateGitalkSettings();
                updateUniqueTags();

                if (rememberTokenCheckbox.checked) {
                    localStorage.setItem('github_token', token);
                } else {
                    localStorage.removeItem('github_token');
                }

                initialMessageEl.innerHTML = ``;
                showAlert('博客后台管理系统已成功加载！', 'success');

            } catch (error) {
                console.error("Critical initialization failure:", error);
                if (!initialMessageEl.innerHTML.includes('无法创建目录') && !initialMessageEl.innerHTML.includes('Token') && !initialMessageEl.innerHTML.includes('获取') && !initialMessageEl.innerHTML.includes('创建')) {
                    initialMessageEl.innerHTML = `<i class="fas fa-times-circle"></i> 登录失败或系统初始化失败: ${error.message}<br>通用建议：请仔细检查您的Token权限、GitHub Pages配置和网络连接。`;
                }
                initialMessageEl.style.color = 'var(--danger-color)';
                token = null;
                localStorage.removeItem('github_token');
            } finally {
                setButtonsDisabled(false);
            }
        };

        // ==================== Dashboard (仪表盘) ====================
        function renderDashboard() {
            const uniqueCategories = new Set(posts.map(p => p.category).filter(Boolean));
            const allTags = posts.flatMap(p => p.tags || []);
            const uniqueTags = new Set(allTags);
    
            document.getElementById('stat-posts').textContent = posts.length;
            document.getElementById('stat-categories').textContent = uniqueCategories.size;
            document.getElementById('stat-tags').textContent = uniqueTags.size;
    
            const recentPostsList = document.getElementById('dashboard-recent-posts');
            recentPostsList.innerHTML = '';
            const recentPosts = [...posts].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
            if (recentPosts.length > 0) {
                recentPosts.forEach(post => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="#" class="edit-link" data-id="${post.id}">${post.title}</a> <span class="date">${formatDateTime(post.createdAt)}</span>`;
                    recentPostsList.appendChild(li);
                });
            } else {
                recentPostsList.innerHTML = '<li>暂无文章</li>';
            }
        }


        // ==================== 文章管理功能 ====================
        const renderPostList = () => {
            postListBody.innerHTML = '';
            selectAllPostsCheckbox.checked = false;
            toggleBulkDeleteButton(); // Hide bulk delete button initially

            if (posts.length === 0) {
                postListBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">暂无文章。点击“撰写新文章”开始创作吧！</td></tr>`;
                return;
            }

            [...posts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(post => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="post-checkbox" data-id="${post.id}"></td>
                    <td>${post.title}</td>
                    <td>${post.category || '未分类'}</td>
                    <td>${post.tags && post.tags.length > 0 ? post.tags.slice(0, 3).join(', ') + (post.tags.length > 3 ? '...' : '') : '无标签'}</td>
                    <td>${formatDateTime(post.createdAt)}</td>
                    <td>${formatDateTime(post.updatedAt)}</td>
                    <td class="actions">
                        <a href="#" class="edit" data-id="${post.id}" title="编辑"><i class="fas fa-edit"></i></a>
                        <a href="#" class="delete" data-id="${post.id}" title="删除"><i class="fas fa-trash-alt"></i></a>
                        <a href="index.html#/post/${post.id}" target="_blank" class="link" title="预览"><i class="fas fa-external-link-alt"></i></a>
                    </td>
                `;
                postListBody.appendChild(tr);
            });
        };

        const toggleBulkDeleteButton = () => {
            const checkedCheckboxes = document.querySelectorAll('.post-checkbox:checked');
            if (checkedCheckboxes.length > 0) {
                bulkDeletePostsBtn.style.display = 'inline-flex';
            } else {
                bulkDeletePostsBtn.style.display = 'none';
            }
        };

        const openEditor = (postId = null) => {
            showAdminView('editor');
            const post = posts.find(p => p.id === postId);
            document.getElementById('editor-title').innerHTML = `<i class="fas fa-edit"></i> ${post ? '编辑文章' : '撰写新文章'}`;
            document.getElementById('save-post-btn').innerHTML = `<i class="fas fa-upload"></i> ${post ? '更新文章' : '发布文章'}`;
            document.getElementById('post-id').value = post?.id || '';
            document.getElementById('post-title').value = post?.title || '';
            document.getElementById('post-category').value = post?.category || '';
            // 清空并重新生成标签输入
            const tagTokenContainer = document.getElementById('tag-token-container');
            tagTokenContainer.querySelectorAll('.tag-token').forEach(tagEl => tagEl.remove());
            const tagsInput = document.getElementById('post-tags-input');
            if (post && post.tags && Array.isArray(post.tags)) {
                post.tags.forEach(tag => addTagToInput(tag, tagsInput));
            }
            tagsInput.value = ''; // 确保输入框清空
            document.getElementById('post-tags').value = JSON.stringify(post?.tags || []);


            // EasyMDE 赋值
            if (easyMDE) {
                easyMDE.value(post?.content || '');
            } else {
                document.getElementById('post-content').value = post?.content || '';
                initializeEasyMDE(); // 确保EasyMDE被初始化
            }
            
            document.getElementById('delete-post-btn').style.display = post ? 'inline-flex' : 'none';
        };

        const savePost = async () => {
            const id = document.getElementById('post-id').value;
            const title = document.getElementById('post-title').value.trim();
            const category = document.getElementById('post-category').value.trim() || '未分类';
            const content = easyMDE.value().trim(); // 从 EasyMDE 获取内容
            if (!title || !content) { showAlert('标题和内容不能为空！', 'danger'); return; }
            
            setButtonsDisabled(true);
            const tags = JSON.parse(document.getElementById('post-tags').value || '[]');

            const postIndex = posts.findIndex(p => p.id === id);
            const now = new Date().toISOString();

            if (postIndex > -1) {
                // 更新现有文章
                Object.assign(posts[postIndex], { title, category, content, tags, updatedAt: now });
            } else {
                // 创建新文章，添加到数组开头
                posts.unshift({ id: `post_${Date.now()}`, title, category, content, tags, createdAt: now, updatedAt: now });
            }
            // 重新排序文章，确保最新文章在前面
            posts.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, getPath('posts.json'), JSON.stringify(posts, null, 2), postsSha, `docs: ${id ? 'update' : 'create'} post "${title}"`);
                postsSha = res.content.sha;
                showAlert('文章保存成功！', 'success');
                // 更新标签建议列表
                updateUniqueTags();
                renderPostList();
                showAdminView('posts');
            } catch (error) {
                showAlert(`文章保存失败: ${error.message}`, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };

        const deletePost = async (postId) => {
            if (!postId || !confirm('确定要删除这篇文章吗？操作不可逆！')) return;
            setButtonsDisabled(true);
            const postToDelete = posts.find(p => p.id === postId);
            if (!postToDelete) {
                showAlert('文章未找到！', 'danger');
                setButtonsDisabled(false);
                return;
            }
            posts = posts.filter(p => p.id !== postId);
            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, getPath('posts.json'), JSON.stringify(posts, null, 2), postsSha, `docs: delete post "${postToDelete.title}"`);
                postsSha = res.content.sha;
                showAlert('文章删除成功！', 'success');
                // 更新标签建议列表
                updateUniqueTags();
                renderPostList();
                showAdminView('posts');
            } catch (error) {
                showAlert(`文章删除失败: ${error.message}`, 'danger');
                posts.push(postToDelete); // Rollback in case of error
            } finally {
                setButtonsDisabled(false);
            }
        };

        const bulkDeletePosts = async () => {
            const checkedCheckboxes = document.querySelectorAll('.post-checkbox:checked');
            if (checkedCheckboxes.length === 0) {
                showAlert('请选择至少一篇文章进行删除。', 'warning');
                return;
            }
            if (!confirm(`确定要删除选中的 ${checkedCheckboxes.length} 篇文章吗？此操作不可逆！`)) {
                return;
            }

            setButtonsDisabled(true);
            const postsToDeleteIds = Array.from(checkedCheckboxes).map(cb => cb.dataset.id);
            const initialPostsLength = posts.length;

            posts = posts.filter(post => !postsToDeleteIds.includes(post.id));

            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, getPath('posts.json'), JSON.stringify(posts, null, 2), postsSha, `docs: bulk delete ${postsToDeleteIds.length} posts`);
                postsSha = res.content.sha;
                showAlert(`成功删除 ${initialPostsLength - posts.length} 篇文章！`, 'success');
                updateUniqueTags();
                renderPostList();
            } catch (error) {
                showAlert(`批量删除文章失败: ${error.message}`, 'danger');
                // Note: Rolling back deleted posts in bulk is complex, consider a more robust backend for production.
                // For this simple client-side app, a page refresh might be needed or a re-fetch.
            } finally {
                setButtonsDisabled(false);
            }
        };


        // ==================== 媒体库功能 (Media Library) ====================
        async function loadMediaLibrary() {
            const grid = document.getElementById('media-library-grid');
            grid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;"><i class="fas fa-spinner fa-spin"></i> 正在加载媒体文件...</p>';
            try {
                const files = await GitHubAPI.getDirectoryContents(token, owner, repo, getPath('images'));
                grid.innerHTML = '';
                if (files && files.length > 0) {
                    files.filter(file => file.type === 'file' && !file.name.endsWith('.gitkeep')).forEach(file => {
                        const card = document.createElement('div');
                        card.className = 'media-card';
                        const imageUrl = file.download_url; // 直接使用 download_url
                        const fileName = file.name;
                        const fileExtension = fileName.split('.').pop().toLowerCase();
                        
                        let fileIcon = 'fas fa-file';
                        if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'svg', 'webp'].includes(fileExtension)) {
                            fileIcon = 'fas fa-image';
                        } else if (['mp4', 'mov', 'avi'].includes(fileExtension)) {
                            fileIcon = 'fas fa-video';
                        } else if (['pdf'].includes(fileExtension)) {
                            fileIcon = 'fas fa-file-pdf';
                        } else if (['zip', 'rar', '7z'].includes(fileExtension)) {
                            fileIcon = 'fas fa-file-archive';
                        }

                        card.innerHTML = `
                            <div class="image-container">
                                ${fileIcon === 'fas fa-image' ? 
                                    `<img src="${imageUrl}" alt="${fileName}" loading="lazy">` : 
                                    `<i class="${fileIcon}" style="font-size: 4em; color: var(--text-color-muted);"></i>`}
                            </div>
                            <div class="info">${fileName}</div>
                            <div class="actions">
                                <button class="btn btn-info btn-sm insert-media-btn" data-url="${imageUrl}" title="插入到文章"><i class="fas fa-plus"></i></button>
                                <button class="btn btn-secondary btn-sm copy-url-btn" data-url="${imageUrl}" title="复制URL"><i class="fas fa-copy"></i></button>
                                <button class="btn btn-danger btn-sm delete-media-btn" data-path="${file.path}" data-sha="${file.sha}" title="删除"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                } else {
                     grid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">媒体库为空。请上传一些图片。</p>';
                }
            } catch (error) {
                grid.innerHTML = `<p class="alert alert-danger" style="grid-column: 1 / -1;">加载媒体库失败: ${error.message}</p>`;
            }
        }
        async function deleteMediaFile(path, sha) {
            if (!confirm(`确定要删除文件 ${path.split('/').pop()} 吗？此操作不可逆，且可能导致文章中的链接失效。`)) return;
            setButtonsDisabled(true);
            showAlert(`正在删除文件 ${path.split('/').pop()}...`, 'info', 'media-delete-alert');
            try {
                await GitHubAPI.deleteFile(token, owner, repo, path, sha, `feat: delete file ${path}`);
                showAlert('文件删除成功！', 'success', 'media-delete-alert');
                loadMediaLibrary(); // Refresh view
            } catch (error) {
                showAlert(`删除失败: ${error.message}`, 'danger', 'media-delete-alert');
            } finally {
                setButtonsDisabled(false);
            }
        }

        // ==================== 网站设置功能 ====================
        const populateSettings = () => {
            document.getElementById('setting-title').value = config.site.title || '';
            document.getElementById('setting-description').value = config.site.description || '';
            document.getElementById('setting-about-content').value = config.site.aboutContent || ''; 
            document.getElementById('setting-bg-color').value = config.styling.backgroundColor || '#f0f2f5';
            document.getElementById('setting-text-color').value = config.styling.textColor || '#343a40';
            document.getElementById('setting-accent-color').value = config.styling.accentColor || '#007bff';
            
            const bgImageUrl = config.styling.backgroundImageUrl;
            document.getElementById('setting-bg-image-url').value = bgImageUrl || '';
            // 更新图片预览
            updateSettingBgImagePreview(bgImageUrl);

            // 触发 about content 的 markdown 预览
            updateAboutContentPreview();
        };

        const updateSettingBgImagePreview = (imageUrl) => {
            const previewContainer = document.getElementById('setting-bg-image-url').previousElementSibling; // This is the file input
            let previewEl = previewContainer.nextElementSibling; // Get the URL input field next element (which should be the preview)
            if (previewEl && previewEl.id != 'setting-bg-image-preview-hack') { // Find or create if structure changed
                 let tempDiv = document.createElement('div');
                 tempDiv.id = 'setting-bg-image-preview-hack';
                 tempDiv.style = "width: 200px; height: 120px; border: 1px dashed var(--border-color); margin-top: 10px; display: flex; justify-content: center; align-items: center; overflow: hidden; background-color: #f9f9f9; border-radius: 5px;";
                 document.getElementById('setting-bg-image-url').parentNode.insertBefore(tempDiv, document.getElementById('setting-bg-image-url'));
                 previewEl = tempDiv;
            } else if (!previewEl) { // On initial load, create it
                 let tempDiv = document.createElement('div');
                 tempDiv.id = 'setting-bg-image-preview-hack';
                 tempDiv.style = "width: 200px; height: 120px; border: 1px dashed var(--border-color); margin-top: 10px; display: flex; justify-content: center; align-items: center; overflow: hidden; background-color: #f9f9f9; border-radius: 5px;";
                 document.getElementById('setting-bg-image-url').parentNode.insertBefore(tempDiv, document.getElementById('setting-bg-image-url'));
                 previewEl = tempDiv;
            }


            if (imageUrl) {
                previewEl.innerHTML = `<img src="${imageUrl}" alt="背景图预览">`;
                document.getElementById('upload-bg-image-btn').style.display = 'none'; 
            } else {
                previewEl.innerHTML = `<span class="placeholder" style="color: var(--text-color-muted);">无背景图</span>`;
                document.getElementById('upload-bg-image-btn').style.display = 'inline-flex';
            }
        };

        const updateAboutContentPreview = () => {
            const markdownContent = document.getElementById('setting-about-content').value;
            document.getElementById('about-content-preview').innerHTML = marked.parse(markdownContent);
        };
        
        const saveSettings = async () => {
            setButtonsDisabled(true);
            const newConfig = JSON.parse(JSON.stringify(config)); // 深拷贝
            newConfig.site = {
                title: document.getElementById('setting-title').value.trim(),
                description: document.getElementById('setting-description').value.trim(),
                aboutContent: document.getElementById('setting-about-content').value.trim(), 
            };
            newConfig.styling = {
                backgroundColor: document.getElementById('setting-bg-color').value,
                textColor: document.getElementById('setting-text-color').value,
                accentColor: document.getElementById('setting-accent-color').value,
                backgroundImageUrl: document.getElementById('setting-bg-image-url').value.trim(),
            };

            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, getPath('config.json'), JSON.stringify(newConfig, null, 2), configSha, 'conf: update website settings');
                configSha = res.content.sha;
                config = newConfig; // 更新本地配置
                showAlert('网站设置已保存！', 'success');
            } catch (error) {
                showAlert(`网站设置保存失败: ${error.message}`, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };
        
        // ==================== Gitalk 评论设置功能 ====================
        const populateGitalkSettings = () => {
            const gitalkConfig = config.gitalk || {};
            document.getElementById('gitalk-enabled').checked = !!gitalkConfig.enabled;
            document.getElementById('gitalk-clientID').value = gitalkConfig.clientID || '';
            document.getElementById('gitalk-clientSecret').value = gitalkConfig.clientSecret || '';
            document.getElementById('gitalk-repo').value = gitalkConfig.repo || repo;
            document.getElementById('gitalk-owner').value = gitalkConfig.owner || owner;
            document.getElementById('gitalk-admin').value = (gitalkConfig.admin && Array.isArray(gitalkConfig.admin) ? gitalkConfig.admin.join(', ') : gitalkConfig.admin || '');
        };

        const saveGitalkSettings = async () => {
            setButtonsDisabled(true);
            const newConfig = JSON.parse(JSON.stringify(config)); // 深拷贝
            const gitalkAdminRaw = document.getElementById('gitalk-admin').value.trim();
            const gitalkAdminArray = gitalkAdminRaw.split(',').map(name => name.trim()).filter(Boolean);

            newConfig.gitalk = {
                enabled: document.getElementById('gitalk-enabled').checked,
                clientID: document.getElementById('gitalk-clientID').value.trim(),
                clientSecret: document.getElementById('gitalk-clientSecret').value.trim(),
                repo: document.getElementById('gitalk-repo').value.trim(),
                owner: document.getElementById('gitalk-owner').value.trim(),
                admin: gitalkAdminArray,
            };

            // 验证必填字段
            if (newConfig.gitalk.enabled && (!newConfig.gitalk.clientID || !newConfig.gitalk.clientSecret || !newConfig.gitalk.repo || !newConfig.gitalk.owner)) {
                showAlert('启用 Gitalk 评论时，Client ID, Client Secret, Repo, Owner 都是必填项！', 'danger');
                setButtonsDisabled(false);
                return;
            }

            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, getPath('config.json'), JSON.stringify(newConfig, null, 2), configSha, 'conf: update Gitalk settings');
                configSha = res.content.sha;
                config = newConfig; // 更新本地配置
                showAlert('Gitalk 评论设置已保存！', 'success');
            } catch (error) {
                showAlert(`Gitalk 评论设置保存失败: ${error.message}`, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };


        // ==================== 文件上传功能 (通用，用于图片) ====================
        const uploadFile = async (file, uploadPath, message) => {
            if (!file) return;
            // No need to disable all buttons, just show alert
            const reader = new FileReader();
            return new Promise((resolve, reject) => {
                reader.onload = async (e) => {
                    // content 是 base64 编码的二进制数据
                    const content = e.target.result.split(',')[1];
                    // 构建 GitHub 内部路径
                    const blobPath = getPath(`${uploadPath}/${new Date().toISOString().replace(/[-:.]/g, '')}_${file.name}`);
                    try {
                        const result = await GitHubAPI.createFile(token, owner, repo, blobPath, content, message, true);
                        resolve(result.content.download_url); // 返回可访问的 raw.githubusercontent.com URL
                    } catch (error) {
                         reject(error);
                    }
                };
                reader.onerror = (error) => {
                    reject(error);
                };
                reader.readAsDataURL(file);
            });
        };

        // ==================== EasyMDE 初始化及图片上传集成 ====================
        const initializeEasyMDE = () => {
            if (easyMDE) return; 

            easyMDE = new EasyMDE({
                element: document.getElementById('post-content'),
                spellChecker: false,
                forceSync: true, // 确保 textarea 的值始终与编辑器同步
                toolbar: [
                    "bold", "italic", "heading", "|",
                    "quote", "unordered-list", "ordered-list", "|",
                    "link", // Original link button
                    {
                        name: "image",
                        action: EasyMDE.drawImage, // Default action for markdown image
                        className: "fa fa-picture-o",
                        title: "Insert Image (Upload or URL)",
                    }, // Keep original image button for direct URL or markdown path
                    `insert-from-media-library`, // Custom button for media library
                    "table", "horizontal-rule", "|",
                    "preview", "side-by-side", "fullscreen", "|",
                    "guide"
                ],
                customIcons: { 
                    "insert-from-media-library": '<i class="fas fa-images fa-fw"></i>' // FontAwesome icon
                }
            });

            // 自定义媒体库插入按钮
            easyMDE.toolbar.find(item => item.name === 'insert-from-media-library').action = () => {
                showAdminView('media'); // 跳转到媒体库视图
                showAlert('请在媒体库中选择图片，然后点击“插入到文章”。', 'info', 'media-insert-tip');
                // Temporarily disable the switch view logic to handle the return from media library later using a global flag
            };
        };


        // ==================== 标签输入管理 ====================
        const allUniqueTags = new Set(); // 存储所有文章中出现的唯一标签
        const updateUniqueTags = () => {
            allUniqueTags.clear();
            posts.forEach(post => {
                if (post.tags && Array.isArray(post.tags)) {
                    post.tags.forEach(tag => allUniqueTags.add(tag));
                }
            });
        };

        const addTagToInput = (tagText, inputElement) => {
            tagText = tagText.trim();
            if (!tagText) return;

            const tagsContainer = document.getElementById('tag-token-container');
            let currentTags = JSON.parse(document.getElementById('post-tags').value || '[]');

            if (!currentTags.includes(tagText)) {
                currentTags.push(tagText);
                document.getElementById('post-tags').value = JSON.stringify(currentTags);

                const tagToken = document.createElement('span');
                tagToken.className = 'tag-token';
                tagToken.innerHTML = `${tagText} <i class="fas fa-times remove-tag"></i>`;
                tagToken.querySelector('.remove-tag').addEventListener('click', () => {
                    removeTagFromInput(tagText, inputElement);
                });
                tagsContainer.insertBefore(tagToken, inputElement);
            }
        };

        const removeTagFromInput = (tagText, inputElement) => {
            let currentTags = JSON.parse(document.getElementById('post-tags').value || '[]');
            currentTags = currentTags.filter(tag => tag !== tagText);
            document.getElementById('post-tags').value = JSON.stringify(currentTags);
            // 重新渲染标签 tokens
            const tagsContainer = document.getElementById('tag-token-container');
            tagsContainer.querySelectorAll('.tag-token').forEach(tagEl => tagEl.remove());
            currentTags.forEach(tag => addTagToInput(tag, inputElement)); // Re-add existing tags
        };

        // Tag input Autocomplete/Suggestions logic
        document.addEventListener('DOMContentLoaded', () => {
            const tagsInput = document.getElementById('post-tags-input');
            const tagSuggestionsBox = document.getElementById('tag-suggestions');
            const tagTokenContainer = document.getElementById('tag-token-container');

            tagsInput.addEventListener('focus', () => {
                if (allUniqueTags.size > 0) {
                     showTagSuggestions(tagsInput.value.trim().toLowerCase());
                }
            });
            tagsInput.addEventListener('blur', (e) => {
                setTimeout(() => {
                    if (!tagSuggestionsBox.contains(document.activeElement)) {
                        tagSuggestionsBox.style.display = 'none';
                    }
                }, 100);
            });

            tagsInput.addEventListener('input', () => {
                const inputValue = tagsInput.value.toLowerCase().trim();
                showTagSuggestions(inputValue);
            });

            tagsInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const inputValue = tagsInput.value.trim();
                    if (inputValue) {
                        addTagToInput(inputValue, tagsInput);
                        tagsInput.value = '';
                        tagSuggestionsBox.style.display = 'none';
                    }
                } else if (e.key === 'Backspace' && tagsInput.value === '') {
                    const lastTagToken = tagTokenContainer.querySelector('.tag-token:last-of-type');
                    if (lastTagToken) {
                        const tagText = lastTagToken.textContent.split(' ')[0].trim();
                        removeTagFromInput(tagText, tagsInput);
                    }
                }
            });

            tagTokenContainer.addEventListener('click', (e) => {
                if (e.target === tagTokenContainer || e.target.classList.contains('tag-token')) {
                    tagsInput.focus();
                }
            });

            const showTagSuggestions = (query) => {
                tagSuggestionsBox.innerHTML = '';
                const filteredSuggestions = Array.from(allUniqueTags).filter(tag =>
                    tag.toLowerCase().includes(query)
                ).sort();

                if (filteredSuggestions.length > 0) {
                    filteredSuggestions.forEach(tag => {
                        const div = document.createElement('div');
                        div.textContent = tag;
                        div.addEventListener('mousedown', (e) => { 
                            e.preventDefault();
                            addTagToInput(tag, tagsInput);
                            tagsInput.value = '';
                            tagSuggestionsBox.style.display = 'none';
                        });
                        tagSuggestionsBox.appendChild(div);
                    });
                    
                    const inputRect = tagsInput.getBoundingClientRect();
                    const containerRect = tagTokenContainer.getBoundingClientRect();
                    tagSuggestionsBox.style.top = `${containerRect.offsetHeight + 5}px`; 
                    tagSuggestionsBox.style.left = `0`;
                    tagSuggestionsBox.style.width = `${tagTokenContainer.offsetWidth}px`;

                    tagSuggestionsBox.style.display = 'block';
                } else {
                    tagSuggestionsBox.style.display = 'none';
                }
            };
        });


        // ==================== 事件绑定 ====================
        document.addEventListener('DOMContentLoaded', () => {
            // 登录
            startBtn.onclick = startAdmin;
            tokenInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') startAdmin(); });
            
            // 导航
            navButtons.dashboard.onclick = () => showAdminView('dashboard');
            navButtons.posts.onclick = () => { showAdminView('posts'); renderPostList(); };
            navButtons.media.onclick = () => { showAdminView('media'); };
            navButtons.settings.onclick = () => { showAdminView('settings'); populateSettings(); };
            navButtons.gitalkSettings.onclick = () => { showAdminView('gitalk-settings'); populateGitalkSettings(); };
            navButtons.logout.onclick = () => {
                if (confirm('确定要安全退出吗？')) {
                    localStorage.removeItem('github_token');
                    location.reload(); 
                }
            };

            // 仪表盘快速操作
            document.getElementById('dashboard-new-post-btn').onclick = () => openEditor();
            document.getElementById('dashboard-settings-btn').onclick = () => showAdminView('settings');
            document.getElementById('dashboard-media-btn').onclick = () => showAdminView('media');
            // 仪表盘最新文章点击编辑
            document.getElementById('dashboard-recent-posts').addEventListener('click', e => { 
                if(e.target.matches('.edit-link')) { 
                    e.preventDefault(); 
                    openEditor(e.target.dataset.id); 
                }
            });


            // 文章管理
            document.getElementById('new-post-btn').onclick = () => openEditor();
            document.getElementById('cancel-edit-btn').onclick = () => {
                 showAdminView('posts');
                 showAlert('已取消文章编辑。', 'info');
            };
            document.getElementById('save-post-btn').onclick = savePost;
            document.getElementById('delete-post-btn').onclick = () => deletePost(document.getElementById('post-id').value);
            postListBody.addEventListener('click', (e) => {
                if (e.target.closest('.edit')) { e.preventDefault(); openEditor(e.target.closest('a').dataset.id); }
                if (e.target.closest('.delete')) { e.preventDefault(); deletePost(e.target.closest('a').dataset.id); }
            });

            // 文章批量操作
            selectAllPostsCheckbox.addEventListener('change', () => {
                document.querySelectorAll('.post-checkbox').forEach(cb => cb.checked = selectAllPostsCheckbox.checked);
                toggleBulkDeleteButton();
            });
            postListBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('post-checkbox')) {
                    const allCheckboxes = document.querySelectorAll('.post-checkbox');
                    const checkedCheckboxes = document.querySelectorAll('.post-checkbox:checked');
                    selectAllPostsCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length;
                    toggleBulkDeleteButton();
                }
            });
            bulkDeletePostsBtn.onclick = bulkDeletePosts;

            // 媒体库操作
            document.getElementById('media-upload-btn').onclick = () => document.getElementById('media-upload-input').click();
            document.getElementById('media-upload-input').onchange = async (e) => {
                const files = e.target.files;
                if (!files.length) return;
                setButtonsDisabled(true);
                showAlert(`正在上传 ${files.length} 个文件...`, 'info', 'media-upload-alert');
                try {
                    await Promise.all([...files].map(file => uploadFile(file, 'images', `feat: upload file from media library "${file.name}"`)));
                    showAlert(`文件上传完成！`, 'success', 'media-upload-alert');
                    loadMediaLibrary(); // Refresh media list
                } catch (error) {
                    showAlert(`文件上传失败: ${error.message}`, 'danger', 'media-upload-alert');
                } finally {
                    setButtonsDisabled(false);
                }
                e.target.value = ''; // Reset file input
            };
            document.getElementById('media-library-grid').addEventListener('click', e => {
                 if(e.target.closest('.copy-url-btn')) copyToClipboard(e.target.closest('.copy-url-btn').dataset.url);
                 if(e.target.closest('.delete-media-btn')) { const btn = e.target.closest('.delete-media-btn'); deleteMediaFile(btn.dataset.path, btn.dataset.sha); }
                 if(e.target.closest('.insert-media-btn')) { 
                    const imageUrl = e.target.closest('.insert-media-btn').dataset.url;
                    if (easyMDE) {
                        const imageName = imageUrl.substring(imageUrl.lastIndexOf('/') + 1).split('_').slice(1).join('_'); // Get clean name
                        const markdownImage = `![${decodeURIComponent(imageName)}](${imageUrl})`;
                        easyMDE.codemirror.replaceSelection(markdownImage);
                        showAlert('图片已插入文章！', 'success');
                        showAdminView('editor'); // Return to editor view
                    } else {
                        showAlert('请先打开文章编辑器！', 'warning');
                    }
                 }
            });

            // 网站设置
            document.getElementById('save-settings-btn').onclick = saveSettings;
            // “关于我”内容实时预览
            document.getElementById('setting-about-content').addEventListener('input', updateAboutContentPreview);

            // 背景图上传处理
            const settingBgImageInput = document.getElementById('setting-bg-image');
            const settingBgImageUrlInput = document.getElementById('setting-bg-image-url');
            const uploadBgImageBtn = document.getElementById('upload-bg-image-btn');
            const clearBgImageBtn = document.getElementById('clear-bg-image-btn');

            settingBgImageInput.onchange = (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        updateSettingBgImagePreview(e.target.result); // Use data URL for preview
                        uploadBgImageBtn.style.display = 'inline-flex';
                    };
                    reader.readAsDataURL(file);
                } else {
                    updateSettingBgImagePreview('');
                    uploadBgImageBtn.style.display = 'none';
                }
            };
            settingBgImageUrlInput.addEventListener('input', () => {
                const url = settingBgImageUrlInput.value.trim();
                updateSettingBgImagePreview(url);
                uploadBgImageBtn.style.display = url ? 'none' : 'inline-flex';
            });

            uploadBgImageBtn.onclick = async () => {
                const file = settingBgImageInput.files[0];
                if (file) {
                    setButtonsDisabled(true);
                    showAlert(`正在上传背景图片 ${file.name}...`, 'info', 'bg-image-upload-alert');
                    try {
                        const url = await uploadFile(file, 'images', `feat: upload background image "${file.name}"`);
                        document.getElementById('setting-bg-image-url').value = url;
                        updateSettingBgImagePreview(url);
                        showAlert('背景图片上传并设置成功！请点击保存设置！', 'success', 'bg-image-upload-alert');
                    } catch (error) {
                        showAlert(`背景图片上传失败: ${error.message}`, 'danger', 'bg-image-upload-alert');
                    } finally {
                        setButtonsDisabled(false);
                    }
                } else {
                    showAlert('请先选择一个图片文件！', 'warning');
                }
            };
            clearBgImageBtn.onclick = () => {
                document.getElementById('setting-bg-image-url').value = '';
                settingBgImageInput.value = ''; 
                updateSettingBgImagePreview('');
                showAlert('背景图已清除！请点击保存设置！', 'info');
            };

            // Gitalk 配置保存
            document.getElementById('save-gitalk-settings-btn').onclick = saveGitalkSettings;

            // 移动端侧边栏切换
            document.getElementById('mobile-menu-btn').onclick = () => document.getElementById('admin-wrapper').classList.toggle('sidebar-visible');
            document.getElementById('mobile-overlay').onclick = () => document.getElementById('admin-wrapper').classList.remove('sidebar-visible');
            
            checkTokenAndStart();
        });
    </script>
</body>
</html>
