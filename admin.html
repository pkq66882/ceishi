<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博客后台管理系统 - 期望ai</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' font-size='90' text-anchor='middle' dominant-baseline='central'%3E⚙️%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        :root {
            --font-body: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --bg-color: #f4f6f8;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --sidebar-hover-bg: #34495e;
            --sidebar-active-bg: #1abc9c;
            --content-bg: #ffffff;
            --text-color: #34495e;
            --heading-color: #2c3e50;
            --accent-color: #3498db;
            --accent-hover: #2980b9;
            --border-color: #e0e0e0;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --shadow: 0 1px 3px rgba(0,0,0,.12), 0 1px 2px rgba(0,0,0,.24);
            --focus-glow: 0 0 0 3px rgba(52, 152, 219, 0.25);
        }

        body {
            font-family: var(--font-body);
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 15px;
            line-height: 1.6;
        }

        a { text-decoration: none; color: var(--accent-color); transition: color .2s; }
        a:hover { color: var(--accent-hover); }

        input, textarea, button, select {
            font-family: inherit;
            font-size: 100%;
            margin: 0;
            padding: 0;
            line-height: normal;
        }

        input:focus, textarea:focus, button:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: var(--focus-glow);
        }

        h1, h2, h3, h4, h5, h6 { color: var(--heading-color); margin-top: 0; margin-bottom: 20px; }

        #login-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--sidebar-bg);
            background-image: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        .login-box {
            width: 90%;
            max-width: 400px;
            padding: 40px;
            background: var(--content-bg);
            box-shadow: var(--shadow);
            border-radius: 8px;
            text-align: center;
            box-sizing: border-box;
        }
        .login-box h1 { margin-bottom: 25px; font-size: 2rem; color: var(--heading-color); }
        .login-box p { margin-bottom: 25px; color: #7f8c8d; line-height: 1.8; }
        .login-box input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1rem;
            color: var(--text-color);
            background-color: var(--bg-color);
        }
        .login-box input[type="checkbox"] { margin-right: 8px; }
        .remember-token-group {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--text-color);
        }
        .login-box button {
            width: 100%;
            padding: 12px;
            background: var(--accent-color);
            color: #fff;
            border: 0;
            border-radius: 5px;
            cursor: pointer;
            transition: background .2s ease, box-shadow .2s ease;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .login-box button:hover { background: var(--accent-hover); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .login-box button:disabled { background: #cccccc; cursor: not-allowed; }
        #initial-message { color: var(--danger-color); margin-top: 20px; font-size: 0.9rem; }
        .generate-token-link {
            display: block;
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--accent-color);
        }

        .admin-wrapper {
            display: flex;
            min-height: 100vh;
            background-color: var(--bg-color);
        }

        #admin-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 250px;
            background: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            transform: translateX(-100%);
            transition: transform .3s ease-in-out;
            z-index: 1000;
            box-shadow: var(--shadow);
        }
        .admin-wrapper.sidebar-visible #admin-sidebar { transform: translateX(0); }
        #admin-sidebar .logo {
            padding: 25px 20px;
            font-size: 1.6rem;
            font-weight: 700;
            text-align: center;
            background-color: rgba(0,0,0,.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        #admin-sidebar .nav {
            flex-grow: 1;
            list-style: none;
            margin: 0;
            padding: 20px 0;
        }
        #admin-sidebar .nav li { margin-bottom: 5px; }
        #admin-sidebar .nav a {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: var(--sidebar-text);
            transition: background .2s ease;
            border-left: 5px solid transparent;
        }
        #admin-sidebar .nav a i {
            margin-right: 12px;
            font-size: 1.1rem;
        }
        #admin-sidebar .nav a:hover { background: var(--sidebar-hover-bg); }
        #admin-sidebar .nav a.active {
            background: var(--sidebar-active-bg);
            color: white;
            border-left-color: #fff;
            font-weight: 600;
        }
        #admin-sidebar footer {
             padding: 20px;
             font-size: 0.9rem;
             color: #a0a8b4;
             border-top: 1px solid rgba(255,255,255,0.1);
             text-align: center;
        }
        #admin-sidebar footer a { color: var(--sidebar-active-bg); }


        #admin-content {
            flex-grow: 1;
            margin-left: 0;
            padding: 30px;
            box-sizing: border-box;
            transition: margin-left .3s ease-in-out;
        }

        #mobile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--content-bg);
            padding: 15px 20px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border-radius: 8px;
        }
        .mobile-menu-btn {
            font-size: 1.8rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
        }
        .mobile-logo {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--heading-color);
        }
        #mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.5);
            z-index: 999;
            display: none;
        }
        .admin-wrapper.sidebar-visible #mobile-overlay{ display: block; }

        @media(min-width: 768px) {
            #admin-sidebar {
                position: static;
                transform: translateX(0);
                flex-shrink: 0;
            }
            #admin-content {
                margin-left: 250px;
                padding: 30px;
            }
            #mobile-header { display: none; }
            #mobile-overlay { display: none !important; }
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }
        .page-header h2 {
            font-size: 1.8rem;
            margin: 0;
            line-height: 1;
        }

        .form-group { margin-bottom: 25px; }
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--heading-color);
            font-size: 0.95rem;
        }
        .form-group input:not([type="checkbox"]), .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            box-sizing: border-box;
            background-color: var(--content-bg);
            color: var(--text-color);
            font-size: 1rem;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 250px;
        }
        .form-group .description {
            font-size: 0.85rem;
            color: var(--meta-color);
            margin-top: 5px;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        .button-group {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        button, .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background .2s ease, box-shadow .2s ease;
            font-weight: 600;
        }
        button i, .btn i { margin-right: 8px; }
        button:hover:not(:disabled), .btn:hover:not(:disabled) { opacity: 0.9; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        button:disabled, .btn:disabled { background: #cccccc !important; cursor: not-allowed; opacity: 0.7; }

        .btn-primary { background: var(--accent-color); color: #fff; }
        .btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
        .btn-success { background: var(--success-color); color: #fff; }
        .btn-success:hover:not(:disabled) { background: #218838; }
        .btn-danger { background: var(--danger-color); color: #fff; }
        .btn-danger:hover:not(:disabled) { background: #c82333; }
        .btn-secondary { background: #6c757d; color: #fff; }
        .btn-secondary:hover:not(:disabled) { background: #5a6268; }

        .admin-table-wrapper { overflow-x: auto; background: var(--content-bg); border-radius: 8px; box-shadow: var(--shadow); }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--content-bg);
        }
        .admin-table thead { background: #f8f9fa; }
        .admin-table th, .admin-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        .admin-table th {
            font-weight: 700;
            color: var(--heading-color);
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        .admin-table td {
            font-size: 0.95rem;
            color: var(--text-color);
        }
        .admin-table tr:last-child td { border-bottom: none; }
        .admin-table .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-start;
            flex-wrap: wrap;
        }
        .admin-table .actions a.edit { color: var(--accent-color); }
        .admin-table .actions a.delete { color: var(--danger-color); }
        .admin-table .actions a.link { color: var(--sidebar-active-bg); }

        /* EasyMDE 样式调整 */
        .editor-toolbar {
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            background-color: #f8f9fa !important;
            border-color: var(--border-color) !important;
        }
        .editor-toolbar button { background: none !important; color: var(--text-color) !important; border: none !important; }
        .editor-toolbar button.active, .editor-toolbar button:hover { background-color: var(--border-color) !important; }
        .editor-toolbar button.active { border-radius: 4px; }
        .CodeMirror {
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
            border: 1px solid var(--border-color) !important;
            border-top: none !important;
            min-height: 400px;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .CodeMirror-fullscreen { z-index: 2000; }
        .editor-preview-active, .editor-preview-active-side {
            background-color: var(--content-bg) !important;
            color: var(--text-color) !important;
            padding: 15px;
        }
        .editor-preview h1, .editor-preview h2, .editor-preview h3, .editor-preview h4, .editor-preview h5, .editor-preview h6 {
            color: var(--heading-color);
        }
        .editor-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1rem 0;
            display: block;
        }
        .editor-preview blockquote {
            padding: 0.5em 1em;
            margin: 1em 0;
            border-left: 4px solid var(--accent-color);
            color: var(--meta-color);
            background-color: rgba(52, 152, 219, 0.05);
            border-radius: 5px;
        }
        .CodeMirror-scroll { background-color: var(--content-bg); }

        /* Alerts */
        .alert {
            padding: 15px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .alert i { font-size: 1.2rem; }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .alert-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        /* Tag/Category Suggestions */
        .suggestion-box {
            position: absolute;
            background-color: var(--content-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            max-height: 150px;
            overflow-y: auto;
            width: 100%;
            z-index: 100;
            box-shadow: var(--shadow);
            top: 100%;
            left: 0;
            margin-top: 5px;
        }
        .suggestion-box div {
            padding: 10px;
            cursor: pointer;
            transition: background-color .2s;
        }
        .suggestion-box div:hover {
            background-color: var(--accent-color);
            color: white;
        }
        .form-group.has-suggestions { position: relative; }
        .tag-token-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 8px 10px;
            min-height: 40px;
            align-items: center;
            background-color: var(--content-bg);
            cursor: text;
        }
        .tag-token {
            display: inline-flex;
            align-items: center;
            background-color: var(--accent-color);
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .tag-token .remove-tag {
            margin-left: 5px;
            cursor: pointer;
            color: rgba(255,255,255,0.7);
        }
        .tag-token-input {
            border: none !important;
            flex-grow: 1;
            padding: 0 !important;
            margin-left: 5px;
            background: transparent !important;
            color: var(--text-color) !important;
            line-height: 1.5 !important;
        }
        .tag-token-input:focus {
            box-shadow: none !important;
        }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--content-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card .icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        .stat-card .info {
            flex-grow: 1;
        }
        .stat-card .info .number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--heading-color);
            margin: 0;
        }
        .stat-card .info .label {
            font-size: 1rem;
            color: var(--text-color);
            opacity: 0.85;
            margin: 0;
        }
        .quick-actions-card {
            background: var(--content-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
        }
        .quick-actions-card h3 {
            margin-top: 0;
            font-size: 1.5rem;
            color: var(--heading-color);
        }
        .recent-posts-card {
            background: var(--content-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
        }
        .recent-posts-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .recent-posts-card li {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        .recent-posts-card li:last-child {
            border-bottom: none;
        }
        .recent-posts-card li:hover {
            background-color: rgba(52, 152, 219, 0.05);
            margin: 0 -15px;
            padding: 12px 15px;
        }
        .recent-posts-card li a {
            font-weight: 600;
            color: var(--text-color);
            text-decoration: none;
        }
        .recent-posts-card li a:hover {
            color: var(--accent-color);
        }
        .recent-posts-card li .date {
            font-size: 0.85rem;
            color: var(--meta-color);
        }

        /* Media Library Styles */
        .media-library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
        }
        .media-card {
            background-color: var(--content-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .media-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .media-card .image-container {
            width: 100%;
            padding-top: 100%;
            position: relative;
            background-color: #f0f0f0;
            overflow: hidden;
        }
        .media-card img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        .media-card:hover img {
            transform: scale(1.05);
        }
        .media-card .info {
            padding: 12px;
            font-size: 0.85rem;
            word-break: break-all;
            text-align: center;
            background-color: var(--content-bg);
        }
        .media-card .actions {
            display: flex;
            gap: 8px;
            padding: 12px;
            justify-content: center;
        }
        .media-card .actions .btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        /* Markdown Preview Box */
        .markdown-preview-box {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            background-color: #f8f9fa;
            margin-top: 20px;
        }
        .markdown-preview-box h4 {
            margin: 0 0 15px 0;
            font-size: 1rem;
            color: var(--heading-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .markdown-preview-box .preview-content {
            background: var(--content-bg);
            padding: 20px;
            border-radius: 8px;
            min-height: 100px;
        }
        .markdown-preview-box .preview-content h1,
        .markdown-preview-box .preview-content h2,
        .markdown-preview-box .preview-content h3 {
            color: var(--heading-color);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .markdown-preview-box .preview-content p {
            margin-bottom: 1rem;
            line-height: 1.7;
        }
        .markdown-preview-box .preview-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>

    <div id="login-wrapper">
        <div id="login-box" class="login-box">
             <h1><i class="fas fa-lock"></i> 博客管理</h1>
             <p>请输入您的GitHub Personal Access Token以开始。该Token需具备 <code style="background-color: #f0f0f0; padding: 2px 5px; border-radius: 3px;">repo</code> 权限。</p>
             <input type="password" id="token-input" placeholder="ghp_xxx 或 Bearer xxx">
            <div class="remember-token-group">
                <input type="checkbox" id="remember-token">
                <label for="remember-token">记住Token (高风险，仅限个人安全设备)</label>
            </div>
             <button id="start-btn"><i class="fas fa-sign-in-alt"></i> 登录</button>
             <p id="initial-message"></p>
             <a href="https://github.com/settings/tokens" target="_blank" class="generate-token-link">如何生成 Personal Access Token?</a>
        </div>
    </div>

    <div id="admin-wrapper" class="admin-wrapper" style="display: none;">
        <div id="mobile-overlay"></div>
        <aside id="admin-sidebar">
            <div class="logo">博客管理系统</div>
            <ul class="nav">
                <li><a href="#" id="nav-dashboard" class="active" data-view="dashboard"><i class="fas fa-tachometer-alt"></i> 仪表盘</a></li>
                <li><a href="#" id="nav-posts" data-view="posts"><i class="fas fa-newspaper"></i> 文章管理</a></li>
                <li><a href="#" id="nav-media" data-view="media"><i class="fas fa-images"></i> 媒体库</a></li>
                <li><a href="#" id="nav-settings" data-view="settings"><i class="fas fa-cogs"></i> 网站设置</a></li>
                <li><a href="#" id="nav-gitalk-settings" data-view="gitalk-settings"><i class="fas fa-comments"></i> 评论设置</a></li>
                <li><a href="index.html" target="_blank"><i class="fas fa-desktop"></i> 查看站点</a></li>
                <li><a href="#" id="nav-logout"><i class="fas fa-sign-out-alt"></i> 安全退出</a></li>
            </ul>
            <footer>
                 <p>Powered by <a href="https://github.com" target="_blank">期望ai</a></p>
            </footer>
        </aside>

        <main id="admin-content">
            <header id="mobile-header">
                <button id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
                <div class="mobile-logo">管理后台</div>
            </header>

            <!-- 仪表盘视图 -->
            <div id="dashboard-view" class="admin-view">
                <div class="page-header"><h2><i class="fas fa-home"></i> 仪表盘</h2></div>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-file-alt"></i></div>
                        <div class="info">
                            <p id="stat-posts" class="number">0</p>
                            <p class="label">篇文章</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-folder-open"></i></div>
                        <div class="info">
                            <p id="stat-categories" class="number">0</p>
                            <p class="label">个分类</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-tags"></i></div>
                        <div class="info">
                            <p id="stat-tags" class="number">0</p>
                            <p class="label">个标签</p>
                        </div>
                    </div>
                </div>
                <div class="dashboard-grid">
                    <div class="quick-actions-card">
                        <h3>快速操作</h3>
                        <div class="button-group">
                            <button id="dashboard-new-post-btn" class="btn btn-primary"><i class="fas fa-plus-circle"></i> 撰写新文章</button>
                            <button id="dashboard-settings-btn" class="btn btn-secondary"><i class="fas fa-cog"></i> 网站设置</button>
                        </div>
                    </div>
                    <div class="recent-posts-card">
                        <h3>最新文章</h3>
                        <ul id="dashboard-recent-posts">
                            <li>暂无文章</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 文章管理视图 -->
            <div id="posts-view" class="admin-view" style="display: none;">
                <div class="page-header">
                    <h2><i class="fas fa-list-alt"></i> 文章管理</h2>
                    <button id="new-post-btn" class="btn-primary"><i class="fas fa-plus-circle"></i> 撰写新文章</button>
                </div>
                <div class="admin-table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr><th>标题</th><th>分类</th><th>标签</th><th>发布日期</th><th>更新日期</th><th class="actions">操作</th></tr>
                        </thead>
                        <tbody id="post-list">
                            <tr><td colspan="6" style="text-align: center;">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 文章编辑/创建视图 -->
            <div id="editor-container" class="admin-view" style="display: none;">
                 <h2 id="editor-title"><i class="fas fa-edit"></i> 撰写新文章</h2>
                 <input type="hidden" id="post-id">
                <div class="form-group">
                    <label for="post-title">文章标题 <span style="color:red;">*</span></label>
                    <input type="text" id="post-title" placeholder="请输入文章标题">
                </div>
                 <div class="form-group">
                    <label for="post-category">文章分类</label>
                    <input type="text" id="post-category" placeholder="请输入文章分类，例如：技术，生活">
                </div>
                 <div class="form-group has-suggestions">
                    <label for="post-tags-input">文章标签 (按 Enter 键添加，点击标签删除)</label>
                    <div id="tag-token-container" class="tag-token-container">
                        <input type="text" id="post-tags-input" placeholder="输入标签并按回车">
                    </div>
                    <div id="tag-suggestions" class="suggestion-box" style="display: none;"></div>
                    <input type="hidden" id="post-tags">
                     <p class="description">输入标签后按回车键添加。点击现有标签可删除。</p>
                </div>
                <div class="form-group">
                    <label for="post-content">文章内容 (支持 Markdown)</label>
                    <textarea id="post-content"></textarea>
                     <p class="description">请使用 Markdown 格式编写文章。使用 <code>&lt;!--more--&gt;</code> 可定义文章摘要。</p>
                </div>
                <div class="button-group">
                    <button id="save-post-btn" class="btn-success"><i class="fas fa-upload"></i> 发布/更新文章</button>
                    <button id="cancel-edit-btn" class="btn-secondary"><i class="fas fa-times-circle"></i> 取消</button>
                    <button id="delete-post-btn" class="btn-danger" style="display:none;"><i class="fas fa-trash-alt"></i> 删除文章</button>
                </div>
            </div>

            <!-- 媒体库视图 -->
            <div id="media-view" class="admin-view" style="display: none;">
                <div class="page-header">
                    <h2><i class="fas fa-photo-video"></i> 媒体库</h2>
                    <div>
                        <input type="file" id="media-upload-input" accept="image/*" multiple style="display: none;">
                        <button id="media-uploadBtn" class="btn-primary"><i class="fas fa-upload"></i> 上传新图片</button>
                    </div>
                </div>
                <div id="media-library-grid" class="media-library-grid">
                    <p>正在加载媒体文件...</p>
                </div>
            </div>


            <!-- 网站设置视图 -->
            <div id="settings-view" class="admin-view" style="display: none;">
                <div class="page-header">
                    <h2><i class="fas fa-cogs"></i> 网站设置</h2>
                    <button id="save-settings-btn" class="btn-success"><i class="fas fa-save"></i> 保存设置</button>
                </div>
                 <div class="form-group">
                    <label for="setting-title">网站标题 <span style="color:red;">*</span></label>
                    <input type="text" id="setting-title" placeholder="例如：我的个人博客">
                </div>
                <div class="form-group">
                    <label for="setting-description">网站描述</label>
                    <input type="text" id="setting-description" placeholder="一句话描述你的博客">
                </div>
                <div class="form-group">
                    <label for="setting-about-content">"关于我"页面内容 (支持 Markdown)</label>
                    <textarea id="setting-about-content" rows="10" placeholder="请在这里填写关于你的介绍，支持 Markdown 格式。"></textarea>
                     <p class="description">此内容将显示在网站的"关于我"页面。</p>
                     <div class="markdown-preview-box">
                         <h4><i class="fas fa-eye"></i> Markdown 预览</h4>
                         <div id="about-preview" class="preview-content">预览将显示在这里...</div>
                     </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="setting-bg-color">背景颜色</label><input type="color" id="setting-bg-color">
                    </div>
                    <div class="form-group">
                        <label for="setting-text-color">文字颜色</label><input type="color" id="setting-text-color">
                    </div>
                    <div class="form-group">
                        <label for="setting-accent-color">链接/强调色</label><input type="color" id="setting-accent-color">
                    </div>
                </div>
                <div class="form-group">
                    <label for="setting-bg-image">网站背景图</label>
                    <input type="file" id="setting-bg-image" accept="image/*">
                    <input type="text" id="setting-bg-image-url" placeholder="背景图URL将显示在这里" readonly style="margin-top: 10px;">
                    <div class="button-group" style="margin-top: 10px; justify-content: flex-start;">
                        <button id="upload-bg-image-btn" class="btn-primary" style="display:none;"><i class="fas fa-upload"></i> 上传并设置</button>
                        <button id="clear-bg-image-btn" class="btn-danger"><i class="fas fa-trash-alt"></i> 清除背景图</button>
                    </div>
                </div>
            </div>

            <!-- Gitalk 评论设置视图 -->
            <div id="gitalk-settings-view" class="admin-view" style="display: none;">
                <div class="page-header">
                    <h2><i class="fas fa-comments"></i> 评论设置</h2>
                    <button id="save-gitalk-settings-btn" class="btn-success"><i class="fas fa-save"></i> 保存评论设置</button>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Gitalk 基于 GitHub Issues，评论内容将存储在您的 GitHub 仓库中。请确保您的 GitHub Token 拥有 <code>repo</code> 权限。
                </div>
                <div class="form-group">
                    <label for="gitalk-enabled">启用 Gitalk 评论系统</label>
                    <div>
                        <label style="display: flex; align-items: center; margin-bottom: 0;">
                            <input type="checkbox" id="gitalk-enabled" style="width: auto; margin-right: 10px;">
                            <span>启用 Gitalk 评论系统</span>
                        </label>
                    </div>
                    <p class="description">启用后，将在文章页面下方显示评论功能。</p>
                </div>
                <div class="form-group">
                    <label for="gitalk-clientID">GitHub Application Client ID <span style="color:red;">*</span></label>
                    <input type="text" id="gitalk-clientID" placeholder="GitHub OAuth Application Client ID">
                </div>
                <div class="form-group">
                    <label for="gitalk-clientSecret">GitHub Application Client Secret <span style="color:red;">*</span></label>
                    <input type="password" id="gitalk-clientSecret" placeholder="GitHub OAuth Application Client Secret">
                </div>
                <div class="form-group">
                    <label for="gitalk-repo">GitHub 仓库名 (用于存储评论) <span style="color:red;">*</span></label>
                    <input type="text" id="gitalk-repo" placeholder="例如：your-repo-name">
                </div>
                <div class="form-group">
                    <label for="gitalk-owner">GitHub 仓库所有者 <span style="color:red;">*</span></label>
                    <input type="text" id="gitalk-owner" placeholder="例如：your-github-username">
                </div>
                <div class="form-group">
                    <label for="gitalk-admin">管理员 (用英文逗号分隔)</label>
                    <input type="text" id="gitalk-admin" placeholder="例如：your-github-username">
                </div>
            </div>
        </main>
    </div>

    <!-- EasyMDE Markdown 编辑器 JS -->
    <script src="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.js"></script>

    <script>
        // 全局变量和工具函数
        const utf8_to_b64 = (str) => btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
        const b64_to_utf8 = (str) => {
            try { 
                return decodeURIComponent(
                    atob(str)
                    .split('')
                    .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
                    .join('')
                ); 
            } catch (e) { 
                return atob(str); 
            }
        };

        const GitHubAPI = {
            BASE_URL: 'https://api.github.com',
            async request(token, endpoint, options = {}) {
                const url = `${this.BASE_URL}${endpoint}`;
                const headers = { 
                    'Authorization': `token ${token}`, 
                    'Accept': 'application/vnd.github.v3+json',
                    ...options.headers 
                };
                
                try {
                    const response = await fetch(url, { ...options, headers });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ 
                            message: `HTTP Error: ${response.statusText}`, 
                            documentation_url: response.url || endpoint 
                        }));
                        
                        const errorMessage = errorData.message || `GitHub API request failed with status ${response.status}`;
                        console.error('GitHub API Error:', errorMessage, errorData);
                        
                        // 404 时的特殊处理
                        if (response.status === 404) {
                            throw new Error(`${errorMessage} (路径：${endpoint})`);
                        }
                        
                        return Promise.reject(errorMessage);
                    }
                    
                    if (response.status === 204 || response.headers.get("Content-Length") === "0") return null;
                    return response.json();
                } catch (error) {
                    console.error('Request failed:', error);
                    return Promise.reject(error);
                }
            },
            async getUser(token) { 
                return this.request(token, '/user'); 
            },
            async getFile(token, owner, repo, path) {
                try {
                    const result = await this.request(token, `/repos/${owner}/${repo}/contents/${path}`);
                    if (!result || typeof result.content !== 'string') {
                        return null; 
                    }
                    return { content: b64_to_utf8(result.content), sha: result.sha };
                } catch (error) {
                    if (error.message.toLowerCase().includes('not found')) {
                        return null;
                    }
                    throw error;
                }
            },
            async getDirectoryContents(token, owner, repo, path) {
                try {
                    return await this.request(token, `/repos/${owner}/${repo}/contents/${path}`);
                } catch (error) {
                    if (error.message.toLowerCase().includes('not found')) return [];
                    throw error;
                }
            },
            async createFile(token, owner, repo, path, content, message, isBinary = false) { 
                return this.request(token, `/repos/${owner}/${repo}/contents/${path}`, { 
                    method: 'PUT', 
                    body: JSON.stringify({ 
                        message, 
                        content: isBinary ? content : utf8_to_b64(content) 
                    }) 
                });
            },
            async updateFile(token, owner, repo, path, content, sha, message, isBinary = false) {
                return this.request(token, `/repos/${owner}/${repo}/contents/${path}`, { 
                    method: 'PUT', 
                    body: JSON.stringify({ 
                        message, 
                        content: isBinary ? content : utf8_to_b64(content), 
                        sha 
                    }) 
                });
            },
            async deleteFile(token, owner, repo, path, sha, message) { 
                return this.request(token, `/repos/${owner}/${repo}/contents/${path}`, { 
                    method: 'DELETE', 
                    body: JSON.stringify({ message, sha }) 
                });
            },
        };

        // DOM 元素缓存
        const loginWrapper = document.getElementById('login-wrapper');
        const adminWrapper = document.getElementById('admin-wrapper');
        const tokenInput = document.getElementById('token-input');
        const rememberTokenCheckbox = document.getElementById('remember-token');
        const startBtn = document.getElementById('start-btn');
        const initialMessageEl = document.getElementById('initial-message');

        const adminViews = {
            dashboard: document.getElementById('dashboard-view'),
            posts: document.getElementById('posts-view'),
            editor: document.getElementById('editor-container'),
            media: document.getElementById('media-view'),
            settings: document.getElementById('settings-view'),
            gitalkSettings: document.getElementById('gitalk-settings-view'),
        };
        const navButtons = {
            dashboard: document.getElementById('nav-dashboard'),
            posts: document.getElementById('nav-posts'),
            media: document.getElementById('nav-media'),
            settings: document.getElementById('nav-settings'),
            gitalkSettings: document.getElementById('nav-gitalk-settings'),
            logout: document.getElementById('nav-logout'),
        };
        const postListBody = document.getElementById('post-list');

        let token = null, owner = '', repo = '', basePath = '';
        let posts = [], postsSha = '';
        let config = {}, configSha = '';
        let easyMDE;

        const getPath = (fileName) => basePath ? `${basePath}/${fileName}` : fileName;

        async function createGitHubDirectory(apiToken, apiOwner, apiRepo, directoryPath) {
            if (!directoryPath) return true;
            const gitkeepPath = `${directoryPath}/.gitkeep`;
            try {
                const fileData = await GitHubAPI.getFile(apiToken, apiOwner, apiRepo, gitkeepPath);
                if (!fileData) {
                    await GitHubAPI.createFile(apiToken, apiOwner, apiRepo, gitkeepPath, '', `feat: create directory ${directoryPath}`);
                }
                return true;
            } catch (error) {
                console.error(`Failed to create directory ${directoryPath}:`, error);
                throw error;
            }
        }
        
        // UI 辅助函数
        const showAdminView = (viewName) => {
            // 检查视图元素是否存在
            const view = adminViews[viewName];
            if (!view) {
                console.error(`View element not found: ${viewName}`);
                return;
            }

            Object.values(adminViews).forEach(v => {
                if (v) v.style.display = 'none';
            });
            
            if (easyMDE && viewName !== 'editor') {
                easyMDE.toTextArea();
                document.getElementById('post-content').style.display = '';
                easyMDE = null;
            }
            
            Object.values(navButtons).forEach(b => {
                if (b) b.classList.remove('active');
            });
            
            const currentNavLink = navButtons[viewName];
            if (currentNavLink) {
                currentNavLink.classList.add('active');
            } else if (viewName === 'editor') {
                if (navButtons.posts) navButtons.posts.classList.add('active');
            }
            
            view.style.display = 'block';
            
            if (viewName === 'editor' && !easyMDE) {
                initializeEasyMDE();
            }
            
            // 特定视图的初始化函数
            if (viewName === 'dashboard') renderDashboard();
            if (viewName === 'media') loadMediaLibrary();
            if (viewName === 'settings') updateMarkdownPreview();
            
            document.querySelector('.admin-wrapper').classList.remove('sidebar-visible');
            
            // 滚动到顶部
            window.scrollTo(0, 0);
        };

        const setButtonsDisabled = (disabled) => {
            document.querySelectorAll('button').forEach(b => {
                if (b) b.disabled = disabled;
            });
        };

        const showAlert = (message, type = 'info', id = 'global-alert') => {
            let existingAlert = document.getElementById(id);
            if (!existingAlert) {
                existingAlert = document.createElement('div');
                existingAlert.id = id;
                if (adminWrapper && adminWrapper.querySelector('main')) {
                    adminWrapper.querySelector('main').prepend(existingAlert);
                } else {
                    document.body.prepend(existingAlert);
                }
            }
            existingAlert.className = `alert alert-${type}`;
            const icon = {
                'info': 'fas fa-info-circle', 
                'success': 'fas fa-check-circle', 
                'danger': 'fas fa-exclamation-circle', 
                'warning': 'fas fa-exclamation-triangle'
            }[type];
            existingAlert.innerHTML = `<i class="${icon}"></i> ${message}`;
            existingAlert.style.display = 'flex';
            
            // 自动消失
            setTimeout(() => {
                if (existingAlert) existingAlert.style.display = 'none';
            }, 5000);
        };

        const renderDashboard = () => {
            const uniqueCategories = new Set(posts.map(p => p.category).filter(Boolean));
            const allTags = posts.flatMap(p => p.tags || []);
            const uniqueTags = new Set(allTags);
    
            const statPosts = document.getElementById('stat-posts');
            if (statPosts) statPosts.textContent = posts.length;
            const statCategories = document.getElementById('stat-categories');
            if (statCategories) statCategories.textContent = uniqueCategories.size;
            const statTags = document.getElementById('stat-tags');
            if (statTags) statTags.textContent = uniqueTags.size;
    
            const recentPostsList = document.getElementById('dashboard-recent-posts');
            if (!recentPostsList) return;
            recentPostsList.innerHTML = '';
            const recentPosts = [...posts].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
            if (recentPosts.length > 0) {
                recentPosts.forEach(post => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div style="flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            <a href="#" class="edit-link" data-id="${post.id}" style="color: var(--text-color);">${post.title}</a>
                        </div>
                        <span class="date">${new Date(post.createdAt).toLocaleDateString()}</span>
                    `;
                    recentPostsList.appendChild(li);
                });
            } else {
                recentPostsList.innerHTML = '<li>暂无文章</li>';
            }
        };

        const loadMediaLibrary = async () => {
            const grid = document.getElementById('media-library-grid');
            if (!grid) return;
            grid.innerHTML = '<p>正在加载媒体文件...</p>';
            try {
                const files = await GitHubAPI.getDirectoryContents(token, owner, repo, getPath('images'));
                grid.innerHTML = '';
                if (files && files.length > 0) {
                    files.filter(file => file.type === 'file' && (file.name.endsWith('.gitkeep') === false)).forEach(file => {
                        const card = document.createElement('div');
                        card.className = 'media-card';
                        card.innerHTML = `
                            <div class="image-container">
                                <img src="${file.download_url}" alt="${file.name}" loading="lazy">
                            </div>
                            <div class="info">${file.name}</div>
                            <div class="actions">
                                <button class="btn btn-secondary copy-url-btn" data-file='${JSON.stringify({name: file.name, url: file.download_url})}'><i class="fas fa-copy"></i> 复制</button>
                                <button class="btn btn-danger delete-media-btn" data-path="${file.path}" data-sha="${file.sha}"><i class="fas fa-trash"></i> 删除</button>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                } else {
                     grid.innerHTML = '<p style="padding: 30px; text-align: center;">媒体库为空。请上传一些图片。</p>';
                }
            } catch (error) {
                grid.innerHTML = `<div class="alert alert-danger">加载媒体库失败: ${error.message}</div>`;
            }
        };

        const updateMarkdownPreview = () => {
            const aboutContent = document.getElementById('setting-about-content').value;
            const previewEl = document.getElementById('about-preview');
            if (previewEl) {
                previewEl.innerHTML = marked.parse(aboutContent || '在上方输入内容，这里将显示Markdown预览...');
            }
        };

        // 登录/初始化
        const checkTokenAndStart = async () => {
            const storedToken = localStorage.getItem('github_token');
            if (storedToken) {
                tokenInput.value = storedToken;
                rememberTokenCheckbox.checked = true;
                startAdmin();
            }
        };

        const startAdmin = async () => {
            const userToken = tokenInput.value.trim();
            if (!userToken) { 
                initialMessageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Token 不能为空。'; 
                return; 
            }
            token = userToken;
            setButtonsDisabled(true);
            initialMessageEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在验证并加载...';
            initialMessageEl.style.color = 'var(--text-color)';

            try {
                const user = await GitHubAPI.getUser(token);
                owner = user.login;
                
                const hostname = window.location.hostname;
                let pathSegments = window.location.pathname.split('/').filter(p => p);

                if (hostname.endsWith('.github.io')) {
                    if (pathSegments.length > 0 && pathSegments[pathSegments.length - 1].toLowerCase().endsWith('admin.html')) {
                        pathSegments.pop();
                    }
                    if (pathSegments.length > 0) {
                        repo = pathSegments[0];
                        basePath = pathSegments.slice(1).join('/');
                    } else {
                        repo = hostname;
                        basePath = '';
                    }
                } else {
                    if (pathSegments.length > 0 && pathSegments[pathSegments.length - 1].toLowerCase().endsWith('admin.html')) {
                        pathSegments.pop();
                    }
                    if (pathSegments.length > 0) {
                        repo = pathSegments[0];
                        basePath = pathSegments.slice(1).join('/');
                    } else {
                        throw new Error("无法从URL中确定仓库名称，请在标准GitHub Pages环境中使用。");
                    }
                }

                // 创建必要的目录
                const baseDirParts = basePath.split('/').filter(Boolean);
                let currentPathAccumulated = '';
                for (const part of baseDirParts) {
                    currentPathAccumulated = currentPathAccumulated ? `${currentPathAccumulated}/${part}` : part;
                    await createGitHubDirectory(token, owner, repo, currentPathAccumulated);
                }
                await createGitHubDirectory(token, owner, repo, getPath('images'));

                // 获取配置文件
                const configPath = getPath('config.json');
                const postsPath = getPath('posts.json');
                let [configData, postsData] = await Promise.all([
                    GitHubAPI.getFile(token, owner, repo, configPath),
                    GitHubAPI.getFile(token, owner, repo, postsPath)
                ]);

                if (!configData && !postsData) {
                    throw new Error("找不到配置文件。请确保 config.json 和 posts.json 存在于仓库的根目录或指定路径中。");
                }

                // 加载配置
                if (configData) {
                    config = JSON.parse(configData.content);
                    configSha = configData.sha;
                } else {
                    config = {
                        site: { 
                            title: `${user.login}的博客`, 
                            description: "一个由GitHub驱动的博客", 
                            aboutContent: "# 关于我\n\n欢迎来到我的博客！这是一个通过GitHub Pages托管的博客系统。\n\n创建你的第一篇文章吧！" 
                        },
                        styling: { 
                            backgroundColor: "#f8f9fa", 
                            textColor: "#212529", 
                            accentColor: "#0d6efd", 
                            backgroundImageUrl: "" 
                        },
                        gitalk: { 
                            enabled: false, 
                            clientID: '', 
                            clientSecret: '', 
                            repo: repo, 
                            owner: owner, 
                            admin: [owner] 
                        }
                    };
                    const res = await GitHubAPI.createFile(token, owner, repo, configPath, JSON.stringify(config, null, 2), 'feat: initialize config');
                    configSha = res.content.sha;
                }

                // 加载文章
                if (postsData) {
                    posts = JSON.parse(postsData.content);
                    postsSha = postsData.sha;
                } else {
                    posts = [{
                        id: `hello_world_${Date.now()}`,
                        title: "欢迎来到我的博客！",
                        content: `# 欢迎！\n\n欢迎来到 [${user.login}](https://github.com/${user.login}) 的博客！\n\n这是一个通过GitHub Pages托管的博客系统。\n\n<!--more-->\n\n创建你的第一篇文章吧！`,
                        category: "公告",
                        tags: ["欢迎"],
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }];
                    const res = await GitHubAPI.createFile(token, owner, repo, postsPath, JSON.stringify(posts, null, 2), 'feat: initialize first post');
                    postsSha = res.content.sha;
                }

                // 加载视图
                renderPostList();
                populateSettings();
                populateGitalkSettings();
                updateUniqueTags();

                if (rememberTokenCheckbox.checked) {
                    localStorage.setItem('github_token', token);
                } else {
                    localStorage.removeItem('github_token');
                }

                // 显示仪表盘
                showAdminView('dashboard');
                loginWrapper.style.display = 'none';
                adminWrapper.style.display = 'flex';
                initialMessageEl.innerHTML = '';
                showAlert('登录成功！', 'success');

            } catch (error) {
                initialMessageEl.innerHTML = `<i class="fas fa-times-circle"></i> 初始化失败: ${error.message}`;
                initialMessageEl.style.color = 'var(--danger-color)';
                localStorage.removeItem('github_token');
            } finally {
                setButtonsDisabled(false);
            }
        };

        // 文章管理函数
        const renderPostList = () => {
            postListBody.innerHTML = '';
            if (posts.length === 0) {
                postListBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">暂无文章。</td></tr>`;
                return;
            }
            
            [...posts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(post => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${post.title}</td>
                    <td>${post.category || '未分类'}</td>
                    <td>${post.tags && post.tags.length > 0 ? post.tags.join(', ') : '无标签'}</td>
                    <td>${new Date(post.createdAt).toLocaleDateString()}</td>
                    <td>${new Date(post.updatedAt).toLocaleDateString()}</td>
                    <td class="actions">
                        <a href="#" class="edit" data-id="${post.id}" title="编辑"><i class="fas fa-edit"></i></a>
                        <a href="#" class="delete" data-id="${post.id}" title="删除"><i class="fas fa-trash-alt"></i></a>
                        <a href="index.html#/post/${post.id}" target="_blank" class="link" title="预览"><i class="fas fa-external-link-alt"></i></a>
                    </td>
                `;
                postListBody.appendChild(tr);
            });
        };

        const populateSettings = () => {
            document.getElementById('setting-title').value = config.site.title || '';
            document.getElementById('setting-description').value = config.site.description || '';
            document.getElementById('setting-about-content').value = config.site.aboutContent || '';
            document.getElementById('setting-bg-color').value = config.styling.backgroundColor || '#f8f9fa';
            document.getElementById('setting-text-color').value = config.styling.textColor || '#212529';
            document.getElementById('setting-accent-color').value = config.styling.accentColor || '#0d6efd';
            
            const bgImageUrl = config.styling.backgroundImageUrl || '';
            document.getElementById('setting-bg-image-url').value = bgImageUrl;
        };

        const populateGitalkSettings = () => {
            const g = config.gitalk || {};
            document.getElementById('gitalk-enabled').checked = !!g.enabled;
            document.getElementById('gitalk-clientID').value = g.clientID || '';
            document.getElementById('gitalk-clientSecret').value = g.clientSecret || '';
            document.getElementById('gitalk-repo').value = g.repo || repo;
            document.getElementById('gitalk-owner').value = g.owner || owner;
            document.getElementById('gitalk-admin').value = (g.admin || []).join(', ');
        };

        // EasyMDE 初始化
        const initializeEasyMDE = () => {
            if (easyMDE) return;
            
            easyMDE = new EasyMDE({
                element: document.getElementById('post-content'),
                spellChecker: false,
                forceSync: true,
                toolbar: [
                    "bold", "italic", "heading", "|",
                    "quote", "unordered-list", "ordered-list", "|",
                    "link", "image", "upload-image", "|",
                    "table", "horizontal-rule", "|",
                    "preview", "side-by-side", "fullscreen", "|",
                    "guide"
                ],
                placeholder: '开始输入您的Markdown内容...',
                autosave: {
                    enabled: true,
                    uniqueId: 'post-editor',
                    delay: 1000
                },
                insertTexts: [
                    ["**", "**"], // Bold
                    ["*", "*"], // Italic
                    ["`", "`"], // Code
                ]
            });
            
            // 添加图片上传按钮到工具栏
            easyMDE.toolbar.find(item => item.name === 'upload-image').action = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    setButtonsDisabled(true);
                    showAlert('正在上传图片...', 'info', 'upload-alert');
                    
                    uploadFile(file, 'images', `上传图片: ${file.name}`)
                        .then(url => {
                            const imageMarkdown = `![${file.name}](${url})`;
                            easyMDE.codemirror.replaceSelection(imageMarkdown);
                            showAlert('图片上传成功！', 'success');
                        })
                        .catch(error => {
                            showAlert(`上传失败: ${error.message}`, 'danger');
                        })
                        .finally(() => {
                            setButtonsDisabled(false);
                        });
                };
                input.click();
            };
        };

        // 文件上传函数
        const uploadFile = async (file, uploadPath, message) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result.split(',')[1];
                    const blobPath = getPath(`${uploadPath}/${new Date().toISOString().replace(/[-:.]/g, '')}_${file.name}`);
                    
                    GitHubAPI.createFile(token, owner, repo, blobPath, content, message, true)
                        .then(res => {
                            showAlert('文件上传成功！', 'success', 'upload-alert');
                            resolve(res.content.download_url);
                        })
                        .catch(error => {
                            showAlert(`文件上传失败: ${error.message}`, 'danger', 'upload-alert');
                            reject(error);
                        });
                };
                reader.onerror = (error) => {
                    showAlert('文件读取失败！', 'danger', 'upload-alert');
                    reject(error);
                };
                reader.readAsDataURL(file);
            });
        };

        // 标签管理
        const updateUniqueTags = () => {
            const allTags = new Set();
            posts.forEach(post => {
                if (post.tags && Array.isArray(post.tags)) {
                    post.tags.forEach(tag => allTags.add(tag));
                }
            });
        };

        // 事件绑定
        document.addEventListener('DOMContentLoaded', () => {
            // 登录
            startBtn.addEventListener('click', startAdmin);
            tokenInput.addEventListener('keydown', (e) => { 
                if (e.key === 'Enter') startAdmin(); 
            });
            
            // 侧边栏导航
            navButtons.dashboard.addEventListener('click', () => showAdminView('dashboard'));
            navButtons.posts.addEventListener('click', () => showAdminView('posts'));
            navButtons.media.addEventListener('click', () => showAdminView('media'));
            navButtons.settings.addEventListener('click', () => showAdminView('settings'));
            
            navButtons.gitalkSettings.addEventListener('click', () => {
                if (navButtons.gitalkSettings) {
                    showAdminView('gitalkSettings');
                }
            });
            
            navButtons.logout.addEventListener('click', () => {
                if (confirm('确定要安全退出吗？')) {
                    localStorage.removeItem('github_token');
                    location.reload();
                }
            });
            
            // 仪表盘快捷操作
            document.getElementById('dashboard-new-post-btn').addEventListener('click', () => openEditor());
            document.getElementById('dashboard-settings-btn').addEventListener('click', () => showAdminView('settings'));
            
            // 文章管理
            document.getElementById('new-post-btn').addEventListener('click', () => openEditor());
            document.getElementById('save-post-btn').addEventListener('click', savePost);
            document.getElementById('cancel-edit-btn').addEventListener('click', () => showAdminView('posts'));
            
            postListBody.addEventListener('click', (e) => {
                if (e.target.closest('.edit')) {
                    e.preventDefault();
                    openEditor(e.target.closest('.edit').dataset.id);
                } else if (e.target.closest('.delete')) {
                    e.preventDefault();
                    deletePost(e.target.closest('.delete').dataset.id);
                }
            });
            
            // 媒体库
            document.getElementById('media-uploadBtn').addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.multiple = true;
                input.onchange = (e) => {
                    const files = e.target.files;
                    if (files.length) {
                        setButtonsDisabled(true);
                        showAlert(`正在上传 ${files.length} 个图片...`, 'info', 'media-upload');
                        
                        Promise.all([...files].map(file => 
                            uploadFile(file, 'images', `上传图片: ${file.name}`)
                        ))
                        .then(urls => {
                            showAlert(`${files.length} 张图片上传完成！`, 'success', 'media-upload');
                            loadMediaLibrary();
                        })
                        .catch(error => {
                            showAlert(`上传失败: ${error.message}`, 'danger', 'media-upload');
                        })
                        .finally(() => setButtonsDisabled(false));
                    }
                };
                input.click();
            });
            
            document.getElementById('media-library-grid').addEventListener('click', (e) => {
                if (e.target.closest('.copy-url-btn')) {
                    const fileData = JSON.parse(e.target.closest('.copy-url-btn').dataset.file);
                    navigator.clipboard.writeText(fileData.url).then(() => {
                        showAlert(`复制成功: ${fileData.name}`, 'success');
                    });
                } else if (e.target.closest('.delete-media-btn')) {
                    const btn = e.target.closest('.delete-media-btn');
                    deleteMediaFile(btn.dataset.path, btn.dataset.sha);
                }
            });
            
            // 设置
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
            
            // Gitalk 设置
            document.getElementById('save-gitalk-settings-btn').addEventListener('click', saveGitalkSettings);
            
            // 设置页面 Markdown 预览
            document.getElementById('setting-about-content').addEventListener('input', updateMarkdownPreview);
            
            // 移动端菜单
            document.getElementById('mobile-menu-btn').addEventListener('click', () => {
                document.getElementById('admin-wrapper').classList.toggle('sidebar-visible');
            });
            document.getElementById('mobile-overlay').addEventListener('click', () => {
                document.getElementById('admin-wrapper').classList.remove('sidebar-visible');
            });
            
            // 启动程序
            checkTokenAndStart();
        });

        // 保存文章
        const savePost = async () => {
            const id = document.getElementById('post-id').value;
            const title = document.getElementById('post-title').value.trim();
            const category = document.getElementById('post-category').value.trim() || '未分类';
            const content = easyMDE.value().trim();
            
            if (!title || !content) { 
                showAlert('标题和内容不能为空！', 'danger'); 
                return; 
            }
            
            setButtonsDisabled(true);
            showAlert('正在保存文章...', 'info', 'save-alert');
            
            const postData = {
                title,
                category,
                content,
                tags: JSON.parse(document.getElementById('post-tags').value || '[]'),
                updatedAt: new Date().toISOString()
            };
            
            try {
                if (id) {
                    // 更新文章
                    const postIndex = posts.findIndex(p => p.id === id);
                    if (postIndex > -1) {
                        posts[postIndex] = { ...posts[postIndex], ...postData, };
                    }
                    const res = await GitHubAPI.updateFile(token, owner, repo, getPath('posts.json'), JSON.stringify(posts, null, 2), postsSha, `docs: update post ${title}`);
                    postsSha = res.content.sha;
                } else {
                    // 创建新文章
                    posts.unshift({ ...postData, id: `post_${Date.now()}`, createdAt: new Date().toISOString() });
                    const res = await GitHubAPI.createFile(token, owner, repo, getPath('posts.json'), JSON.stringify(posts, null, 2), `docs: create post ${title}`);
                    postsSha = res.content.sha;
                }
                
                showAlert('文章保存成功！', 'success', 'save-alert');
                renderPostList();
                showAdminView('posts');
            } catch (error) {
                showAlert(`文章保存失败: ${error.message}`, 'danger', 'save-alert');
            } finally {
                setButtonsDisabled(false);
            }
        };

        // 删除文章
        const deletePost = async (postId) => {
            if (!confirm('确定要删除这篇文章吗？此操作不可逆！')) return;
            
            setButtonsDisabled(true);
            const postToDelete = posts.find(p => p.id === postId);
            posts = posts.filter(p => p.id !== postId);
            
            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, getPath('posts.json'), JSON.stringify(posts, null, 2), postsSha, `docs: delete post ${postToDelete.title}`);
                postsSha = res.content.sha;
                showAlert('文章删除成功！', 'success');
                renderPostList();
                showAdminView('posts');
            } catch (error) {
                showAlert(`文章删除失败: ${error.message}`, 'danger');
                posts.push(postToDelete);
            } finally {
                setButtonsDisabled(false);
            }
        };

        // 删除媒体文件
        const deleteMediaFile = async (path, sha) => {
            if (!confirm(`确定要删除图片 ${path.split('/').pop()} 吗？此操作不可逆，且可能导致文章中的图片失效。`)) return;
            setButtonsDisabled(true);
            
            try {
                await GitHubAPI.deleteFile(token, owner, repo, path, sha, `feat: delete image ${path}`);
                showAlert('图片删除成功！', 'success');
                loadMediaLibrary();
            } catch (error) {
                showAlert(`删除失败: ${error.message}`, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };

        // 打开编辑器
        const openEditor = (postId = null) => {
            showAdminView('editor');
            const post = posts.find(p => p.id === postId);
            
            document.getElementById('editor-title').innerHTML = `<i class="fas fa-edit"></i> ${post ? '编辑文章' : '撰写新文章'}`;
            document.getElementById('save-post-btn').innerHTML = `<i class="fas fa-upload"></i> ${post ? '更新文章' : '发布文章'}`;
            document.getElementById('post-id').value = post?.id || '';
            document.getElementById('post-title').value = post?.title || '';
            document.getElementById('post-category').value = post?.category || '';
            
            // 清空并重新生成标签
            const tagTokenContainer = document.getElementById('tag-token-container');
            tagTokenContainer.querySelectorAll('.tag-token').forEach(tagEl => tagEl.remove());
            const tagsInput = document.getElementById('post-tags-input');
            
            if (post && post.tags && Array.isArray(post.tags)) {
                post.tags.forEach(tag => {
                    const tagToken = document.createElement('span');
                    tagToken.className = 'tag-token';
                    tagToken.innerHTML = `${tag} <i class="fas fa-times remove-tag"></i>`;
                    tagToken.querySelector('.remove-tag').addEventListener('click', () => {
                        removeTagFromInput(tag, tagsInput);
                    });
                    tagTokenContainer.insertBefore(tagToken, tagsInput);
                });
            }
            
            tagsInput.value = '';
            document.getElementById('post-tags').value = JSON.stringify(post?.tags || []);
            
            // 设置内容
            if (easyMDE) {
                easyMDE.value(post?.content || '');
            } else {
                document.getElementById('post-content').value = post?.content || '';
                initializeEasyMDE();
            }
            
            document.getElementById('delete-post-btn').style.display = post ? 'inline-flex' : 'none';
        };

        // 删除标签
        const removeTagFromInput = (tagText, inputElement) => {
            let currentTags = JSON.parse(document.getElementById('post-tags').value || '[]');
            currentTags = currentTags.filter(tag => tag !== tagText);
            document.getElementById('post-tags').value = JSON.stringify(currentTags);
            
            const tagsContainer = document.getElementById('tag-token-container');
            const tags = tagsContainer.querySelectorAll('.tag-token');
            tags.forEach(tag => {
                if (tag.textContent.trim().replace('×', '').trim() === tagText) {
                    tag.remove();
                }
            });
        };

        // 保存网站设置
        const saveSettings = async () => {
            setButtonsDisabled(true);
            showAlert('正在保存设置...', 'info', 'settings-alert');
            
            config.site = {
                title: document.getElementById('setting-title').value.trim(),
                description: document.getElementById('setting-description').value.trim(),
                aboutContent: document.getElementById('setting-about-content').value.trim()
            };
            config.styling = {
                backgroundColor: document.getElementById('setting-bg-color').value,
                textColor: document.getElementById('setting-text-color').value,
                accentColor: document.getElementById('setting-accent-color').value,
                backgroundImageUrl: document.getElementById('setting-bg-image-url').value.trim()
            };
            
            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, getPath('config.json'), JSON.stringify(config, null, 2), configSha, 'conf: update website settings');
                configSha = res.content.sha;
                showAlert('网站设置已保存！', 'success', 'settings-alert');
                
                // 更新前端
                document.title = config.site.title;
                document.querySelector('.site-title').textContent = config.site.title;
                
            } catch (error) {
                showAlert(`设置保存失败: ${error.message}`, 'danger', 'settings-alert');
            } finally {
                setButtonsDisabled(false);
            }
        };

        // 保存 Gitalk 设置
        const saveGitalkSettings = async () => {
            setButtonsDisabled(true);
            showAlert('正在保存评论设置...', 'info', 'gitalk-alert');
            
            config.gitalk = {
                enabled: document.getElementById('gitalk-enabled').checked,
                clientID: document.getElementById('gitalk-clientID').value.trim(),
                clientSecret: document.getElementById('gitalk-clientSecret').value.trim(),
                repo: document.getElementById('gitalk-repo').value.trim(),
                owner: document.getElementById('gitalk-owner').value.trim(),
                admin: document.getElementById('gitalk-admin').value.split(',').map(name => name.trim()).filter(Boolean)
            };
            
            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, getPath('config.json'), JSON.stringify(config, null, 2), configSha, 'conf: update Gitalk settings');
                configSha = res.content.sha;
                showAlert('评论设置已保存！', 'success', 'gitalk-alert');
            } catch (error) {
                showAlert(`评论设置保存失败: ${error.message}`, 'danger', 'gitalk-alert');
            } finally {
                setButtonsDisabled(false);
            }
        };

    </script>
</body>
</html>
