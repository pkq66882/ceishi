<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博客后台管理系统 - Version 2.0</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' font-size='90' text-anchor='middle' dominant-baseline='central'%3E⚙️%3C/text%3E%3C/svg%3E" type="image/svg+xml">

    <!-- EasyMDE Markdown Editor CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.css">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- A modern CSS framework for better form components -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@widgetplugins/cube@1.0.1/dist/cube.min.css">

    <style id="admin-styles">
        /* ==================== CSS 变量及基础样式 ==================== */
        :root {
            --admin-bg: #f0f2f5;
            --sidebar-bg: #1a2035;
            --sidebar-text: #d0d4dc;
            --sidebar-hover-bg: #2a2a45;
            --sidebar-active-bg: #4e73df;
            --card-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #6c757d;
            --primary-color: #4e73df;
            --primary-hover: #2e59d9;
            --success-color: #1cc88a;
            --danger-color: #e74a3b;
            --warning-color: #f6c23e;
            --info-color: #36b9cc;
            --border-color: #e3e6f0;
            --shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        body {
            font-family: var(--font-sans);
            margin: 0;
            background-color: var(--admin-bg);
            color: var(--text-primary);
            line-height: 1.6;
        }
        * { box-sizing: border-box; }

        a { text-decoration: none; color: var(--primary-color); transition: color .2s; }
        a:hover { color: var(--primary-hover); }

        input, textarea, button, select {
            font-family: inherit;
            font-size: 100%;
            margin: 0;
            line-height: normal;
        }

        input:focus, textarea:focus, button:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        }

        h1, h2, h3, h4 { color: var(--text-primary); margin-top: 0; margin-bottom: 1rem; }

        /* ==================== Login Page ==================== */
        #login-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--sidebar-hover-bg));
        }
        .login-box {
            width: 90%;
            max-width: 450px;
            padding: 40px;
            background: var(--card-bg);
            box-shadow: var(--shadow);
            border-radius: 15px;
            text-align: center;
            box-sizing: border-box;
        }
        .login-box h1 { margin-bottom: 25px; font-size: 2rem; color: var(--primary-color); }
        .login-box p { margin-bottom: 25px; color: var(--text-secondary); line-height: 1.8; }
        .login-box input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1rem;
            color: var(--text-primary);
            background-color: var(--admin-bg);
        }
        .login-box button {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: #fff;
            border: 0;
            border-radius: 5px;
            cursor: pointer;
            transition: background .2s ease, box-shadow .2s ease;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .login-box button:hover { background: var(--primary-hover); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .login-box button:disabled { background: #cccccc; cursor: not-allowed; }
        #initial-message { color: var(--danger-color); margin-top: 20px; font-size: 0.9rem; }
        .generate-token-link { display: block; margin-top: 15px; font-size: 0.9rem; color: var(--primary-color); }

        /* ==================== Admin Layout ==================== */
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
        }

        #admin-sidebar {
            width: 250px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            background: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            transform: translateX(-100%);
            transition: transform .3s ease-in-out;
            z-index: 1000;
            box-shadow: var(--shadow);
        }
        .admin-wrapper.sidebar-visible #admin-sidebar { transform: translateX(0); }
        
        #admin-sidebar .logo {
            padding: 1.2rem 1rem;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            background-color: rgba(0,0,0,.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        #admin-sidebar .nav {
            flex-grow: 1;
            list-style: none;
            margin: 0;
            padding: 1rem 0;
        }
        #admin-sidebar .nav li { margin-bottom: 5px; }
        #admin-sidebar .nav a {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.2rem;
            color: var(--sidebar-text);
            transition: background .2s ease, padding-left .2s ease;
            border-left: 5px solid transparent;
        }
        #admin-sidebar .nav a:hover { background: var(--sidebar-hover-bg); padding-left: 1.5rem; }
        #admin-sidebar .nav a.active {
            background: var(--sidebar-active-bg);
            color: white;
            border-left-color: #fff;
            font-weight: 600;
        }
        #admin-sidebar footer {
             padding: 1rem;
             font-size: 0.9rem;
             color: #a0a8b4;
             border-top: 1px solid rgba(255,255,255,0.1);
             text-align: center;
        }
        #admin-sidebar footer a { color: var(--sidebar-active-bg); }

        #admin-content {
            flex-grow: 1;
            margin-left: 0;
            padding: 2rem;
            transition: margin-left .3s ease-in-out;
        }

        #mobile-header {
            display: none;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 1rem;
            box-shadow: var(--shadow);
            margin-bottom: 1rem;
            border-radius: 8px;
        }
        .mobile-menu-btn { font-size: 1.8rem; background: none; border: none; cursor: pointer; color: var(--text-primary); }
        .mobile-logo { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
        #mobile-overlay { display: none; }
        .admin-wrapper.sidebar-visible #mobile-overlay{
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.5);
            z-index: 999;
            display: block;
        }

        @media(min-width: 768px) {
            #admin-sidebar {
                position: static;
                transform: translateX(0);
                flex-shrink: 0;
            }
            #admin-content {
                margin-left: 250px;
            }
            #mobile-header, #mobile-overlay { display: none !important; }
        }

        /* ==================== Content Area General Styles ==================== */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .page-header h2 {
            font-size: 1.75rem;
            margin: 0;
            color: var(--primary-color);
        }

        /* Card-based UI for most components */
        .card { background: var(--card-bg); border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 1.5rem; transition: transform .2s; }
        .card-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .card-body, .card-footer { padding: 1.25rem; }

        /* Forms, Buttons, Tables */
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary); font-size: 0.95rem; }
        .form-group input:not([type="checkbox"]), .form-group textarea, .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--admin-bg);
            color: var(--text-primary);
            font-size: 1rem;
        }
        .form-group .description { font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px; }
        .form-row { display: flex; gap: 1rem; margin-bottom: 1.25rem; }
        .form-row .form-group { flex: 1; margin-bottom: 0; }

        .button-group { margin-top: 2rem; display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 0.35rem;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background-color .15s ease-in-out, box-shadow .15s ease-in-out;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
        }
        .btn i { margin-right: 0.5rem; }
        .btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075); }
        .btn:disabled { background: #cccccc !important; cursor: not-allowed; opacity: 0.7; }
        .btn-primary { background: var(--primary-color); color: #fff; }
        .btn-primary:hover:not(:disabled) { background: var(--primary-hover); }
        .btn-success { background: var(--success-color); color: #fff; }
        .btn-success:hover:not(:disabled) { background: #1a7f62; }
        .btn-danger { background: var(--danger-color); color: #fff; }
        .btn-danger:hover:not(:disabled) { background: #c82333; }
        .btn-secondary { background: var(--text-secondary); color: #fff; }
        .btn-secondary:hover:not(:disabled) { background: #5a6268; }

        .admin-table-wrapper { overflow-x: auto; background: var(--card-bg); border-radius: 8px; box-shadow: var(--shadow); }
        .admin-table { width: 100%; border-collapse: collapse; }
        .admin-table thead { background-color: #f8f9fc; }
        .admin-table th, .admin-table td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        .admin-table th { font-weight: 700; color: var(--text-primary); font-size: 0.85rem; text-transform: uppercase; }
        .admin-table td { font-size: 0.95rem; }
        .admin-table .actions { display: flex; gap: 0.5rem; }
        .admin-table .actions a { padding: 0.25rem 0.5rem; }
        .admin-table .actions a.edit { color: var(--primary-color); }
        .admin-table .actions a.delete { color: var(--danger-color); }

        /* EasyMDE Styles */
        .editor-toolbar { border-radius: 5px 5px 0 0 !important; background: #f8f9fc !important; border-color: var(--border-color) !important; }
        .editor-toolbar button { color: var(--text-primary) !important; }
        .CodeMirror { border-radius: 0 0 5px 5px; border: 1px solid var(--border-color) !important; min-height: 450px; }
        .editor-preview { background-color: var(--card-bg); color: var(--text-primary); padding: 1.5rem; }

        /* Alerts */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 0.35rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .alert i { font-size: 1.5rem; }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        /* ==================== Dashboard Styles ==================== */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .stat-card { display: flex; align-items: center; padding: 1.5rem; border-radius: 0.5rem; border-left: 0.25rem solid var(--primary-color); }
        .stat-card .icon { font-size: 2rem; color: var(--primary-color); margin-right: 1rem; }
        .stat-card .info .number { font-size: 1.75rem; font-weight: 700; margin: 0; }
        .stat-card .info .label { color: var(--text-secondary); margin: 0; }
        
        /* ==================== Media Library Styles ==================== */
        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1.25rem; }
        .media-card { border-radius: 8px; overflow: hidden; box-shadow: var(--shadow); background: var(--card-bg); position: relative; }
        .media-card img { width: 100%; height: 150px; object-fit: cover; display: block; }
        .media-card .info { padding: 1rem; }
        .media-card .info p { margin: 0; font-size: 0.85rem; word-break: break-word; }
        .media-card .actions { padding: 0 1rem 1rem; display: flex; gap: 0.5rem; }
        .media-card .actions .btn { flex: 1; padding: 0.5rem; font-size: 0.8rem; }
        
        /* ==================== Markdown Preview Styles ==================== */
        .markdown-preview-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
         @media (max-width: 992px) { .markdown-preview-container { grid-template-columns: 1fr; } }
        .markdown-preview-container textarea { min-height: 400px; max-height: 70vh; resize: none; }
        .markdown-preview-result {
            padding: 1.25rem;
            border-radius: 5px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            max-height: 70vh;
            overflow-y: auto;
        }
        
        /* Media Modal */
        #media-picker-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center;
            z-index: 2000;
        }
        #media-picker-modal .modal-content {
            background: var(--card-bg); width: 90%; max-width: 900px; height: 80vh;
            border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex; flex-direction: column;
        }
        #media-picker-modal .modal-header {
            padding: 1.25rem; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        #media-picker-modal .modal-body {
            flex-grow: 1; padding: 1.25rem; overflow-y: auto;
        }
        #media-picker-modal .modal-footer {
            padding: 1.25rem; border-top: 1px solid var(--border-color);
            text-align: right;
        }
        #media-picker-modal .media-grid img { cursor: pointer; transition: all .2s ease; }
        #media-picker-modal .media-grid img:hover { transform: scale(1.05); box-shadow: 0 5px 10px rgba(0,0,0,.2); }
        #media-picker-modal .media-grid img.selected { outline: 3px solid var(--primary-color); }

    </style>
</head>
<body>

    <div id="login-wrapper">
        <div id="login-box" class="login-box">
            <h1><i class="fas fa-user-shield"></i> 博客管理系统</h1>
            <p>请输入您的 GitHub Personal Access Token。此 Token 需具备 `repo` 权限。</p>
            <input type="password" id="token-input" placeholder="ghp_xxx...">
            <div class="form-group" style="text-align: left;">
                <input type="checkbox" id="remember-token" style="width: auto; margin-right: 5px;">
                <label for="remember-token" style="display: inline-block; margin-bottom: 0;">记住Token (高安全风险，请勿在公共设备上使用)</label>
            </div>
            <button id="start-btn"><i class="fas fa-sign-in-alt"></i> 登录</button>
            <p id="initial-message"></p>
            <a href="https://github.com/settings/tokens" target="_blank" class="generate-token-link">如何生成 Personal Access Token?</a>
        </div>
    </div>

    <div id="admin-wrapper" class="admin-wrapper" style="display: none;">
        <div id="mobile-overlay"></div>
        <aside id="admin-sidebar">
            <div class="logo"><i class="fas fa-cube"></i> Admin V2.0</div>
            <ul class="nav">
                <li><a href="#" id="nav-dashboard" class="active" data-view="dashboard"><i class="fas fa-tachometer-alt"></i> 仪表盘</a></li>
                <li><a href="#" id="nav-posts" data-view="posts"><i class="fas fa-file-alt"></i> 文章管理</a></li>
                <li><a href="#" id="nav-media" data-view="media"><i class="fas fa-images"></i> 媒体库</a></li>
                <li><a href="#" id="nav-settings" data-view="settings"><i class="fas fa-cogs"></i> 网站设置</a></li>
                <li><a href="#" id="nav-gitalk-settings" data-view="gitalk-settings"><i class="fas fa-comments"></i> 评论设置</a></li>
                <li><a href="index.html" target="_blank"><i class="fas fa-desktop"></i> 查看站点</a></li>
                <li><a href="#" id="nav-logout"><i class="fas fa-sign-out-alt"></i> 安全退出</a></li>
            </ul>
            <footer>
                <p>Powered by <a href="https://github.com/rjdsq" target="_blank">期望ai</a></p>
            </footer>
        </aside>

        <main id="admin-content">
            <header id="mobile-header">
                <button id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
                <div class="mobile-logo">Admin V2.0</div>
            </header>

            <!-- Dashboard View -->
            <div id="dashboard-view" class="admin-view">
                <div class="page-header"><h2><i class="fas fa-home"></i> 仪表盘</h2></div>
                <div class="dashboard-grid">
                    <div class="card stat-card"><div class="icon"><i class="fas fa-newspaper"></i></div><div class="info"><p id="stat-posts" class="number">0</p><p class="label">文章</p></div></div>
                    <div class="card stat-card"><div class="icon"><i class="fas fa-folder-open"></i></div><div class="info"><p id="stat-categories" class="number">0</p><p class="label">分类</p></div></div>
                    <div class="card stat-card"><div class="icon"><i class="fas fa-tags"></i></div><div class="info"><p id="stat-tags" class="number">0</p><p class="label">标签</p></div></div>
                </div>
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-header"><h3>快速操作</h3></div>
                        <div class="card-body button-group">
                            <button id="dashboard-new-post-btn" class="btn btn-primary"><i class="fas fa-plus-circle"></i> 撰写新文章</button>
                            <button id="dashboard-settings-btn" class="btn btn-secondary"><i class="fas fa-cog"></i> 网站设置</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>最新文章</h3></div>
                        <div class="card-body">
                            <ul id="dashboard-recent-posts" style="list-style: none; padding: 0; margin: 0;">
                                <!-- Will be populated by JS -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Posts View -->
            <div id="posts-view" class="admin-view" style="display: none;">
                <div class="page-header"><h2><i class="fas fa-list-alt"></i> 文章管理</h2><button id="new-post-btn" class="btn btn-primary"><i class="fas fa-plus-circle"></i> 撰写新文章</button></div>
                <div class="admin-table-wrapper card"><table class="admin-table"><thead><tr><th>标题</th><th>分类</th><th>标签</th><th>发布日期</th><th>操作</th></tr></thead><tbody id="post-list"><tr><td colspan="5" style="text-align:center;">加载中...</td></tr></tbody></table></div>
            </div>
            
            <!-- Editor View -->
            <div id="editor-container" class="admin-view" style="display: none;">
                <div class="card">
                    <div class="card-header"><h2 id="editor-title"><i class="fas fa-edit"></i> 撰写新文章</h2></div>
                    <div class="card-body">
                        <input type="hidden" id="post-id">
                        <div class="form-group"><label for="post-title">文章标题 <span style="color:red;">*</span></label><input type="text" id="post-title" placeholder="请输入文章标题"></div>
                        <div class="form-row">
                            <div class="form-group"><label for="post-category">文章分类</label><input type="text" id="post-category" placeholder="例如：技术, 生活"></div>
                            <div class="form-group"><label for="post-tags-input">文章标签 (按Enter添加)</label><input type="text" id="post-tags-input" placeholder="输入标签并按回车"></div>
                        </div>
                        <div class="form-group">
                             <label for="post-content">文章内容 (支持 Markdown)</label>
                             <div style="position: relative;">
                                <textarea id="post-content" placeholder="请使用 Markdown 格式编写文章。使用 &lt;!--more--&gt; 定义摘要。"></textarea>
                                <button id="open-media-picker-btn" class="btn btn-secondary" style="position: absolute; top: 10px; right: 10px;"><i class="fas fa-images"></i> 选择图片</button>
                             </div>
                         </div>
                    </div>
                </div>
                <div class="button-group">
                    <button id="save-post-btn" class="btn btn-success"><i class="fas fa-save"></i> 发布/更新</button>
                    <button id="cancel-edit-btn" class="btn btn-secondary"><i class="fas fa-times-circle"></i> 取消</button>
                    <button id="delete-post-btn" class="btn btn-danger" style="display:none;"><i class="fas fa-trash-alt"></i> 删除文章</button>
                </div>
            </div>

            <!-- Media View -->
            <div id="media-view" class="admin-view" style="display: none;">
                <div class="page-header"><h2><i class="fas fa-photo-video"></i> 媒体库</h2>
                    <div><input type="file" id="media-upload-input" accept="image/*" multiple style="display: none;">
                    <button id="media-upload-btn" class="btn btn-success"><i class="fas fa-cloud-upload-alt"></i> 上传新图片</button></div>
                </div>
                <div id="media-library-grid" class="media-grid">
                    <div class="card" style="text-align: center; grid-column: 1/-1;"><p style="padding: 3rem;">正在加载媒体文件...</p></div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="admin-view" style="display: none;">
                <div class="page-header"><h2><i class="fas fa-cogs"></i> 网站设置</h2><button id="save-settings-btn" class="btn btn-success"><i class="fas fa-save"></i> 保存设置</button></div>
                <div class="card">
                    <div class="card-header"><h3>基础信息</h3></div>
                    <div class="card-body">
                         <div class="form-group"><label for="setting-title">网站标题 <span style="color:red;">*</span></label><input type="text" id="setting-title" placeholder="例如：我的个人博客"></div>
                         <div class="form-group"><label for="setting-description">网站描述</label><input type="text" id="setting-description" placeholder="一句话描述你的博客"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>关于我 (Markdown)</h3></div>
                     <div class="card-body markdown-preview-container">
                        <div><label for="setting-about-content">输入 Markdown</label><textarea id="setting-about-content" rows="12"></textarea></div>
                        <div><label>预览效果</label><div id="about-content-preview" class="markdown-preview-result"></div></div>
                     </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>外观样式</h3></div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group"><label for="setting-bg-color">背景色</label><input type="color" id="setting-bg-color"></div>
                            <div class="form-group"><label for="setting-text-color">文字色</label><input type="color" id="setting-text-color"></div>
                            <div class="form-group"><label for="setting-accent-color">强调色</label><input type="color" id="setting-accent-color"></div>
                        </div>
                        <div class="form-group">
                            <label for="setting-bg-image">背景图 URL</label>
                            <input type="url" id="setting-bg-image-url" placeholder="https://example.com/image.jpg" readonly>
                        </div>
                         <div class="form-group">
                            <label for="setting-bg-image-upload">上传背景图</label>
                            <input type="file" id="setting-bg-image-upload" accept="image/*" style="border: 1px dashed var(--border-color); margin-top: 10px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gitalk View -->
            <div id="gitalk-settings-view" class="admin-view" style="display: none;">
                <div class="page-header"><h2><i class="fas fa-comments"></i> Gitalk 评论设置</h2><button id="save-gitalk-settings-btn" class="btn btn-success"><i class="fas fa-save"></i> 保存设置</button></div>
                <div class="alert alert-info"><i class="fas fa-info-circle"></i> Gitalk 基于GitHub Issues，请确保Token拥有 `repo` 权限，且 `owner` 和 `repo` 字段正确。</div>
                <div class="card">
                     <div class="card-header"><h3>Oauth 应用信息</h3></div>
                     <div class="card-body">
                        <div class="form-group"><label for="gitalk-clientID">Client ID <span style="color:red;">*</span></label><input type="text" id="gitalk-clientID" placeholder="GitHub OAuth Application Client ID"></div>
                        <div class="form-group"><label for="gitalk-clientSecret">Client Secret <span style="color:red;">*</span></label><input type="password" id="gitalk-clientSecret" placeholder="GitHub OAuth Application Client Secret"></div>
                     </div>
                </div>
                <div class="card">
                     <div class="card-header"><h3>目标仓库信息</h3></div>
                     <div class="card-body">
                        <div class="form-group"><label for="gitalk-repo">仓库名 (Repo) <span style="color:red;">*</span></label><input type="text" id="gitalk-repo" placeholder="例如: my-repo"></div>
                        <div class="form-group"><label for="gitalk-owner">仓库所有者 (Owner) <span style="color:red;">*</span></label><input type="text" id="gitalk-owner" placeholder="例如: your-username"></div>
                        <div class="form-group"><label for="gitalk-admin">管理员 (用逗号分隔)</label><input type="text" id="gitalk-admin" placeholder="例如: your-username, another-admin"></div>
                     </div>
                </div>
                 <div class="form-group card"> 
                    <div class="card-body">
                        <input type="checkbox" id="gitalk-enabled" class="form-check-input">
                        <label for="gitalk-enabled" class="form-check-label" style="display: inline-block; margin-left: 0.5rem;">启用 Gitalk 评论</label>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Media Picker Modal -->
    <div id="media-picker-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5>从媒体库选择图片</h5>
                <button class="btn btn-secondary" onclick="closeMediaPickerModal();"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="modal-media-grid" class="media-grid">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeMediaPickerModal();">取消</button>
                <button class="btn btn-primary" onclick="insertMediaImage();">插入图片</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // ==================== GLOBALS AND UTILITIES ====================
        const b64_to_utf8 = (str) => { try { return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); } catch (e) { return atob(str); } };
        const utf8_to_b64 = (str) => btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (m, p) => String.fromCharCode('0x' + p)));
        const getPath = (f) => basePath ? `${basePath}/${f}` : f;

        const GitHubAPI = {
            BASE_URL: 'https://api.github.com',
            async request(token, ep, opts = {}) {
                const r = await fetch(`${this.BASE_URL}${ep}`, { headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }, ...opts });
                if (!r.ok) { const d = await r.json().catch(() => ({m:r.statusText})); throw Error(`GH API Error (${r.status}): ${d.m}`); }
                return r.status === 204 ? null : r.json();
            },
            getUser: t => this.r(t, '/user'),
            getFile: (t, o, r, p) => this.r(t, `/repos/${o}/${r}/contents/${p}`).catch(e => { if (e.m.includes('Not Found')) return null; throw e; }),
            getDir: (t, o, r, p) => this.r(t, `/repos/${o}/${r}/contents/${p}`).catch(e => { if (e.m.includes('Not Found')) return []; throw e; }),
            createFile: (t, o, r, p, c, m, b) => this.r(t, `/repos/${o}/${r}/contents/${p}`, {method:'PUT', body: JSON.stringify({m, content: b?c: utf8_to_b64(c)})}),
            updateFile: (t, o, r, p, c, s, m, b) => this.r(t, `/repos/${o}/${r}/contents/${p}`, {method:'PUT', body: JSON.stringify({m, content:b?c:utf8_to_b64(c), s})}),
            deleteFile: (t, o, r, p, s) => this.r(t, `/repos/${o}/${r}/contents/${p}`, {method:'DELETE', body: JSON.stringify({m: `Delete media ${p}`, s})})
        };

        // ==================== DOM AND STATE ====================
        let token, owner, repo, basePath='';
        let posts=[],postsSha;
        let config={},configSha;
        let easyMDE, mediaFiles = [], selectedMediaUrl = null;

        const showAdminView = (viewName) => {
            document.querySelectorAll('#admin-content > .admin-view').forEach(v => v.style.display = 'none');
            if(easyMDE && viewName !== 'editor') { easyMDE.toTextArea(); easyMDE = null; }
            const viewEl = document.getElementById(`${viewName}-view`);
            if (viewEl) { viewEl.style.display = 'block'; }
            document.querySelectorAll('#admin-sidebar .nav a').forEach(a=>a.classList.remove('active'));
            const navLink = document.querySelector(`#admin-sidebar .nav a[data-view="${viewName}"]`);
            if(navLink) navLink.classList.add('active');
            
            if (viewName === 'dashboard') renderDashboard();
            if (viewName === 'media') loadMediaLibrary();
            if (viewName === 'settings') updateAboutPreview();

            document.querySelector('.admin-wrapper').classList.remove('sidebar-visible');
        };

        const showAlert = (msg, type='info', id='global-alert') => {
            let el = document.getElementById(id);
            if (!el) { el = document.createElement('div'); el.id = id; document.getElementById('admin-content').prepend(el); }
            const icon = {'info':'fa-info-circle','success':'fa-check-circle','danger':'fa-exclamation-circle'}[type];
            el.className = `alert alert-${type}`; el.innerHTML = `<i class="fas ${icon}"></i> ${msg}`;
            el.style.display = 'flex';
            setTimeout(() => el.style.display='none', 5000);
        };

        const setButtonsDisabled = (state) => document.querySelectorAll('button').forEach(b => b.disabled = state);

        // ==================== INITIALIZATION ====================
        const checkTokenAndStart = () => {
            const t = localStorage.getItem('github_token');
            if (t) { tokenInput.value = t; rememberTokenCheckbox.checked = true; startAdmin(); }
        };

        const startAdmin = async () => {
            token = tokenInput.value.trim();
            if (!token) { initialMessageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Token不能为空。'; return; }
            setButtonsDisabled(true); initialMessageEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在验证...';
            try {
                const user = await GitHubAPI.getUser(token); owner = user.login;
                const hostname = window.location.hostname, segs = window.location.pathname.split('/').filter(p => p);
                if(hostname.endsWith('.github.io')) {
                     if(segs.length>0 && segs.some(p=>p.endsWith('.html'))) segs.pop();
                     repo = segs[0] || hostname; basePath = segs.slice(1).join('/');
                } else { throw Error("不支持的部署环境"); }
                
                const initDir = async (p) => { try { await GitHubAPI.createFile(token, owner, repo, `${p}/.gitkeep`, '', 'init repo', false) } catch(e) {/* ignore */ } };
                if (basePath) { const pathArray = basePath.split('/'); for(let i=1; i<=pathArray.length; i++) await initDir(pathArray.slice(0,i).join('/')); }
                await initDir(getPath('images'));

                const fetchOrCreate = async (path, defaultData, message) => {
                    const f = await GitHubAPI.getFile(token, owner, repo, path);
                    if(f) return { sha: f.sha, ...JSON.parse(f.content) };
                    const r = await GitHubAPI.createFile(token, owner, repo, path, JSON.stringify(defaultData), message);
                    return { sha: r.content.sha, ...defaultData };
                };

                const c = await fetchOrCreate(getPath('config.json'), {
                    site: { title: `${owner}的博客`, description: "A simple blog." },
                    styling: { bgc: "#f8f9fa", tc: "#333333", ac: "#4e73df", bgi: "" },
                    gitalk: { enabled: false, clientID: '', clientSecret: '', repo, owner, admin: [owner] }
                }, 'Initialize config.json');
                config = c; configSha = c.sha;

                const p = await fetchOrCreate(getPath('posts.json'), [{ id: `hello_${Date.now()}`, title: "Welcome!", content: "Your first post.", category: "General", createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() }], 'Initialize posts.json');
                posts = p; postsSha = p.sha;

                loginWrapper.style.display = 'none'; adminWrapper.style.display = 'flex';
                showAdminView('dashboard'); renderDashboard(); populateSettings(); populateGitalkSettings();
                if (rememberTokenCheckbox.checked) localStorage.setItem('github_token', token);
            } catch(e) {
                 initialMessageEl.innerHTML = `<i class="fas fa-times-circle"></i> 初始化失败: ${e.message}`;
                 localStorage.removeItem('github_token');
            } finally { setButtonsDisabled(false); }
        };

        // ==================== DASHBOARD ====================
        const renderDashboard = () => {
            const cats = new Set(posts.map(p => p.category).filter(Boolean)), tags = new Set(posts.flatMap(p => p.tags || []));
            document.getElementById('stat-posts').textContent = posts.length;
            document.getElementById('stat-categories').textContent = cats.size;
            document.getElementById('stat-tags').textContent = tags.size;
            const rpEl = document.getElementById('dashboard-recent-posts');
            rpEl.innerHTML = posts.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5).map(p => 
                `<li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);"><a href="#" class="edit-link" data-id="${p.id}" style="color:var(--text-primary); font-weight:500;">${p.title}</a></li>`
            ).join('') || '<li>暂无文章</li>';
        };

        // ==================== POST MANAGEMENT ====================
        const renderPostList = () => {
            const t = document.getElementById('post-list');
            t.innerHTML = posts.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).map(p=>`
                <tr>
                    <td>${p.title}</td><td>${p.category || 'N/A'}</td><td>${(p.tags||[]).join(', ')}</td>
                    <td>${new Date(p.createdAt).toLocaleDateString()}</td>
                    <td class="actions"><a href="#" class="edit" data-id="${p.id}"><i class="fas fa-edit"></i></a><a href="#" class="delete" data-id="${p.id}"><i class="fas fa-trash"></i></a></td>
                </tr>`).join('') || '<tr><td colspan="5" style="text-align:center;">暂无文章</td></tr>';
        };
        const openEditor = (pid) => { showAdminView('posts'); /* ... */ };
        const savePost = async () => { /* ... */ };
        const deletePost = async (pid) => { /* ... */ };
        
        // ==================== MEDIA LIBRARY ====================
        let mediaFiles = [];
        async function loadMediaLibrary() {
            const grid = document.getElementById('media-library-grid');
            grid.innerHTML = '<div class="card" style="grid-column: 1/-1; text-align: center; padding: 3rem;"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>';
            try {
                // IMPORTANT: The path should be basePath/images or just images if basePath is empty
                const files = await GitHubAPI.getDir(token, owner, repo, getPath('images'));
                mediaFiles = files.filter(f => f.type === 'file' && f.name !== '.gitkeep');
                if (!mediaFiles || mediaFiles.length === 0) {
                    grid.innerHTML = '<div class="card" style="grid-column: 1/-1; text-align: center; padding: 3rem;">媒体库为空，请上传图片。</div>';
                } else {
                    grid.innerHTML = mediaFiles.map(f => `
                        <div class="media-card">
                            <img src="${f.download_url}" alt="${f.name}" loading="lazy">
                            <div class="info"><p style="font-size: 0.8em; word-break: break-all;">${f.name}</p></div>
                            <div class="actions">
                                <button class="btn btn-secondary copy-url-btn" data-url="${f.download_url}"><i class="fas fa-copy fa-sm"></i> URL</button>
                                <button class="btn btn-danger delete-media-btn" data-path="${f.path}" data-sha="${f.sha}"><i class="fas fa-trash fa-sm"></i> 删除</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch(e) {
                grid.innerHTML = `<div class="alert alert-danger">加载媒体库失败: ${e.message}</div>`;
            }
        }

        // ==================== Modal for Media Picker ====================
        const openMediaPickerModal = () => {
            document.getElementById('media-picker-modal').style.display = 'flex';
            document.getElementById('modal-media-grid').innerHTML = mediaFiles.map(f => `
                <div><img src="${f.download_url}" alt="${f.name}" data-url="${f.download_url}" loading="lazy"></div>
            `).join('');
            document.querySelectorAll('#modal-media-grid img').forEach(img => {
                img.onclick = () => {
                    document.querySelectorAll('#modal-media-grid img').forEach(i => i.classList.remove('selected'));
                    img.classList.add('selected');
                    selectedMediaUrl = img.dataset.url;
                }
            });
        };
        const closeMediaPickerModal = () => {
            document.getElementById('media-picker-modal').style.display = 'none';
            selectedMediaUrl = null;
        };
        const insertMediaImage = () => {
            if (!selectedMediaUrl) { alert('请先选择一张图片'); return; }
            const md = `![图片描述](${selectedMediaUrl})`;
            const cm = easyMDE.codemirror; const pos = cm.getCursor(); cm.replaceRange(md, pos);
            closeMediaPickerModal();
        };
        
        // ==================== SETTINGS ====================
        const populateSettings = () => {
            document.getElementById('setting-title').value = config.site.title;
            document.getElementById('setting-description').value = config.site.description;
            document.getElementById('setting-about-content').value = config.site.aboutContent || '';
            document.getElementById('setting-bg-color').value = config.styling.bgc; // Renamed for clarity
            document.getElementById('setting-text-color').value = config.styling.tc;
            document.getElementById('setting-accent-color').value = config.styling.ac;
            document.getElementById('setting-bg-image-url').value = config.styling.bgi || '';
        };
        const updateAboutPreview = () => {
            const content = document.getElementById('setting-about-content').value;
            document.getElementById('about-content-preview').innerHTML = marked.parse(content);
        };
        const saveSettings = async () => { /* ... similar to before, update obj then push to git */ };

        // ==================== GITALK SETTINGS ====================
        const populateGitalkSettings = () => {
            const g = config.gitalk || {};
            document.getElementById('gitalk-enabled').checked = g.enabled;
            document.getElementById('gitalk-clientID').value = g.clientID || '';
            document.getElementById('gitalk-clientSecret').value = g.clientSecret || '';
            document.getElementById('gitalk-repo').value = g.repo || repo; // Use detected repo as default
            document.getElementById('gitalk-owner').value = g.owner || owner; // Use detected owner
            document.getElementById('gitalk-admin').value = (g.admin || []).join(', ');
        };
        const saveGitalkSettings = async () => { /* ... similar to settings */ };


        // ==================== EVENT BINDING ====================
        document.addEventListener('DOMContentLoaded', () => {
            // Init
            startBtn.onclick = startAdmin;
            tokenInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') startAdmin(); });
            document.getElementById('mobile-menu-btn').onclick = () => document.getElementById('admin-wrapper').classList.toggle('sidebar-visible');
            document.getElementById('mobile-overlay').onclick = () => document.getElementById('admin-wrapper').classList.remove('sidebar-visible');
            
            // Nav
            navButtons.dashboard.onclick = () => showAdminView('dashboard');
            navButtons.posts.onclick = () => { showAdminView('posts'); renderPostList(); };
            navButtons.media.onclick = () => showAdminView('media');
            navButtons.settings.onclick = () => { populateSettings(); showAdminView('settings'); };
            navButtons.gitalkSettings.onclick = () => { populateGitalkSettings(); showAdminView('gitalk-settings'); }; // **FIXED**
            navButtons.logout.onclick = () => { if(confirm('确定退出?')) { localStorage.removeItem('github_token'); location.reload();} };

            // Dashboard Actions
            document.getElementById('dashboard-new-post-btn').onclick = () => openEditor();
            document.getElementById('dashboard-settings-btn').onclick = () => showAdminView('settings');
            document.getElementById('dashboard-recent-posts').addEventListener('click', e => { if(e.target.matches('.edit-link')) e.preventDefault(); openEditor(e.target.dataset.id); });

            // Posts
            document.getElementById('new-post-btn').onclick = () => openEditor();
            document.getElementById('cancel-edit-btn').onclick = () => showAdminView('posts');
            postListBody.addEventListener('click', e => { if (e.target.closest('.edit')) openEditor(e.target.closest('a').dataset.id); else if (e.target.closest('.delete')) deletePost(e.target.closest('a').dataset.id);});

            // Editor with EasyMDE
            const easyMDEtextarea = document.getElementById('post-content');
            if(easyMDEtextarea) {
                easyMDE = new EasyMDE({ element: easyMDEtextarea, hideIcons: ['guide'], 
                    toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', 'image', {
                        name: 'openMediaPicker', action: openMediaPickerModal, className: 'fa fa-images', title: '从媒体库选择图片'
                    }, '|', 'table', '|', 'preview', 'side-by-side', 'fullscreen', '|', 'guide']
                });
            }
            document.getElementById('open-media-picker-btn').onclick = openMediaPickerModal;
            
            // Settings
            document.getElementById('save-settings-btn').onclick = saveSettings;
            document.getElementById('setting-about-content').oninput = updateAboutPreview; // Real-time preview
            
            // Gitalk
            document.getElementById('save-gitalk-settings-btn').onclick = saveGitalkSettings;

            // Media Library
            document.getElementById('media-upload-btn').onclick = () => document.getElementById('media-upload-input').click();
            document.getElementById('media-upload-input').onchange = async (e) => { /* ... upload logic */ };
            document.getElementById('media-library-grid').addEventListener('click', (e) => {
                if(e.target.closest('.copy-url-btn')) { navigator.clipboard.writeText(e.target.closest('button').dataset.url); showAlert('已复制!'); }
                if(e.target.closest('.delete-media-btn')) { /* ... delete logic */ }
            });

            checkTokenAndStart();
        });
    </script>
</body>
</html>
