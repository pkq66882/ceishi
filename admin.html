<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博客后台管理系统 - 期望ai</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' font-size='90' text-anchor='middle' dominant-baseline='central'%3E⚙️%3C/text%3E%3C/svg%3E" type="image/svg+xml">

    <!-- EasyMDE Markdown 编辑器 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.css">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* ==================== CSS 变量及基础样式 ==================== */
        :root {
            --font-body: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --bg-color: #f4f6f8;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --sidebar-hover-bg: #34495e;
            --sidebar-active-bg: #1abc9c;
            --content-bg: #ffffff;
            --text-color: #34495e;
            --heading-color: #2c3e50;
            --accent-color: #3498db;
            --accent-hover: #2980b9;
            --border-color: #e0e0e0;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --shadow: 0 1px 3px rgba(0,0,0,.12), 0 1px 2px rgba(0,0,0,.24);
            --focus-glow: 0 0 0 3px rgba(52, 152, 219, 0.25);
            --header-height: 60px; /* New: for fixed header */
        }

        body {
            font-family: var(--font-body);
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 15px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        a { text-decoration: none; color: var(--accent-color); transition: color .2s; }
        a:hover { color: var(--accent-hover); }

        input, textarea, button, select {
            font-family: inherit;
            font-size: 100%;
            margin: 0;
            padding: 0;
            line-height: normal;
            background-color: var(--content-bg); /* Default background for inputs */
            color: var(--text-color); /* Default text color for inputs */
            border: 1px solid var(--border-color);
            border-radius: 5px;
            box-sizing: border-box;
        }

        input:not([type="checkbox"]):focus, textarea:focus, button:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: var(--focus-glow);
        }

        h1, h2, h3, h4, h5, h6 { color: var(--heading-color); margin-top: 0; margin-bottom: 20px; }

        /* ==================== Login 页面 ==================== */
        #login-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--sidebar-bg);
            background-image: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        .login-box {
            width: 90%;
            max-width: 400px;
            padding: 40px;
            background: var(--content-bg);
            box-shadow: var(--shadow);
            border-radius: 8px;
            text-align: center;
            box-sizing: border-box;
        }
        .login-box h1 { margin-bottom: 25px; font-size: 2rem; color: var(--heading-color); }
        .login-box p { margin-bottom: 25px; color: #7f8c8d; line-height: 1.8; }
        .login-box input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 25px;
            font-size: 1rem;
        }
        .login-box input[type="checkbox"] {
            margin-right: 8px;
            width: initial;
            padding: initial;
            border-radius: initial;
        }
        .remember-token-group {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--text-color);
        }
        .login-box button {
            width: 100%;
            padding: 12px;
            background: var(--accent-color);
            color: #fff;
            border: 0;
            border-radius: 5px;
            cursor: pointer;
            transition: background .2s ease, box-shadow .2s ease;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .login-box button:hover { background: var(--accent-hover); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .login-box button:disabled { background: #cccccc; cursor: not-allowed; }
        #initial-message { color: var(--danger-color); margin-top: 20px; font-size: 0.9rem; }
        .generate-token-link {
            display: block;
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--accent-color);
        }

        /* ==================== Admin Layout ==================== */
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
            background-color: var(--bg-color);
        }

        #admin-sidebar {
            /* 变为非悬浮，固定在左侧 */
            position: sticky; /* 固定位置 */
            top: 0; /* 顶部对齐 */
            left: 0;
            height: 100vh; /* 撑满视口高度 */
            width: 250px;
            background: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            flex-shrink: 0; /* 防止内容区挤压侧边栏 */
            z-index: 1000;
            box-shadow: 2px 0 5px rgba(0,0,0,.1); /* 右侧阴影 */
            transition: transform .3s ease-in-out; /* For mobile slide-out */

            /* 移动端默认隐藏，只有在sidebar-visible时才显示 */
            transform: translateX(0); /* Default to visible on desktop */
        }
        @media (max-width: 768px) {
            #admin-sidebar {
                position: fixed; /* Mobile: fixed for overlay */
                transform: translateX(-100%); /* Mobile: default hidden */
            }
            .admin-wrapper.sidebar-visible #admin-sidebar {
                transform: translateX(0); /* Mobile: show when active */
            }
        }

        #admin-sidebar .logo {
            padding: 25px 20px;
            font-size: 1.6rem;
            font-weight: 700;
            text-align: center;
            background-color: rgba(0,0,0,.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        #admin-sidebar .nav {
            flex-grow: 1;
            list-style: none;
            margin: 0;
            padding: 20px 0;
        }
        #admin-sidebar .nav li { margin-bottom: 5px; }
        #admin-sidebar .nav a {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: var(--sidebar-text);
            transition: background .2s ease;
            border-left: 5px solid transparent;
        }
        #admin-sidebar .nav a i {
            margin-right: 12px;
            font-size: 1.1rem;
        }
        #admin-sidebar .nav a:hover { background: var(--sidebar-hover-bg); }
        #admin-sidebar .nav a.active {
            background: var(--sidebar-active-bg);
            color: white;
            border-left-color: #fff;
            font-weight: 600;
        }
        #admin-sidebar footer {
             padding: 20px;
             font-size: 0.9rem;
             color: #a0a8b4;
             border-top: 1px solid rgba(255,255,255,0.1);
             text-align: center;
        }
        #admin-sidebar footer a { color: var(--sidebar-active-bg); }


        #admin-content {
            flex-grow: 1;
            padding: 30px;
            box-sizing: border-box;
            background-color: var(--bg-color); /* Ensure content has its own background */
        }

        #mobile-header {
            display: none; /* Hide by default on desktop */
            justify-content: space-between;
            align-items: center;
            background: var(--content-bg);
            padding: 15px 20px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border-radius: 8px;
        }
        @media(max-width: 768px) {
            #mobile-header { display: flex; } /* Show on mobile */
            #admin-content { padding-top: calc(var(--header-height) + 15px); } /* Push content down for fixed header */
        }

        .mobile-menu-btn {
            font-size: 1.8rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
        }
        .mobile-logo {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--heading-color);
        }
        #mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.5);
            z-index: 999;
            display: none;
        }
        .admin-wrapper.sidebar-visible #mobile-overlay{ display: block; }

        /* ==================== 内容区通用样式 ==================== */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }
        .page-header h2 {
            font-size: 1.8rem;
            margin: 0;
            line-height: 1;
        }

        /* Forms, Buttons, Tables */
        .form-group { margin-bottom: 25px; }
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--heading-color);
            font-size: 0.95rem;
        }
        .form-group input:not([type="checkbox"]), .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px 15px;
            font-size: 1rem;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 250px;
        }
        .form-group .description {
            font-size: 0.85rem;
            color: var(--meta-color);
            margin-top: 5px;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        .form-row .form-group {
            flex: 1;
            min-width: 250px; /* Ensure a minimum width for form groups in a row */
            margin-bottom: 0;
        }
        .button-group {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: flex-start; /* Align buttons to start */
        }

        button, .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background .2s ease, box-shadow .2s ease;
            font-weight: 600;
        }
        button i, .btn i { margin-right: 8px; }
        button:hover:not(:disabled), .btn:hover:not(:disabled) { opacity: 0.9; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        button:disabled, .btn:disabled { background: #cccccc !important; cursor: not-allowed; opacity: 0.7; }

        .btn-primary { background: var(--accent-color); color: #fff; }
        .btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
        .btn-success { background: var(--success-color); color: #fff; }
        .btn-success:hover:not(:disabled) { background: #218838; }
        .btn-danger { background: var(--danger-color); color: #fff; }
        .btn-danger:hover:not(:disabled) { background: #c82333; }
        .btn-secondary { background: #6c757d; color: #fff; }
        .btn-secondary:hover:not(:disabled) { background: #5a6268; }

        .admin-table-wrapper { overflow-x: auto; background: var(--content-bg); border-radius: 8px; box-shadow: var(--shadow); }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--content-bg);
        }
        .admin-table thead { background: #f8f9fa; }
        .admin-table th, .admin-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            /* white-space: nowrap;  Disable for now to allow text wrapping for better mobile view */
        }
        .admin-table th {
            font-weight: 700;
            color: var(--heading-color);
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        .admin-table td {
            font-size: 0.95rem;
            color: var(--text-color);
        }
        .admin-table tr:last-child td { border-bottom: none; }
        .admin-table .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-start;
            flex-wrap: wrap;
        }
        .admin-table .actions a.edit { color: var(--accent-color); }
        .admin-table .actions a.delete { color: var(--danger-color); }
        .admin-table .actions a.link { color: var(--sidebar-active-bg); }

        /* EasyMDE 样式调整 */
        .editor-toolbar { border-top-left-radius: 5px; border-top-right-radius: 5px; background-color: #f8f9fa !important; border-color: var(--border-color) !important;}
        .editor-toolbar button { background: none !important; color: var(--text-color) !important; border: none !important; }
        .editor-toolbar button.active, .editor-toolbar button:hover { background-color: var(--border-color) !important; }
        .editor-toolbar button.active { border-radius: 4px; }
        .CodeMirror { border-bottom-left-radius: 5px; border-bottom-right-radius: 5px; border: 1px solid var(--border-color) !important; border-top: none !important; min-height: 400px; font-size: 0.95rem; line-height: 1.6;}
        .CodeMirror-fullscreen { z-index: 2000; }
        .editor-preview-active, .editor-preview-active-side { background-color: var(--content-bg) !important; color: var(--text-color) !important; padding: 15px;}
        .editor-preview h1, .editor-preview h2, .editor-preview h3, .editor-preview h4, .editor-preview h5, .editor-preview h6 { color: var(--heading-color);}
        .editor-preview img { max-width: 100%; height: auto; border-radius: 8px; margin: 1rem 0; display: block;}
        .editor-preview blockquote { padding: 0.5em 1em; margin: 1em 0; border-left: 4px solid var(--accent-color); color: var(--meta-color); background-color: rgba(52, 152, 219, 0.05); border-radius: 5px;}
        .CodeMirror-scroll { background-color: var(--content-bg); }
        
        /* Alerts */
        .alert { padding: 15px 20px; border-radius: 5px; margin-bottom: 20px; font-size: 0.95rem; display: flex; align-items: center; gap: 10px;}
        .alert i { font-size: 1.2rem; }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .alert-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        /* Tag/Category Suggestions */
        .suggestion-box { position: absolute; background-color: var(--content-bg); border: 1px solid var(--border-color); border-radius: 5px; max-height: 150px; overflow-y: auto; width: 100%; z-index: 100; box-shadow: var(--shadow); top: calc(100% + 5px); left: 0;}
        .suggestion-box div { padding: 10px; cursor: pointer; transition: background-color .2s;}
        .suggestion-box div:hover { background-color: var(--accent-color); color: white;}
        .form-group.has-suggestions { position: relative; }
        .tag-token-container { display: flex; flex-wrap: wrap; gap: 5px; border: 1px solid var(--border-color); border-radius: 5px; padding: 8px 10px; min-height: 40px; align-items: center; background-color: var(--content-bg); cursor: text;}
        .tag-token { display: inline-flex; align-items: center; background-color: var(--accent-color); color: white; padding: 4px 8px; border-radius: 3px; font-size: 0.9em;}
        .tag-token .remove-tag { margin-left: 5px; cursor: pointer; color: rgba(255,255,255,0.7);}
        .tag-token-input { border: none !important; flex-grow: 1; padding: 0 !important; margin-left: 5px; background: transparent !important; color: var(--text-color) !important; line-height: 1.5 !important; box-shadow: none !important;}
        .tag-token-input:focus { box-shadow: none !important; }

        /* =========== Dashboard Styles =========== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        .stat-card, .quick-actions-card, .recent-posts-card {
            background: var(--content-bg);
            border-radius: 8px;
            padding: 25px;
            box-shadow: var(--shadow);
        }
        .stat-card {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .stat-card .icon {
            font-size: 2.5rem;
            color: var(--accent-color);
            flex-shrink: 0;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-color);
        }
        .stat-card .info .number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--heading-color);
            margin: 0;
        }
        .stat-card .info .label {
            font-size: 0.9rem;
            color: var(--text-color);
            margin: 0;
        }
        .quick-actions-card h3, .recent-posts-card h3 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.2rem;
            color: var(--heading-color);
        }
        .quick-actions-card .button-group {
            margin-top: 0;
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
        }
        .recent-posts-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .recent-posts-card li {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .recent-posts-card li:last-child {
            border-bottom: none;
        }
        .recent-posts-card li a {
            font-weight: 600;
            color: var(--text-color);
            transition: color 0.2s;
        }
        .recent-posts-card li a:hover {
            color: var(--accent-color);
        }
        .recent-posts-card li .date {
            font-size: 0.85rem;
            color: #6c757d;
        }

        /* =========== Media Library Styles =========== */
        .media-library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        .media-card {
            background-color: var(--content-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
            display: flex; /* Flex container for content */
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer; /* Indicate clickable */
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .media-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .media-card.selected {
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.4);
        }
        .media-card .image-container {
            width: 100%;
            padding-top: 100%; /* 1:1 Aspect Ratio */
            position: relative;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .media-card img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .media-card .file-icon {
            font-size: 3rem;
            color: #ccc;
        }
        .media-card .info {
            padding: 10px;
            font-size: 0.8em;
            word-break: break-all;
            color: var(--text-color);
            flex-grow: 1; /* Allow info to take available space */
        }
        .media-card .actions {
            display: flex;
            gap: 5px;
            padding: 0 10px 10px;
        }
        .media-card .actions .btn {
            flex: 1;
            padding: 5px;
            font-size: 0.8em;
        }

        /* Modal for Media Library in Editor */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal.is-visible { display: flex; }
        .modal-content {
            background-color: var(--content-bg);
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 900px;
            min-height: 60vh;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .modal-header h3 { margin: 0; font-size: 1.5rem; color: var(--heading-color); }
        .close-button {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--text-color);
        }
        .modal-body {
            flex-grow: 1;
            overflow-y: auto;
        }
        .modal-footer {
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
            margin-top: 15px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .modal .media-library-grid {
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* Smaller grid in modal */
        }
        .modal .media-card {
            border: 1px solid var(--border-color); /* Lighter border in modal */
        }
        .modal .media-card.selected {
             border: 2px solid var(--accent-color);
             box-shadow: inset 0 0 0 3px rgba(52, 152, 219, 0.4); /* Inset shadow for selection */
        }
        .modal .media-card .actions { display: none; } /* Hide actions in modal selection */


        /* Markdown Preview in Settings */
        .markdown-preview-area {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            min-height: 100px;
            max-height: 400px; /* Limit height */
            overflow-y: auto;
            font-size: 0.95em;
            line-height: 1.7;
            color: #333;
        }
        .markdown-preview-area h1, .markdown-preview-area h2, .markdown-preview-area h3 {
            color: var(--heading-color);
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-family: var(--font-body); /* Match admin font */
        }


    </style>
</head>
<body>

    <div id="login-wrapper">
        <div id="login-box" class="login-box">
             <h1><i class="fas fa-lock"></i> 博客管理</h1>
             <p>请输入您的GitHub Personal Access Token以开始。该Token需具备 <code style="background-color: #f0f0f0; padding: 2px 5px; border-radius: 3px;">repo</code> 权限。</p>
             <input type="password" id="token-input" placeholder="ghp_xxx 或 Bearer xxx">
            <div class="remember-token-group">
                <input type="checkbox" id="remember-token">
                <label for="remember-token">记住Token (高风险，仅限个人安全设备)</label>
            </div>
             <button id="start-btn"><i class="fas fa-sign-in-alt"></i> 登录</button>
             <p id="initial-message"></p>
             <a href="https://github.com/settings/tokens" target="_blank" class="generate-token-link">如何生成 Personal Access Token?</a>
        </div>
    </div>

    <div id="admin-wrapper" class="admin-wrapper" style="display: none;">
        <div id="mobile-overlay"></div>
        <aside id="admin-sidebar">
            <div class="logo">博客管理系统</div>
            <ul class="nav">
                <li><a href="#" id="nav-dashboard" class="active" data-view="dashboard"><i class="fas fa-tachometer-alt"></i> 仪表盘</a></li>
                <li><a href="#" id="nav-posts" data-view="posts"><i class="fas fa-newspaper"></i> 文章管理</a></li>
                <li><a href="#" id="nav-media" data-view="media"><i class="fas fa-images"></i> 媒体库</a></li>
                <li><a href="#" id="nav-settings" data-view="settings"><i class="fas fa-cog"></i> 网站设置</a></li>
                <li><a href="#" id="nav-gitalk-settings" data-view="gitalk-settings"><i class="fas fa-comments"></i> 评论设置</a></li>
                <li><a href="index.html" target="_blank"><i class="fas fa-desktop"></i> 查看站点</a></li>
                <li><a href="#" id="nav-logout"><i class="fas fa-sign-out-alt"></i> 安全退出</a></li>
            </ul>
            <footer>
                 <p>Powered by <a href="https://github.com/rjdsq/rjdsq.github.io" target="_blank">期望ai</a></p>
            </footer>
        </aside>

        <main id="admin-content">
            <header id="mobile-header">
                <button id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
                <div class="mobile-logo">管理后台</div>
            </header>

            <!-- 仪表盘视图 -->
            <div id="dashboard-view" class="admin-view">
                <div class="page-header"><h2><i class="fas fa-home"></i> 仪表盘</h2></div>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-file-alt"></i></div>
                        <div class="info">
                            <p id="stat-posts" class="number">0</p>
                            <p class="label">篇文章</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-folder-open"></i></div>
                        <div class="info">
                            <p id="stat-categories" class="number">0</p>
                            <p class="label">个分类</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-tags"></i></div>
                        <div class="info">
                            <p id="stat-tags" class="number">0</p>
                            <p class="label">个标签</p>
                        </div>
                    </div>
                </div>
                <div class="dashboard-grid">
                    <div class="quick-actions-card">
                        <h3>快速操作</h3>
                        <div class="button-group">
                            <button id="dashboard-new-post-btn" class="btn-primary"><i class="fas fa-plus-circle"></i> 撰写新文章</button>
                            <button id="dashboard-settings-btn" class="btn-secondary"><i class="fas fa-cog"></i> 网站设置</button>
                        </div>
                    </div>
                    <div class="recent-posts-card">
                        <h3>最新文章</h3>
                        <ul id="dashboard-recent-posts">
                            <li>暂无文章</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 文章管理视图 -->
            <div id="posts-view" class="admin-view" style="display: none;">
                <div class="page-header">
                    <h2><i class="fas fa-list-alt"></i> 文章管理</h2>
                    <button id="new-post-btn" class="btn-primary"><i class="fas fa-plus-circle"></i> 撰写新文章</button>
                </div>
                <div class="admin-table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr><th>标题</th><th>分类</th><th>标签</th><th>发布日期</th><th>更新日期</th><th class="actions">操作</th></tr>
                        </thead>
                        <tbody id="post-list">
                            <tr><td colspan="6" style="text-align: center;">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 文章编辑/创建视图 -->
            <div id="editor-container" class="admin-view" style="display: none;">
                 <h2 id="editor-title"><i class="fas fa-edit"></i> 撰写新文章</h2>
                 <input type="hidden" id="post-id">
                <div class="form-group">
                    <label for="post-title">文章标题 <span style="color:red;">*</span></label>
                    <input type="text" id="post-title" placeholder="请输入文章标题">
                </div>
                 <div class="form-group">
                    <label for="post-category">文章分类</label>
                    <input type="text" id="post-category" placeholder="请输入文章分类，例如：技术，生活">
                </div>
                 <div class="form-group has-suggestions">
                    <label for="post-tags-input">文章标签 (按 Enter 键添加，点击标签删除)</label>
                    <div id="tag-token-container" class="tag-token-container">
                        <input type="text" id="post-tags-input" placeholder="输入标签并按回车">
                    </div>
                    <div id="tag-suggestions" class="suggestion-box" style="display: none;"></div>
                    <input type="hidden" id="post-tags">
                     <p class="description">输入标签后按回车键添加。点击现有标签可删除。从建议列表中选择。</p>
                </div>
                <div class="form-group">
                    <label for="post-content">文章内容 (Markdown)</label>
                    <textarea id="post-content"></textarea>
                     <p class="description">请使用 Markdown 格式编写文章。使用 <code>&lt;!--more--&gt;</code> 可定义文章摘要。</p>
                </div>
                <div class="button-group">
                    <button id="save-post-btn" class="btn-success"><i class="fas fa-upload"></i> 发布/更新文章</button>
                    <button id="cancel-edit-btn" class="btn-secondary"><i class="fas fa-times-circle"></i> 取消</button>
                    <button id="delete-post-btn" class="btn-danger" style="display:none;"><i class="fas fa-trash-alt"></i> 删除文章</button>
                </div>
            </div>

            <!-- 媒体库视图 -->
            <div id="media-view" class="admin-view" style="display: none;">
                <div class="page-header">
                    <h2><i class="fas fa-photo-video"></i> 媒体库</h2>
                    <div>
                        <input type="file" id="media-upload-input" accept="image/*" multiple style="display: none;">
                        <button id="media-upload-btn" class="btn-primary"><i class="fas fa-upload"></i> 上传新图片</button>
                    </div>
                </div>
                <div id="media-library-grid" class="media-library-grid">
                    <p style="text-align: center; width: 100%;">正在加载媒体文件...</p>
                </div>
            </div>


            <!-- 网站设置视图 -->
            <div id="settings-view" class="admin-view" style="display: none;">
                <div class="page-header">
                    <h2><i class="fas fa-cogs"></i> 网站设置</h2>
                    <button id="save-settings-btn" class="btn-success"><i class="fas fa-save"></i> 保存设置</button>
                </div>
                 <div class="form-group">
                    <label for="setting-title">网站标题 <span style="color:red;">*</span></label>
                    <input type="text" id="setting-title" placeholder="例如：我的个人博客">
                </div>
                <div class="form-group">
                    <label for="setting-description">网站描述</label>
                    <input type="text" id="setting-description" placeholder="一句话描述你的博客">
                </div>
                <div class="form-group">
                    <label for="setting-about-content">“关于我”页面内容 (支持 Markdown)</label>
                    <textarea id="setting-about-content" rows="10" placeholder="请在这里填写关于你的介绍，支持 Markdown 格式。"></textarea>
                    <div id="setting-about-content-preview" class="markdown-preview-area"></div>
                     <p class="description">此内容将显示在网站的“关于我”页面。</p>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="setting-bg-color">背景颜色</label><input type="color" id="setting-bg-color">
                        <p class="description">网站的整体背景色。</p>
                    </div>
                    <div class="form-group">
                        <label for="setting-text-color">文字颜色</label><input type="color" id="setting-text-color">
                        <p class="description">网站内容的默认文字颜色。</p>
                    </div>
                    <div class="form-group">
                        <label for="setting-accent-color">链接/强调色</label><input type="color" id="setting-accent-color">
                        <p class="description">链接、按钮等强调元素的颜色。</p>
                    </div>
                </div>
                <div class="form-group">
                    <label for="setting-bg-image">网站背景图</label>
                    <input type="file" id="setting-bg-image" accept="image/*">
                    <input type="text" id="setting-bg-image-url" placeholder="背景图URL将显示在这里" readonly style="margin-top: 10px;">
                    <div class="button-group" style="margin-top: 10px; justify-content: flex-start;">
                        <button id="upload-bg-image-btn" class="btn-primary" style="display:none;"><i class="fas fa-upload"></i> 上传并设置</button>
                        <button id="clear-bg-image-btn" class="btn-danger"><i class="fas fa-trash-alt"></i> 清除背景图</button>
                    </div>
                    <p class="description">可上传图片作为网站背景，或直接粘帖URL。上传后需点击"保存设置"。</p>
                </div>
            </div>

            <!-- Gitalk 评论设置视图 -->
            <div id="gitalk-settings-view" class="admin-view" style="display: none;">
                <div class="page-header">
                    <h2><i class="fas fa-comments"></i> Gitalk 评论设置</h2>
                    <button id="save-gitalk-settings-btn" class="btn-success"><i class="fas fa-save"></i> 保存评论设置</button>
                </div>
                <p class="alert alert-info"><i class="fas fa-info-circle"></i> Gitalk基于GitHub Issues，请确保Token拥有 `repo` 权限，且`owner`和`repo`字段填写正确。</p>
                <div class="form-group">
                    <label for="gitalk-clientID">GitHub Application Client ID <span style="color:red;">*</span></label>
                    <input type="text" id="gitalk-clientID" placeholder="GitHub OAuth Application Client ID">
                    <p class="description">在 GitHub 创建 OAuth Application 获取。回调 URL 填写您的博客网址。</p>
                </div>
                <div class="form-group">
                    <label for="gitalk-clientSecret">GitHub Application Client Secret <span style="color:red;">*</span></label>
                    <input type="password" id="gitalk-clientSecret" placeholder="GitHub OAuth Application Client Secret">
                    <p class="description">在 GitHub 创建 OAuth Application 获取。请妥善保管此Secret，但由于在前端使用，仍存在被获取的风险。</p>
                </div>
                <div class="form-group">
                    <label for="gitalk-repo">GitHub 仓库名 (用于存储评论) <span style="color:red;">*</span></label>
                    <input type="text" id="gitalk-repo" placeholder="例如：your-repo-name">
                    <p class="description">存储博客评论的 GitHub 仓库名称，通常与您的博客仓库相同。</p>
                </div>
                <div class="form-group">
                    <label for="gitalk-owner">GitHub 仓库所有者 <span style="color:red;">*</span></label>
                    <input type="text" id="gitalk-owner" placeholder="例如：your-github-username">
                    <p class="description">GitHub 仓库所有者的用户名。</p>
                </div>
                <div class="form-group">
                    <label for="gitalk-admin">管理员 (用英文逗号分隔)</label>
                    <input type="text" id="gitalk-admin" placeholder="例如：your-github-username">
                    <p class="description">拥有 Gitalk 评论管理权限的 GitHub 用户名。</p>
                </div>
                 <div class="form-group">
                    <input type="checkbox" id="gitalk-enabled" style="width: auto; margin-right: 5px;">
                    <label for="gitalk-enabled" style="display: inline-block; margin-bottom: 0;">启用 Gitalk 评论</label>
                </div>
            </div>
        </main>
    </div>

    <!-- Media Library Modal (for editor image selection) -->
    <div id="media-library-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>选择图片</h3>
                <button class="close-button" id="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modal-media-library-grid" class="media-library-grid">
                    <p style="text-align: center; width: 100%;">加载媒体文件...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="modal-insert-image-btn" class="btn-primary" disabled><i class="fas fa-plus-circle"></i> 插入选中图片</button>
                <button id="modal-cancel-btn" class="btn-secondary"><i class="fas fa-times-circle"></i> 取消</button>
            </div>
        </div>
    </div>


    <!-- EasyMDE Markdown 编辑器 JS -->
    <script src="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.js"></script>
    <!-- Marked.js for Markdown preview -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


    <script>
        // ==================== 全局变量和工具函数 ====================
        const utf8_to_b64 = (str) => btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
        const b64_to_utf8 = (str) => {
            try { return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); } catch (e) { return atob(str); }
        };

        const GitHubAPI = {
            BASE_URL: 'https://api.github.com',
            async request(token, endpoint, options = {}) {
                const url = `${this.BASE_URL}${endpoint}`;
                const headers = { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json', ...options.headers };
                const response = await fetch(url, { ...options, headers });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP Error: ${response.statusText}`, documentation_url: response.url || endpoint }));
                    const errorMessage = errorData.message || `GitHub API request failed with status ${response.status}`;
                    console.error('GitHub API Error:', errorMessage, errorData);
                    const specificError = errorMessage.toLowerCase().includes('bad credentials') || errorMessage.toLowerCase().includes('requires authentication') || response.status === 401 || response.status === 403
                        ? '你的 GitHub Token 可能无效或权限不足。请检查：Token生成页面 [<sup>1</sup>](https://github.com/settings/tokens)'
                        : '';
                    if (response.status === 404 && (options.method === 'PUT' || options.method === 'DELETE')) {
                        throw new Error(`${errorMessage} (路径：${endpoint})。可能是由于父目录或文件不存在。`);
                    }
                    throw new Error(`${errorMessage} ${specificError}`);
                }
                if (response.status === 204 || response.headers.get("Content-Length") === "0") return null;
                return response.json();
            },
            async getUser(token) { return this.request(token, '/user'); },
            async getFile(token, owner, repo, path) {
                try {
                    const result = await this.request(token, `/repos/${owner}/${repo}/contents/${path}`);
                    if (!result || typeof result.content !== 'string') {
                        return null; 
                    }
                    return { content: b64_to_utf8(result.content), sha: result.sha };
                } catch (error) {
                    if (error.message.toLowerCase().includes('not found')) {
                        return null;
                    }
                    throw error;
                }
            },
            async getDirectoryContents(token, owner, repo, path) {
                try {
                    const contents = await this.request(token, `/repos/${owner}/${repo}/contents/${path}`);
                    return contents;
                } catch (error) {
                    if (error.message.toLowerCase().includes('not found')) return [];
                    throw error;
                }
            },
            async createFile(token, owner, repo, path, content, message, isBinary = false) { 
                return this.request(token, `/repos/${owner}/${repo}/contents/${path}`, { method: 'PUT', body: JSON.stringify({ message, content: isBinary ? content : utf8_to_b64(content) }) });
            },
            async updateFile(token, owner, repo, path, content, sha, message, isBinary = false) {
                return this.request(token, `/repos/${owner}/${repo}/contents/${path}`, { method: 'PUT', body: JSON.stringify({ message, content: isBinary ? content : utf8_to_b64(content), sha }) });
            },
            async deleteFile(token, owner, repo, path, sha, message) { 
                return this.request(token, `/repos/${owner}/${repo}/contents/${path}`, { method: 'DELETE', body: JSON.stringify({ message, sha }) });
            },
        };

        // ==================== DOM 元素缓存 ====================
        const loginWrapper = document.getElementById('login-wrapper');
        const adminWrapper = document.getElementById('admin-wrapper');
        const tokenInput = document.getElementById('token-input');
        const rememberTokenCheckbox = document.getElementById('remember-token');
        const startBtn = document.getElementById('start-btn');
        const initialMessageEl = document.getElementById('initial-message');

        const adminViews = {
            dashboard: document.getElementById('dashboard-view'),
            posts: document.getElementById('posts-view'),
            editor: document.getElementById('editor-container'),
            media: document.getElementById('media-view'),
            settings: document.getElementById('settings-view'),
            gitalkSettings: document.getElementById('gitalk-settings-view'),
        };
        const navButtons = {
            dashboard: document.getElementById('nav-dashboard'),
            posts: document.getElementById('nav-posts'),
            media: document.getElementById('nav-media'),
            settings: document.getElementById('nav-settings'),
            gitalkSettings: document.getElementById('nav-gitalk-settings'), 
            logout: document.getElementById('nav-logout'),
        };
        const postListBody = document.getElementById('post-list');

        let token = null, owner = '', repo = '', basePath = '';
        let posts = [], postsSha = '';
        let config = {}, configSha = '';
        let easyMDE;

        // Media Library Modal related elements
        const mediaLibraryModal = document.getElementById('media-library-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalInsertImageBtn = document.getElementById('modal-insert-image-btn');
        const modalMediaLibraryGrid = document.getElementById('modal-media-library-grid');
        let selectedMediaFile = null; // To store the currently selected file in the modal

        const getPath = (fileName) => basePath ? `${basePath}/${fileName}` : fileName;


        async function createGitHubDirectory(apiToken, apiOwner, apiRepo, directoryPath) {
            if (!directoryPath) return true; // Don't create empty base path (repo root)
            // For a path like "images", it means repo/images/.gitkeep
            // For a path like "subdir/images", it means repo/subdir/images/.gitkeep
            const gitkeepPath = `${directoryPath}/.gitkeep`;
            try {
                const fileData = await GitHubAPI.getFile(apiToken, apiOwner, apiRepo, gitkeepPath);
                if (!fileData) {
                    await GitHubAPI.createFile(apiToken, apiOwner, apiRepo, gitkeepPath, '', `feat: create directory ${directoryPath}`);
                }
                return true;
            } catch (error) {
                console.error(`Failed to create directory ${directoryPath}:`, error);
                throw error;
            }
        }
        
        // ==================== UI 辅助函数 ====================
        const showAdminView = (viewName) => {
            Object.values(adminViews).forEach(v => {
                if(v) v.style.display = 'none'; // Safely hide
            });
            
            if (easyMDE && viewName !== 'editor') {
                easyMDE.toTextArea();
                document.getElementById('post-content').style.display = '';
                easyMDE = null;
            }
            
            Object.values(navButtons).forEach(b => {
                if(b) b.classList.remove('active'); // Safely remove active class
            });

            const currentNavLink = document.querySelector(`#admin-sidebar .nav a[data-view="${viewName}"]`);
            if (currentNavLink) {
                 currentNavLink.classList.add('active');
            } else if (viewName === 'editor') {
                navButtons.posts.classList.add('active'); // Editor belongs to posts
            }
            
            if (adminViews[viewName]) { // Check if the view element exists before trying to show it
                 adminViews[viewName].style.display = 'block';
            } else {
                console.warn(`Admin view element for '${viewName}' not found.`);
                showAlert(`无法显示视图 '${viewName}'，页面元素不存在。`, 'danger');
            }
            
            if (viewName === 'editor' && !easyMDE) {
                initializeEasyMDE();
            }
            if (viewName === 'dashboard') renderDashboard();
            if (viewName === 'media') loadMediaLibrary();
            if (viewName === 'settings') {
                populateSettings();
                // Initialize Markdown preview for about content
                document.getElementById('setting-about-content').addEventListener('input', updateAboutPreview);
                updateAboutPreview(); // Initial render
            } else {
                // Remove listener if not on settings page to prevent memory leaks
                const aboutContentTextarea = document.getElementById('setting-about-content');
                if (aboutContentTextarea) {
                    aboutContentTextarea.removeEventListener('input', updateAboutPreview);
                }
            }
            

            document.querySelector('.admin-wrapper').classList.remove('sidebar-visible');
        };

        const setButtonsDisabled = (disabled) => document.querySelectorAll('button').forEach(b => b.disabled = disabled);

        const showAlert = (message, type = 'info', id = 'global-alert') => {
            let existingAlert = document.getElementById(id);
            if (!existingAlert) {
                existingAlert = document.createElement('div');
                existingAlert.id = id;
                adminWrapper.querySelector('main').prepend(existingAlert);
            }
            existingAlert.className = `alert alert-${type}`;
            const icon = {'info': 'fas fa-info-circle', 'success': 'fas fa-check-circle', 'danger': 'fas fa-exclamation-circle', 'warning': 'fas fa-exclamation-triangle'}[type];
            existingAlert.innerHTML = `<i class="${icon}"></i> ${message}`;
            existingAlert.style.display = 'flex';
            setTimeout(() => { if(existingAlert) existingAlert.style.display = 'none'; }, 5000);
        };

        const copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('URL已复制到剪贴板！', 'success');
            }).catch(err => {
                showAlert('复制失败: ' + err, 'danger');
            });
        };

        // ==================== 登录/初始化 ====================
        const checkTokenAndStart = async () => {
             const storedToken = localStorage.getItem('github_token');
             if (storedToken) {
                 tokenInput.value = storedToken;
                 rememberTokenCheckbox.checked = true;
                startAdmin();
             }
        };

        const startAdmin = async () => {
            const userToken = tokenInput.value.trim();
            if (!userToken) { initialMessageEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Token 不能为空。'; return; }
            token = userToken;
            setButtonsDisabled(true);
            initialMessageEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在验证并加载...';
            initialMessageEl.style.color = 'var(--text-color)';

            try {
                const user = await GitHubAPI.getUser(token);
                owner = user.login;
                
                // Dynamic repo and basePath detection (copied from index.html for consistency)
                const hostname = window.location.hostname;
                let pathname = window.location.pathname;

                if (pathname.endsWith('/index.html') || pathname.endsWith('/admin.html')) {
                    pathname = pathname.substring(0, pathname.lastIndexOf('/'));
                } else if (pathname.endsWith('/')) {
                    pathname = pathname.substring(0, pathname.length - 1);
                }

                const pathSegments = pathname.split('/').filter(p => p);

                let owner_detected, repo_detected, basePath_detected;

                if (hostname.endsWith('.github.io')) {
                    owner_detected = hostname.split('.')[0];
                   
                    if (pathSegments.length > 0 && pathSegments[0].toLowerCase() === owner_detected.toLowerCase()) {
                        repo_detected = hostname;
                        basePath_detected = pathSegments.slice(1).join('/');
                    } else if (pathSegments.length > 0) {
                        repo_detected = pathSegments[0];
                        basePath_detected = '';
                    } else {
                        repo_detected = hostname;
                        basePath_detected = '';
                    }
                } else {
                    if (pathSegments.length > 0) {
                        repo_detected = pathSegments[0];
                        basePath_detected = pathSegments.slice(1).join('/');
                    } else {
                         // For custom domains directly pointing to repo root, user still needs to specify repo.
                         // We can try to infer from owner, but best to let user confirm.
                        console.warn("Could not automatically determine repository name from URL. Assuming repo is direct on hostname. Please verify in Gitalk settings.");
                        repo_detected = prompt("Could not automatically determine your GitHub repository name. Please enter it (e.g., 'my-blog-repo' or 'username.github.io'):", `${owner}.github.io`) || `${owner}.github.io`; // Fallback to prompt
                        basePath_detected = '';
                    }
                }
                
                owner = owner_detected;
                repo = repo_detected;
                basePath = basePath_detected;
                
                console.log(`Backend Initialized with: Owner=${owner}, Repo=${repo}, Base Path="${basePath}"`);
                showAlert(`检测到仓库信息：Owner: ${owner}, Repo: ${repo}, Base Path: "${basePath}"`, 'info', 'path-detection-alert');


                initialMessageEl.innerHTML = `<i class="fas fa-spinner fa-spin"></i> 正在检查并创建所需文件目录...`;
                try {
                    const baseDirParts = basePath.split('/').filter(Boolean);
                    let currentPathAccumulated = '';
                    for (const part of baseDirParts) {
                        currentPathAccumulated = currentPathAccumulated ? `${currentPathAccumulated}/${part}` : part;
                        await createGitHubDirectory(token, owner, repo, currentPathAccumulated);
                    }
                    await createGitHubDirectory(token, owner, repo, getPath('images')); 

                } catch (e) {
                    initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 无法创建必要的目录。错误: ${e.message}<br>请检查您的 GitHub Token 权限是否包含 ` + `repo` + ` 权限。`;
                    throw e;
                }

                
                let configData = null;
                let postsData = null;
                initialMessageEl.innerHTML = `<i class="fas fa-spinner fa-spin"></i> 正在获取核心配置文件...`;

                try {
                    configData = await GitHubAPI.getFile(token, owner, repo, getPath('config.json'));
                } catch (e) {
                    initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 获取 ${getPath('config.json')} 失败: ${e.message}`;
                    throw e;
                }
                
                try {
                    postsData = await GitHubAPI.getFile(token, owner, repo, getPath('posts.json'));
                } catch (e) {
                    initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 获取 ${getPath('posts.json')} 失败: ${e.message}`;
                    throw e;
                }

                const hasExistingConfig = !!configData;
                const hasExistingPosts = !!postsData; 

                const initialConfig = {
                    site: {
                        title: `${user.login}的博客`,
                        description: "由GitHub驱动的现代化半静态博客",
                        aboutContent: `# 关于我\n\n你好！我是 ${user.login}，一个热爱技术和分享的开发者。欢迎来到我的博客！\n\n在这里，我将分享我的技术心得、学习笔记以及一些生活感悟。希望我的内容能对你有所启发或帮助。\n\n**联系我:**\n\n*   GitHub: ${user.login} [<sup>2</sup>](https://github.com/${user.login})\n*   Email: your_email@example.com\n\n---`,
                    },
                    styling: {
                        backgroundColor: "#f8f9fa",
                        textColor: "#212529",
                        accentColor: "#0d6efd",
                        backgroundImageUrl: ""
                    },
                    gitalk: {
                        enabled: false,
                        clientID: '',
                        clientSecret: '',
                        repo: repo, 
                        owner: owner,
                        admin: [owner],
                    }
                };
                const initialPosts = [{
                    id: `hello_world_${Date.now()}`,
                    title: "欢迎来到我的博客！",
                    content: "# 欢迎！\n\n这是您的第一篇文章，由期望ai自动生成。\n\n使用后台管理系统，您可以轻松发布、编辑和删除文章。文章支持 **Markdown** 格式。\n\n在 博客管理后台 [<sup>3</sup>](admin.html) 中，您可以：\n\n*   撰写新的文章\n*   管理网站配置 (标题、描述、颜色、背景图)\n*   配置 Gitalk 评论系统\n\n快去发布你的第一篇文章吧！\n\n<!--more-->\n\n### Markdown 示例\n\n```javascript\nconsole.log('Hello, world!');\n```\n\n> 引用块。\n\n*   列表项1\n*   列表项2\n\n--- \n\n<p style=\"text-align: center;\">祝你创作愉快！</p>",
                    category: "公告",
                    tags: ["欢迎", "教程"],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }];

                // 核心文件处理逻辑 - config.json 
                let currentConfig = initialConfig;
                if (hasExistingConfig) {
                    try {
                        let parsedConfig = JSON.parse(configData.content);
                        Object.assign(currentConfig, parsedConfig);
                        currentConfig.site = Object.assign({}, initialConfig.site, parsedConfig.site);
                        currentConfig.styling = Object.assign({}, initialConfig.styling, parsedConfig.styling);
                        currentConfig.gitalk = Object.assign({}, initialConfig.gitalk, parsedConfig.gitalk);
                        currentConfig.gitalk.repo = repo; 
                        currentConfig.gitalk.owner = owner;
                        if (!currentConfig.gitalk.admin || currentConfig.gitalk.admin.length === 0) {
                            currentConfig.gitalk.admin = [owner];
                        }
                    } catch (e) {
                        console.warn("Invalid config.json content, using default config.", e);
                        showAlert('config.json' + (configData.content ? '内容无效' : '文件不存在或为空') + '，已使用默认配置覆盖。', 'warning');
                    }
                    try {
                        const commitMessage = 'conf: update config with default/existing values';
                        const res = await GitHubAPI.updateFile(token, owner, repo, getPath('config.json'), JSON.stringify(currentConfig, null, 2), configData.sha, commitMessage);
                        configSha = res.content.sha;
                    } catch (e) {
                         console.error(`Error updating config.json: ${e.message}`);
                         initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 更新 ${getPath('config.json')} 失败: ${e.message}`;
                         throw e;
                    }
                } else {
                    try {
                        const commitMessage = 'feat: initialize config';
                        const res = await GitHubAPI.createFile(token, owner, repo, getPath('config.json'), JSON.stringify(initialConfig, null, 2), commitMessage);
                        configSha = res.content.sha;
                        currentConfig = initialConfig;
                    } catch (e) {
                        console.error(`Error creating config.json: ${e.message}`);
                        initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 创建 ${getPath('config.json')} 失败: ${e.message}`;
                        throw e;
                    }
                }
                config = currentConfig;

                // 核心文件处理逻辑 - posts.json
                let currentPostsArray = [];
                if (hasExistingPosts) {
                    try {
                        currentPostsArray = JSON.parse(postsData.content);
                        if (currentPostsArray.length === 0 || !currentPostsArray.some(p => p.id === initialPosts[0].id)) {
                             currentPostsArray.push(initialPosts[0]);
                             showAlert('posts.json 文件之前为空或缺少欢迎文章，已补充。', 'info');
                        }
                    } catch (e) {
                        console.warn("Invalid posts.json content, overwriting with default post.", e);
                        showAlert('posts.json' + (postsData.content ? '内容无效' : '文件不存在或为空') + '，已添加默认文章。', 'warning');
                        currentPostsArray = initialPosts;
                    }
                    currentPostsArray.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                    try {
                        const commitMessage = 'docs: update posts with initial/existing entries';
                        const res = await GitHubAPI.updateFile(token, owner, repo, getPath('posts.json'), JSON.stringify(currentPostsArray, null, 2), postsData.sha, commitMessage);
                        postsSha = res.content.sha;
                    } catch (e) {
                        console.error(`Error updating posts.json: ${e.message}`);
                        initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 更新 ${getPath('posts.json')} 失败: ${e.message}`;
                        throw e;
                    }
                } else {
                    try {
                        const commitMessage = 'feat: initialize first post';
                        const res = await GitHubAPI.createFile(token, owner, repo, getPath('posts.json'), JSON.stringify(initialPosts, null, 2), commitMessage);
                        postsSha = res.content.sha;
                        currentPostsArray = initialPosts;
                    } catch (e) {
                        console.error(`Error creating posts.json: ${e.message}`);
                        initialMessageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> 创建 ${getPath('posts.json')} 失败: ${e.message}`;
                        throw e;
                    }
                }
                posts = currentPostsArray;

                // --- 初始化成功后界面渲染 ---
                loginWrapper.style.display = 'none';
                adminWrapper.style.display = 'flex';
                showAdminView('dashboard'); // Default to dashboard
                updateUniqueTags();

                if (rememberTokenCheckbox.checked) {
                    localStorage.setItem('github_token', token);
                } else {
                    localStorage.removeItem('github_token');
                }

                initialMessageEl.innerHTML = ``;
                showAlert('博客后台管理系统已成功加载！', 'success');

            } catch (error) {
                console.error("Critical initialization failure:", error);
                if (!initialMessageEl.innerHTML.includes('无法创建目录') && !initialMessageEl.innerHTML.includes('Token') && !initialMessageEl.innerHTML.includes('获取') && !initialMessageEl.innerHTML.includes('创建')) {
                    initialMessageEl.innerHTML = `<i class="fas fa-times-circle"></i> 登录失败或系统初始化失败: ${error.message}<br>通用建议：请仔细检查您的Token权限、GitHub Pages配置和网络连接。`;
                }
                initialMessageEl.style.color = 'var(--danger-color)';
                token = null;
                localStorage.removeItem('github_token');
            } finally {
                setButtonsDisabled(false);
            }
        };

        // ==================== Dashboard Functions ====================
        function renderDashboard() {
            const uniqueCategories = new Set(posts.map(p => p.category).filter(Boolean));
            const allTags = posts.flatMap(p => p.tags || []);
            const uniqueTags = new Set(allTags);
    
            document.getElementById('stat-posts').textContent = posts.length;
            document.getElementById('stat-categories').textContent = uniqueCategories.size;
            document.getElementById('stat-tags').textContent = uniqueTags.size;
    
            const recentPostsList = document.getElementById('dashboard-recent-posts');
            recentPostsList.innerHTML = '';
            const recentPosts = [...posts].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
            if (recentPosts.length > 0) {
                recentPosts.forEach(post => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="#" class="edit-link" data-id="${post.id}">${post.title}</a> <span class="date">${new Date(post.createdAt).toLocaleDateString()}</span>`;
                    recentPostsList.appendChild(li);
                });
            } else {
                recentPostsList.innerHTML = '<li>暂无文章</li>';
            }
        }


        // ==================== 文章管理功能 ====================
        const renderPostList = () => {
             postListBody.innerHTML = '';
             if (posts.length === 0) {
                 postListBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">暂无文章。点击“撰写新文章”开始创作吧！</td></tr>`;
                 return;
             }

             [...posts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(post => {
                 const tr = document.createElement('tr');
                 tr.innerHTML = `
                    <td>${post.title}</td>
                    <td>${post.category || '未分类'}</td>
                    <td>${post.tags && post.tags.length > 0 ? post.tags.slice(0, 3).join(', ') + (post.tags.length > 3 ? '...' : '') : '无标签'}</td>
                    <td>${new Date(post.createdAt).toLocaleDateString()}</td>
                    <td>${new Date(post.updatedAt).toLocaleDateString()}</td>
                    <td class="actions">
                        <a href="#" class="edit" data-id="${post.id}" title="编辑"><i class="fas fa-edit"></i></a>
                        <a href="#" class="delete" data-id="${post.id}" title="删除"><i class="fas fa-trash-alt"></i></a>
                        <a href="index.html#/post/${post.id}" target="_blank" class="link" title="预览"><i class="fas fa-external-link-alt"></i></a>
                    </td>
                `;
                 postListBody.appendChild(tr);
             });
        };

        const openEditor = (postId = null) => {
            showAdminView('editor');
            const post = posts.find(p => p.id === postId);
            document.getElementById('editor-title').innerHTML = `<i class="fas fa-edit"></i> ${post ? '编辑文章' : '撰写新文章'}`;
            document.getElementById('save-post-btn').innerHTML = `<i class="fas fa-upload"></i> ${post ? '更新文章' : '发布文章'}`;
            document.getElementById('post-id').value = post?.id || '';
            document.getElementById('post-title').value = post?.title || '';
            document.getElementById('post-category').value = post?.category || '';
            // 清空并重新生成标签输入
            const tagTokenContainer = document.getElementById('tag-token-container');
            tagTokenContainer.querySelectorAll('.tag-token').forEach(tagEl => tagEl.remove());
            const tagsInput = document.getElementById('post-tags-input');
            if (post && post.tags && Array.isArray(post.tags)) {
                post.tags.forEach(tag => addTagToInput(tag, tagsInput));
            }
            tagsInput.value = ''; // 确保输入框清空
            document.getElementById('post-tags').value = JSON.stringify(post?.tags || []);


            // EasyMDE 赋值
            if (easyMDE) {
                easyMDE.value(post?.content || '');
            } else {
                document.getElementById('post-content').value = post?.content || '';
                initializeEasyMDE(); // 确保EasyMDE被初始化
            }
            
            document.getElementById('delete-post-btn').style.display = post ? 'inline-flex' : 'none';
        };

        const savePost = async () => {
            const id = document.getElementById('post-id').value;
            const title = document.getElementById('post-title').value.trim();
            const category = document.getElementById('post-category').value.trim() || '未分类';
            const content = easyMDE.value().trim(); // 从 EasyMDE 获取内容
            if (!title || !content) { showAlert('标题和内容不能为空！', 'danger'); return; }
            
            setButtonsDisabled(true);
            const tags = JSON.parse(document.getElementById('post-tags').value || '[]');

            const postIndex = posts.findIndex(p => p.id === id);
            const now = new Date().toISOString();

            if (postIndex > -1) {
                // 更新现有文章
                Object.assign(posts[postIndex], { title, category, content, tags, updatedAt: now });
            } else {
                // 创建新文章
                posts.push({ id: `post_${Date.now()}`, title, category, content, tags, createdAt: now, updatedAt: now });
            }
            // 重新排序文章，确保最新文章在前面
            posts.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, getPath('posts.json'), JSON.stringify(posts, null, 2), postsSha, `docs: ${id ? 'update' : 'create'} post "${title}"`);
                postsSha = res.content.sha;
                showAlert('文章保存成功！', 'success');
                // 更新标签建议列表
                updateUniqueTags();
                renderPostList();
                showAdminView('posts');
            } catch (error) {
                showAlert(`文章保存失败: ${error.message}`, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };

        const deletePost = async (postId) => {
            if (!postId || !confirm('确定要删除这篇文章吗？操作不可逆！')) return;
            setButtonsDisabled(true);
            const postToDelete = posts.find(p => p.id === postId);
            if (!postToDelete) {
                 showAlert('文章未找到！', 'danger');
                 setButtonsDisabled(false);
                 return;
            }
            posts = posts.filter(p => p.id !== postId);
            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, getPath('posts.json'), JSON.stringify(posts, null, 2), postsSha, `docs: delete post "${postToDelete.title}"`);
                postsSha = res.content.sha;
                showAlert('文章删除成功！', 'success');
                // 更新标签建议列表
                updateUniqueTags();
                renderPostList();
                showAdminView('posts');
            } catch (error) {
                showAlert(`文章删除失败: ${error.message}`, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };

        // ==================== 媒体库功能 ====================
        async function loadMediaLibrary(targetGrid = modalMediaLibraryGrid) {
            targetGrid.innerHTML = '<p style="text-align: center; width: 100%;">正在加载媒体文件...</p>';
            try {
                const files = await GitHubAPI.getDirectoryContents(token, owner, repo, getPath('images'));
                targetGrid.innerHTML = '';
                if (files && files.length > 0) {
                    files.filter(file => file.type === 'file' && !file.name.endsWith('.gitkeep')).forEach(file => {
                        const card = document.createElement('div');
                        card.className = 'media-card';
                        
                        // Determine file type for icon/image
                        const isImage = /\.(jpeg|jpg|png|gif|webp|svg)$/i.test(file.name);
                        const fileContent = isImage 
                            ? `<img src="${file.download_url}" alt="${file.name}" loading="lazy">`
                            : `<i class="fas fa-file file-icon"></i>`; // Fallback icon for non-image files
                        
                        card.innerHTML = `
                            <div class="image-container">
                                ${fileContent}
                            </div>
                            <div class="info">${file.name}</div>
                            <div class="actions">
                                <button class="btn btn-secondary copy-url-btn" data-url="${file.download_url}"><i class="fas fa-copy"></i></button>
                                <button class="btn btn-danger delete-media-btn" data-path="${file.path}" data-sha="${file.sha}"><i class="fas fa-trash"></i></button>
                            </div>
                        `;

                        // Add click listener for modal selection
                        card.addEventListener('click', () => {
                            if (targetGrid === modalMediaLibraryGrid) { // Only allow selection in modal
                                if (selectedMediaFile === file.download_url) {
                                    selectedMediaFile = null;
                                    card.classList.remove('selected');
                                    modalInsertImageBtn.disabled = true;
                                } else {
                                    const previouslySelected = targetGrid.querySelector('.media-card.selected');
                                    if (previouslySelected) previouslySelected.classList.remove('selected');
                                    selectedMediaFile = file.download_url;
                                    card.classList.add('selected');
                                    modalInsertImageBtn.disabled = false;
                                }
                            }
                        });


                        targetGrid.appendChild(card);
                    });
                } else {
                     targetGrid.innerHTML = '<p style="text-align: center; width: 100%;">媒体库为空。请上传一些图片。</p>';
                }
            } catch (error) {
                targetGrid.innerHTML = `<p class="alert alert-danger" style="width: 100%;">加载媒体库失败: ${error.message}</p>`;
            }
        }
        async function deleteMediaFile(path, sha) {
            if (!confirm(`确定要删除图片 ${path.split('/').pop()} 吗？此操作不可逆，且可能导致文章中的图片失效。`)) return;
            setButtonsDisabled(true);
            try {
                await GitHubAPI.deleteFile(token, owner, repo, path, sha, `del: delete image ${path.split('/').pop()}`);
                showAlert('图片删除成功！', 'success');
                loadMediaLibrary(document.getElementById('media-library-grid')); // Refresh main media view
                loadMediaLibrary(modalMediaLibraryGrid); // Also refresh modal library if open
            } catch (error) {
                showAlert(`删除失败: ${error.message}`, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        }

        // ==================== 网站设置功能 ====================
        const populateSettings = () => {
            document.getElementById('setting-title').value = config.site.title || '';
            document.getElementById('setting-description').value = config.site.description || '';
            document.getElementById('setting-about-content').value = config.site.aboutContent || ''; 
            document.getElementById('setting-bg-color').value = config.styling.backgroundColor || '#f8f9fa';
            document.getElementById('setting-text-color').value = config.styling.textColor || '#212529';
            document.getElementById('setting-accent-color').value = config.styling.accentColor || '#0d6efd';
            
            const bgImageUrl = config.styling.backgroundImageUrl;
            document.getElementById('setting-bg-image-url').value = bgImageUrl || '';
            
            // Re-evaluate visibility of upload button based on whether a URL is present
            if (bgImageUrl) {
                document.getElementById('upload-bg-image-btn').style.display = 'none';
            } else {
                document.getElementById('upload-bg-image-btn').style.display = 'inline-flex';
            }
            // Trigger preview update
            updateAboutPreview();
        };
        
        const saveSettings = async () => {
            setButtonsDisabled(true);
            const newConfig = JSON.parse(JSON.stringify(config)); // Deep copy
            newConfig.site = {
                title: document.getElementById('setting-title').value.trim(),
                description: document.getElementById('setting-description').value.trim(),
                aboutContent: document.getElementById('setting-about-content').value.trim(), 
            };
            newConfig.styling = {
                backgroundColor: document.getElementById('setting-bg-color').value,
                textColor: document.getElementById('setting-text-color').value,
                accentColor: document.getElementById('setting-accent-color').value,
                backgroundImageUrl: document.getElementById('setting-bg-image-url').value.trim(),
            };

            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, getPath('config.json'), JSON.stringify(newConfig, null, 2), configSha, 'conf: update website settings');
                configSha = res.content.sha;
                config = newConfig; // Update local config
                showAlert('网站设置已保存！', 'success');
                 // Also ensure frontend config is updated on next load
            } catch (error) {
                showAlert(`网站设置保存失败: ${error.message}`, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };

        const updateAboutPreview = () => {
            const content = document.getElementById('setting-about-content').value;
            document.getElementById('setting-about-content-preview').innerHTML = marked.parse(content || "在此处输入 Markdown 内容以预览...");
        };
        
        // ==================== Gitalk 评论设置功能 ====================
        const populateGitalkSettings = () => {
            const gitalkConfig = config.gitalk || {};
            document.getElementById('gitalk-enabled').checked = !!gitalkConfig.enabled;
            document.getElementById('gitalk-clientID').value = gitalkConfig.clientID || '';
            document.getElementById('gitalk-clientSecret').value = gitalkConfig.clientSecret || '';
            document.getElementById('gitalk-repo').value = gitalkConfig.repo || repo;
            document.getElementById('gitalk-owner').value = gitalkConfig.owner || owner;
            document.getElementById('gitalk-admin').value = (gitalkConfig.admin && Array.isArray(gitalkConfig.admin) ? gitalkConfig.admin.join(', ') : gitalkConfig.admin || '');
        };

        const saveGitalkSettings = async () => {
            setButtonsDisabled(true);
            const newConfig = JSON.parse(JSON.stringify(config)); // 深拷贝
            const gitalkAdminRaw = document.getElementById('gitalk-admin').value.trim();
            const gitalkAdminArray = gitalkAdminRaw.split(',').map(name => name.trim()).filter(Boolean);

            newConfig.gitalk = {
                enabled: document.getElementById('gitalk-enabled').checked,
                clientID: document.getElementById('gitalk-clientID').value.trim(),
                clientSecret: document.getElementById('gitalk-clientSecret')?.value.trim() || '', // Use optional chaining for safety
                repo: document.getElementById('gitalk-repo').value.trim(),
                owner: document.getElementById('gitalk-owner').value.trim(),
                admin: gitalkAdminArray,
            };

            // 验证必填字段
            if (newConfig.gitalk.enabled && (!newConfig.gitalk.clientID || !newConfig.gitalk.clientSecret || !newConfig.gitalk.repo || !newConfig.gitalk.owner)) {
                showAlert('启用 Gitalk 评论时，Client ID, Client Secret, Repo, Owner 都是必填项！', 'danger');
                setButtonsDisabled(false);
                return;
            }

            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, getPath('config.json'), JSON.stringify(newConfig, null, 2), configSha, 'conf: update Gitalk settings');
                configSha = res.content.sha;
                config = newConfig; // 更新本地配置
                showAlert('Gitalk 评论设置已保存！', 'success');
            } catch (error) {
                showAlert(`Gitalk 评论设置保存失败: ${error.message}`, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };


        // ==================== 文件上传功能 (通用，用于图片) ====================
        const uploadFile = async (file, uploadPath, message) => {
            if (!file) return;
            // No need to setButtonsDisabled here, parent function handles it
            const reader = new FileReader();
            return new Promise((resolve, reject) => {
                reader.onload = async (e) => {
                    const content = e.target.result.split(',')[1];
                    const blobPath = getPath(`${uploadPath}/${new Date().toISOString().replace(/[-:.]/g, '')}_${file.name}`);
                    try {
                        const result = await GitHubAPI.createFile(token, owner, repo, blobPath, content, message, true);
                        resolve(result.content.download_url); // Return raw.githubusercontent.com URL
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = (error) => {
                    reject(error);
                };
                reader.readAsDataURL(file);
            });
        };

        // ==================== EasyMDE 初始化及图片上传集成 ====================
        const initializeEasyMDE = () => {
            if (easyMDE) return; 

            easyMDE = new EasyMDE({
                element: document.getElementById('post-content'),
                spellChecker: false,
                forceSync: true,
                toolbar: [
                    "bold", "italic", "heading", "|",
                    "quote", "unordered-list", "ordered-list", "|",
                    "link", "image", "upload-image", "media-library", "|", // Add media-library button
                    "table", "horizontal-rule", "|",
                    "preview", "side-by-side", "fullscreen", "|",
                    "guide"
                ],
                customIcons: {
                    "upload-image": "<i class='fas fa-upload fa-fw'></i>",
                    "media-library": "<i class='fas fa-images fa-fw'></i>" // Custom icon for media library
                }
            });

            // Upload Image button
            easyMDE.toolbar.find(item => item.name === 'upload-image').action = async () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        setButtonsDisabled(true); 
                        showAlert(`正在上传图片 ${file.name}...`, 'info', 'image-upload-alert');

                        try {
                            const imageUrl = await uploadFile(file, 'images', `feat: upload image "${file.name}" for post`);
                            const markdownImage = `![${file.name.split('.')[0]}](${imageUrl})`; // Direct URL, GitHub API provides raw.githubusercontent.com links
                            
                            // Insert into editor at cursor position
                            const cm = easyMDE.codemirror;
                            const pos = cm.getCursor();
                            cm.replaceRange(markdownImage, pos);
                            showAlert(`图片 ${file.name} 上传成功并已插入！`, 'success', 'image-upload-alert');
                        } catch (error) {
                            showAlert(`图片上传失败: ${error.message}`, 'danger', 'image-upload-alert');
                        } finally {
                            setButtonsDisabled(false);
                        }
                    }
                };
                input.click();
            };

            // Media Library button
            easyMDE.toolbar.find(item => item.name === 'media-library').action = () => {
                selectedMediaFile = null;
                modalInsertImageBtn.disabled = true;
                const prevSelected = modalMediaLibraryGrid.querySelector('.media-card.selected');
                if (prevSelected) prevSelected.classList.remove('selected');

                loadMediaLibrary(modalMediaLibraryGrid); // Load into modal grid
                mediaLibraryModal.classList.add('is-visible'); // Show modal
            };
        };


        // ==================== 标签输入管理 ====================
        const allUniqueTags = new Set();
        const updateUniqueTags = () => {
            allUniqueTags.clear();
            posts.forEach(post => {
                if (post.tags && Array.isArray(post.tags)) {
                    post.tags.forEach(tag => allUniqueTags.add(tag));
                }
            });
        };

        const addTagToInput = (tagText, inputElement) => {
            tagText = tagText.trim();
            if (!tagText) return;

            const tagsContainer = document.getElementById('tag-token-container');
            let currentTags = JSON.parse(document.getElementById('post-tags').value || '[]');

            if (!currentTags.includes(tagText)) {
                currentTags.push(tagText);
                document.getElementById('post-tags').value = JSON.stringify(currentTags);

                const tagToken = document.createElement('span');
                tagToken.className = 'tag-token';
                tagToken.innerHTML = `${tagText} <i class="fas fa-times remove-tag"></i>`;
                tagToken.querySelector('.remove-tag').addEventListener('click', () => {
                    removeTagFromInput(tagText, inputElement);
                });
                tagsContainer.insertBefore(tagToken, inputElement);
            }
        };

        const removeTagFromInput = (tagText, inputElement) => {
            let currentTags = JSON.parse(document.getElementById('post-tags').value || '[]');
            currentTags = currentTags.filter(tag => tag !== tagText);
            document.getElementById('post-tags').value = JSON.stringify(currentTags);
            // Re-render tag tokens to ensure consistency
            const tagsContainer = document.getElementById('tag-token-container');
            tagsContainer.querySelectorAll('.tag-token').forEach(tagEl => tagEl.remove());
            currentTags.forEach(tag => addTagToInput(tag, inputElement));
        };

        document.addEventListener('DOMContentLoaded', () => {
            const tagsInput = document.getElementById('post-tags-input');
            const tagSuggestionsBox = document.getElementById('tag-suggestions');
            const tagTokenContainer = document.getElementById('tag-token-container');

            tagsInput.addEventListener('focus', () => {
                if (posts.length > 0) {
                     showTagSuggestions(tagsInput.value.trim().toLowerCase());
                }
            });
            tagsInput.addEventListener('blur', (e) => {
                setTimeout(() => {
                    if (!tagSuggestionsBox.contains(document.activeElement)) {
                        tagSuggestionsBox.style.display = 'none';
                    }
                }, 100);
            });

            tagsInput.addEventListener('input', () => {
                const inputValue = tagsInput.value.toLowerCase().trim();
                showTagSuggestions(inputValue);
            });

            tagsInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const inputValue = tagsInput.value.trim();
                    if (inputValue) {
                        addTagToInput(inputValue, tagsInput);
                        tagsInput.value = '';
                        tagSuggestionsBox.style.display = 'none';
                    }
                } else if (e.key === 'Backspace' && tagsInput.value === '') {
                    const lastTagToken = tagTokenContainer.querySelector('.tag-token:last-of-type');
                    if (lastTagToken) {
                        const tagText = lastTagToken.textContent.split(' ')[0].trim();
                        removeTagFromInput(tagText, tagsInput);
                    }
                }
            });

            tagTokenContainer.addEventListener('click', (e) => {
                if (e.target === tagTokenContainer || e.target.classList.contains('tag-token')) {
                    tagsInput.focus();
                }
            });

            const showTagSuggestions = (query) => {
                tagSuggestionsBox.innerHTML = '';
                const filteredSuggestions = Array.from(allUniqueTags).filter(tag =>
                    tag.toLowerCase().includes(query)
                ).sort();

                if (filteredSuggestions.length > 0) {
                    filteredSuggestions.forEach(tag => {
                        const div = document.createElement('div');
                        div.textContent = tag;
                        div.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            addTagToInput(tag, tagsInput);
                            tagsInput.value = '';
                            tagSuggestionsBox.style.display = 'none';
                        });
                        tagSuggestionsBox.appendChild(div);
                    });
                    const inputRect = tagsInput.getBoundingClientRect();
                    const containerRect = tagTokenContainer.getBoundingClientRect();
                    tagSuggestionsBox.style.top = `${containerRect.height + 5}px`;
                    tagSuggestionsBox.style.left = `0`;
                    tagSuggestionsBox.style.width = `${tagTokenContainer.offsetWidth}px`;

                    tagSuggestionsBox.style.display = 'block';
                } else {
                    tagSuggestionsBox.style.display = 'none';
                }
            };
        });


        // ==================== 事件绑定 ====================
        document.addEventListener('DOMContentLoaded', () => {
            // 登录
            startBtn.onclick = startAdmin;
            tokenInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') startAdmin(); });
            
            // 导航
            navButtons.dashboard.onclick = () => showAdminView('dashboard');
            navButtons.posts.onclick = () => { showAdminView('posts'); renderPostList(); };
            navButtons.media.onclick = () => showAdminView('media');
            navButtons.settings.onclick = () => { showAdminView('settings'); populateSettings(); };
            navButtons.gitalkSettings.onclick = () => { showAdminView('gitalk-settings'); populateGitalkSettings(); };
            navButtons.logout.onclick = () => {
                if (confirm('确定要安全退出吗？')) {
                    localStorage.removeItem('github_token');
                    location.reload(); // 重新加载页面，回到登录界面
                }
            };

            // 仪表盘按钮
            document.getElementById('dashboard-new-post-btn').onclick = () => openEditor();
            document.getElementById('dashboard-settings-btn').onclick = () => showAdminView('settings');
            document.getElementById('dashboard-recent-posts').addEventListener('click', e => { 
                if(e.target.matches('.edit-link')) { 
                    e.preventDefault(); 
                    openEditor(e.target.dataset.id); 
                }
            });
            
            // 文章管理
            document.getElementById('new-post-btn').onclick = () => openEditor();
            document.getElementById('cancel-edit-btn').onclick = () => {
                 showAdminView('posts');
                 showAlert('已取消文章编辑。', 'info');
            };
            document.getElementById('save-post-btn').onclick = savePost;
            document.getElementById('delete-post-btn').onclick = () => deletePost(document.getElementById('post-id').value);
            postListBody.addEventListener('click', (e) => {
                if (e.target.closest('.edit')) { e.preventDefault(); openEditor(e.target.closest('a').dataset.id); }
                if (e.target.closest('.delete')) { e.preventDefault(); deletePost(e.target.closest('a').dataset.id); }
            });

            // 媒体库上传和操作
            document.getElementById('media-upload-btn').onclick = () => document.getElementById('media-upload-input').click();
            document.getElementById('media-upload-input').onchange = async (e) => {
                const files = e.target.files;
                if (!files.length) return;
                setButtonsDisabled(true); // Disable all buttons during upload
                showAlert(`正在上传 ${files.length} 个图片...`, 'info', 'media-upload-alert');

                try {
                    const uploadPromises = [...files].map(file => uploadFile(file, 'images', `feat: upload image "${file.name}" from media library`));
                    await Promise.all(uploadPromises);
                    showAlert(`所有图片上传完成！`, 'success', 'media-upload-alert');
                    loadMediaLibrary(document.getElementById('media-library-grid')); // Refresh main media view
                    loadMediaLibrary(modalMediaLibraryGrid); // Also refresh modal library if open
                } catch(error) { 
                    showAlert(`上传失败: ${error.message}`, 'danger', 'media-upload-alert'); 
                } finally {
                    setButtonsDisabled(false); // Re-enable all buttons
                    e.target.value = ''; // Clear file input
                }
            };
            document.getElementById('media-library-grid').addEventListener('click', e => {
                 if(e.target.closest('.copy-url-btn')) { e.preventDefault(); copyToClipboard(e.target.closest('.copy-url-btn').dataset.url); }
                 if(e.target.closest('.delete-media-btn')) { e.preventDefault(); const btn = e.target.closest('.delete-media-btn'); deleteMediaFile(btn.dataset.path, btn.dataset.sha); }
            });
            
            // 网站设置
            document.getElementById('save-settings-btn').onclick = saveSettings;
            
            // 背景图上传处理
            const settingBgImageInput = document.getElementById('setting-bg-image');
            const settingBgImageUrlInput = document.getElementById('setting-bg-image-url');
            const uploadBgImageBtn = document.getElementById('upload-bg-image-btn');
            const clearBgImageBtn = document.getElementById('clear-bg-image-btn');

            settingBgImageInput.onchange = (e) => {
                if (e.target.files.length > 0) {
                    uploadBgImageBtn.style.display = 'inline-flex';
                    settingBgImageUrlInput.value = ''; // Clear URL if a new file is chosen
                } else {
                    uploadBgImageBtn.style.display = 'none';
                }
            };

            // If a URL is manually typed/pasted, hide upload button
            settingBgImageUrlInput.addEventListener('input', () => {
                const url = settingBgImageUrlInput.value.trim();
                uploadBgImageBtn.style.display = url ? 'none' : 'inline-flex';
                if(url) settingBgImageInput.value = ''; // clear file input if URL is provided
            });

            uploadBgImageBtn.onclick = async () => {
                const file = settingBgImageInput.files[0];
                if (file) {
                    setButtonsDisabled(true);
                    showAlert(`正在上传背景图片 ${file.name}...`, 'info', 'bg-image-alert');
                    try {
                        const url = await uploadFile(file, 'images', `feat: upload background image "${file.name}"`);
                        document.getElementById('setting-bg-image-url').value = url;
                        uploadBgImageBtn.style.display = 'none';
                        showAlert('背景图片上传并设置成功！请点击保存设置！', 'success', 'bg-image-alert');
                    } catch (error) {
                        showAlert(`背景图片上传失败: ${error.message}`, 'danger', 'bg-image-alert');
                    } finally {
                        setButtonsDisabled(false);
                    }
                } else {
                    showAlert('请先选择一个图片文件！', 'warning', 'bg-image-alert');
                }
            };
            clearBgImageBtn.onclick = () => {
                document.getElementById('setting-bg-image-url').value = '';
                settingBgImageInput.value = '';
                uploadBgImageBtn.style.display = 'inline-flex';
                showAlert('背景图已清除！请点击保存设置！', 'info');
            };

            // Gitalk 配置保存
            document.getElementById('save-gitalk-settings-btn').onclick = saveGitalkSettings;

            // 媒体库模态框事件
            modalCloseBtn.onclick = () => mediaLibraryModal.classList.remove('is-visible');
            modalCancelBtn.onclick = () => mediaLibraryModal.classList.remove('is-visible');
            modalInsertImageBtn.onclick = () => {
                if (selectedMediaFile) {
                    const markdownImage = `![](${selectedMediaFile})`;
                    easyMDE.codemirror.replaceSelection(markdownImage);
                    mediaLibraryModal.classList.remove('is-visible');
                    showAlert('图片已插入文章！', 'success');
                } else {
                    showAlert('请选择一张图片！', 'warning', 'modal-alert');
                }
            };


            // 移动端侧边栏切换
            document.getElementById('mobile-menu-btn').onclick = () => document.getElementById('admin-wrapper').classList.toggle('sidebar-visible');
            document.getElementById('mobile-overlay').onclick = () => document.getElementById('admin-wrapper').classList.remove('sidebar-visible');
            
            checkTokenAndStart();
        });
    </script>
</body>
</html>
