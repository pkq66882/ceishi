<!-- admin.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期望AI博客管理后台</title>
    <!-- Use a simple CSS Framework for better styling, e.g., Pure.css or custom styles -->
    <!-- For simplicity, integrating a custom modern CSS setup instead of a full framework -->

    <!-- Favicon PlaceHolder -->
    <link rel="icon" href="https://example.com/favicon.ico" type="image/x-icon">

    <!-- Google Fonts - Inter for clean typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">


    <style>
        /* CSS Variables for Theming */
        :root {
            --bg-color: #f4f6f8;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --sidebar-hover-bg: #34495e;
            --sidebar-active-bg: #1abc9c;
            --content-bg: #ffffff;
            --text-color: #34495e;
            --heading-color: #2c3e50;
            --accent-color: #3498db;
            --accent-hover-color: #2980b9;
            --border-color: #e0e0e0;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --toast-bg-success: #2ecc71; --toast-text-success: #fff;
            --toast-bg-error: #e74c3c; --toast-text-error: #fff;
            --toast-bg-info: #3498db; --toast-text-info: #fff;
            --button-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Base Styles */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 15px;
            line-height: 1.6;
        }

        a { text-decoration: none; color: var(--accent-color); transition: color .2s;}
        a:hover { color: var(--accent-hover-color); }

        input, textarea, button, select {
            font-family: inherit;
            font-size: inherit;
            border-radius: 4px;
            padding: 10px;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            background-color: var(--content-bg);
            color: var(--text-color);
            transition: border-color .2s, box-shadow .2s;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        button {
            padding: 10px 20px;
            border: none;
            background: var(--accent-color);
            color: #fff;
            cursor: pointer;
            transition: background .2s, transform .1s, box-shadow .2s;
            box-shadow: var(--button-shadow);
        }
        button:hover { background: var(--accent-hover-color); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        button:active { transform: translateY(0); box-shadow: var(--button-shadow); }
        button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
        }

        /* Login Wrapper */
        #login-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
        }
        .login-box {
            width: 90%;
            max-width: 400px;
            padding: 40px;
            background: var(--content-bg);
            box-shadow: var(--shadow);
            border-radius: 8px;
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }
        .login-box h1 { margin-bottom: 25px; color: var(--heading-color); font-size: 2.2rem; }
        .login-box p { margin-bottom: 25px; color: var(--meta-color, #7f8c8d); font-size: 1rem; }
        .login-box input {
            width: 100%;
            margin-bottom: 20px;
        }
        .login-box button { width: 100%; }
        #initial-message { margin-top: 20px; font-size: 0.9rem; color: var(--danger-color); }

        /* Admin Layout */
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
            opacity: 0; /* Hidden initially */
            transition: opacity 0.5s ease-out;
        }
        .admin-wrapper.visible { opacity: 1; }

        /* Sidebar */
        #admin-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 250px;
            background: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            z-index: 1000;
            box-shadow: 2px 0 6px rgba(0,0,0,0.2);
        }
        .admin-wrapper.sidebar-visible #admin-sidebar {
            transform: translateX(0);
        }
        #admin-sidebar .logo {
            padding: 25px 20px;
            font-size: 1.6rem;
            font-weight: 700;
            text-align: center;
            background-color: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        #admin-sidebar .nav {
            flex-grow: 1;
            list-style: none;
            margin: 0;
            padding: 20px 0;
        }
        #admin-sidebar .nav a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--sidebar-text);
            transition: background .2s, color .2s;
            position: relative;
        }
        #admin-sidebar .nav a svg {
            margin-right: 10px;
            opacity: 0.7;
        }
        #admin-sidebar .nav a:hover {
            background: var(--sidebar-hover-bg);
            color: #fff;
        }
        #admin-sidebar .nav a.active {
            background: var(--sidebar-active-bg);
            font-weight: 600;
            color: #fff;
        }
        #admin-sidebar .nav a.active svg {
            opacity: 1;
        }

        /* Main Content */
        #admin-content {
            flex-grow: 1;
            padding: 20px;
            margin-left: 0; /* Default for mobile */
            transition: margin-left .3s ease-in-out;
        }

        /* Mobile Header */
        #mobile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--content-bg);
            padding: 15px 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .mobile-menu-btn {
            font-size: 1.5rem;
            background: none;
            border: 0;
            cursor: pointer;
            color: var(--text-color);
            padding: 0; /* Reset button padding */
            box-shadow: none; /* Reset button shadow */
        }
        .mobile-logo {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--heading-color);
        }
        #mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        .admin-wrapper.sidebar-visible #mobile-overlay {
            display: block;
        }

        /* Desktop Layout */
        @media (min-width: 768px) {
            #admin-sidebar {
                position: static;
                transform: translateX(0);
                box-shadow: none;
            }
            #admin-content {
                margin-left: 250px;
                padding: 30px;
            }
            #mobile-header {
                display: none;
            }
            .admin-wrapper.sidebar-visible #mobile-overlay {
                display: none; /* Hide overlay on desktop even if sidebar is open */
            }
        }

        /* Page Content Styles */
        #admin-content h2, .page-header h2 {
            font-size: 1.8rem;
            color: var(--heading-color);
            margin-top: 0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .page-header h2 {
            border-bottom: none; /* Remove duplicate border */
            margin-bottom: 0;
            padding-bottom: 0;
        }

        /* Tables */
        .admin-table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--content-bg);
            min-width: 600px; /* Ensure table is wide enough on smaller screens */
        }
        .admin-table th, .admin-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        .admin-table th {
            background: #f9fafb;
            font-weight: 600;
            color: var(--heading-color);
        }
        .admin-table tbody tr:last-child td {
            border-bottom: none;
        }
        .admin-table .actions {
            display: flex;
            gap: 10px;
        }
        .admin-table .actions a {
            padding: 6px 12px;
            border-radius: 4px;
            transition: background-color .2s;
        }
        .admin-table .actions .edit {
            background-color: var(--accent-color);
            color: #fff;
        }
        .admin-table .actions .edit:hover {
            background-color: var(--accent-hover-color);
        }
        .admin-table .actions .delete {
            background-color: var(--danger-color);
            color: #fff;
        }
        .admin-table .actions .delete:hover {
            background-color: #c0392b; /* Darker red */
        }

        /* Buttons and Forms */
        .btn-success { background: var(--success-color); }
        .btn-success:hover { background: #27ae60; }
        .btn-danger { background: var(--danger-color); }
        .btn-danger:hover { background: #c0392b; }
        .btn-warning { background: var(--warning-color); }
        .btn-warning:hover { background: #e67e22; }

        .form-group { margin-bottom: 25px; }
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--heading-color);
            font-size: 0.9em;
        }
        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="color"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            max-width: 100%;
            min-width: 0;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 250px;
            line-height: 1.5;
        }
        .form-group input[type="color"] {
            padding: 5px;
            height: 40px;
            width: 80px;
        }
        .form-group .description {
            font-size: 0.85em;
            color: var(--meta-color);
            margin-top: 5px;
        }
        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            margin-bottom: 25px;
        }
        .form-row > .form-group {
            flex: 1;
            min-width: 280px; /* Adjust as needed */
            margin-bottom: 0; /* Reset margin for flex item */
        }
        .form-group.full-width {
            flex-basis: 100%;
        }

        /* Editor Container */
        #editor-container {
            display: none;
            background: var(--content-bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        #editor-container .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        #editor-container .button-group button {
            flex-shrink: 0;
        }

        /* Settings View */
        #settings-view {
            display: none;
            background: var(--content-bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        #settings-view .form-group {
            max-width: 700px;
        }
        .image-upload-preview {
            display: flex;
            align-items: flex-end; /* Align input with button */
            gap: 10px;
            margin-top: 10px;
        }
        .image-upload-preview input[type="text"] {
            flex-grow: 1;
        }
        #setting-bg-image-preview {
            max-width: 200px;
            max-height: 150px;
            margin-top: 10px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            object-fit: cover;
            display: none; /* Hidden by default */
        }
        .giscus-config-section {
            border-top: 1px solid var(--border-color);
            padding-top: 25px;
            margin-top: 25px;
        }
        .giscus-config-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--heading-color);
            font-size: 1.4rem;
        }
        .giscus-help-text {
            font-size: 0.85em;
            color: var(--meta-color);
            margin-top: -15px;
            margin-bottom: 15px;
            line-height: 1.4;
        }


        /* Loader for individual actions */
        .action-loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .action-loader-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }
        .action-loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast notifications */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 15px 20px;
            border-radius: 5px;
            min-width: 250px;
            max-width: 350px;
            box-shadow: var(--shadow);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            display: flex;
            align-items: center;
        }
        .toast.visible {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { background-color: var(--toast-bg-success); color: var(--toast-text-success); }
        .toast.error { background-color: var(--toast-bg-error); color: var(--toast-text-error); }
        .toast.info { background-color: var(--toast-bg-info); color: var(--toast-text-info); }
        .toast svg { margin-right: 10px; }


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="login-wrapper">
        <div id="login-box" class="login-box">
            <h1>博客管理</h1>
            <p>请输入您的GitHub Personal Access Token开始管理。</p>
            <input type="password" id="token-input" placeholder="输入具备 repo 权限的Token">
            <button id="start-btn">开始</button>
            <p id="initial-message"></p>
            <small style="color: #6c757d; display: block; margin-top: 15px;">
                提示: Token会被存储在浏览器的Session Storage中，关闭浏览器后需要重新输入。
                请确保您的Token具有 <code style="background-color: #f0f0f0; padding: 2px 4px; border-radius: 3px;">repo</code> 权限。
            </small>
        </div>
    </div>

    <div id="admin-wrapper" class="admin-wrapper">
        <div id="mobile-overlay"></div>
        <aside id="admin-sidebar">
            <div class="logo">期望AI博客</div>
            <ul class="nav">
                <li><a href="#posts" id="nav-posts" class="active">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    管理文章</a>
                </li>
                <li><a href="#settings" id="nav-settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0-.33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0 .33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    网站设置</a>
                </li>
                <li><a href="index.html" target="_blank">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-eye"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    查看站点</a>
                </li>
                 <li><a href="#" id="nav-logout">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    退出登陆</a>
                </li>
            </ul>
        </aside>

        <main id="admin-content">
            <header id="mobile-header">
                <button id="mobile-menu-btn" aria-label="Toggle menu">&#9776;</button>
                <div class="mobile-logo">管理后台</div>
            </header>

            <div id="posts-view">
                <div class="page-header">
                    <h2>文章管理</h2>
                    <button id="new-post-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        撰写新文章
                    </button>
                </div>
                <div class="admin-table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>标题</th>
                                <th>发布日期</th>
                                <th>更新日期</th>
                                <th class="actions">操作</th>
                            </tr>
                        </thead>
                        <tbody id="post-list">
                            <tr><td colspan="4" style="text-align: center;">正在加载文章...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="editor-container" style="display: none;">
                <h2 id="editor-title">撰写新文章</h2>
                <input type="hidden" id="post-id">
                <div class="form-group">
                    <label for="post-title">文章标题</label>
                    <input type="text" id="post-title" placeholder="输入文章标题...">
                </div>
                <div class="form-group full-width">
                    <label for="post-content">内容 (使用富文本编辑器)</label>
                    <textarea id="post-content" rows="18"></textarea>
                    <div class="description">使用 <code style="background-color: #f0f0f0; padding: 2px 4px; border-radius: 3px;">&lt;!--more--&gt;</code> (插入分隔线) 在文章列表视图中创建摘要。</div>
                </div>
                <div class="form-group">
                    <label for="post-tags">标签 (用英文逗号分隔)</label>
                    <input type="text" id="post-tags" placeholder="例如: web, programming, tutorial">
                    <div class="description">多个标签之间请使用英文逗号 <code>,</code> 分隔。</div>
                </div>
                <div class="form-group">
                    <label for="image-upload">上传文章图片</label>
                    <input type="file" id="image-upload" accept="image/*">
                    <div class="description">上传图片后，图片将自动插入到文章内容中。</div>
                </div>

                <div class="button-group">
                    <button id="save-post-btn" class="btn-success">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                        发布文章
                    </button>
                    <button id="cancel-edit-btn" class="btn-warning">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-circle"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                        取消
                    </button>
                    <button id="delete-post-btn" class="btn-danger" style="display:none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        删除文章
                    </button>
                </div>
            </div>

            <div id="settings-view">
                <div class="page-header">
                    <h2>网站设置</h2>
                </div>
                <div class="form-group">
                    <label for="setting-title">网站标题</label>
                    <input type="text" id="setting-title" placeholder="您博客的标题">
                </div>
                <div class="form-group">
                    <label for="setting-description">网站描述</label>
                    <input type="text" id="setting-description" placeholder="您博客的简短描述">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="setting-bg-color">背景颜色</label>
                        <input type="color" id="setting-bg-color">
                    </div>
                    <div class="form-group">
                        <label for="setting-text-color">文字颜色</label>
                        <input type="color" id="setting-text-color">
                    </div>
                    <div class="form-group">
                        <label for="setting-heading-color">标题颜色</label>
                        <input type="color" id="setting-heading-color">
                    </div>
                    <div class="form-group">
                        <label for="setting-accent-color">链接/强调色</label>
                        <input type="color" id="setting-accent-color">
                    </div>
                </div>
                <div class="form-row">
                     <div class="form-group">
                        <label for="setting-link-hover-color">链接悬停颜色</label>
                        <input type="color" id="setting-link-hover-color">
                    </div>
                     <div class="form-group">
                        <label for="setting-border-color">边框颜色</label>
                        <input type="color" id="setting-border-color">
                    </div>
                    <div class="form-group">
                        <label for="setting-card-bg">卡片背景色</label>
                        <input type="color" id="setting-card-bg">
                    </div>
                    <div class="form-group">
                        <label for="setting-meta-color">元数据颜色</label>
                        <input type="color" id="setting-meta-color">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="setting-code-bg">代码背景色</label>
                        <input type="color" id="setting-code-bg">
                    </div>
                    <div class="form-group">
                        <label for="setting-code-text">代码文字色</label>
                        <input type="color" id="setting-code-text">
                    </div>
                    <div class="form-group">
                        <label for="setting-footer-bg">页脚背景色</label>
                        <input type="color" id="setting-footer-bg">
                    </div>
                     <div class="form-group">
                        <label for="setting-dark-mode-enabled">启用夜间模式</label>
                        <input type="checkbox" id="setting-dark-mode-enabled" style="width: auto; margin-top: 10px;">
                        <div class="description">启用后，网站将使用深色主题。</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="setting-bg-image">上传网站背景图</label>
                    <div class="image-upload-preview">
                        <input type="file" id="setting-bg-image" accept="image/*">
                        <input type="text" id="setting-bg-image-url" placeholder="背景图URL将显示在这里" readonly>
                    </div>
                    <img id="setting-bg-image-preview" src="" alt="背景图片预览" style="max-width: 250px; max-height: 150px; margin-top: 10px; border-radius: 4px; border: 1px solid var(--border-color); object-fit: cover; display: none;">
                    <div class="button-group" style="margin-top: 10px; display: flex; gap: 10px;">
                         <button id="clear-bg-image-btn" class="btn-danger">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-square"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg>
                             清除背景图
                         </button>
                         <button id="upload-bg-image-btn" class="btn-info" style="display:none;">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-upload-cloud"><polyline points="16 16 12 12 8 16"></polyline><line x1="12" y1="12" x2="12" y2="21"></line><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"></path><polyline points="16 16 12 12 8 16"></polyline></svg>
                             上传背景图
                         </button>
                    </div>
                </div>

                <div class="giscus-config-section">
                    <h3>评论系统 (Giscus) 设置</h3>
                    <p class="giscus-help-text">
                        Giscus 是一个基于 GitHub Discussions 的评论系统。您需要先在 GitHub 上为您的仓库启用 Discuss，并安装 Giscus App。
                        <a href="https://giscus.app/" target="_blank" rel="noopener noreferrer">Giscus 官网配置向导 &rarr;</a>
                    </p>
                    <div class="form-group">
                        <label for="giscus-repo">GitHub 仓库 (例如: YourUsername/your-repo-name)</label>
                        <input type="text" id="giscus-repo" placeholder="用于评论的GitHub仓库, 例如 expectai/my-blog">
                        <div class="description">格式为: <code>您的用户名/您的仓库名</code>。</div>
                    </div>
                    <div class="form-group">
                        <label for="giscus-repo-id">仓库 ID</label>
                        <input type="text" id="giscus-repo-id" placeholder="从Giscus配置向导获取的仓库ID">
                        <div class="description">请从 Giscus 官网配置向导的第二步获取。</div>
                    </div>
                     <div class="form-group">
                        <label for="giscus-category">Discussion 分类名称</label>
                        <input type="text" id="giscus-category" placeholder="用于评论的Discussion分类名称, 例如 Comments">
                        <div class="description">指您在 GitHub Discussion 中创建的评论分类名称。</div>
                    </div>
                    <div class="form-group">
                        <label for="giscus-category-id">Discussion 分类 ID</label>
                        <input type="text" id="giscus-category-id" placeholder="从Giscus配置向导获取的分类ID">
                        <div class="description">请从 Giscus 官网配置向导的第三步获取。</div>
                    </div>
                </div>

                <div class="button-group">
                    <button id="save-settings-btn" class="btn-success">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                        保存设置
                    </button>
                    <button id="reset-settings-btn" class="btn-warning">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rotate-ccw"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
                        重置表单
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Action Loader Overlay -->
    <div id="action-loader-overlay" class="action-loader-overlay">
        <div class="action-loader-spinner"></div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- TinyMCE Rich Text Editor -->
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <!-- Replace 'no-api-key' with your actual TinyMCE API key for production -->

    <script>
        // Utility functions for Base64 encoding/decoding
        const utf8_to_b64 = (str) => btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
        const b64_to_utf8 = (str) => {
            try { return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); } catch (e) { return atob(str); }
        };

        // GitHub API interaction utility
        const GitHubAPI = {
            BASE_URL: 'https://api.github.com',
            async request(token, endpoint, options = {}) {
                const url = `${this.BASE_URL}${endpoint}`;
                const headers = {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    ...options.headers
                };
                const response = await fetch(url, { ...options, headers });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP Error: ${response.statusText}` }));
                    throw new Error(errorData.message || `GitHub API request failed: ${response.statusText}`);
                }
                if (response.status === 204 || response.headers.get("Content-Length") === "0") return null;
                return response.json();
            },
            getUser: (token) => GitHubAPI.request(token, '/user'),
            async getFile(token, owner, repo, path) {
                try {
                    const result = await this.request(token, `/repos/${owner}/${repo}/contents/${path}`);
                    if (!result || typeof result.content !== 'string') return null; // File not found or empty
                    return { content: b64_to_utf8(result.content), sha: result.sha };
                } catch (error) {
                    if (error.message.toLowerCase().includes('not found') || error.message.toLowerCase().includes('this repository appears to be empty')) {
                        return null; // File not found is a valid scenario for initial setup
                    }
                    throw error;
                }
            },
            createOrUpdateFile: async (token, owner, repo, path, content, message, sha = null, isBinary = false) => {
                const body = {
                    message,
                    content: isBinary ? content : utf8_to_b64(content),
                };
                if (sha) body.sha = sha; // Only include SHA for update operations
                return GitHubAPI.request(token, `/repos/${owner}/${repo}/contents/${path}`, {
                    method: 'PUT',
                    body: JSON.stringify(body)
                });
            },
            deleteFile: (token, owner, repo, path, sha, message) => GitHubAPI.request(token, `/repos/${owner}/${repo}/contents/${path}`, { method: 'DELETE', body: JSON.stringify({ message, sha }) }),
        };

        // DOM elements and state variables
        const loginWrapper = document.getElementById('login-wrapper');
        const adminWrapper = document.getElementById('admin-wrapper');
        const mainViews = { posts: document.getElementById('posts-view'), settings: document.getElementById('settings-view') };
        const navButtons = { posts: document.getElementById('nav-posts'), settings: document.getElementById('nav-settings') };
        const editorContainer = document.getElementById('editor-container');
        const postListBody = document.getElementById('post-list');
        const messageEl = document.getElementById('initial-message');
        const actionLoaderOverlay = document.getElementById('action-loader-overlay');
        const toastContainer = document.getElementById('toast-container');
        const uploadBgImageBtn = document.getElementById('upload-bg-image-btn');

        let token = null, owner = '', repo = '', basePath = '';
        let posts = [], postsSha = '';
        let config = {}, configSha = '';
        let tinymceEditor = null; // Store TinyMCE editor instance

        const getPath = (fileName) => basePath ? `${basePath}/${fileName}` : fileName;

        // Custom Toast Notification System
        const showToast = (message, type = 'info', duration = 3000) => {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = '';
            if (type === 'success') icon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-8.11"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
            if (type === 'error') icon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-octagon"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`;
            if (type === 'info') icon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-info"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`;
            toast.innerHTML = `${icon}<span>${message}</span>`;
            toastContainer.appendChild(toast);

            setTimeout(() => toast.classList.add('visible'), 10); // Trigger CSS transition
            setTimeout(() => {
                toast.classList.remove('visible');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        };

        // Show/hide loading overlay
        const showLoader = () => actionLoaderOverlay.classList.add('visible');
        const hideLoader = () => actionLoaderOverlay.classList.remove('visible');

        // Toggle button disabled state globally
        const setButtonsDisabled = (disabled) => document.querySelectorAll('button').forEach(b => b.disabled = disabled);

        // Show a specific admin view and update URL hash
        const showAdminView = (view, extraParams = null) => {
            Object.values(mainViews).forEach(v => v.style.display = 'none');
            editorContainer.style.display = 'none';
            Object.values(navButtons).forEach(b => b.classList.remove('active'));
            document.querySelector('.admin-wrapper').classList.remove('sidebar-visible'); // Close mobile sidebar

            const targetViewElement = view === 'editor' ? editorContainer : mainViews[view];
            if (targetViewElement) {
                targetViewElement.style.display = 'block';
            }

            const targetNavButton = navButtons[view === 'editor' ? 'posts' : view]; // Editor is part of posts nav
            if (targetNavButton) {
                targetNavButton.classList.add('active');
            }

            // Update URL hash without reloading
            let hash = view;
            if (view === 'editor' && extraParams?.postId) hash = `editor/${extraParams.postId}`;
            else if (view === 'editor') hash = `editor/new`;
            history.pushState(null, '', `#${hash}`);
            window.scrollTo(0,0); // Scroll to top on view change
        };

        // Handle browser hash changes
        const handleHashChange = () => {
             const hash = window.location.hash.substring(1); // Remove '#'
             if (hash.startsWith('editor')) {
                 const parts = hash.split('/'); // e.g., editor/new or editor/post_123
                 const postId = parts.length > 1 ? parts[1] : null;
                 openEditor(postId === 'new' ? null : postId);
             } else if (mainViews[hash]) {
                 showAdminView(hash);
             } else {
                 showAdminView('posts'); // Default to posts view
             }
        };

        // Initial setup and login logic
        const startAdminSession = async () => {
            const userToken = document.getElementById('token-input').value.trim();
            if (!userToken) {
                messageEl.textContent = 'GitHub Personal Access Token 不能为空。';
                return;
            }
            token = userToken;
            sessionStorage.setItem('github_token', token); // Store token in session storage

            setButtonsDisabled(true);
            messageEl.textContent = '正在验证并加载...';
            showLoader();

            try {
                const user = await GitHubAPI.getUser(token);
                owner = user.login;
                // For GitHub Pages, `owner.github.io` is the repo for user pages.
                // If it's a project page (e.g., username.github.io/my-project), repo is 'my-project'
                // We'll primarily assume user pages for simplicity or detect a repository.
                // For now, let's assume the user's main gh-pages repo for simplicity.
                // More robust would be to detect the current repo name from URL or allow setting in config.
                // Based on previous code: repo = `${owner}.github.io`;
                // Let's use ` window.location.hostname.split('.')[0]` as owner and repo as `${owner}.github.io` by default.
                // This logic is better placed in frontend `index.html`. For admin, assume repo = `owner.github.io` for user page.
                // If admin.html is deployed under a specific repo (e.g., yourname.github.io/my-blog/admin.html),
                // then the repo is `my-blog`, not `username.github.io`.
                let currentRepoName = window.location.hostname.split('.')[0];
                if (currentRepoName === owner.toLowerCase()) { // It's a user/organization page repo
                    repo = `${owner}.github.io`;
                } else { // It's likely a project page, e.g., mysite.com or username.github.io/my-repo
                     // We need to extract the repo name from the current URL if not a root domain setup
                    const pathParts = window.location.pathname.split('/').filter(p => p && p.toLowerCase() !== 'admin.html');
                    if (pathParts.length > 0) {
                        repo = pathParts[0]; // e.g., for /my-repo/admin.html, repo is 'my-repo'
                    } else {
                        repo = `${owner}.github.io`; // Fallback to user pages
                    }
                }


                // Determine base path for custom domains / subdirectories
                // If admin.html is at `root/admin.html`, basePath is empty string.
                // If admin.html is at `root/blog/admin.html`, basePath is 'blog'.
                const pathParts = window.location.pathname.split('/').filter(p => p && p.toLowerCase() !== 'admin.html');
                basePath = pathParts.join('/'); // Join into 'blog' or similar

                let configData = await GitHubAPI.getFile(token, owner, repo, getPath('config.json'));
                let postsData = await GitHubAPI.getFile(token, owner, repo, getPath('posts.json'));

                const initialConfig = {
                    site: { title: `${user.login}的博客`, description: "一个由 GitHub 驱动的半静态博客" },
                    styling: {
                        backgroundColor: "#f8f9fa", textColor: "#212529", headingColor: "#212529", accentColor: "#0d6efd",
                        linkHoverColor: "#0b5ed7", borderColor: "#e9ecef", cardBg: "#ffffff", cardShadow: "0 4px 12px rgba(0, 0, 0, 0.06)",
                        metaColor: "#6c757d", codeBg: "#2d2d2d", codeText: "#f8f8f2", footerBg: "#f1f3f5", darkModeEnabled: false, backgroundImageUrl: ""
                    },
                    giscus: { repo: "", repoId: "", category: "", categoryId: "" }
                };

                if (!configData) {
                    messageEl.textContent = '未检测到配置，正在为您激活系统并创建默认文件...';
                    const [configRes, postsRes, gitkeepRes] = await Promise.all([
                        GitHubAPI.createOrUpdateFile(token, owner, repo, getPath('config.json'), JSON.stringify(initialConfig, null, 2), 'feat: initialize blog config'),
                        GitHubAPI.createOrUpdateFile(token, owner, repo, getPath('posts.json'), '[]', 'feat: initialize blog posts'),
                        GitHubAPI.createOrUpdateFile(token, owner, repo, getPath('images/.gitkeep'), '', 'feat: initialize images directory')
                    ]);
                    config = initialConfig;
                    configSha = configRes.content.sha;
                    posts = [];
                    postsSha = postsRes.content.sha; // Ensure postsSha is set correctly from creation response
                    showToast('博客系统激活成功！已创建默认配置文件和文章数据。', 'success');
                } else {
                    config = JSON.parse(configData.content);
                    configSha = configData.sha;
                    posts = postsData && postsData.content ? JSON.parse(postsData.content) : [];
                    postsSha = postsData ? postsData.sha : null; // Keep SHA for updates
                }

                loginWrapper.style.display = 'none';
                adminWrapper.style.display = 'flex'; // Use flex for layout
                adminWrapper.classList.add('visible'); // Fade in admin panel
                
                await initTinyMCE(); // Initialize TinyMCE after content is visible
                renderPostList();
                populateSettings();

                // Check for initial hash and route
                if (window.location.hash) {
                    handleHashChange();
                } else {
                    showAdminView('posts');
                }

            } catch (error) {
                showToast(`操作失败: ${error.message}`, 'error');
                messageEl.textContent = `登录或加载失败: ${error.message}`;
                sessionStorage.removeItem('github_token'); // Clear invalid token
                token = null;
            } finally {
                hideLoader();
                setButtonsDisabled(false);
            }
        };

        // Initialize TinyMCE editor
        const initTinyMCE = async () => {
            if (tinymceEditor) {
                tinymceEditor.remove(); // Remove existing instance if any
            }
            tinymce._tinymceOverride = true; // Fix for multiple initializations warning sometimes
            tinymce.init({
                selector: '#post-content',
                plugins: 'advlist autolink lists link image charmap print preview hr anchor pagebreak nonbreaking table code fullscreen emoticons media insertdatetime searchreplace wordcount visualblocks visualchars codesample directionality help quickbars',
                toolbar: 'undo redo | formatselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image media codesample | forecolor backcolor | charmap emoticons | preview fullscreen | hr code | insertfile | quickbars',
                menubar: 'file edit view insert format tools table help',
                height: 500,
                convert_urls: false, // Important to prevent TinyMCE from converting URLs (e.g., to relative)
                images_upload_handler: (blobInfo, progress) => new Promise((resolve, reject) => {
                    const file = blobInfo.blob();
                    if (file.type.indexOf('image') === -1) {
                        reject('文件类型错误，只能上传图片。');
                        return;
                    }

                    showToast('图片上传中...', 'info');
                    uploadFile(file, true).then(url => {
                        showToast('图片上传成功！', 'success');
                        resolve(url);
                    }).catch(err => {
                        showToast(`图片上传失败: ${err.message}`, 'error');
                        reject('图片上传失败: ' + err.message);
                    });
                }),
                setup: (editor) => {
                    editor.on('SkinLoaded', () => { setTimeout(() => showToast('富文本编辑器已就绪。', 'info', 2000), 500); });
                    // Custom 'Read More' break button
                    editor.ui.registry.addButton('insertfile', {
                        text: '插入摘要分隔符',
                        icon: 'horizontal-rule',
                        tooltip: '插入摘要分隔符（<!--more-->）',
                        onAction: () => {
                            editor.insertContent('<!--more-->');
                        }
                    });
                     // Overwrite the default image toolbar for better controls
                    editor.ui.registry.getAll().icons.image = `<svg width="24" height="24"><path d="M5 15h14v-2H5v2zm0 4h14v-2H5v2zm0-8h14V5H5v6z"></path></svg>`; // Example custom icon, use TinyMCE's built-in image icon for real usage
                }
            }).then(editors => {
                tinymceEditor = editors[0]; // Store the TinyMCE editor instance
            }).catch(err => {
                showToast(`TinyMCE 初始化失败: ${err.message}`, 'error');
                console.error("TinyMCE 初始化失败", err);
            });
        };


        // Render posts list in admin table
        const renderPostList = () => {
            postListBody.innerHTML = '';
            if (posts.length === 0) {
                postListBody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--meta-color);">暂无文章。点击“撰写新文章”开始创作吧！</td></tr>`;
                return;
            }
            [...posts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(post => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${post.title}</td>
                    <td>${new Date(post.createdAt).toLocaleDateString()}</td>
                    <td>${post.updatedAt ? new Date(post.updatedAt).toLocaleDateString() : 'N/A'}</td>
                    <td class="actions">
                        <a href="#editor/${post.id}" class="edit" data-id="${post.id}">编辑</a>
                        <a href="#" class="delete" data-id="${post.id}">删除</a>
                    </td>
                `;
                postListBody.appendChild(tr);
            });
        };

        // Open editor for new or existing post
        const openEditor = (postId = null) => {
            showAdminView('editor', { postId });
            mainViews.posts.style.display = 'none'; // Explicitly hide posts view
            editorContainer.style.display = 'block'; // Explicitly show editor container

            const post = posts.find(p => p.id === postId);
            document.getElementById('editor-title').textContent = post ? '编辑文章' : '撰写新文章';
            document.getElementById('save-post-btn').textContent = post ? '更新文章' : '发布文章';
            document.getElementById('post-id').value = post?.id || '';
            document.getElementById('post-title').value = post?.title || '';
            document.getElementById('post-tags').value = post?.tags?.join(', ') || '';
            document.getElementById('delete-post-btn').style.display = post ? 'inline-block' : 'none';

            if (tinymceEditor) {
                tinymceEditor.setContent(post?.content || ''); // Set TinyMCE content
                // tinymceEditor.setDirty(false); // Reset dirty state
            } else {
                 document.getElementById('post-content').value = post?.content || '';
            }
        };

        // Save (create or update) a post
        const savePost = async () => {
            const id = document.getElementById('post-id').value;
            const title = document.getElementById('post-title').value.trim();
            const content = tinymceEditor ? tinymceEditor.getContent().trim() : document.getElementById('post-content').value.trim();

            if (!title || !content) {
                showToast('标题和内容不能为空！', 'error');
                return;
            }

            setButtonsDisabled(true);
            showLoader();
            const tags = document.getElementById('post-tags').value.split(',').map(t => t.trim()).filter(Boolean);
            const now = new Date().toISOString();
            let commitMessage = '';

            try {
                if (id) {
                    // Update existing post
                    const postIndex = posts.findIndex(p => p.id === id);
                    if (postIndex === -1) throw new Error('文章未找到，无法更新。');
                    Object.assign(posts[postIndex], { title, content, tags, updatedAt: now });
                    commitMessage = `docs: update post "${title}"`;
                } else {
                    // Create new post
                    const newPost = { id: `post_${now.replace(/[-:.]/g, '')}`, title, content, tags, createdAt: now, updatedAt: now };
                    posts.push(newPost);
                    commitMessage = `feat: create new post "${title}"`;
                }

                const res = await GitHubAPI.createOrUpdateFile(token, owner, repo, getPath('posts.json'), JSON.stringify(posts, null, 2), commitMessage, postsSha);
                postsSha = res.content.sha; // Update SHA for next operation
                showToast('文章保存成功！', 'success');
                renderPostList();
                showAdminView('posts'); // Return to posts list
            } catch (error) {
                showToast(`保存失败: ${error.message}`, 'error');
                console.error("保存文章失败:", error);
            } finally {
                hideLoader();
                setButtonsDisabled(false);
            }
        };

        // Delete a post
        const deletePost = async (postId) => {
            if (!postId) { showToast('无法删除空ID的文章。', 'error'); return; }
            if (!confirm('确定要删除这篇文章吗？此操作不可逆！')) return;

            setButtonsDisabled(true);
            showLoader();

            try {
                const postToDelete = posts.find(p => p.id === postId);
                if (!postToDelete) throw new Error('文章未找到，无法删除。');

                posts = posts.filter(p => p.id !== postId);
                const commitMessage = `docs: delete post "${postToDelete.title}"`;
                const res = await GitHubAPI.createOrUpdateFile(token, owner, repo, getPath('posts.json'), JSON.stringify(posts, null, 2), commitMessage, postsSha);
                postsSha = res.content.sha; // Update SHA
                showToast('文章删除成功！', 'success');
                renderPostList();
                showAdminView('posts');
            } catch (error) {
                showToast(`删除失败: ${error.message}`, 'error');
                console.error("删除文章失败:", error);
            } finally {
                hideLoader();
                setButtonsDisabled(false);
            }
        };

        // Populate settings form
        const populateSettings = () => {
            document.getElementById('setting-title').value = config.site.title || '';
            document.getElementById('setting-description').value = config.site.description || '';
            document.getElementById('setting-bg-color').value = config.styling.backgroundColor || '#f8f9fa';
            document.getElementById('setting-text-color').value = config.styling.textColor || '#212529';
            document.getElementById('setting-heading-color').value = config.styling.headingColor || '#212529';
            document.getElementById('setting-accent-color').value = config.styling.accentColor || '#0d6efd';
            document.getElementById('setting-link-hover-color').value = config.styling.linkHoverColor || '#0b5ed7';
            document.getElementById('setting-border-color').value = config.styling.borderColor || '#e9ecef';
            document.getElementById('setting-card-bg').value = config.styling.cardBg || '#ffffff';
            document.getElementById('setting-meta-color').value = config.styling.metaColor || '#6c757d';
            document.getElementById('setting-code-bg').value = config.styling.codeBg || '#2d2d2d';
            document.getElementById('setting-code-text').value = config.styling.codeText || '#f8f8f2';
            document.getElementById('setting-footer-bg').value = config.styling.footerBg || '#f1f3f5';
            document.getElementById('setting-dark-mode-enabled').checked = config.styling.darkModeEnabled || false;

            const bgImageUrl = config.styling.backgroundImageUrl || '';
            document.getElementById('setting-bg-image-url').value = bgImageUrl;
            const bgImagePreview = document.getElementById('setting-bg-image-preview');
            if (bgImageUrl) {
                bgImagePreview.src = bgImageUrl;
                bgImagePreview.style.display = 'block';
            } else {
                bgImagePreview.src = '#';
                bgImagePreview.style.display = 'none';
            }
            // Update Giscus settings
            document.getElementById('giscus-repo').value = config.giscus.repo || '';
            document.getElementById('giscus-repo-id').value = config.giscus.repoId || '';
            document.getElementById('giscus-category').value = config.giscus.category || '';
            document.getElementById('giscus-category-id').value = config.giscus.categoryId || '';
        };

        // Save website settings
        const saveSettings = async () => {
            setButtonsDisabled(true);
            showLoader();

            const newConfig = JSON.parse(JSON.stringify(config)); // Deep copy current config

            newConfig.site = {
                title: document.getElementById('setting-title').value.trim(),
                description: document.getElementById('setting-description').value.trim()
            };
            newConfig.styling = {
                backgroundColor: document.getElementById('setting-bg-color').value,
                textColor: document.getElementById('setting-text-color').value,
                headingColor: document.getElementById('setting-heading-color').value,
                accentColor: document.getElementById('setting-accent-color').value,
                linkHoverColor: document.getElementById('setting-link-hover-color').value,
                borderColor: document.getElementById('setting-border-color').value,
                cardBg: document.getElementById('setting-card-bg').value,
                metaColor: document.getElementById('setting-meta-color').value,
                codeBg: document.getElementById('setting-code-bg').value,
                codeText: document.getElementById('setting-code-text').value,
                footerBg: document.getElementById('setting-footer-bg').value,
                darkModeEnabled: document.getElementById('setting-dark-mode-enabled').checked,
                backgroundImageUrl: document.getElementById('setting-bg-image-url').value,
            };
            // Giscus settings
            newConfig.giscus = {
                repo: document.getElementById('giscus-repo').value.trim(),
                repoId: document.getElementById('giscus-repo-id').value.trim(),
                category: document.getElementById('giscus-category').value.trim(),
                categoryId: document.getElementById('giscus-category-id').value.trim(),
            };

            try {
                const res = await GitHubAPI.createOrUpdateFile(token, owner, repo, getPath('config.json'), JSON.stringify(newConfig, null, 2), 'docs: update blog config', configSha);
                configSha = res.content.sha;
                config = newConfig; // Update local config state
                showToast('网站设置已保存！', 'success');
            } catch (error) {
                showToast(`设置保存失败: ${error.message}`, 'error');
                console.error("保存设置失败:", error);
            } finally {
                hideLoader();
                setButtonsDisabled(false);
            }
        };

        // Upload a file (image) to GitHub
        const uploadFile = async (file, forTinyMCE = false, isBgImage = false) => {
            if (!file) {
                showToast('请选择一个文件。', 'error');
                return null;
            }

            showLoader();
            setButtonsDisabled(true);

            const reader = new FileReader();
            reader.readAsDataURL(file); // Encode as base64 for GitHub API
            return new Promise((resolve, reject) => {
                reader.onload = async (e) => {
                    const content = e.target.result.split(',')[1]; // Get base64 content
                    const filePath = getPath(`images/${new Date().toISOString().replace(/[-:.]/g, '')}_${file.name}`);
                    try {
                        const result = await GitHubAPI.createOrUpdateFile(token, owner, repo, filePath, content, `feat: upload image ${file.name}`, null, true);
                        const url = result.content.download_url; // Use download_url for direct access
                        // For gh-proxy for faster loading in China
                        const proxiedUrl = `https://gh-proxy.com/${url}`

                        if (isBgImage) {
                            document.getElementById('setting-bg-image-url').value = proxiedUrl;
                            document.getElementById('setting-bg-image-preview').src = proxiedUrl;
                            document.getElementById('setting-bg-image-preview').style.display = 'block';
                            showToast('背景图上传成功！', 'success');
                        } else if (!forTinyMCE) { // For manual image upload button in post editor directly
                            const htmlToInsert = `<img src="${proxiedUrl}" alt="${file.name}">`;
                            const contentTextarea = document.getElementById('post-content');
                            contentTextarea.value += `\n${htmlToInsert}\n`; // Append to textarea
                            showToast('图片上传成功！已插入到文章。', 'success');
                        }
                        resolve(proxiedUrl);
                    } catch (error) {
                        showToast(`图片上传失败: ${error.message}`, 'error');
                        console.error("图片上传失败:", error);
                        reject(error);
                    } finally {
                        hideLoader();
                        setButtonsDisabled(false);
                    }
                };
                reader.onerror = (error) => {
                    showToast('文件读取失败。', 'error');
                    hideLoader();
                    setButtonsDisabled(false);
                    reject(error);
                };
            });
        };

        const clearBackgroundImage = () => {
            document.getElementById('setting-bg-image-url').value = '';
            document.getElementById('setting-bg-image-preview').src = '';
            document.getElementById('setting-bg-image-preview').style.display = 'none';
            showToast('背景图已清除。请保存设置以生效。', 'info');
        };

        const resetSettingsForm = () => {
            if (confirm('确定要重置表单内容吗？未保存的更改将丢失。')) {
                populateSettings(); // Reload initial config values
                showToast('设置表单已重置。', 'info');
            }
        };

        const logout = () => {
            if (confirm('确定要退出登录吗？您将需要重新输入Token。')) {
                sessionStorage.removeItem('github_token');
                window.location.reload(); // Reload page to return to login screen
            }
             showToast('已退出登录。', 'info');
        };

        // Event Listeners
        document.getElementById('start-btn').onclick = startAdminSession;
        document.getElementById('token-input').addEventListener('keypress', (e) => {
             if (e.key === 'Enter') startAdminSession();
        });

        navButtons.posts.onclick = () => showAdminView('posts');
        navButtons.settings.onclick = () => showAdminView('settings');
        document.getElementById('nav-logout').onclick = logout;
        document.getElementById('new-post-btn').onclick = () => openEditor();
        document.getElementById('cancel-edit-btn').onclick = () => showAdminView('posts');
        document.getElementById('save-post-btn').onclick = savePost;

        postListBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit')) {
                e.preventDefault();
                openEditor(e.target.dataset.id);
            }
            if (e.target.classList.contains('delete')) {
                e.preventDefault();
                deletePost(e.target.dataset.id);
            }
        });

        document.getElementById('delete-post-btn').onclick = () => deletePost(document.getElementById('post-id').value);
        document.getElementById('save-settings-btn').onclick = saveSettings;
        document.getElementById('reset-settings-btn').onclick = resetSettingsForm;
        
        // Manual image upload (for editor) - if TinyMCE's handler is not used or fails
        // document.getElementById('image-upload').onchange = (e) => uploadFile(e.target.files[0], false, false);

        // Background image upload logic
        document.getElementById('setting-bg-image').onchange = (e) => {
           const file = e.target.files[0];
           if (file) {
               // Show temp preview and "Upload" button
               const reader = new FileReader();
               reader.onload = (event) => {
                   document.getElementById('setting-bg-image-preview').src = event.target.result;
                   document.getElementById('setting-bg-image-preview').style.display = 'block';
                   uploadBgImageBtn.style.display = 'inline-block';
               };
               reader.readAsDataURL(file);
           } else {
               document.getElementById('setting-bg-image-preview').src = '#';
               document.getElementById('setting-bg-image-preview').style.display = 'none';
               uploadBgImageBtn.style.display = 'none';
           }
        };
        uploadBgImageBtn.onclick = () => {
             const fileInput = document.getElementById('setting-bg-image');
             if (fileInput.files.length > 0) {
                 showToast('背景图上传中...', 'info');
                 uploadFile(fileInput.files[0], false, true); // forTinyMCE = false, isBgImage = true
             } else {
                 showToast('请选择背景图片。', 'error');
             }
        };

        document.getElementById('clear-bg-image-btn').onclick = clearBackgroundImage;

        document.getElementById('mobile-menu-btn').onclick = () => adminWrapper.classList.toggle('sidebar-visible');
        document.getElementById('mobile-overlay').onclick = () => adminWrapper.classList.remove('sidebar-visible');


        // Load token from session storage on page load
        document.addEventListener('DOMContentLoaded', () => {
            const storedToken = sessionStorage.getItem('github_token');
            if (storedToken) {
                document.getElementById('token-input').value = storedToken;
                startAdminSession();
            }

            // Restore view based on hash on initial load
            window.addEventListener('hashchange', handleHashChange);
            if (!storedToken && window.location.hash) {
                // If there's a hash but no token, suggest re-logging
                 showToast('请重新登录以继续。', 'info', 5000);
            }
        });
    </script>
</body>
</html>
