<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博客管理后台 - 期望AI</title>
    <!-- Favicon -->
    <link rel="icon" href="/admin_favicon.ico" type="image/x-icon">
    <!-- Google Fonts - Opt for system fonts if privacy is a concern -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- EasyMDE CSS - Markdown Editor Styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.css">
    <!-- Font Awesome for Icons (optional, but good for UI) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Base Variables */
        :root {
            --font-main: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            --bg-color: #f4f6f9;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --sidebar-hover-bg: #34495e;
            --sidebar-active-bg: #1abc9c;
            --content-bg: #ffffff;
            --text-color: #34495e;
            --heading-color: #2c3e50;
            --accent-color: #3498db; /* Blue */
            --accent-hover-color: #2980b9;
            --danger-color: #e74c3c; /* Red */
            --danger-hover-color: #c0392b;
            --success-color: #2ecc71; /* Green */
            --success-hover-color: #27ae60;
            --border-color: #e0e0e0;
            --input-border: #dcdcdc;
            --input-focus-border: var(--accent-color);
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Soft shadow */
            --transition-duration: 0.2s ease;
        }

        /* General Styling */
        body {
            font-family: var(--font-main);
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 15px;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        a {
            text-decoration: none;
            color: var(--accent-color);
            transition: color var(--transition-duration);
        }

        a:hover {
            color: var(--accent-hover-color);
        }

        input, textarea, button, select {
            font-family: inherit;
            border-radius: 4px;
            padding: 10px 12px;
            border: 1px solid var(--input-border);
            box-sizing: border-box;
            color: var(--text-color);
            background-color: var(--content-bg);
            transition: border-color var(--transition-duration), background-color var(--transition-duration), color var(--transition-duration);
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--input-focus-border);
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb, 52, 152, 219), 0.2);
        }
        
        h1, h2, h3 {
            color: var(--heading-color);
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert {
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .alert.show {
            opacity: 1;
            transform: translateY(0);
        }
        .alert.alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert.alert-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert.alert-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }


        /* Login Wrapper */
        #login-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: var(--bg-color);
        }

        .login-box {
            width: 90%;
            max-width: 400px;
            padding: 40px;
            background: var(--content-bg);
            box-shadow: var(--card-shadow);
            border-radius: 8px;
            text-align: center;
        }

        .login-box h1 {
            margin-bottom: 25px;
            font-size: 2rem;
            color: var(--heading-color);
        }

        .login-box p {
            margin-bottom: 25px;
            color: var(--secondary-text-color, #7f8c8d);
        }

        .login-box input {
            width: 100%;
            margin-bottom: 20px;
        }

        .login-box button {
            width: 100%;
            background: var(--accent-color);
            color: #fff;
            border: 0;
            cursor: pointer;
            transition: background var(--transition-duration);
        }

        .login-box button:hover {
            background: var(--accent-hover-color);
        }

        #initial-message {
            color: var(--danger-color);
            margin-top: 15px;
            font-weight: 500;
        }


        /* Admin Wrapper */
        #admin-wrapper {
            display: flex;
            min-height: 100vh;
            background-color: var(--bg-color);
            transition: margin-left 0.3s ease-in-out;
        }

        /* Admin Sidebar */
        #admin-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 260px; /* Wider sidebar */
            background: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            transform: translateX(-100%); /* Hidden by default on mobile */
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
            box-shadow: 2px 0 6px rgba(0,0,0,0.2);
        }

        #admin-wrapper.sidebar-visible #admin-sidebar {
            transform: translateX(0);
        }

        #admin-sidebar .logo {
            padding: 25px 20px;
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            background-color: rgba(0,0,0,.1);
            color: #fff;
            box-shadow: 0 1px 0 rgba(255,255,255,.05);
        }

        #admin-sidebar .nav {
            flex-grow: 1;
            list-style: none;
            margin: 0;
            padding: 20px 0;
        }

        #admin-sidebar .nav li {
            margin-bottom: 5px;
        }

        #admin-sidebar .nav a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 25px;
            color: var(--sidebar-text);
            transition: background var(--transition-duration);
            font-size: 1rem;
        }

        #admin-sidebar .nav a i {
            font-size: 1.1rem;
        }

        #admin-sidebar .nav a:hover {
            background: var(--sidebar-hover-bg);
        }

        #admin-sidebar .nav a.active,
        #admin-sidebar .nav a.active:hover {
            background: var(--sidebar-active-bg);
            color: #fff;
            font-weight: 500;
        }
        
        /* Mobile Header & Overlay */
        #mobile-header {
            display: flex; /* Show by default on mobile */
            justify-content: space-between;
            align-items: center;
            background: var(--content-bg);
            padding: 15px 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 999;
        }

        .mobile-menu-btn {
            font-size: 1.8rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            padding: 0;
        }

        .mobile-logo {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--heading-color);
        }

        #mobile-overlay {
            position: fixed;
            top: 0;
    
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.5);
            z-index: 999;
            display: none; /* Hidden by default */
        }

        #admin-wrapper.sidebar-visible #mobile-overlay {
            display: block;
        }

        /* Admin Content */
        #admin-content {
            flex-grow: 1;
            padding: 20px;
            transition: margin-left 0.3s ease-in-out;
        }
        
        #admin-wrapper.sidebar-visible #admin-content {
             /* Adjust margin to give space to sidebar when it's open */
        }


        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }
        .page-header h2 {
            margin: 0;
        }

        /* Tables */
        .admin-table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }

        .admin-table {
            width: 100%;
            border-collapse: separate; /* For rounded corners */
            border-spacing: 0;
            background: var(--content-bg);
            min-width: 700px; /* Ensure table doesn't get too small */
        }

        .admin-table th, .admin-table td {
            padding: 18px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            transition: background var(--transition-duration);
        }

        .admin-table th {
            background: var(--bg-color);
            color: var(--heading-color);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        
        .admin-table tbody tr:hover {
            background-color: var(--bg-color);
        }

        .admin-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .admin-table thead tr:first-child th:first-child { border-top-left-radius: 8px; }
        .admin-table thead tr:first-child th:last-child { border-top-right-radius: 8px; }
        .admin-table tbody tr:last-child td:first-child { border-bottom-left-radius: 8px; }
        .admin-table tbody tr:last-child td:last-child { border-bottom-right-radius: 8px; }


        .admin-table .actions {
            display: flex;
            gap: 15px;
        }

        .admin-table .actions a {
            font-weight: 500;
            font-size: 0.95rem;
        }

        .admin-table .actions .delete {
            color: var(--danger-color);
        }

        /* Buttons */
        button, a.btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: var(--accent-color);
            color: #fff;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background var(--transition-duration), transform 0.1s ease-out, box-shadow var( --transition-duration);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        button:hover, a.btn:hover {
            background: var(--accent-hover-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        button:disabled, a.btn.disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success { background: var(--success-color); }
        .btn-success:hover { background: var(--success-hover-color); }
        .btn-danger { background: var(--danger-color); }
        .btn-danger:hover { background: var(--danger-hover-color); }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }

        /* Forms */
        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--heading-color);
            font-size: 0.95rem;
        }

        .form-group input:not([type="checkbox"]):not([type="radio"]), 
        .form-group textarea, 
        .form-group select {
            width: 100%;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 150px;
        }

        .editor-container {
            display: none;
            background: var(--content-bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }
        
        .editor-container .page-header {
            margin-bottom: 30px; /* More space for editor header */
        }
        
        /* EasyMDE adjustments */
        .editor-toolbar {
            border-radius: 8px 8px 0 0 !important;
            background-color: var(--bg-color) !important;
            border-color: var(--border-color) !important;
        }
        .editor-preview, .editor-markdown {
             background-color: var(--content-bg) !important;
             border-color: var(--border-color) !important;
             color: var(--text-color) !important;
        }
        .CodeMirror {
            border: 1px solid var(--border-color) !important;
             border-radius: 0 0 8px 8px;
        }
        .CodeMirror-vscrollbar, .CodeMirror-hscrollbar {
            /* Better scrollbar visibility */
            background-color: rgba(var(--text-color-rgb, 52, 73, 94), 0.1) !important;
        }
        .CodeMirror-vscrollbar::-webkit-scrollbar-thumb, .CodeMirror-hscrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(var(--text-color-rgb, 52, 73, 94), 0.3) !important;
        }


        /* Settings View */
        #settings-view {
            display: none;
            background: var(--content-bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }
        
        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .color-picker-group input[type="color"] {
            width: 50px;
            height: 40px;
            padding: 0;
            border: none;
            background: none;
            cursor: pointer;
        }
        .color-picker-group input[type="text"] {
            flex-grow: 1;
        }

        .comment-system-config {
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
            background-color: var(--bg-color);
        }
        .comment-system-config h3 {
            margin-top: 0;
        }
        .comment-system-config > div {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed var(--border-color);
        }
        .comment-system-config > div:first-of-type {
            border-top: none;
            padding-top: 0;
            margin-top: 0;
        }
        .github-oauth-info p {
            font-size: 0.9rem;
            color: var(--secondary-text-color, #7f8c8d);
            margin-top: 10px;
        }
        .github-oauth-info a {
            font-weight: 500;
        }


        /* User Submissions View (Future expansion) */
        #submissions-view {
            display: none; /* Hidden by default */
        }
        
        #submissions-view .alert {
            margin-top: 20px;
        }


        /* Media Queries for Responsiveness */
        @media (min-width: 768px) {
            #admin-sidebar {
                position: static;
                transform: translateX(0);
                flex-shrink: 0; /* Prevents sidebar from shrinking */
            }
            #admin-content {
                margin-left: 0; /* No margin when sidebar static */
                padding: 30px;
            }
            #mobile-header {
                display: none;
            }
            #admin-wrapper.sidebar-visible #admin-content {
                margin-left: 0; /* Remove mobile-specific margin */
            }
        }

        @media (max-width: 767px) {
            #admin-wrapper.sidebar-visible #admin-content {
                margin-left: 260px; /* Push content to the right when sidebar is open */
            }
        }
    </style>
</head>
<body>

    <div id="login-wrapper">
        <div id="login-box" class="login-box">
            <h1><i class="fas fa-lock" style="margin-right: 10px;"></i>博客管理登录</h1>
            <p>请输入您的GitHub Personal Access Token。</p>
            <div class="alert alert-info show" style="font-size: 0.9em;">
                **提示:** Token需要`repo`权限才能正常管理您的博客。建议创建一个专门的Token。<br>
                <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" target="_blank" style="color: var(--accent-color);">如何创建Personal Access Token?</a>
            </div>
            <input type="password" id="token-input" placeholder="输入具备 repo 权限的Token" autocomplete="current-password">
            <button id="start-btn"><i class="fas fa-sign-in-alt"></i> 开始管理</button>
            <p id="initial-message"></p>
        </div>
    </div>

    <div id="admin-wrapper" class="admin-wrapper" style="display: none;">
        <div id="mobile-overlay"></div>
        <aside id="admin-sidebar">
            <div class="logo">My Blog Admin</div>
            <ul class="nav">
                <li><a href="#" id="nav-posts" class="active"><i class="fas fa-newspaper"></i> 文章管理</a></li>
                <li><a href="#" id="nav-settings"><i class="fas fa-cogs"></i> 网站设置</a></li>
                <!-- Future user submission management -->
                <li><a href="#" id="nav-submissions"><i class="fas fa-inbox"></i> 用户投稿 (待开发)</a></li> 
                <li><a id="view-site-link" href="index.html" target="_blank"><i class="fas fa-external-link-alt"></i> 查看站点</a></li>
                <li><a href="#" id="logout-btn" class="btn-danger" style="margin-top: auto; margin-bottom: 20px;"><i class="fas fa-sign-out-alt"></i> 登出</a></li>
            </ul>
        </aside>

        <main id="admin-content">
            <header id="mobile-header">
                <button id="mobile-menu-btn" class="mobile-menu-btn"><i class="fas fa-bars"></i></button>
                <div class="mobile-logo">管理后台</div>
            </header>

            <div id="global-alert-container"></div>
            
            <div id="posts-view" class="content-view">
                <div class="page-header">
                    <h2>文章管理</h2>
                    <button id="new-post-btn"><i class="fas fa-plus"></i> 撰写新文章</button>
                </div>
                <div class="admin-table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>标题</th>
                                <th>分类</th>
                                <th>标签</th>
                                <th>发布日期</th>
                                <th class="actions">操作</th>
                            </tr>
                        </thead>
                        <tbody id="post-list">
                            <tr><td colspan="5" style="text-align: center;">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="editor-container" class="content-view">
                <div class="page-header">
                    <h2 id="editor-title">撰写新文章</h2>
                </div>
                <input type="hidden" id="post-id">
                <div class="form-group">
                    <label for="post-title">文章标题</label>
                    <input type="text" id="post-title" placeholder="请输入文章标题">
                </div>
                <div class="form-group">
                    <label for="post-category">文章分类</label>
                    <input type="text" id="post-category" placeholder="请输入文章分类 (例如: 技术, 生活, 随笔)">
                </div>
                <div class="form-group">
                    <label for="post-tags">标签 (用英文逗号分隔，例如: JavaScript, GitHub, Vue)</label>
                    <input type="text" id="post-tags" placeholder="请输入标签">
                    <small style="color: var(--secondary-text-color);">有助于文章分类和搜索</small>
                </div>
                <div class="form-group">
                    <label for="post-content">文章内容 (支持 Markdown，使用 `<!--more-->` 设置摘要分界线)</label>
                    <textarea id="post-content"></textarea> <!-- EasyMDE will attach here -->
                    <small style="color: var(--secondary-text-color);">直接编写 Markdown，`<!--more-->` 上方内容将作为摘要显示。</small>
                </div>
                <!-- Image upload is now part of EasyMDE toolbar -->
                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button id="save-post-btn" class="btn-success"><i class="fas fa-save"></i> 发布/更新文章</button>
                    <button id="cancel-edit-btn" class="btn-secondary"><i class="fas fa-times"></i> 取消</button>
                    <button id="delete-post-btn" class="btn-danger" style="display:none;"><i class="fas fa-trash-alt"></i> 删除文章</button>
                </div>
            </div>

            <div id="settings-view" class="content-view" style="display: none;">
                <div class="page-header">
                    <h2>网站设置</h2>
                </div>
                <div class="form-group">
                    <label for="setting-title"><i class="fas fa-heading"></i> 网站标题</label>
                    <input type="text" id="setting-title" placeholder="例如: 我的个人博客">
                </div>
                <div class="form-group">
                    <label for="setting-description"><i class="fas fa-info-circle"></i> 网站描述</label>
                    <input type="text" id="setting-description" placeholder="例如: 分享我的技术心得与生活感悟">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-palette"></i> <b>样式主题定制</b></label>
                    <div class="form-group">
                        <label for="setting-default-theme">默认主题</label>
                        <select id="setting-default-theme">
                            <option value="light">明亮模式</option>
                            <option value="dark">暗黑模式</option>
                        </select>
                        <small style="color: var(--secondary-text-color);">用户端将优先使用浏览器系统主题设置，其次是此默认值。</small>
                    </div>
                    <div class="form-group color-picker-group">
                        <label for="setting-bg-color">背景颜色</label>
                        <input type="color" id="setting-bg-color-picker">
                        <input type="text" id="setting-bg-color" placeholder="例如: #f8f9fa 或 leave empty for default">
                        <small style="color: var(--secondary-text-color);">留空则使用默认主题颜色。</small>
                    </div>
                    <div class="form-group color-picker-group">
                        <label for="setting-text-color">文字颜色</label>
                        <input type="color" id="setting-text-color-picker">
                        <input type="text" id="setting-text-color" placeholder="例如: #212529 或 leave empty for default">
                        <small style="color: var(--secondary-text-color);">留空则使用默认主题颜色。</small>
                    </div>
                    <div class="form-group color-picker-group">
                        <label for="setting-accent-color">链接/强调色</label>
                        <input type="color" id="setting-accent-color-picker">
                        <input type="text" id="setting-accent-color" placeholder="例如: #0d6efd 或 leave empty for default">
                        <small style="color: var(--secondary-text-color);">留空则使用默认主题颜色。</small>
                    </div>
                    <div class="form-group">
                        <label for="setting-bg-image"><i class="fas fa-image"></i> 网站背景图 (URL)</label>
                        <input type="file" id="setting-bg-image-upload" accept="image/*" style="margin-bottom: 5px;">
                        <input type="text" id="setting-bg-image-url" placeholder="背景图URL将显示在这里 (自动上传)" readonly>
                        <button id="clear-bg-image-btn" class="btn-secondary" style="margin-top: 10px;"><i class="fas fa-eraser"></i> 清除背景图</button>
                        <small style="color: var(--secondary-text-color);">上传图片后，URL将自动填充。</small>
                    </div>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-comments"></i> <b>评论系统设置</b></label>
                     <div class="comment-system-config">
                        <div class="form-group">
                            <label for="comments-type">选择评论系统</label>
                            <select id="comments-type">
                                <option value="">禁用评论</option>
                                <option value="utterances">Utterances (推荐，基于GitHub Issue)</option>
                                <option value="gitalk">Gitalk (基于GitHub Issue，需OAuth App)</option>
                            </select>
                        </div>

                        <div id="utterances-config" style="display: none;">
                            <h3>Utterances 配置</h3>
                            <p class="github-oauth-info">
                                Utterances 是一个轻量级评论系统，使用 GitHub Issue 作为评论存储，无需注册 OAuth App。<br>
                                只需提供你的仓库地址。
                            </p>
                            <div class="form-group">
                                <label for="utterances-repo">GitHub 仓库 (例如: `your-username/your-repo-name`)</label>
                                <input type="text" id="utterances-repo" placeholder="用于存储评论的GitHub仓库">
                            </div>
                            <div class="form-group">
                                <label for="utterances-issue-term">Issue Term (Issue 匹配方式，建议使用 `pathname`)</label>
                                <select id="utterances-issue-term">
                                    <option value="pathname">页面路径 (pathname)</option>
                                    <option value="url">页面URL (URL)</option>
                                    <option value="title">页面标题 (title)</option>
                                    <option value="og:title">Meta "og:title"</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="utterances-label">Issue 标签 (可选，例如: `comment`)</label>
                                <input type="text" id="utterances-label" placeholder="评论Issue的标签">
                            </div>
                        </div>

                        <div id="gitalk-config" style="display: none;">
                            <h3>Gitalk 配置</h3>
                            <p class="github-oauth-info">
                                Gitalk 评论系统功能更丰富，但需要注册 GitHub OAuth Application。
                                <a href="https://github.com/settings/applications/new" target="_blank" style="color: var(--accent-color);">前往注册 OAuth App</a>
                                Callback URL 填写您的博客地址 (例如: `https://your-username.github.io/`)。
                            </p>
                            <div class="form-group">
                                <label for="gitalk-client-id">Client ID</label>
                                <input type="text" id="gitalk-client-id" placeholder="GitHub OAuth App Client ID">
                            </div>
                            <div class="form-group">
                                <label for="gitalk-client-secret">Client Secret</label>
                                <input type="password" id="gitalk-client-secret" placeholder="GitHub OAuth App Client Secret">
                            </div>
                            <div class="form-group">
                                <label for="gitalk-repo">GitHub 仓库 (例如: `your-username/your-repo-name`)</label>
                                <input type="text" id="gitalk-repo" placeholder="用于存储评论的GitHub仓库">
                            </div>
                            <div class="form-group">
                                <label for="gitalk-owner">仓库所有者 (通常是你的GitHub用户名)</label>
                                <input type="text" id="gitalk-owner" placeholder="例如: your-username">
                            </div>
                            <div class="form-group">
                                <label for="gitalk-admin">管理员 GitHub 用户名 (数组，用逗号分隔，例如: `["username1", "username2"]`)</label>
                                <input type="text" id="gitalk-admin" placeholder="例如: your-username">
                                <small style="color: var(--secondary-text-color);">只有这些用户可以初始化和管理评论。</small>
                            </div>
                            <div class="form-group">
                                <label for="gitalk-label">Issue 标签 (可选，例如: `Gitalk`)</label>
                                <input type="text" id="gitalk-label" placeholder="评论Issue的标签">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-stream"></i> <b>文章列表分页</b></label>
                    <div class="form-group">
                        <label for="pagination-posts-per-page">每页显示文章数量</label>
                        <input type="number" id="pagination-posts-per-page" min="1" value="6" placeholder="例如: 6">
                        <small style="color: var(--secondary-text-color);">博客首页每页显示的文章数量。</small>
                    </div>
                </div>

                <button id="save-settings-btn" class="btn-success"><i class="fas fa-save"></i> 保存设置</button>
            </div>

            <!-- User Submissions View (Placeholder for future development) -->
            <div id="submissions-view" class="content-view" style="display: none;">
                <div class="page-header">
                    <h2>用户投稿管理</h2>
                </div>
                <div id="submissions-list-container">
                    <div class="alert alert-info show">
                        此功能**待开发**。<br>
                        未来将需要一个独立的后端服务来收集用户投稿。管理员将在此处审核并决定是否发布到网站。
                    </div>
                    <p style="text-align: center; color: var(--secondary-text-color);">暂无用户投稿。</p>
                </div>
            </div>

        </main>
    </div>

    <!-- EasyMDE JavaScript - Markdown Editor -->
    <script src="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.js"></script>

    <script>
        // Utility functions for Base64 encoding/decoding
        const utf8_to_b64 = (str) => btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
        const b64_to_utf8 = (str) => {
            try { return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); } catch (e) { return atob(str); }
        };

        // GitHub API Wrapper
        const GitHubAPI = {
            BASE_URL: 'https://api.github.com',
            async request(token, endpoint, options = {}) {
                const url = `${this.BASE_URL}${endpoint}`;
                const headers = {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    ...options.headers
                };
                try {
                    const response = await fetch(url, { ...options, headers });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: `HTTP Error: ${response.statusText}` }));
                        throw new Error(errorData.message || `GitHub API请求失败: ${response.status} ${response.statusText}`);
                    }
                    if (response.status === 204 || response.headers.get("Content-Length") === "0") return null;
                    return response.json();
                } catch (originalError) {
                    console.error("GitHub API请求失败:", originalError);
                    if (originalError.message.includes("Bad credentials") || originalError.message.includes("Unauthorized")) {
                        throw new Error("GitHub Token无效或权限不足，请检查您的Token。");
                    }
                    throw originalError;
                }
            },
            getUser: (token) => GitHubAPI.request(token, '/user'),
            async getFile(token, owner, repo, path) {
                try {
                    const result = await this.request(token, `/repos/${owner}/${repo}/contents/${path}`);
                    if (!result || typeof result.content !== 'string') return null;
                    return { content: b64_to_utf8(result.content), sha: result.sha };
                } catch (error) {
                    if (error.message.toLowerCase().includes('not found') || error.message.toLowerCase().includes('no such file')) return null;
                    throw error;
                }
            },
            updateFile: (token, owner, repo, path, content, sha, message, isBinary = false) => {
                return GitHubAPI.request(token, `/repos/${owner}/${repo}/contents/${path}`, {
                    method: 'PUT',
                    body: JSON.stringify({ message, content: isBinary ? content : utf8_to_b64(content), sha })
                });
            },
            createFile: (token, owner, repo, path, content, message, isBinary = false) => {
                return GitHubAPI.request(token, `/repos/${owner}/${repo}/contents/${path}`, {
                    method: 'PUT',
                    body: JSON.stringify({ message, content: isBinary ? content : utf8_to_b64(content) })
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const loginWrapper = document.getElementById('login-wrapper');
            const adminWrapper = document.getElementById('admin-wrapper');
            const mobileOverlay = document.getElementById('mobile-overlay');
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const initialMessageEl = document.getElementById('initial-message');
            const globalAlertContainer = document.getElementById('global-alert-container');

            const views = {
                posts: document.getElementById('posts-view'),
                editor: document.getElementById('editor-container'),
                settings: document.getElementById('settings-view'),
                submissions: document.getElementById('submissions-view')
            };
            const navButtons = {
                posts: document.getElementById('nav-posts'),
                settings: document.getElementById('nav-settings'),
                submissions: document.getElementById('nav-submissions')
            };

            const postListBody = document.getElementById('post-list');
            const editorTitleEl = document.getElementById('editor-title');
            const postIdHiddenInput = document.getElementById('post-id');
            const postTitleInput = document.getElementById('post-title');
            const postCategoryInput = document.getElementById('post-category');
            const postTagsInput = document.getElementById('post-tags');
            const postContentTextarea = document.getElementById('post-content');
            const savePostBtn = document.getElementById('save-post-btn');
            const deletePostBtn = document.getElementById('delete-post-btn');

            const settingTitleInput = document.getElementById('setting-title');
            const settingDescriptionInput = document.getElementById('setting-description');
            const settingDefaultThemeSelect = document.getElementById('setting-default-theme');
            const settingBgColorInput = document.getElementById('setting-bg-color');
            const settingBgColorPicker = document.getElementById('setting-bg-color-picker');
            const settingTextColorInput = document.getElementById('setting-text-color');
            const settingTextColorPicker = document.getElementById('setting-text-color-picker');
            const settingAccentColorInput = document.getElementById('setting-accent-color');
            const settingAccentColorPicker = document.getElementById('setting-accent-color-picker');
            const settingBgImageUpload = document.getElementById('setting-bg-image-upload');
            const settingBgImageUrlInput = document.getElementById('setting-bg-image-url');
            const clearBgImageBtn = document.getElementById('clear-bg-image-btn');
            const saveSettingsBtn = document.getElementById('save-settings-btn');

            const commentsTypeSelect = document.getElementById('comments-type');
            const utterancesConfigDiv = document.getElementById('utterances-config');
            const utterancesRepoInput = document.getElementById('utterances-repo');
            const utterancesIssueTermSelect = document.getElementById('utterances-issue-term');
            const utterancesLabelInput = document.getElementById('utterances-label');

            const gitalkConfigDiv = document.getElementById('gitalk-config');
            const gitalkClientIdInput = document.getElementById('gitalk-client-id');
            const gitalkClientSecretInput = document.getElementById('gitalk-client-secret');
            const gitalkRepoInput = document.getElementById('gitalk-repo');
            const gitalkOwnerInput = document.getElementById('gitalk-owner');
            const gitalkAdminInput = document.getElementById('gitalk-admin');
            const gitalkLabelInput = document.getElementById('gitalk-label');
            const paginationPostsPerPageInput = document.getElementById('pagination-posts-per-page');


            // Global State
            let token = null;
            let owner = '';
            let repo = '';
            let basePath = ''; // For sub-directory deployments
            let posts = [];
            let postsSha = '';
            let config = {};
            let configSha = '';
            let easyMDEInstance = null; // EasyMDE instance

            // Utility for generating file paths
            const getPath = (fileName) => basePath ? `${basePath}/${fileName}` : fileName;

            // --- Alert System ---
            const showAlert = (message, type = 'info', duration = 3000) => {
                const alertEl = document.createElement('div');
                alertEl.className = `alert alert-${type}`;
                alertEl.textContent = message;
                globalAlertContainer.appendChild(alertEl);
                // Trigger transition
                setTimeout(() => alertEl.classList.add('show'), 10); 

                if (duration) {
                    setTimeout(() => {
                        alertEl.classList.remove('show');
                        alertEl.addEventListener('transitionend', () => alertEl.remove());
                    }, duration);
                }
                return alertEl;
            };

            // --- UI Management ---
            const showView = (viewName) => {
                Object.values(views).forEach(v => v.style.display = 'none');
                Object.values(navButtons).forEach(b => b.classList.remove('active'));
                
                views[viewName].style.display = 'block';
                if (navButtons[viewName]) {
                    navButtons[viewName].classList.add('active');
                }
                document.getElementById('admin-wrapper').classList.remove('sidebar-visible'); // Close sidebar on mobile
            };

            const setButtonsDisabled = (disabled) => {
                document.querySelectorAll('button').forEach(b => {
                    // Exclude logout button from disable during token operation from user side
                    if (b.id !== 'logout-btn' && b.id !== 'cancel-edit-btn') { 
                        b.disabled = disabled;
                    }
                });
                document.querySelectorAll('input').forEach(i => i.disabled = disabled);
                document.querySelectorAll('textarea').forEach(t => t.disabled = disabled);
                document.querySelectorAll('select').forEach(s => s.disabled = disabled);
                if (easyMDEInstance) {
                    easyMDEInstance.codemirror.setOption('readOnly', disabled);
                    easyMDEInstance.toolbar.forEach(item => {
                        if (item.className && item.className.includes('separator')) return;
                        const button = document.querySelector(`.editor-toolbar button.fa-${item.name}`);
                        if (button) button.disabled = disabled;
                    });
                }
            };
            
            // --- Core Logic ---
            const initializeEasyMDE = (initialContent = '') => {
                if (easyMDEInstance) {
                    easyMDEInstance.toTextArea(); // Destroy existing instance
                    easyMDEInstance = null;
                }
                easyMDEInstance = new EasyMDE({
                    element: postContentTextarea,
                    initialValue: initialContent,
                    spellChecker: false,
                    hideIcons: ["guide", "fullscreen"],
                    showIcons: ["code", "table"],
                    autofocus: true,
                    forceSync: true,
                    toolbar: [
                        "bold", "italic", "heading", "|", 
                        "quote", "unordered-list", "ordered-list", "|", 
                        "link", "image", "|", 
                        "code", "table", "horizontal-rule", "|",
                        "preview", "side-by-side",
                        {
                            name: "customImageUpload",
                            action: async (editor) => {
                                const input = document.createElement('input');
                                input.type = 'file';
                                input.accept = 'image/*';
                                input.onchange = async (e) => {
                                    const file = e.target.files[0];
                                    if (file) {
                                        showAlert('正在上传图片...', 'info', 0); // Indefinite alert
                                        try {
                                            const imageUrl = await uploadFile(file);
                                            editor.codemirror.replaceSelection(`![${file.name}](${imageUrl})`);
                                            showAlert('图片上传成功！', 'success');
                                        } catch (error) {
                                            showAlert(`图片上传失败: ${error.message}`, 'danger');
                                        } finally {
                                            globalAlertContainer.lastChild.remove(); // Remove indefinite alert
                                        }
                                    }
                                };
                                input.click();
                            },
                            className: "fa fa-image",
                            title: "上传图片",
                        },
                        "|",
                        "undo", "redo",
                    ],
                    status: ["lines", "words", "cursor"],
                });
            };

            const startAdminSession = async () => {
                const userToken = document.getElementById('token-input').value;
                if (!userToken) { showAlert('Token 不能为空。', 'danger'); return; }
                token = userToken;
                localStorage.setItem('github_pat', token); // Store token for future sessions (insecure, but typical for client-side admin)
                setButtonsDisabled(true);
                initialMessageEl.textContent = '正在验证并加载...';

                try {
                    const user = await GitHubAPI.getUser(token);
                    owner = user.login;
                    repo = `${owner}.github.io`; // Assumes your blog repo is `username.github.io`
                    // Adjust basePath for sub-directory deployments if admin.html is in one
                    basePath = window.location.pathname.split('/').filter(p => p && p.toLowerCase() !== 'admin.html').join('/');
                    
                    document.getElementById('view-site-link').href = basePath ? `/${basePath}/index.html` : `index.html`;

                    // Fetch config.json
                    let configData = await GitHubAPI.getFile(token, owner, repo, getPath('config.json'));
                    if (!configData || !configData.content) {
                        showAlert('未检测到配置文件，正在为您激活系统...', 'info', 0); // Indefinite alert
                        const initialConfig = { 
                            site: { title: `${user.login}的博客`, description: "由期望AI驱动的博客" }, 
                            styling: { defaultTheme: "light", backgroundColor: null, textColor: null, accentColor: null, backgroundImageUrl: null },
                            comments: { type: "utterances", utterances: { repo: `${owner}/${repo}`, issueTerm: "pathname", label: "评论" }, gitalk: null },
                            pagination: { postsPerPage: 6 }
                        };
                        const [configRes, postsRes, imagesRes] = await Promise.all([
                            GitHubAPI.createFile(token, owner, repo, getPath('config.json'), JSON.stringify(initialConfig, null, 2), 'feat: initialize config'),
                            GitHubAPI.createFile(token, owner, repo, getPath('posts.json'), '[]', 'feat: initialize posts'),
                            GitHubAPI.createFile(token, owner, repo, getPath('images/.gitkeep'), '', 'feat: initialize images directory (for uploads)')
                        ]);
                        config = initialConfig; configSha = configRes.content.sha;
                        posts = []; postsSha = postsRes.content.sha;
                        showAlert('系统激活成功！', 'success');
                        globalAlertContainer.lastChild.remove(); // Remove indefinite alert
                    } else {
                        config = JSON.parse(configData.content); configSha = configData.sha;
                        const postsData = await GitHubAPI.getFile(token, owner, repo, getPath('posts.json'));
                        posts = postsData && postsData.content ? JSON.parse(postsData.content) : [];
                        postsSha = postsData ? postsData.sha : null;
                    }
                    
                    loginWrapper.style.display = 'none';
                    adminWrapper.style.display = 'flex';
                    showView('posts');
                    renderPostList();
                    populateSettings();
                    showAlert('登录成功！', 'success');

                } catch (error) {
                    initialMessageEl.textContent = `登录失败: ${error.message}`;
                    showAlert(`登录失败: ${error.message}`, 'danger');
                    token = null; // Clear token on error
                    localStorage.removeItem('github_pat');
                } finally {
                    setButtonsDisabled(false);
                }
            };

            const renderPostList = () => {
                postListBody.innerHTML = '';
                if (posts.length === 0) {
                    postListBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">暂无文章。点击"撰写新文章"开始创作吧！</td></tr>';
                    return;
                }
                const sortedPosts = [...posts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                sortedPosts.forEach(post => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${post.title}</td>
                        <td>${post.category || 'N/A'}</td>
                        <td>${post.tags && post.tags.length > 0 ? post.tags.join(', ') : 'N/A'}</td>
                        <td>${new Date(post.createdAt).toLocaleDateString()}</td>
                        <td class="actions">
                            <a href="#" class="edit-post-btn" data-id="${post.id}"><i class="fas fa-edit"></i> 编辑</a>
                            <a href="#" class="delete-post-btn" data-id="${post.id}" style="color: var(--danger-color);"><i class="fas fa-trash-alt"></i> 删除</a>
                        </td>
                    `;
                    postListBody.appendChild(tr);
                });
            };

            const openPostEditor = (postId = null) => {
                showView('editor');
                const post = posts.find(p => p.id === postId);
                editorTitleEl.textContent = post ? '编辑文章' : '撰写新文章';
                savePostBtn.textContent = post ? '更新文章' : '发布文章';
                postIdHiddenInput.value = post?.id || '';
                postTitleInput.value = post?.title || '';
                postCategoryInput.value = post?.category || '';
                postTagsInput.value = post?.tags?.join(', ') || '';
                initializeEasyMDE(post?.content || '');
                deletePostBtn.style.display = post ? 'inline-flex' : 'none';
            };

            const savePost = async () => {
                const id = postIdHiddenInput.value;
                const title = postTitleInput.value.trim();
                const category = postCategoryInput.value.trim();
                const content = easyMDEInstance.value().trim();
                const tags = postTagsInput.value.split(',').map(t => t.trim()).filter(Boolean);

                if (!title || !content) { showAlert('标题和内容不能为空！', 'danger'); return; }
                
                setButtonsDisabled(true);
                showAlert('正在保存文章...', 'info', 0);

                const postIndex = posts.findIndex(p => p.id === id);
                const now = new Date().toISOString();

                if (postIndex > -1) {
                    Object.assign(posts[postIndex], { title, category, content, tags, updatedAt: now });
                } else {
                    posts.push({ id: `post_${Date.now()}`, title, category, content, tags, createdAt: now, updatedAt: now });
                }
                
                try {
                    const res = await GitHubAPI.updateFile(token, owner, repo, getPath('posts.json'), JSON.stringify(posts, null, 2), postsSha, `docs: ${id ? 'update' : 'create'} post "${title}"`);
                    postsSha = res.content.sha;
                    showAlert('文章保存成功！', 'success');
                    renderPostList();
                    showView('posts');
                } catch (error) { 
                    showAlert(`文章保存失败: ${error.message}`, 'danger');
                } finally { 
                    setButtonsDisabled(false);
                    if (globalAlertContainer.lastChild && globalAlertContainer.lastChild.textContent.includes('正在保存文章')) globalAlertContainer.lastChild.remove();
                }
            };

            const deletePost = async (postId) => {
                if (!postId) return; // Should not happen
                if (!confirm('确定要删除这篇文章吗？此操作不可逆！')) return;
                
                setButtonsDisabled(true);
                showAlert('正在删除文章...', 'info', 0);

                const originalPostsLength = posts.length;
                posts = posts.filter(p => p.id !== postId);

                if (posts.length === originalPostsLength) {
                    showAlert('未找到要删除的文章。', 'warning');
                    setButtonsDisabled(false);
                    if (globalAlertContainer.lastChild && globalAlertContainer.lastChild.textContent.includes('正在删除文章')) globalAlertContainer.lastChild.remove();
                    return;
                }

                try {
                    const res = await GitHubAPI.updateFile(token, owner, repo, getPath('posts.json'), JSON.stringify(posts, null, 2), postsSha, 'docs: delete post');
                    postsSha = res.content.sha;
                    showAlert('文章删除成功！', 'success');
                    renderPostList();
                    showView('posts'); // Redirect to posts list
                } catch (error) { 
                    showAlert(`文章删除失败: ${error.message}`, 'danger');
                } finally { 
                    setButtonsDisabled(false); 
                    if (globalAlertContainer.lastChild && globalAlertContainer.lastChild.textContent.includes('正在删除文章')) globalAlertContainer.lastChild.remove();
                }
            };
            
            const populateSettings = () => {
                settingTitleInput.value = config.site.title || '';
                settingDescriptionInput.value = config.site.description || '';
                settingDefaultThemeSelect.value = config.styling.defaultTheme || 'light';
                // Handle styling colors (can be null/empty, use empty string for input fields)
                settingBgColorInput.value = config.styling.backgroundColor || '';
                settingBgColorPicker.value = config.styling.backgroundColor || '#ffffff';
                settingTextColorInput.value = config.styling.textColor || '';
                settingTextColorPicker.value = config.styling.textColor || '#000000';
                settingAccentColorInput.value = config.styling.accentColor || '';
                settingAccentColorPicker.value = config.styling.accentColor || '#007bff';
                settingBgImageUrlInput.value = config.styling.backgroundImageUrl || '';

                commentsTypeSelect.value = config.comments?.type || '';
                toggleCommentsConfigLayout(); // Show/hide relevant config sections

                // Utterances
                utterancesRepoInput.value = config.comments?.utterances?.repo || '';
                utterancesIssueTermSelect.value = config.comments?.utterances?.issueTerm || 'pathname';
                utterancesLabelInput.value = config.comments?.utterances?.label || '';

                // Gitalk
                gitalkClientIdInput.value = config.comments?.gitalk?.clientID || '';
                gitalkClientSecretInput.value = config.comments?.gitalk?.clientSecret || '';
                gitalkRepoInput.value = config.comments?.gitalk?.repo || '';
                gitalkOwnerInput.value = config.comments?.gitalk?.owner || '';
                gitalkAdminInput.value = Array.isArray(config.comments?.gitalk?.admin) ? config.comments.gitalk.admin.join(', ') : (config.comments?.gitalk?.admin || '');
                gitalkLabelInput.value = config.comments?.gitalk?.label || '';
                
                paginationPostsPerPageInput.value = config.pagination?.postsPerPage || 6;

                // Update site link if custom domain is used in config (future enhancement)
                // For now, it assumes {owner}.github.io but if config becomes more complex, this can update
                // document.getElementById('view-site-link').href = config.site.siteUrl || `https://${owner}.github.io/${basePath ? basePath + '/' : ''}index.html`;
            };
            
            const saveSettings = async () => {
                setButtonsDisabled(true);
                showAlert('正在保存设置...', 'info', 0);

                const newConfig = JSON.parse(JSON.stringify(config)); // Deep clone
                newConfig.site = { 
                    title: settingTitleInput.value.trim(), 
                    description: settingDescriptionInput.value.trim() 
                };
                
                newConfig.styling = {
                    defaultTheme: settingDefaultThemeSelect.value,
                    backgroundColor: settingBgColorInput.value.trim() || null,
                    textColor: settingTextColorInput.value.trim() || null,
                    accentColor: settingAccentColorInput.value.trim() || null,
                    backgroundImageUrl: settingBgImageUrlInput.value.trim() || null
                };

                newConfig.pagination = {
                    postsPerPage: parseInt(paginationPostsPerPageInput.value, 10) || 6
                };


                // Comments System configuration
                newConfig.comments = { type: commentsTypeSelect.value };
                if (commentsTypeSelect.value === 'utterances') {
                    newConfig.comments.utterances = {
                        repo: utterancesRepoInput.value.trim(),
                        issueTerm: utterancesIssueTermSelect.value,
                        label: utterancesLabelInput.value.trim() || null
                    };
                    newConfig.comments.gitalk = null; // Clear Gitalk config if not used
                } else if (commentsTypeSelect.value === 'gitalk') {
                    newConfig.comments.gitalk = {
                        clientID: gitalkClientIdInput.value.trim(),
                        clientSecret: gitalkClientSecretInput.value.trim(),
                        repo: gitalkRepoInput.value.trim(),
                        owner: gitalkOwnerInput.value.trim(),
                        admin: gitalkAdminInput.value.split(',').map(s => s.trim()).filter(Boolean),
                        label: gitalkLabelInput.value.trim() || null
                    };
                    newConfig.comments.utterances = null; // Clear Utterances config if not used
                } else { // No comments
                    newConfig.comments = null;
                }

                try {
                    const res = await GitHubAPI.updateFile(token, owner, repo, getPath('config.json'), JSON.stringify(newConfig, null, 2), configSha, 'docs: update config');
                    configSha = res.content.sha;
                    config = newConfig; // Update local config with new SHA
                    showAlert('网站设置已保存！', 'success');
                } catch (error) { 
                    showAlert(`设置保存失败: ${error.message}`, 'danger');
                } finally { 
                    setButtonsDisabled(false); 
                    if (globalAlertContainer.lastChild && globalAlertContainer.lastChild.textContent.includes('正在保存设置')) globalAlertContainer.lastChild.remove();
                }
            };
            
            const uploadFile = async (file) => {
                if (!file) throw new Error('没有选择文件！');
                if (!token) throw new Error('未授权，请先登录！');
                
                // Allow image, but restrict other file types for security/simplicity
                if (!file.type.startsWith('image/')) {
                    throw new Error('只支持上传图片文件。');
                }

                const reader = new FileReader();
                return new Promise((resolve, reject) => {
                    reader.onload = async (e) => {
                        const content = e.target.result.split(',')[1]; // Base64 content
                        // Generate a unique path for the image
                        const timestamp = new Date().toISOString().replace(/[-:.]/g, '');
                        const filename = `${timestamp}_${file.name}`;
                        const path = getPath(`images/${filename}`); // Store images in an 'images' sub-directory
                        
                        try {
                            const result = await GitHubAPI.createFile(token, owner, repo, path, content, `feat: upload image "${filename}"`, true);
                            // GitHub API returns a download_url which is suitable for direct use
                            // To ensure reliable access, we can prepend a proxy like gh-proxy.com if needed
                            const rawUrl = result.content.download_url;
                            const proxiedUrl = `https://gh-proxy.com/${rawUrl.replace('https://raw.githubusercontent.com/', 'https://raw.githubusercontent.com/')}`;
                            resolve(proxiedUrl);
                        } catch (error) { 
                            reject(error);
                        }
                    };
                    reader.onerror = (error) => reject(new Error('文件读取失败:' + error.target.error));
                    reader.readAsDataURL(file);
                });
            };

            const toggleCommentsConfigLayout = () => {
                utterancesConfigDiv.style.display = 'none';
                gitalkConfigDiv.style.display = 'none';
                const selectedType = commentsTypeSelect.value;
                if (selectedType === 'utterances') {
                    utterancesConfigDiv.style.display = 'block';
                } else if (selectedType === 'gitalk') {
                    gitalkConfigDiv.style.display = 'block';
                }
            };
            
            const handleColorInputChange = (colorPicker, textInput) => {
                colorPicker.addEventListener('input', (e) => {
                    textInput.value = e.target.value;
                });
                textInput.addEventListener('input', (e) => {
                    // Only update color picker if it's a valid hex color
                    if (/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(e.target.value)) {
                        colorPicker.value = e.target.value;
                    }
                });
            };

            // --- Event Listeners ---
            document.getElementById('start-btn').addEventListener('click', startAdminSession);
            document.getElementById('token-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') startAdminSession();
            });

            // Restore token from localStorage if available
            const storedToken = localStorage.getItem('github_pat');
            if (storedToken) {
                document.getElementById('token-input').value = storedToken;
                startAdminSession();
            }

            // Navigation
            navButtons.posts.addEventListener('click', () => showView('posts'));
            navButtons.settings.addEventListener('click', () => showView('settings'));
            navButtons.submissions.addEventListener('click', () => showView('submissions')); // Placeholder

            document.getElementById('new-post-btn').addEventListener('click', () => openPostEditor());
            document.getElementById('cancel-edit-btn').addEventListener('click', () => showView('posts'));
            savePostBtn.addEventListener('click', savePost);
            
            postListBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-post-btn') || e.target.closest('.edit-post-btn')) { 
                    e.preventDefault(); 
                    openPostEditor(e.target.dataset.id || e.target.closest('.edit-post-btn').dataset.id);
                }
                if (e.target.classList.contains('delete-post-btn') || e.target.closest('.delete-post-btn')) { 
                    e.preventDefault(); 
                    deletePost(e.target.dataset.id || e.target.closest('.delete-post-btn').dataset.id);
                }
            });
            deletePostBtn.addEventListener('click', () => deletePost(postIdHiddenInput.value));

            // Settings events
            saveSettingsBtn.addEventListener('click', saveSettings);
            settingBgColorInput.addEventListener('focus', () => settingBgColorInput.select());
            settingTextColorInput.addEventListener('focus', () => settingTextColorInput.select());
            settingAccentColorInput.addEventListener('focus', () => settingAccentColorInput.select());
            
            handleColorInputChange(settingBgColorPicker, settingBgColorInput);
            handleColorInputChange(settingTextColorPicker, settingTextColorInput);
            handleColorInputChange(settingAccentColorPicker, settingAccentColorInput);

            settingBgImageUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    showAlert('正在上传背景图...', 'info', 0);
                    try {
                        const imageUrl = await uploadFile(file);
                        settingBgImageUrlInput.value = imageUrl;
                        showAlert('背景图上传成功！', 'success');
                    } catch (error) {
                        showAlert(`背景图上传失败: ${error.message}`, 'danger');
                    } finally {
                        if (globalAlertContainer.lastChild && globalAlertContainer.lastChild.textContent.includes('正在上传背景图')) globalAlertContainer.lastChild.remove();
                    }
                }
            });
            clearBgImageBtn.addEventListener('click', () => { settingBgImageUrlInput.value = ''; });
            commentsTypeSelect.addEventListener('change', toggleCommentsConfigLayout);

            // Mobile menu toggle
            mobileMenuBtn.addEventListener('click', () => adminWrapper.classList.toggle('sidebar-visible'));
            mobileOverlay.addEventListener('click', () => adminWrapper.classList.remove('sidebar-visible'));
            
            // Logout
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('github_pat');
                token = null;
                window.location.reload(); // Reload to login screen
            });

            // Initial view setup for color pickers (sync text to picker) based on any pre-filled values
            // This needs to run AFTER populateSettings if values are loaded from config
            settingBgColorInput.dispatchEvent(new Event('input'));
            settingTextColorInput.dispatchEvent(new Event('input'));
            settingAccentColorInput.dispatchEvent(new Event('input'));
        });
    </script>
</body>
</html>
