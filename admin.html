<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>博客后台管理 - 期望ai</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' font-size='90' text-anchor='middle' dominant-baseline='central'%3E⚙️%3C/text%3E%3C/svg%3E" type="image/svg+xml">

    <!-- EasyMDE CSS & Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        :root {
            --bg: #f4f6f8;
            --sidebar: #2c3e50;
            --accent: #3498db;
            --accent-hover: #2980b9;
            --danger: #e74c3c;
            --success: #2ecc71;
            --content-bg: #fff;
            --text: #34495e;
            --muted: #7f8c8d;
            --shadow: 0 1px 3px rgba(0,0,0,.12);
        }
        *{box-sizing:border-box}
        body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial; margin:0; background:var(--bg); color:var(--text); }
        a { color:var(--accent); }
        .login-box { max-width:420px; margin:8vh auto; background:var(--content-bg); padding:32px; border-radius:8px; box-shadow:var(--shadow); text-align:center; }
        input[type=password], input[type=text], textarea { width:100%; padding:10px 12px; border:1px solid #e6e9ee; border-radius:6px; margin-top:12px; }
        button { padding:10px 16px; border:none; border-radius:6px; cursor:pointer; }
        button.btn-primary { background:var(--accent); color:#fff; }
        button.btn-danger { background:var(--danger); color:#fff; }
        .admin-wrapper { display:flex; min-height:100vh; }
        aside#admin-sidebar { width:250px; background:var(--sidebar); color:#ecf0f1; padding:20px; flex-shrink:0; }
        aside#admin-sidebar .logo { font-weight:700; font-size:1.2rem; margin-bottom:20px; }
        aside#admin-sidebar .nav { list-style:none; padding:0; margin:0; }
        aside#admin-sidebar .nav a { display:block; color:inherit; padding:12px 10px; border-radius:6px; margin-bottom:6px; }
        aside#admin-sidebar .nav a.active, aside#admin-sidebar .nav a:hover { background:rgba(255,255,255,0.06); }
        main#admin-content { flex:1; padding:24px; background:var(--bg); }
        .page-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
        .admin-table { width:100%; border-collapse:collapse; background:var(--content-bg); box-shadow:var(--shadow); border-radius:8px; overflow:hidden; }
        .admin-table th, .admin-table td { padding:12px 16px; border-bottom:1px solid #eee; text-align:left; }
        .admin-table thead { background:#fafafa; font-weight:700; }
        .media-upload-area { background:var(--content-bg); padding:20px; border-radius:8px; border:2px dashed #e6e9ee; text-align:center; box-shadow:var(--shadow); }
        .media-upload-area.drag-over { border-color:var(--accent); }
        .media-item { background:var(--content-bg); border-radius:8px; overflow:hidden; box-shadow:var(--shadow); display:flex; flex-direction:column; }
        .media-item-thumbnail { height:150px; display:flex; justify-content:center; align-items:center; background:#f6f7f8; border-bottom:1px solid #eee; }
        .media-item-thumbnail img { max-width:100%; max-height:100%; object-fit:contain; }
        .media-item-info { padding:12px; display:flex; flex-direction:column; gap:8px; }
        .progress-container { width:100%; background:#e9ecef; height:26px; border-radius:6px; overflow:hidden; position:relative; margin-top:12px;}
        .progress-bar { height:100%; width:0%; background:var(--accent); color:#fff; text-align:center; line-height:26px; font-size:0.9rem; }
        .alert { padding:12px 16px; border-radius:6px; margin-bottom:12px; display:none; }
        .alert.info { background:#d1ecf1; color:#0c5460; display:flex; gap:8px; align-items:center; }
        .editor-toolbar + .progress-container.editor { margin-top:8px; margin-bottom:8px; }
        @media(max-width:768px){ aside#admin-sidebar{display:none} }
    </style>
</head>
<body>
    <!-- Login -->
    <div id="login-wrapper">
        <div class="login-box" id="login-box">
            <h1><i class="fas fa-lock"></i> 管理后台</h1>
            <p>请输入 GitHub Personal Access Token（需要 repo 权限）</p>
            <input id="token-input" type="password" placeholder="ghp_xxx 或 Bearer xxx" />
            <div style="margin-top:10px;text-align:left;">
                <input id="remember-token" type="checkbox" /> <label for="remember-token">记住 Token（仅在个人设备）</label>
            </div>
            <button id="start-btn" class="btn-primary" style="margin-top:14px;"><i class="fas fa-sign-in-alt"></i> 登录</button>
            <div id="initial-message" style="margin-top:12px;color:var(--muted)"></div>
            <div id="path-display" style="margin-top:8px;color:#888;display:none"></div>
            <p style="margin-top:12px; font-size:0.9rem;">如何生成 Token？<a href="https://github.com/settings/tokens" target="_blank">点此</a></p>
        </div>
    </div>

    <!-- Admin -->
    <div id="admin-wrapper" class="admin-wrapper" style="display:none;">
        <aside id="admin-sidebar">
            <div class="logo">博客管理系统</div>
            <ul class="nav">
                <li><a href="#" id="nav-dashboard" data-view="dashboard" class="active"><i class="fas fa-chart-line"></i> 仪表盘</a></li>
                <li><a href="#" id="nav-posts" data-view="posts"><i class="fas fa-newspaper"></i> 文章管理</a></li>
                <li><a href="#" id="nav-media-library" data-view="mediaLibrary"><i class="fas fa-images"></i> 媒体库</a></li>
                <li><a href="#" id="nav-settings" data-view="settings"><i class="fas fa-cog"></i> 网站设置</a></li>
                <li><a href="#" id="nav-gitalk-settings" data-view="gitalkSettings"><i class="fas fa-comments"></i> 评论设置</a></li>
                <li><a href="#" id="nav-logout"><i class="fas fa-sign-out-alt"></i> 退出</a></li>
                <li style="margin-top:12px;"><a id="view-site-link" href="#" target="_blank"><i class="fas fa-desktop"></i> 查看站点</a></li>
            </ul>
            <footer style="color:#a0a8b4; font-size:0.9rem; margin-top:18px;">Powered by 期望ai</footer>
        </aside>

        <main id="admin-content">
            <!-- Dashboard -->
            <div id="dashboard-view" class="admin-view" style="display:block;">
                <div class="page-header">
                    <h2><i class="fas fa-chart-line"></i> 仪表盘</h2>
                    <div><button id="open-posts" class="btn-primary"><i class="fas fa-list"></i> 管理文章</button></div>
                </div>
                <div id="dashboard-stats" style="display:flex;gap:16px;flex-wrap:wrap;">
                    <div style="background:var(--content-bg);padding:18px;border-radius:8px;box-shadow:var(--shadow);min-width:180px;">
                        <div style="font-size:0.9rem;color:var(--muted)">文章总数</div>
                        <div id="total-posts" style="font-size:1.6rem;font-weight:700">0</div>
                    </div>
                    <div style="background:var(--content-bg);padding:18px;border-radius:8px;box-shadow:var(--shadow);min-width:180px;">
                        <div style="font-size:0.9rem;color:var(--muted)">分类数</div>
                        <div id="total-categories" style="font-size:1.6rem;font-weight:700">0</div>
                    </div>
                    <div style="background:var(--content-bg);padding:18px;border-radius:8px;box-shadow:var(--shadow);min-width:180px;">
                        <div style="font-size:0.9rem;color:var(--muted)">标签数</div>
                        <div id="total-tags" style="font-size:1.6rem;font-weight:700">0</div>
                    </div>
                </div>
            </div>

            <!-- Posts -->
            <div id="posts-view" class="admin-view" style="display:none;">
                <div class="page-header">
                    <h2><i class="fas fa-newspaper"></i> 文章管理</h2>
                    <div>
                        <button id="new-post-btn" class="btn-primary"><i class="fas fa-plus-circle"></i> 新建</button>
                        <button id="delete-selected-posts-btn" class="btn-danger" style="display:none;">删除选中</button>
                    </div>
                </div>
                <div class="admin-table-wrapper">
                    <table class="admin-table" id="posts-table">
                        <thead><tr><th style="width:36px"><input id="select-all-posts" type="checkbox" /></th><th>标题</th><th>分类</th><th>标签</th><th>创建</th><th>更新</th><th>操作</th></tr></thead>
                        <tbody id="post-list"><tr><td colspan="7" style="text-align:center;">加载中...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- Editor -->
            <div id="editor-container" class="admin-view" style="display:none;">
                <h2 id="editor-title"><i class="fas fa-edit"></i> 写文章</h2>
                <input type="hidden" id="post-id" />
                <div style="margin-top:12px;">
                    <label>标题</label>
                    <input id="post-title" type="text" placeholder="文章标题" />
                </div>
                <div style="margin-top:12px;">
                    <label>分类</label>
                    <input id="post-category" type="text" placeholder="分类，例如：技术" />
                </div>
                <div style="margin-top:12px;">
                    <label>标签（按 Enter 添加）</label>
                    <div id="tag-token-container" style="display:flex;gap:8px;flex-wrap:wrap;padding:8px;border:1px solid #e9ecef;border-radius:6px;background:#fff;">
                        <input id="post-tags-input" type="text" placeholder="输入标签并回车" style="border:none;outline:none;flex:1" />
                    </div>
                    <input id="post-tags" type="hidden" value="[]" />
                </div>
                <div style="margin-top:12px;">
                    <label>内容 (Markdown)</label>
                    <textarea id="post-content"></textarea>
                </div>
                <div style="margin-top:12px;display:flex;gap:8px;">
                    <button id="save-post-btn" class="btn-primary"><i class="fas fa-upload"></i> 保存</button>
                    <button id="cancel-edit-btn" class="btn" style="background:#f1f1f1">取消</button>
                    <button id="delete-post-btn" class="btn-danger" style="display:none">删除</button>
                </div>
            </div>

            <!-- Media Library -->
            <div id="media-library-view" class="admin-view" style="display:none;">
                <div class="page-header">
                    <h2><i class="fas fa-images"></i> 媒体库</h2>
                    <div>
                        <label for="media-upload-input" class="btn-primary" style="cursor:pointer;"><i class="fas fa-plus-circle"></i> 上传图片</label>
                        <input id="media-upload-input" type="file" accept="image/*" multiple style="display:none" />
                    </div>
                </div>

                <div id="media-upload-droparea" class="media-upload-area">
                    <p><i class="fas fa-cloud-upload-alt"></i> 将图片拖拽到此处或点击“上传图片”</p>
                    <div id="upload-progress-container" class="progress-container" style="display:none;">
                        <div id="upload-progress-bar" class="progress-bar">0%</div>
                    </div>
                </div>

                <div id="media-library-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-top:16px;">
                    <div style="grid-column:1/-1;text-align:center;color:var(--muted)"><i class="fas fa-info-circle"></i> 媒体库为空或加载中</div>
                </div>
            </div>

            <!-- Settings -->
            <div id="settings-view" class="admin-view" style="display:none;">
                <div class="page-header">
                    <h2><i class="fas fa-cog"></i> 网站设置</h2>
                    <div><button id="save-settings-btn" class="btn-primary"><i class="fas fa-save"></i> 保存设置</button></div>
                </div>

                <div style="background:var(--content-bg);padding:16px;border-radius:8px;box-shadow:var(--shadow);">
                    <div style="margin-bottom:12px;"><label>网站标题</label><input id="setting-title" type="text" /></div>
                    <div style="margin-bottom:12px;"><label>网站描述</label><input id="setting-description" type="text" /></div>
                    <div style="margin-bottom:12px;"><label>关于我 (Markdown)</label><textarea id="setting-about-content" rows="6"></textarea></div>
                    <div style="display:flex;gap:12px;flex-wrap:wrap">
                        <div><label>背景颜色</label><input id="setting-bg-color" type="color" /></div>
                        <div><label>文字颜色</label><input id="setting-text-color" type="color" /></div>
                        <div><label>强调色</label><input id="setting-accent-color" type="color" /></div>
                    </div>

                    <div style="margin-top:12px;">
                        <label>网站背景图 (可上传或填写 URL)</label>
                        <input id="setting-bg-image" type="file" accept="image/*" />
                        <div id="setting-bg-image-preview" style="margin-top:8px;width:200px;height:120px;border:1px dashed #e9ecef;display:flex;align-items:center;justify-content:center;">
                            <span class="placeholder">无背景图</span>
                        </div>
                        <input id="setting-bg-image-url" readonly style="margin-top:8px;width:100%;padding:8px;border:1px solid #eee;border-radius:6px" placeholder="背景图 URL" />
                        <div style="margin-top:8px;display:flex;gap:8px;">
                            <button id="upload-bg-image-btn" class="btn-primary" style="display:none">上传并设置</button>
                            <button id="clear-bg-image-btn" class="btn" style="background:#f1f1f1">清除背景图</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gitalk Settings -->
            <div id="gitalk-settings-view" class="admin-view" style="display:none;">
                <div class="page-header">
                    <h2><i class="fas fa-comments"></i> Gitalk 设置</h2>
                    <div><button id="save-gitalk-settings-btn" class="btn-primary">保存评论设置</button></div>
                </div>
                <div style="background:var(--content-bg);padding:16px;border-radius:8px;box-shadow:var(--shadow);">
                    <p style="color:var(--muted)">Gitalk 需要 OAuth App 的 Client ID / Secret，并在管理后台启用后生效。</p>
                    <div style="margin-bottom:8px;"><label>Client ID</label><input id="gitalk-clientID" type="text" /></div>
                    <div style="margin-bottom:8px;"><label>Client Secret</label><input id="gitalk-clientSecret" type="password" /></div>
                    <div style="margin-bottom:8px;"><label>Repo</label><input id="gitalk-repo" type="text" /></div>
                    <div style="margin-bottom:8px;"><label>Owner</label><input id="gitalk-owner" type="text" /></div>
                    <div style="margin-bottom:8px;"><label>管理员 (逗号分隔)</label><input id="gitalk-admin" type="text" /></div>
                    <div style="margin-top:8px;"><input id="gitalk-enabled" type="checkbox" /> <label for="gitalk-enabled">启用 Gitalk 评论</label></div>
                </div>
            </div>

        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.js"></script>
    <script>
        // ============== Utilities ==============
        const utf8_to_b64 = str => btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,(m,p)=>String.fromCharCode('0x'+p)));
        const b64_to_utf8 = b64 => decodeURIComponent(Array.prototype.map.call(atob(b64), c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));

        // GitHub API helper (uses token)
        const GitHubAPI = {
            BASE: 'https://api.github.com',
            DEFAULT_HEADERS: { 'Accept': 'application/vnd.github.v3+json' },
            async request(token, endpoint, options = {}) {
                const url = `${this.BASE}${endpoint}`;
                const headers = { ...this.DEFAULT_HEADERS, ...(options.headers || {}) };
                if (token) headers['Authorization'] = `token ${token}`;
                if (options.method && ['POST','PUT','DELETE'].includes(options.method.toUpperCase())) {
                    headers['Content-Type'] = headers['Content-Type'] || 'application/json';
                }
                const res = await fetch(url, { ...options, headers });
                if (!res.ok) {
                    let body = null;
                    try { body = await res.json(); } catch (e) { body = { message: res.statusText }; }
                    const msg = body && body.message ? body.message : `HTTP ${res.status}`;
                    const extra = (res.status === 401 || res.status === 403) ? '（可能是 Token 无效或权限不足）' : '';
                    throw new Error(`${msg} ${extra}`);
                }
                if (res.status === 204) return null;
                return res.json();
            },
            async getUser(token) { return this.request(token, '/user'); },
            async getDirectoryContents(token, owner, repo, path) {
                try {
                    const res = await this.request(token, `/repos/${owner}/${repo}/contents/${path}`);
                    if (!Array.isArray(res)) return [];
                    return res;
                } catch (e) {
                    if (String(e).includes('Not Found') || String(e).includes('404')) return [];
                    throw e;
                }
            },
            async getFile(token, owner, repo, path) {
                try {
                    return await this.request(token, `/repos/${owner}/${repo}/contents/${path}`);
                } catch (e) {
                    if (String(e).includes('Not Found') || String(e).includes('404')) return null;
                    throw e;
                }
            },
            // createFile / updateFile use PUT to contents endpoint. Provide binary (base64) content if isBinary true.
            async createFile(token, owner, repo, path, contentBase64, message) {
                const body = JSON.stringify({ message, content: contentBase64 });
                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('PUT', `${this.BASE}/repos/${owner}/${repo}/contents/${path}`, true);
                    xhr.setRequestHeader('Authorization', `token ${token}`);
                    xhr.setRequestHeader('Accept', this.DEFAULT_HEADERS.Accept);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            try { resolve(JSON.parse(xhr.responseText)); } catch (e) { resolve(null); }
                        } else {
                            try { const err = JSON.parse(xhr.responseText); reject(new Error(err.message || xhr.statusText)); } catch (e) { reject(new Error(xhr.statusText)); }
                        }
                    };
                    xhr.onerror = () => reject(new Error('Network error during createFile'));
                    xhr.send(body);
                });
            },
            async updateFile(token, owner, repo, path, contentBase64, sha, message) {
                const body = JSON.stringify({ message, content: contentBase64, sha });
                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('PUT', `${this.BASE}/repos/${owner}/${repo}/contents/${path}`, true);
                    xhr.setRequestHeader('Authorization', `token ${token}`);
                    xhr.setRequestHeader('Accept', this.DEFAULT_HEADERS.Accept);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            try { resolve(JSON.parse(xhr.responseText)); } catch (e) { resolve(null); }
                        } else {
                            try { const err = JSON.parse(xhr.responseText); reject(new Error(err.message || xhr.statusText)); } catch (e) { reject(new Error(xhr.statusText)); }
                        }
                    };
                    xhr.onerror = () => reject(new Error('Network error during updateFile'));
                    xhr.send(body);
                });
            },
            async deleteFile(token, owner, repo, path, sha, message) {
                return this.request(token, `/repos/${owner}/${repo}/contents/${path}`, { method:'DELETE', body: JSON.stringify({ message, sha }) });
            }
        };

        // ============== DOM & State ==============
        const loginWrapper = document.getElementById('login-wrapper');
        const adminWrapper = document.getElementById('admin-wrapper');
        const tokenInput = document.getElementById('token-input');
        const rememberTokenCheckbox = document.getElementById('remember-token');
        const startBtn = document.getElementById('start-btn');
        const initialMessageEl = document.getElementById('initial-message');
        const pathDisplayEl = document.getElementById('path-display');
        const viewSiteLink = document.getElementById('view-site-link');

        const adminViews = {
            dashboard: document.getElementById('dashboard-view'),
            posts: document.getElementById('posts-view'),
            editor: document.getElementById('editor-container'),
            mediaLibrary: document.getElementById('media-library-view'),
            settings: document.getElementById('settings-view'),
            gitalkSettings: document.getElementById('gitalk-settings-view'),
        };

        const postListBody = document.getElementById('post-list');
        const mediaLibraryGrid = document.getElementById('media-library-grid');
        const uploadProgressContainer = document.getElementById('upload-progress-container');
        const uploadProgressBar = document.getElementById('upload-progress-bar');

        let token = null, owner = '', repo = '', publicUrlBase = '';
        let posts = [], postsSha = '';
        let config = {}, configSha = '';
        let easyMDE = null;
        let allUniqueTags = new Set();
        let selectedPostIds = [];

        // Path parsing (same logic as frontend index)
        const parseGitHubRepoAndBasePath = (githubUsername) => {
            const hostname = window.location.hostname;
            let pathSegments = window.location.pathname.split('/').filter(p => p);
            if (pathSegments.length > 0 && (pathSegments[pathSegments.length - 1].toLowerCase() === 'admin.html' || pathSegments[pathSegments.length - 1].toLowerCase() === 'index.html')) {
                pathSegments.pop();
            }
            const usernameLow = githubUsername.toLowerCase();
            const hostnameLow = hostname.toLowerCase();
            let finalOwner = githubUsername;
            let finalRepo = '';
            let finalPublicUrlBase = '';

            if (hostnameLow === `${usernameLow}.github.io` || /^localhost$|^127\.0\.0\.1$/.test(hostnameLow)) {
                if (pathSegments.length > 0) {
                    finalRepo = pathSegments[0];
                    finalPublicUrlBase = `/${pathSegments[0]}`;
                } else {
                    finalRepo = `${usernameLow}.github.io`;
                    finalPublicUrlBase = '';
                }
            } else if (pathSegments.length > 0) {
                finalRepo = pathSegments[0];
                finalPublicUrlBase = `/${pathSegments[0]}`;
            } else {
                finalRepo = `${usernameLow}.github.io`;
                finalPublicUrlBase = '';
            }

            if (!finalRepo) {
                finalRepo = `${usernameLow}.github.io`;
                finalPublicUrlBase = '';
            }
            console.log(`[parseGitHubRepoAndBasePath] owner=${finalOwner}, repo=${finalRepo}, base=${finalPublicUrlBase}`);
            return { owner: finalOwner, repo: finalRepo, publicUrlBase: finalPublicUrlBase };
        };

        // sanitize filenames for GitHub raw
        const sanitizeFileName = (filename) => {
            if (!filename) return '';
            const ext = filename.includes('.') ? filename.substring(filename.lastIndexOf('.') + 1) : '';
            const base = filename.includes('.') ? filename.substring(0, filename.lastIndexOf('.')) : filename;
            // Keep letters, numbers, underscore, dash, dot. Replace others with underscore.
            const sanitizedBase = base.replace(/[^\p{L}\p{N}_\-.]/gu, '_').replace(/_+/g,'_').replace(/^[_\-.]+|[_\-.]+$/g, '').slice(0,100);
            return `${sanitizedBase}${ext ? '.' + ext : ''}`;
        };

        // getProxiedImageUrl: normalize path segments, decode then re-encode for gh-proxy
        const getProxiedImageUrl = (inputUrl) => {
            if (!inputUrl) return '';
            let urlToProcess = inputUrl;
            if (urlToProcess.startsWith('https://gh-proxy.com/')) {
                try {
                    const decoded = decodeURIComponent(urlToProcess.substring('https://gh-proxy.com/'.length));
                    urlToProcess = decoded.startsWith('http') ? decoded : decoded;
                } catch (e) {
                    console.warn('decode gh-proxy failed', e);
                    urlToProcess = urlToProcess.substring('https://gh-proxy.com/'.length);
                }
            }
            if (/^https?:\/\//.test(urlToProcess)) {
                try {
                    const u = new URL(urlToProcess);
                    u.pathname = u.pathname.split('/').map(seg => decodeURIComponent(seg || '')).join('/');
                    u.search = decodeURIComponent(u.search || '');
                    urlToProcess = u.toString();
                } catch (e) {
                    console.warn('URL parse error in getProxiedImageUrl', e);
                }
                return `https://gh-proxy.com/${encodeURIComponent(urlToProcess)}`;
            }
            return inputUrl;
        };

        // UI helpers
        const showAdminView = (viewName) => {
            Object.values(adminViews).forEach(v => v.style.display = 'none');
            const navLinks = document.querySelectorAll('#admin-sidebar .nav a');
            navLinks.forEach(a => a.classList.remove('active'));
            const link = document.querySelector(`#admin-sidebar .nav a[data-view="${viewName}"]`);
            if (link) link.classList.add('active');
            if (adminViews[viewName]) adminViews[viewName].style.display = 'block';
            if (viewName === 'editor' && !easyMDE) initializeEasyMDE();
            if (viewName === 'mediaLibrary') renderMediaLibrary();
            if (viewName === 'dashboard') renderDashboard();
        };

        const setButtonsDisabled = (disabled) => {
            document.querySelectorAll('button').forEach(b => b.disabled = disabled);
        };

        const showAlert = (message, type='info', duration=4500) => {
            // small transient alert at top of main
            let id = 'global-alert';
            let el = document.getElementById(id);
            if (!el) {
                el = document.createElement('div');
                el.id = id;
                document.body.prepend(el);
            }
            el.className = `alert ${type}`;
            el.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            el.style.display = 'flex';
            setTimeout(() => el.style.display = 'none', duration);
        };

        // createGitHubDirectory ensures images/ folder exists by writing .gitkeep
        const createGitHubDirectory = async (apiToken, apiOwner, apiRepo, directoryPath) => {
            const gitkeepPath = `${directoryPath}/.gitkeep`;
            try {
                const existing = await GitHubAPI.getFile(apiToken, apiOwner, apiRepo, gitkeepPath);
                if (!existing) {
                    const res = await GitHubAPI.createFile(apiToken, apiOwner, apiRepo, gitkeepPath, utf8_to_b64(''), `feat: create directory ${directoryPath}`);
                    return !!res;
                } else {
                    // update with same empty content to ensure SHA freshness
                    const res = await GitHubAPI.updateFile(apiToken, apiOwner, apiRepo, gitkeepPath, utf8_to_b64(''), existing.sha, `ci: update .gitkeep for ${directoryPath}`);
                    return !!res;
                }
            } catch (e) {
                console.error('createGitHubDirectory error', e);
                throw e;
            }
        };

        // Upload helper: reads file and calls GitHubAPI.createFile. Provide onProgress callback signature: (percentage, filename)
        const uploadFile = async (file, uploadDirectory, commitMessage, onProgress = null) => {
            if (!file) throw new Error('No file provided');
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        // e.target.result is data:[mime];base64,xxxx
                        const base64data = e.target.result.split(',')[1];
                        const timestamp = new Date().toISOString().replace(/[-:.TZ]/g, '');
                        const sanitized = sanitizeFileName(file.name);
                        const finalName = `${timestamp}_${sanitized}`;
                        const path = `${uploadDirectory}/${finalName}`;
                        // Use GitHubAPI.createFile (XHR) to upload base64 content
                        // We pass base64 content directly: createFile expects base64 string content
                        const res = await GitHubAPI.createFile(token, owner, repo, path, base64data, commitMessage);
                        // commit callback (no progress support for base64 push via XHR body), so call onProgress 100
                        if (onProgress && typeof onProgress === 'function') {
                            try { onProgress(100, file.name); } catch (e) { console.warn('onProgress callback error', e); }
                        }
                        const rawUrl = (res && res.content && res.content.download_url) ? res.content.download_url : `https://raw.githubusercontent.com/${owner}/${repo}/main/${path}`;
                        resolve(rawUrl);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = (err) => reject(err);
                reader.readAsDataURL(file);
            });
        };

        // Delete file
        const deleteMediaFile = async (filePath, fileSha) => {
            setButtonsDisabled(true);
            try {
                await GitHubAPI.deleteFile(token, owner, repo, filePath, fileSha, `feat: delete media ${filePath.split('/').pop()}`);
                showAlert('删除成功', 'success');
                setTimeout(() => renderMediaLibrary(), 500);
            } catch (e) {
                console.error(e);
                showAlert('删除失败：' + e.message, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };

        // Render media library (reads images/ contents)
        const renderMediaLibrary = async () => {
            mediaLibraryGrid.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:var(--muted)"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>`;
            setButtonsDisabled(true);
            try {
                const contents = await GitHubAPI.getDirectoryContents(token, owner, repo, 'images');
                mediaLibraryGrid.innerHTML = '';
                let found = false;
                for (const item of contents) {
                    if (item.type === 'file' && item.name !== '.gitkeep') {
                        found = true;
                        const div = document.createElement('div');
                        div.className = 'media-item';
                        div.innerHTML = `
                            <div class="media-item-thumbnail">
                                <img src="${getProxiedImageUrl(item.download_url)}" alt="${item.name}" loading="lazy" onerror="this.onerror=null;this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 24 24\\'%3E%3Cpath fill=\\'%23ccc\\' d=\\'M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z\\'%3E%3C/path%3E%3C/svg%3E'; this.title='图片加载失败';" />
                            </div>
                            <div class="media-item-info">
                                <div style="font-weight:600" title="${item.name}">${item.name}</div>
                                <div style="display:flex;gap:8px;">
                                    <button class="btn" data-raw-url="${item.download_url}" style="background:#f1f1f1;padding:6px;border-radius:6px">复制 URL</button>
                                    <button class="btn" data-md="${item.name}" data-raw-url="${item.download_url}" style="background:#f1f1f1;padding:6px;border-radius:6px">复制 Markdown</button>
                                    <button class="btn btn-danger" data-path="${item.path}" data-sha="${item.sha}" title="删除" style="margin-left:auto">删除</button>
                                </div>
                            </div>
                        `;
                        mediaLibraryGrid.appendChild(div);
                    }
                }
                if (!found) {
                    mediaLibraryGrid.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:var(--muted)"><i class="fas fa-info-circle"></i> 媒体库为空。</div>`;
                } else {
                    // bind buttons
                    mediaLibraryGrid.querySelectorAll('button[data-raw-url]').forEach(b => {
                        b.addEventListener('click', async (e) => {
                            const rawUrl = e.currentTarget.dataset.rawUrl;
                            const proxied = getProxiedImageUrl(rawUrl);
                            try {
                                await navigator.clipboard.writeText(proxied);
                                showAlert('图片 URL 已复制', 'success');
                            } catch (err) {
                                showAlert('复制失败', 'danger');
                            }
                        });
                    });
                    mediaLibraryGrid.querySelectorAll('button[data-md]').forEach(b => {
                        b.addEventListener('click', async (e) => {
                            const rawUrl = e.currentTarget.dataset.rawUrl;
                            const filename = e.currentTarget.dataset.md;
                            const proxied = getProxiedImageUrl(rawUrl);
                            const md = `![${filename.split('.')[0]}](${proxied})`;
                            try {
                                await navigator.clipboard.writeText(md);
                                showAlert('Markdown 已复制', 'success');
                            } catch (err) {
                                showAlert('复制失败', 'danger');
                            }
                        });
                    });
                    mediaLibraryGrid.querySelectorAll('button[data-path]').forEach(b => {
                        b.addEventListener('click', (e) => {
                            const path = e.currentTarget.dataset.path;
                            const sha = e.currentTarget.dataset.sha;
                            if (confirm(`确定删除 ${path.split('/').pop()} 吗？`)) {
                                deleteMediaFile(path, sha);
                            }
                        });
                    });
                }
            } catch (e) {
                console.error(e);
                mediaLibraryGrid.innerHTML = `<div style="grid-column:1/-1;color:var(--danger);text-align:center">加载失败：${e.message}</div>`;
                showAlert('加载媒体库失败：' + e.message, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };

        // Handle file uploads (from input or drop)
        const handleMediaFileUpload = async (files) => {
            if (!files || files.length === 0) return;
            setButtonsDisabled(true);
            uploadProgressContainer.style.display = 'block';
            uploadProgressBar.style.width = '0%';
            uploadProgressBar.textContent = '0%';
            try {
                const arr = Array.from(files);
                let success = 0, fail = 0;
                for (let i = 0; i < arr.length; i++) {
                    const f = arr[i];
                    try {
                        // call uploadFile with onProgress signature (percentage, filename)
                        await uploadFile(f, 'images', `feat: upload image "${f.name}"`, (percentage, filename) => {
                            uploadProgressBar.style.width = `${Math.round(percentage)}%`;
                            uploadProgressBar.textContent = `${Math.round(percentage)}%`;
                        });
                        success++;
                    } catch (err) {
                        console.error('upload error', err);
                        fail++;
                    }
                }
                uploadProgressBar.style.width = `100%`;
                uploadProgressBar.textContent = `完成`;
                if (success) showAlert(`${success} 张图片上传成功`, 'success');
                if (fail) showAlert(`${fail} 张上传失败（查看控制台）`, 'danger');
                setTimeout(() => {
                    uploadProgressContainer.style.display = 'none';
                    renderMediaLibrary();
                }, 900);
            } catch (e) {
                console.error(e);
                showAlert('上传失败：' + e.message, 'danger');
                uploadProgressContainer.style.display = 'none';
            } finally {
                setButtonsDisabled(false);
            }
        };

        // Posts management
        const renderPostList = () => {
            postListBody.innerHTML = '';
            document.getElementById('select-all-posts').checked = false;
            selectedPostIds = [];
            toggleBulkDeleteButton();
            if (!posts || posts.length === 0) {
                postListBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">暂无文章</td></tr>`;
                return;
            }
            posts.slice().sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt)).forEach(post => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><input class="post-checkbox" type="checkbox" data-id="${post.id}" /></td>
                                <td>${post.title}</td>
                                <td>${post.category || '未分类'}</td>
                                <td>${post.tags && post.tags.length ? post.tags.slice(0,3).join(', ') : '无'}</td>
                                <td>${new Date(post.createdAt).toLocaleDateString()}</td>
                                <td>${new Date(post.updatedAt).toLocaleDateString()}</td>
                                <td>
                                    <a href="#" class="edit" data-id="${post.id}"><i class="fas fa-edit"></i></a>
                                    <a href="${window.location.origin}${publicUrlBase}/index.html#/post/${post.id}" target="_blank"><i class="fas fa-external-link-alt"></i></a>
                                    <a href="#" class="delete" data-id="${post.id}"><i class="fas fa-trash-alt"></i></a>
                                </td>`;
                postListBody.appendChild(tr);
            });
        };

        const toggleBulkDeleteButton = () => {
            document.getElementById('delete-selected-posts-btn').style.display = selectedPostIds.length > 0 ? 'inline-flex' : 'none';
        };

        document.getElementById('post-list').addEventListener('change', (e) => {
            if (e.target.classList.contains('post-checkbox')) {
                const id = e.target.dataset.id;
                if (e.target.checked) {
                    if (!selectedPostIds.includes(id)) selectedPostIds.push(id);
                } else {
                    selectedPostIds = selectedPostIds.filter(x=>x!==id);
                    document.getElementById('select-all-posts').checked = false;
                }
                toggleBulkDeleteButton();
            }
        });

        document.getElementById('select-all-posts').addEventListener('change', (e) => {
            const checked = e.target.checked;
            document.querySelectorAll('.post-checkbox').forEach(cb => {
                cb.checked = checked;
                const id = cb.dataset.id;
                if (checked) { if (!selectedPostIds.includes(id)) selectedPostIds.push(id); } else selectedPostIds = [];
            });
            toggleBulkDeleteButton();
        });

        const bulkDeletePosts = async () => {
            if (!selectedPostIds.length) return showAlert('请选择要删除的文章', 'warning');
            if (!confirm(`确认删除 ${selectedPostIds.length} 篇文章？`)) return;
            setButtonsDisabled(true);
            const toDelete = posts.filter(p=>selectedPostIds.includes(p.id)).map(p=>p.title).join(', ');
            posts = posts.filter(p=>!selectedPostIds.includes(p.id));
            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, 'posts.json', utf8_to_b64(JSON.stringify(posts, null, 2)), postsSha, `docs: bulk delete (${selectedPostIds.length})`);
                postsSha = res.content.sha;
                showAlert('删除成功', 'success');
                renderPostList(); renderDashboard();
            } catch (e) {
                console.error(e);
                showAlert('删除失败：' + e.message, 'danger');
            } finally {
                setButtonsDisabled(false);
                selectedPostIds = [];
                toggleBulkDeleteButton();
            }
        };

        // Editor functions
        const initializeEasyMDE = () => {
            if (easyMDE) return;
            easyMDE = new EasyMDE({
                element: document.getElementById('post-content'),
                spellChecker:false,
                forceSync:true,
                toolbar:["bold","italic","heading","|","quote","unordered-list","ordered-list","|","link","image","|","upload-image","table","preview","side-by-side","fullscreen","guide"],
                customIcons: { "upload-image": "<i class='fas fa-image'></i>" }
            });

            // Custom upload action
            const uploadBtn = easyMDE.toolbar.find(t => t.name === 'upload-image');
            if (uploadBtn) {
                uploadBtn.action = () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        setButtonsDisabled(true);
                        const alertId = 'image-upload-alert';
                        showAlert(`正在上传 ${file.name} ...`, 'info', 5000);
                        try {
                            const rawUrl = await uploadFile(file, 'images', `feat: upload image "${file.name}"`, (percentage, filename) => {
                                // we don't show dedicated editor progress here beyond global alert
                            });
                            // Insert raw GitHub URL into markdown; frontend will proxy for display
                            const cm = easyMDE.codemirror;
                            const pos = cm.getCursor();
                            cm.replaceRange(`![${file.name.split('.')[0]}](${rawUrl})`, pos);
                            showAlert('图片上传并插入成功', 'success');
                        } catch (err) {
                            console.error(err);
                            showAlert('图片上传失败：' + err.message, 'danger');
                        } finally {
                            setButtonsDisabled(false);
                        }
                    };
                    input.click();
                };
            }
        };

        const openEditor = (postId = null) => {
            showAdminView('editor');
            const post = posts.find(p=>p.id===postId);
            document.getElementById('editor-title').innerHTML = `<i class="fas fa-edit"></i> ${post ? '编辑文章' : '撰写新文章'}`;
            document.getElementById('post-id').value = post ? post.id : '';
            document.getElementById('post-title').value = post ? post.title : '';
            document.getElementById('post-category').value = post ? post.category : '';
            document.getElementById('post-tags').value = JSON.stringify(post ? post.tags || [] : []);
            // rebuild tag tokens
            const tagContainer = document.getElementById('tag-token-container');
            tagContainer.querySelectorAll('.tag-token').forEach(t=>t.remove());
            const tags = post && post.tags ? post.tags : [];
            const inputEl = document.getElementById('post-tags-input');
            tags.forEach(t => {
                const span = document.createElement('span'); span.className='tag-token'; span.style.background= 'var(--accent)'; span.style.color='#fff'; span.style.padding='4px 8px'; span.style.borderRadius='4px';
                span.style.display='inline-flex'; span.style.alignItems='center'; span.style.gap='8px';
                span.innerHTML = `${t} <i class="fas fa-times remove-tag" style="cursor:pointer"></i>`;
                span.querySelector('.remove-tag').addEventListener('click', ()=> {
                    removeTagFromInput(t, inputEl);
                });
                tagContainer.insertBefore(span, inputEl);
            });
            inputEl.value = '';
            if (!easyMDE) initializeEasyMDE();
            easyMDE.value(post ? post.content : '');
            document.getElementById('delete-post-btn').style.display = post ? 'inline-flex' : 'none';
        };

        const savePost = async () => {
            const id = document.getElementById('post-id').value;
            const title = document.getElementById('post-title').value.trim();
            const category = document.getElementById('post-category').value.trim() || '未分类';
            const tags = JSON.parse(document.getElementById('post-tags').value || '[]');
            const content = easyMDE.value().trim();
            if (!title || !content) { showAlert('标题和内容不能为空', 'danger'); return; }
            setButtonsDisabled(true);
            const now = new Date().toISOString();
            if (id) {
                const idx = posts.findIndex(p=>p.id===id);
                if (idx>-1) { posts[idx] = { ...posts[idx], title, category, tags, content, updatedAt: now }; }
            } else {
                posts.push({ id:`post_${Date.now()}_${Math.random().toString(36).slice(2,8)}`, title, category, tags, content, createdAt: now, updatedAt: now });
            }
            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, 'posts.json', utf8_to_b64(JSON.stringify(posts, null, 2)), postsSha, `docs: ${id ? 'update' : 'create'} post "${title}"`);
                postsSha = res.content.sha;
                showAlert('文章保存成功', 'success');
                renderPostList(); renderDashboard();
                showAdminView('posts');
            } catch (e) {
                console.error(e);
                showAlert('保存失败：' + e.message, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };

        const deletePost = async (postId) => {
            if (!postId) return;
            if (!confirm('确定删除该文章？')) return;
            setButtonsDisabled(true);
            const target = posts.find(p=>p.id===postId);
            posts = posts.filter(p=>p.id!==postId);
            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, 'posts.json', utf8_to_b64(JSON.stringify(posts, null, 2)), postsSha, `docs: delete post "${target.title}"`);
                postsSha = res.content.sha;
                showAlert('删除成功', 'success');
                renderPostList(); renderDashboard();
                showAdminView('posts');
            } catch (e) {
                console.error(e);
                showAlert('删除失败：' + e.message, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };

        // Tags functions
        const addTagToInput = (tag, inputEl) => {
            tag = tag.trim();
            if (!tag) return;
            let current = JSON.parse(document.getElementById('post-tags').value || '[]');
            if (!current.includes(tag)) {
                current.push(tag);
                document.getElementById('post-tags').value = JSON.stringify(current);
                const span = document.createElement('span'); span.className='tag-token'; span.style.background= 'var(--accent)'; span.style.color='#fff'; span.style.padding='4px 8px'; span.style.borderRadius='4px';
                span.style.display='inline-flex'; span.style.alignItems='center'; span.style.gap='8px';
                span.innerHTML = `${tag} <i class="fas fa-times remove-tag" style="cursor:pointer"></i>`;
                span.querySelector('.remove-tag').addEventListener('click', ()=> {
                    removeTagFromInput(tag, inputEl);
                });
                inputEl.parentNode.insertBefore(span, inputEl);
            }
        };
        const removeTagFromInput = (tag, inputEl) => {
            let current = JSON.parse(document.getElementById('post-tags').value || '[]');
            current = current.filter(t=>t!==tag);
            document.getElementById('post-tags').value = JSON.stringify(current);
            const container = document.getElementById('tag-token-container');
            container.querySelectorAll('.tag-token').forEach(tEl => {
                if (tEl.textContent.trim().startsWith(tag)) tEl.remove();
            });
        };

        // Settings
        const populateSettings = () => {
            document.getElementById('setting-title').value = config.site.title || `${owner}的博客`;
            document.getElementById('setting-description').value = config.site.description || '';
            document.getElementById('setting-about-content').value = config.site.aboutContent || '';
            document.getElementById('setting-bg-color').value = config.styling.backgroundColor || '#f8f9fa';
            document.getElementById('setting-text-color').value = config.styling.textColor || '#212529';
            document.getElementById('setting-accent-color').value = config.styling.accentColor || '#0d6efd';
            const bgUrl = config.styling.backgroundImageUrl || '';
            document.getElementById('setting-bg-image-url').value = bgUrl;
            const preview = document.getElementById('setting-bg-image-preview');
            if (bgUrl && /^https?:\/\//i.test(bgUrl)) {
                preview.innerHTML = `<img src="${getProxiedImageUrl(bgUrl)}" style="max-width:100%;max-height:100%;object-fit:cover" />`;
                document.getElementById('upload-bg-image-btn').style.display = 'none';
            } else {
                preview.innerHTML = `<span class="placeholder">无背景图</span>`;
                document.getElementById('upload-bg-image-btn').style.display = 'inline-flex';
            }
        };

        const saveSettings = async () => {
            setButtonsDisabled(true);
            const newConfig = JSON.parse(JSON.stringify(config));
            newConfig.site = {
                title: document.getElementById('setting-title').value.trim(),
                description: document.getElementById('setting-description').value.trim(),
                aboutContent: document.getElementById('setting-about-content').value.trim()
            };
            const bgUrl = document.getElementById('setting-bg-image-url').value.trim();
            newConfig.styling = {
                backgroundColor: document.getElementById('setting-bg-color').value,
                textColor: document.getElementById('setting-text-color').value,
                accentColor: document.getElementById('setting-accent-color').value,
                backgroundImageUrl: /^https?:\/\//i.test(bgUrl) ? bgUrl : ''
            };
            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, 'config.json', utf8_to_b64(JSON.stringify(newConfig, null, 2)), configSha, 'conf: update website settings');
                configSha = res.content.sha;
                config = newConfig;
                showAlert('设置已保存', 'success');
            } catch (e) {
                console.error(e);
                showAlert('保存失败：' + e.message, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };

        // Gitalk settings
        const populateGitalkSettings = () => {
            const g = config.gitalk || {};
            document.getElementById('gitalk-enabled').checked = !!g.enabled;
            document.getElementById('gitalk-clientID').value = g.clientID || '';
            document.getElementById('gitalk-clientSecret').value = g.clientSecret || '';
            document.getElementById('gitalk-repo').value = g.repo || '';
            document.getElementById('gitalk-owner').value = g.owner || '';
            document.getElementById('gitalk-admin').value = (g.admin && Array.isArray(g.admin)) ? g.admin.join(', ') : (g.admin || '');
        };

        const saveGitalkSettings = async () => {
            setButtonsDisabled(true);
            const newConfig = JSON.parse(JSON.stringify(config));
            const adminRaw = document.getElementById('gitalk-admin').value.trim();
            newConfig.gitalk = {
                enabled: document.getElementById('gitalk-enabled').checked,
                clientID: document.getElementById('gitalk-clientID').value.trim(),
                clientSecret: document.getElementById('gitalk-clientSecret').value.trim(),
                repo: document.getElementById('gitalk-repo').value.trim(),
                owner: document.getElementById('gitalk-owner').value.trim(),
                admin: adminRaw ? adminRaw.split(',').map(s=>s.trim()).filter(Boolean) : []
            };
            if (newConfig.gitalk.enabled && (!newConfig.gitalk.clientID || !newConfig.gitalk.clientSecret || !newConfig.gitalk.repo || !newConfig.gitalk.owner)) {
                showAlert('启用 Gitalk 时需填写 Client ID/Secret/Repo/Owner', 'danger');
                setButtonsDisabled(false);
                return;
            }
            try {
                const res = await GitHubAPI.updateFile(token, owner, repo, 'config.json', utf8_to_b64(JSON.stringify(newConfig, null, 2)), configSha, 'conf: update gitalk settings');
                configSha = res.content.sha;
                config = newConfig;
                showAlert('Gitalk 设置保存成功', 'success');
            } catch (e) {
                console.error(e);
                showAlert('保存失败：' + e.message, 'danger');
            } finally {
                setButtonsDisabled(false);
            }
        };

        // Dashboard
        const renderDashboard = () => {
            document.getElementById('total-posts').textContent = posts.length.toString();
            const cats = new Set(posts.map(p=>p.category).filter(Boolean));
            document.getElementById('total-categories').textContent = cats.size.toString();
            const tags = new Set(); posts.forEach(p=>p.tags && p.tags.forEach(t=>tags.add(t)));
            document.getElementById('total-tags').textContent = tags.size.toString();
        };

        // Initialization / start
        const checkTokenAndStart = async () => {
            const stored = localStorage.getItem('github_token');
            if (stored) {
                tokenInput.value = stored;
                rememberTokenCheckbox.checked = true;
                await startAdmin();
            }
        };

        const startAdmin = async () => {
            const t = tokenInput.value.trim();
            if (!t) { initialMessageEl.textContent = 'Token 不能为空'; return; }
            token = t;
            setButtonsDisabled(true);
            initialMessageEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 验证中...';
            try {
                const user = await GitHubAPI.getUser(token);
                initialMessageEl.textContent = `已验证：${user.login}，解析仓库路径...`;
                const parsed = parseGitHubRepoAndBasePath(user.login);
                owner = parsed.owner; repo = parsed.repo; publicUrlBase = parsed.publicUrlBase;
                pathDisplayEl.style.display = 'block';
                pathDisplayEl.textContent = `Owner:${owner} Repo:${repo} Base:${publicUrlBase || '/'}`;
                viewSiteLink.href = `${window.location.origin}${publicUrlBase}/index.html`;

                // ensure images/ exists
                try { await createGitHubDirectory(token, owner, repo, 'images'); } catch (e) { console.warn('create images failed', e); }

                // load config.json & posts.json
                initialMessageEl.textContent = '正在获取配置与文章数据...';
                const cfgFile = await GitHubAPI.getFile(token, owner, repo, 'config.json');
                const postsFile = await GitHubAPI.getFile(token, owner, repo, 'posts.json');
                if (!cfgFile || !cfgFile.content) {
                    // create default config
                    config = {
                        site: { title: `${owner} 的博客`, description: '由 GitHub 驱动', aboutContent: `# 关于` },
                        styling: { backgroundColor: '#f8f9fa', textColor: '#212529', accentColor: '#0d6efd', backgroundImageUrl: '' },
                        gitalk: { enabled:false, clientID:'', clientSecret:'', repo: repo, owner: owner, admin:[owner], labels:['Gitalk'], perPage:10 }
                    };
                    const res = await GitHubAPI.createFile(token, owner, repo, 'config.json', utf8_to_b64(JSON.stringify(config, null, 2)), 'feat: init config');
                    configSha = res.content.sha;
                } else {
                    config = JSON.parse(b64_to_utf8(cfgFile.content));
                    configSha = cfgFile.sha;
                }

                if (!postsFile || !postsFile.content) {
                    const initialPost = {
                        id:`welcome_${Date.now()}`,
                        title:'欢迎！',
                        content:'# 欢迎来到博客！\n\n这是第一篇文章。',
                        category:'公告',
                        tags:['欢迎'],
                        createdAt:new Date().toISOString(),
                        updatedAt:new Date().toISOString()
                    };
                    posts = [initialPost];
                    const res = await GitHubAPI.createFile(token, owner, repo, 'posts.json', utf8_to_b64(JSON.stringify(posts, null, 2)), 'feat: init posts');
                    postsSha = res.content.sha;
                } else {
                    posts = JSON.parse(b64_to_utf8(postsFile.content));
                    postsSha = postsFile.sha;
                }

                // ensure posts content raw urls are normal (no gh-proxy)
                posts = posts.map(p => {
                    const c = (p.content || '').replace(/!\[(.*?)\]\((https?:\/\/[^\s)]+)\)/g, (m, alt, url) => {
                        let original = url;
                        if (original.startsWith('https://gh-proxy.com/')) {
                            try { original = decodeURIComponent(original.substring('https://gh-proxy.com/'.length)); } catch (e) { }
                        }
                        return `![${alt}](${original})`;
                    });
                    return { ...p, content: c };
                });

                // UI show
                loginWrapper.style.display = 'none';
                adminWrapper.style.display = 'flex';
                populateSettings();
                populateGitalkSettings();
                renderPostList();
                renderDashboard();
                showAdminView('dashboard');

                if (rememberTokenCheckbox.checked) localStorage.setItem('github_token', token); else localStorage.removeItem('github_token');
                initialMessageEl.textContent = '';
                showAlert('管理后台已就绪', 'success');

            } catch (e) {
                console.error(e);
                initialMessageEl.textContent = '初始化失败：' + e.message;
                token = null;
                localStorage.removeItem('github_token');
            } finally { setButtonsDisabled(false); }
        };

        // Event binding
        document.addEventListener('DOMContentLoaded', () => {
            startBtn.onclick = startAdmin;
            tokenInput.addEventListener('keydown', (e)=> { if (e.key==='Enter') startAdmin(); });
            document.getElementById('nav-dashboard').onclick = (e)=>{ e.preventDefault(); showAdminView('dashboard'); };
            document.getElementById('nav-posts').onclick = (e)=>{ e.preventDefault(); showAdminView('posts'); };
            document.getElementById('nav-media-library').onclick = (e)=>{ e.preventDefault(); showAdminView('mediaLibrary'); };
            document.getElementById('nav-settings').onclick = (e)=>{ e.preventDefault(); showAdminView('settings'); populateSettings(); };
            document.getElementById('nav-gitalk-settings').onclick = (e)=>{ e.preventDefault(); showAdminView('gitalkSettings'); populateGitalkSettings(); };
            document.getElementById('nav-logout').onclick = (e)=>{ e.preventDefault(); if (confirm('确定退出？')) { localStorage.removeItem('github_token'); location.reload(); } };

            document.getElementById('open-posts').onclick = ()=> showAdminView('posts');
            document.getElementById('new-post-btn').onclick = ()=> openEditor();
            document.getElementById('save-post-btn').onclick = savePost;
            document.getElementById('cancel-edit-btn').onclick = ()=> showAdminView('posts');
            document.getElementById('delete-post-btn').onclick = ()=> deletePost(document.getElementById('post-id').value);
            document.getElementById('delete-selected-posts-btn').onclick = bulkDeletePosts;

            // posts table delegate
            postListBody.addEventListener('click', (e) => {
                const ed = e.target.closest('.edit');
                const del = e.target.closest('.delete');
                if (ed) { e.preventDefault(); openEditor(ed.dataset.id); }
                if (del) { e.preventDefault(); deletePost(del.dataset.id); }
            });

            // tags input
            const tagsInput = document.getElementById('post-tags-input');
            tagsInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); const v = tagsInput.value.trim(); if (v) { addTagToInput(v, tagsInput); tagsInput.value = ''; } }
                else if (e.key === 'Backspace' && tagsInput.value === '') {
                    const last = document.querySelector('#tag-token-container .tag-token:last-of-type');
                    if (last) {
                        const t = last.textContent.trim().split(' ')[0];
                        removeTagFromInput(t, tagsInput);
                    }
                }
            });

            // settings image upload handlers
            const settingBgImageInput = document.getElementById('setting-bg-image');
            const settingBgImageUrlInput = document.getElementById('setting-bg-image-url');
            const settingBgImagePreview = document.getElementById('setting-bg-image-preview');
            const uploadBgImageBtn = document.getElementById('upload-bg-image-btn');

            settingBgImageInput.onchange = (e) => {
                if (e.target.files && e.target.files.length) {
                    const f = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = evt => {
                        settingBgImagePreview.innerHTML = `<img src="${evt.target.result}" style="max-width:100%;max-height:100%;object-fit:cover" />`;
                        uploadBgImageBtn.style.display = 'inline-flex';
                        settingBgImageUrlInput.value = '';
                    };
                    reader.readAsDataURL(f);
                } else {
                    settingBgImagePreview.innerHTML = `<span class="placeholder">无背景图</span>`;
                }
            };

            uploadBgImageBtn.onclick = async () => {
                const file = settingBgImageInput.files && settingBgImageInput.files[0];
                if (!file) { showAlert('请先选择图片', 'warning'); return; }
                setButtonsDisabled(true);
                try {
                    const rawUrl = await uploadFile(file, 'images', `feat: upload background ${file.name}`);
                    document.getElementById('setting-bg-image-url').value = rawUrl;
                    settingBgImagePreview.innerHTML = `<img src="${getProxiedImageUrl(rawUrl)}" style="max-width:100%;max-height:100%;object-fit:cover" />`;
                    showAlert('背景图片上传成功，请点击保存设置', 'success');
                } catch (e) {
                    console.error(e);
                    showAlert('上传失败：' + e.message, 'danger');
                } finally { setButtonsDisabled(false); }
            };

            document.getElementById('clear-bg-image-btn').onclick = () => {
                document.getElementById('setting-bg-image-url').value = '';
                settingBgImagePreview.innerHTML = `<span class="placeholder">无背景图</span>`;
                showAlert('已清除背景图，请保存设置', 'info');
            };

            document.getElementById('save-settings-btn').onclick = saveSettings;
            document.getElementById('save-gitalk-settings-btn').onclick = saveGitalkSettings;

            // media upload input & drag-drop
            const mediaUploadInput = document.getElementById('media-upload-input');
            const mediaUploadDroparea = document.getElementById('media-upload-droparea');
            mediaUploadInput.onchange = (e) => handleMediaFileUpload(e.target.files);

            ['dragenter','dragover','dragleave','drop'].forEach(ev => mediaUploadDroparea.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); }, false));
            ['dragenter','dragover'].forEach(ev => mediaUploadDroparea.addEventListener(ev, ()=> mediaUploadDroparea.classList.add('drag-over')));
            ['dragleave','drop'].forEach(ev => mediaUploadDroparea.addEventListener(ev, ()=> mediaUploadDroparea.classList.remove('drag-over')));
            mediaUploadDroparea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleMediaFileUpload(files);
            });

            // Posts table event delegations are already set
            checkTokenAndStart();
            document.getElementById('delete-selected-posts-btn').addEventListener('click', bulkDeletePosts);
        });
    </script>
</body>
</html>
